=== CONTE√öDO: 1_TELAS_E_ROTAS.txt ===


==================================================
ARQUIVO: .\src\app\globals.css
==================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

==================================================
ARQUIVO: .\src\app\layout.tsx
==================================================
// Caminho: src/app/layout.tsx
import type { Metadata, Viewport } from 'next' // <--- Importe Viewport
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

// 1. CONFIGURA√á√ÉO DE APP NATIVO (ZOOM E CORES)
export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  userScalable: false, // Impede zoom de pin√ßa (sensa√ß√£o de app nativo)
  themeColor: '#2563eb', // Pinta a barra de status do celular de azul
}

// 2. METADADOS PARA iOS (IPHONE)
export const metadata: Metadata = {
  title: 'Gest√£o √ìtica Pro',
  description: 'Sistema de gest√£o para redes de √≥ticas',
  appleWebApp: {
    capable: true,
    statusBarStyle: 'default',
    title: '√ìtica Pro',
  },
  formatDetection: {
    telephone: false, // Evita que n√∫meros aleat√≥rios virem links de telefone
  },
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="pt-br">
      <body
        className={`${inter.className} flex flex-col min-h-screen bg-gray-100 text-slate-800`}
      >
        {children}
      </body>
    </html>
  )
}

==================================================
ARQUIVO: .\src\app\manifest.ts
==================================================
// ARQUIVO: src/app/manifest.ts
import { MetadataRoute } from 'next'

export default function manifest(): MetadataRoute.Manifest {
  return {
    name: 'Gest√£o √ìtica Pro',
    short_name: '√ìtica Pro',
    description: 'Sistema de Gest√£o para √ìticas',
    start_url: '/',
    display: 'standalone', // <--- ISSO REMOVE A BARRA DE ENDERE√áO
    background_color: '#f3f4f6', // Cor do bg-gray-100
    theme_color: '#2563eb',      // Cor do blue-600 (Header)
    orientation: 'portrait',     // Opcional: for√ßa modo retrato se quiser
    icons: [
      {
        src: '/favicon.ico',
        sizes: 'any',
        type: 'image/x-icon',
      },
      // Idealmente depois voc√™ adiciona √≠cones PNG (192x192 e 512x512) aqui
    ],
  }
}

==================================================
ARQUIVO: .\src\app\page.tsx
==================================================
// Caminho: src/app/page.tsx
import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
// Importa o helper do admin, que usa o Service Role Client
import { getProfileByAdmin } from '@/lib/supabase/admin' 

export default async function HomePage() {
  const supabase = createClient()

  const {
    data: { user },
  } = await supabase.auth.getUser()

  if (user) {
    // CORRE√á√ÉO: Cast 'as any' para garantir acesso √†s propriedades role e store_id
    const profile = await getProfileByAdmin(user.id) as any;

    if (profile?.role === 'admin') {
      const adminStoreId = profile.store_id || 1; 
      redirect(`/dashboard/loja/${adminStoreId}`) 

    } else if (profile?.role === 'manager') {
       if (profile.store_id) {
           redirect(`/dashboard/loja/${profile.store_id}`)
       } else {
           redirect('/dashboard/manager') 
       }
      
    } else if (profile?.role === 'store_operator' && profile.store_id) {
      redirect(`/dashboard/loja/${profile.store_id}`) 
      
    } else if (profile?.role === 'vendedor' && profile.store_id) {
      // Vendedor vai direto para o PDV ou para a home da loja
      redirect(`/dashboard/loja/${profile.store_id}/pdv-express`)
      
    } else {
      // Se for um usu√°rio logado sem perfil v√°lido, desloga
      await supabase.auth.signOut();
      redirect('/login?error=invalid_profile') 
    }
  }

  // Se n√£o houver usu√°rio, vai para o login
  redirect('/login')
}

==================================================
ARQUIVO: .\src\app\dashboard\layout.tsx
==================================================
// Caminho: src/app/dashboard/layout.tsx
import React from 'react';
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
// CORRE√á√ÉO: Ajuste do caminho para min√∫sculo para coincidir com o nome real do arquivo e evitar erro no Linux/Vercel
import Header from '@/components/header';

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const supabase = createClient();
  
  // 1. Apenas faz a checagem de autentica√ß√£o no n√≠vel mais alto.
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return redirect('/login');
  }

  // Se o usu√°rio est√° logado, apenas renderiza o Header e passa o controle
  // para o layout aninhado (children).

  return (
    <>
      <Header />
      
      {/* Container Principal: Header √© compensado por pt-16 */}
      <div className="flex flex-1 pt-16">
        {/* O CHILDREN (a rota filha) ser√° respons√°vel por renderizar a SideNav (se for uma rota de loja) */}
        {children}
      </div>
    </>
  );
}

==================================================
ARQUIVO: .\src\app\dashboard\admin\page.tsx
==================================================
export default function AdminPage() {
  return (
    <div className="text-center p-10">
      <h1 className="text-4xl font-bold text-gray-800">Painel Geral (Admin)</h1>
      <p className="mt-4 text-lg text-green-600">
        Gerenciamento de Tenants em desenvolvimento.
      </p>
    </div>
  );
}

==================================================
ARQUIVO: .\src\app\dashboard\lab-financeiro\page.tsx
==================================================
'use client'

import { useState } from 'react';
import { 
  criarCarneLab, 
  excluirCarneLab, 
  renegociarParcelasLab, 
  investigarVendaLab 
} from '@/lib/actions/lab-carnes.actions';

export default function LabFinanceiroPage() {
  const [vendaIdInput, setVendaIdInput] = useState('');
  
  const [dados, setDados] = useState<{
    venda: any;
    carne: any;
    parcelas: any[];
  } | null>(null);

  const [loading, setLoading] = useState(false);
  const [msg, setMsg] = useState<{ texto: string; tipo: 'erro' | 'sucesso' | 'aviso' } | null>(null);

  // Busca usando a fun√ß√£o ADMIN do servidor
  const buscarDados = async () => {
    if (!vendaIdInput) return;

    setLoading(true);
    setMsg(null);
    setDados(null);

    try {
      const resultado = await investigarVendaLab(vendaIdInput);

      if (!resultado.success) {
        setMsg({ texto: resultado.message || 'Erro desconhecido', tipo: 'erro' });
        setLoading(false);
        return;
      }

      // CORRE√á√ÉO 1: Verificamos se 'data' existe antes de usar
      if (resultado.data) {
        setDados(resultado.data);

        // DETECTOR DE ZUMBIS (Capa existe, parcelas vazias)
        if (resultado.data.carne && resultado.data.parcelas.length === 0) {
          setMsg({ 
            texto: 'ALERTA DE ZUMBI: Contrato existe (Capa), mas as parcelas sumiram.', 
            tipo: 'erro' 
          });
        }
      }

    } catch (error) {
      setMsg({ texto: 'Erro de comunica√ß√£o.', tipo: 'erro' });
    } finally {
      setLoading(false);
    }
  };

  const handleCriar = async () => {
    if (!dados?.venda) return;
    setLoading(true);
    
    // Cria 3x fixo para teste
    const res = await criarCarneLab({
      // CORRE√á√ÉO 2: Garantimos que nunca seja undefined usando || ''
      tenant_id: dados.venda.tenant_id || '', 
      venda_id: dados.venda.id,
      customer_id: dados.venda.customer_id,
      store_id: dados.venda.store_id,
      valor_total: dados.venda.valor_total,
      qtd_parcelas: 3, 
      data_primeiro_vencimento: new Date().toISOString().split('T')[0]
    });

    setMsg({ texto: res.message || 'Processado', tipo: res.success ? 'sucesso' : 'erro' });
    
    if (res.success) {
      await buscarDados();
    } else {
      setLoading(false);
    }
  };

  const handleExcluir = async () => {
    if (!dados?.carne) return;
    if (!confirm('Tem certeza? Isso apagar√° o contrato e todas as parcelas.')) return;

    setLoading(true);
    const res = await excluirCarneLab(dados.carne.id, dados.venda.id);
    
    setMsg({ texto: res.message || 'Processado', tipo: res.success ? 'sucesso' : 'erro' });
    await buscarDados(); 
  };

  const handleRenegociar = async () => {
    if (!dados?.carne) return;
    setLoading(true);

    const res = await renegociarParcelasLab(
        dados.carne.id, 
        5, 
        new Date().toISOString().split('T')[0]
    );

    setMsg({ texto: res.message || 'Processado', tipo: res.success ? 'sucesso' : 'erro' });
    await buscarDados();
  };

  return (
    <div className="p-8 bg-gray-50 min-h-screen font-sans text-gray-800">
      <header className="mb-8 border-b pb-4">
        <h1 className="text-3xl font-bold text-blue-900">üî¨ Laborat√≥rio de Carn√™s (Admin Mode)</h1>
        <p className="text-gray-600 text-sm mt-1">
          Ambiente de teste e corre√ß√£o com permiss√µes elevadas.
        </p>
      </header>
      
      {/* Busca */}
      <div className="flex gap-4 mb-8 bg-white p-4 rounded shadow-sm border border-gray-200">
        <input 
          type="text" 
          placeholder="ID da Venda (ex: 70)" 
          className="p-3 border rounded w-64 outline-none focus:border-blue-500"
          value={vendaIdInput}
          onChange={(e) => setVendaIdInput(e.target.value)}
          onKeyDown={(e) => e.key === 'Enter' && buscarDados()}
        />
        <button 
          onClick={buscarDados} 
          disabled={loading}
          className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 disabled:opacity-50 font-bold transition"
        >
          {loading ? 'Carregando...' : 'Carregar Venda'}
        </button>
      </div>

      {/* Alertas */}
      {msg && (
        <div className={`p-4 mb-6 rounded border-l-4 ${
          msg.tipo === 'erro' ? 'bg-red-50 text-red-900 border-red-600' :
          msg.tipo === 'sucesso' ? 'bg-green-50 text-green-900 border-green-600' :
          'bg-yellow-50 text-yellow-900 border-yellow-500'
        }`}>
          <span className="font-bold block text-xs uppercase opacity-70 mb-1">{msg.tipo}</span>
          {msg.texto}
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        {/* Painel ESQUERDO: Venda */}
        <div className="bg-white p-6 shadow rounded border border-gray-200">
          <h2 className="text-xl font-bold mb-4 border-b pb-2">üìÇ Dados da Venda</h2>
          
          {dados?.venda ? (
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div className="bg-gray-50 p-3 rounded">
                  <span className="block text-gray-500 text-xs uppercase">ID da Venda</span>
                  <span className="font-mono font-bold text-xl">{dados.venda.id}</span>
                </div>
                <div className="bg-gray-50 p-3 rounded">
                  <span className="block text-gray-500 text-xs uppercase">Total</span>
                  <span className="font-bold text-green-700 text-lg">R$ {dados.venda.valor_total}</span>
                </div>
                <div className={`p-3 rounded ${!dados.venda.financiamento_id ? 'bg-red-50 text-red-700' : 'bg-blue-50 text-blue-700'}`}>
                  <span className="block text-xs uppercase opacity-70">Link Financiamento</span>
                  <span className="font-mono font-bold">
                    {dados.venda.financiamento_id ? `OK (ID: ${dados.venda.financiamento_id})` : 'NULL (Sem V√≠nculo)'}
                  </span>
                </div>
              </div>
              
              <div className="text-xs text-gray-400 mt-4 font-mono bg-gray-100 p-2 rounded">
                Tenant: {dados.venda.tenant_id}
              </div>
            </div>
          ) : (
            <div className="h-40 flex items-center justify-center text-gray-400 bg-gray-50 rounded border border-dashed">
              Aguardando busca...
            </div>
          )}
        </div>

        {/* Painel DIREITO: Carn√™ */}
        <div className="bg-white p-6 shadow rounded border-2 border-blue-50">
          <div className="flex justify-between items-center mb-4 border-b pb-2">
            <h2 className="text-xl font-bold text-blue-900">üìë Contrato & Parcelas</h2>
            
            <div className="space-x-2">
              {/* Bot√£o CRIAR */}
              {dados?.venda && !dados?.carne && (
                <button 
                  onClick={handleCriar} 
                  disabled={loading}
                  className="text-sm bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow transition font-bold"
                >
                  + Criar Teste (3x)
                </button>
              )}
              
              {/* Bot√µes de MANUTEN√á√ÉO */}
              {dados?.carne && (
                <>
                  <button 
                    onClick={handleRenegociar}
                    disabled={loading} 
                    className="text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded shadow transition"
                  >
                    Renegociar (5x)
                  </button>
                  <button 
                    onClick={handleExcluir}
                    disabled={loading} 
                    className="text-sm bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded shadow transition"
                  >
                    Excluir Tudo
                  </button>
                </>
              )}
            </div>
          </div>

          {dados?.carne ? (
            <div>
              <div className="grid grid-cols-3 gap-2 mb-4 text-sm bg-blue-50 p-3 rounded text-blue-900">
                <div>
                  <span className="block text-xs opacity-60">ID Contrato</span>
                  <span className="font-bold">{dados.carne.id}</span>
                </div>
                <div>
                  <span className="block text-xs opacity-60">Parcelas (Capa)</span>
                  <span className="font-bold">{dados.carne.quantidade_parcelas}</span>
                </div>
                <div>
                  <span className="block text-xs opacity-60">Total Financiado</span>
                  <span className="font-bold">R$ {dados.carne.valor_total_financiado}</span>
                </div>
              </div>

              <div className="overflow-hidden border rounded-lg mt-4">
                <table className="w-full text-sm">
                  <thead className="bg-gray-100 text-gray-600">
                    <tr>
                      <th className="p-3 text-left">#</th>
                      <th className="p-3 text-left">Vencimento</th>
                      <th className="p-3 text-left">Valor</th>
                      <th className="p-3 text-left">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-100">
                    {dados.parcelas.map((p) => (
                      <tr key={p.id} className="hover:bg-gray-50">
                        <td className="p-3 font-mono text-gray-500">{p.numero_parcela}</td>
                        <td className="p-3">{new Date(p.data_vencimento).toLocaleDateString()}</td>
                        <td className="p-3">R$ {p.valor_parcela}</td>
                        <td className="p-3">
                          <span className={`px-2 py-1 rounded text-xs font-bold ${
                            p.status === 'Pago' 
                              ? 'bg-green-100 text-green-700' 
                              : 'bg-orange-100 text-orange-700'
                          }`}>
                            {p.status}
                          </span>
                        </td>
                      </tr>
                    ))}
                    
                    {dados.parcelas.length === 0 && (
                      <tr>
                        <td colSpan={4} className="p-8 text-center bg-red-50 text-red-600">
                          <p className="font-bold text-lg">‚ö†Ô∏è ERRO ZUMBI DETECTADO</p>
                          <p className="text-sm mt-1">Este contrato n√£o possui parcelas.</p>
                          <p className="text-xs mt-2 text-gray-500">Clique em "Excluir Tudo" acima para corrigir.</p>
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          ) : (
             <div className="h-40 flex flex-col items-center justify-center text-gray-400 italic bg-gray-50 rounded border border-dashed">
              <p>Nenhum contrato ativo.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\layout.tsx
==================================================
// Caminho: src/app/dashboard/loja/[storeId]/layout.tsx

import { createClient } from '@/lib/supabase/server';
import { redirect, notFound } from 'next/navigation';
import SideNav from '@/components/SideNav';
import { getProfileByAdmin } from '@/lib/supabase/admin'; 
import { createAdminClient } from '@/lib/supabase/admin'; 
import CashGuard from '@/components/financeiro/CashGuard'; // <--- 1. Importa√ß√£o do Guardi√£o

type Role = 'admin' | 'manager' | 'store_operator' | 'vendedor' | 'tecnico';

export default async function StoreLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: { storeId: string };
}) {
  const supabase = createClient();
  const storeIdParam = parseInt(params.storeId as string, 10);

  if (isNaN(storeIdParam)) return notFound();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return redirect('/login');

  // Busca perfil usando admin client para garantir leitura correta
  const profile = await getProfileByAdmin(user.id) as any; 

  if (!profile || !profile.role) {
      return redirect('/login?error=profile_incomplete');
  }
  
  const { store_id, role } = profile;
  const userRole = role as Role;

  // Valida√ß√£o de Seguran√ßa: O usu√°rio pertence a esta loja?
  const isAuthorized = userRole === 'admin' || store_id === storeIdParam;

  if (!isAuthorized) {
    return redirect('/dashboard/manager?error=access_denied');
  }

  // Busca o nome da loja para exibir no Menu
  const supabaseAdmin = createAdminClient();
  const { data: storeData } = await (supabaseAdmin
    .from('stores') as any)
    .select('name')
    .eq('id', storeIdParam)
    .single();
    
  const storeName = storeData?.name || '√ìtica';

  return (
    <div className="flex w-full h-screen overflow-hidden"> 
      
      {/* 2. O GUARDI√ÉO DO CAIXA */}
      {/* Ele roda em segundo plano verificando se o caixa est√° aberto.
          Se estiver fechado, ele bloqueia a tela (com op√ß√£o de pular). */}
      <CashGuard storeId={storeIdParam} />

      <div className="flex-shrink-0 relative z-40">
          <SideNav 
            userRole={userRole} 
            storeId={storeIdParam} 
            storeName={storeName} 
          />
      </div>

      <main className="flex-1 overflow-hidden bg-gray-100 relative">
        {children}
      </main>
    </div>
  );
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\page.tsx
==================================================
// ARQUIVO: src/app/dashboard/loja/[storeId]/page.tsx

import { notFound, redirect } from 'next/navigation'
import { createClient } from '@/lib/supabase/server'
import { getProfileByAdmin, createAdminClient } from '@/lib/supabase/admin'

// Importa√ß√£o das Actions de Dados
import { getManagerKPIs, getAdminKPIs } from '@/lib/actions/dashboard.actions'
import { getAlertasOperacionais, getAniversariantes, getVencimentosProximos } from '@/lib/actions/consultas.actions'

// Importa√ß√£o dos Pain√©is Visuais
import { ManagerDashboard, AdminDashboard } from '@/components/dashboard/DashboardViews'
import ActionMenuDashboard from '@/components/dashboard/ActionMenuDashboard'

export default async function StoreHomePage({ params }: { params: { storeId: string } }) {
  const storeId = parseInt(params.storeId, 10)
  if (isNaN(storeId)) return notFound()

  const supabase = createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return redirect('/login')

  const profile = await getProfileByAdmin(user.id) as any
  if (!profile) return redirect('/login')

  // Busca nome da loja
  const supabaseAdmin = createAdminClient()
  const { data: store } = await (supabaseAdmin.from('stores') as any)
    .select('name')
    .eq('id', storeId)
    .single()
    
  const storeName = store?.name || `Loja ${storeId}`

  // 1. ADMIN (Dono da Rede)
  if (profile.role === 'admin') {
      const kpis = await getAdminKPIs()
      return (
          <div className="p-6 max-w-7xl mx-auto">
              <h1 className="text-2xl font-bold text-slate-800 mb-6">Vis√£o Geral da Rede (Admin)</h1>
              <AdminDashboard data={kpis} />
          </div>
      )
  }

  // 2. MANAGER (Gerente)
  if (profile.role === 'manager') {
      const kpis = await getManagerKPIs(storeId)
      return (
          <div className="p-6 max-w-7xl mx-auto">
              <div className="flex justify-between items-center mb-6">
                  <h1 className="text-2xl font-bold text-slate-800">Painel Gerencial</h1>
                  <span className="text-sm font-medium text-slate-500 bg-white border border-slate-200 px-3 py-1 rounded-full shadow-sm">
                      {storeName}
                  </span>
              </div>
              <ManagerDashboard data={kpis} />
          </div>
      )
  }

  // 3. OPERADOR / VENDEDOR (Dashboard Operacional)
  // Busca em paralelo para ser r√°pido
  const [alertas, aniversariantes, vencimentos] = await Promise.all([
      getAlertasOperacionais(storeId),
      getAniversariantes(storeId),
      getVencimentosProximos(storeId) // <--- Busca nova
  ])

  return (
      <ActionMenuDashboard 
          storeId={storeId} 
          storeName={storeName} // <--- Passa o nome da loja
          alerts={alertas} 
          birthdays={aniversariantes} 
          vencimentos={vencimentos} // <--- Passa os vencimentos
      />
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\assistencia\page.tsx
==================================================
// ARQUIVO: src/app/dashboard/loja/[storeId]/assistencia/page.tsx
import { getAssistanceTickets } from '@/lib/actions/assistance.actions'
import AssistanceKanban from '@/components/assistencia/AssistanceKanban'
import { LifeBuoy } from 'lucide-react'

export default async function AssistenciaPage({ params }: { params: { storeId: string } }) {
  const storeId = parseInt(params.storeId, 10)
  const tickets = await getAssistanceTickets(storeId)

  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-slate-100 overflow-hidden">
      
      {/* Header */}
      <div className="bg-white border-b border-slate-200 px-6 py-3 shadow-sm flex-shrink-0 flex justify-between items-center">
        <div className="flex items-center gap-3">
            <div className="p-2 bg-indigo-100 text-indigo-600 rounded-lg">
                <LifeBuoy className="h-6 w-6" />
            </div>
            <div>
                <h1 className="text-xl font-bold text-gray-800">Controle de Assist√™ncia</h1>
                <p className="text-xs text-gray-500">Gest√£o de Garantias e Reparos</p>
            </div>
        </div>
      </div>

      {/* Kanban Board */}
      <div className="flex-1 overflow-hidden">
         <AssistanceKanban initialData={tickets} storeId={storeId} />
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\atendimento\page.tsx
==================================================
// ============================
// üìÑ ARQUIVO: src/app/dashboard/loja/[storeId]/atendimento/page.tsx
// ============================

'use client'

import { useState, useTransition, useEffect } from 'react'
import { useParams, useRouter } from 'next/navigation'
import {
  searchCustomersByName,
  createNewVenda,
  type CustomerSearchResult,
  getLastSalesForCustomer, 
  type CustomerSaleHistory
} from '@/lib/actions/vendas.actions'
import { getEmployees } from '@/lib/actions/employee.actions'
import { 
  Loader2, Search, X, PlusCircle, UserCircle, 
  History, ChevronDown, ChevronUp, Eye, Wallet, 
  AlertTriangle, CheckCircle2, User, Briefcase,
  ShoppingCart, UserPlus 
} from 'lucide-react'
import { Database } from '@/lib/database.types'
import QuickCustomerModal from '@/components/modals/QuickCustomerModal'

type Employee = Database['public']['Tables']['employees']['Row']
type Customer = Database['public']['Tables']['customers']['Row']

// ATUALIZA√á√ÉO 1: Adicionado prop customerObs na assinatura do componente
function HistoryCard({ data, customerObs }: { data: CustomerSaleHistory, customerObs?: string | null }) {
    const [isOpen, setIsOpen] = useState(false)
    const isAtrasado = data.financeiro.status_geral === 'Atrasado'
    const isQuitado = data.financeiro.status_geral === 'Quitado'
    const formatMoney = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

    return (
        <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden transition-all hover:shadow-md w-full">
            <div onClick={() => setIsOpen(!isOpen)} className="p-4 cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors">
                <div className="flex items-center gap-4 flex-1">
                    <div className={`p-3 rounded-full flex-shrink-0 ${isAtrasado ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'}`}>
                        {isAtrasado ? <AlertTriangle className="h-6 w-6" /> : <History className="h-6 w-6" />}
                    </div>
                    <div>
                        <div className="flex items-baseline gap-2">
                            <p className="text-base text-gray-600">Venda #{data.venda_id}</p>
                            <span className="text-sm font-black text-gray-800">{new Date(data.data).toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div className="flex items-center gap-1 mt-0.5">
                            <User className="h-4 w-4 text-gray-400" />
                            <span className="text-sm text-gray-600">Para:</span>
                            <strong className="text-base text-blue-800">{data.paciente_nome}</strong>
                        </div>
                    </div>
                </div>
                <div className="flex items-center gap-6">
                    <div className="text-right hidden sm:block">
                        <p className="text-lg font-black text-gray-900">{formatMoney(data.valor_total)}</p>
                        <div className="flex flex-col items-end">
                             <span className="text-[11px] font-bold text-gray-700 uppercase tracking-wide">{data.financeiro.forma_pagamento_resumo || 'Em Aberto'}</span>
                             {data.financeiro.tem_carne && (
                                <span className={`text-[10px] font-bold uppercase px-1.5 py-0.5 rounded mt-0.5 ${isQuitado ? 'text-green-600 bg-green-50' : isAtrasado ? 'text-red-600 bg-red-50' : 'text-amber-600 bg-amber-50'}`}>
                                    {data.financeiro.status_geral}
                                </span>
                             )}
                        </div>
                    </div>
                    {isOpen ? <ChevronUp className="h-6 w-6 text-gray-400" /> : <ChevronDown className="h-6 w-6 text-gray-400" />}
                </div>
            </div>
            {isOpen && (
                <div className="p-5 border-t border-gray-100 animate-in slide-in-from-top-2 bg-white">
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-7 space-y-4">
                            <div>
                                <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-wider">Produtos Adquiridos</p>
                                <div className="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 text-gray-500 font-bold text-[10px] uppercase">
                                            <tr>
                                                <th className="px-3 py-2">Descri√ß√£o</th>
                                                <th className="px-3 py-2 text-center">Qtd.</th>
                                                <th className="px-3 py-2 text-right">Vl. Unit.</th>
                                                <th className="px-3 py-2 text-right">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {data.itens.map((item, idx) => (
                                                <tr key={idx}>
                                                    <td className="px-3 py-2 font-medium text-gray-700">{item.descricao}</td>
                                                    <td className="px-3 py-2 text-center text-gray-500">{item.quantidade}</td>
                                                    <td className="px-3 py-2 text-right text-gray-500">{formatMoney(item.valor_unitario)}</td>
                                                    <td className="px-3 py-2 text-right font-bold text-blue-600">{formatMoney(item.valor_total)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {data.financeiro.tem_carne && data.financeiro.parcelas_detalhes.length > 0 && (
                                <div>
                                    <p className="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-wider">Parcelamento (Carn√™)</p>
                                    <div className="flex gap-2 overflow-x-auto pb-2">
                                        {data.financeiro.parcelas_detalhes.map((p) => (
                                            <div key={p.numero} className={`flex-shrink-0 p-2 rounded border min-w-[100px] text-center ${p.status === 'Pago' ? 'bg-green-50 border-green-200' : new Date(p.vencimento) < new Date() ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'}`}>
                                                <p className="text-[10px] text-gray-500 font-bold uppercase">{p.numero}¬™ Parc</p>
                                                <p className="font-bold text-sm text-gray-800">{formatMoney(p.valor)}</p>
                                                <p className={`text-[10px] ${p.status === 'Pago' ? 'text-green-600 font-bold' : 'text-gray-400'}`}>
                                                    {new Date(p.vencimento).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="lg:col-span-5 space-y-4">
                            <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100 h-full">
                                <p className="text-[10px] font-bold text-blue-400 uppercase mb-3 flex items-center gap-1 tracking-wider"><Eye className="h-3 w-3" /> DADOS DA RECEITA USADA</p>
                                {data.tecnico ? (
                                    <div className="space-y-4">
                                        <div className="flex justify-between text-sm items-baseline border-b border-blue-100 pb-2">
                                            <span className="text-gray-500">M√©dico:</span>
                                            <span className="font-bold text-blue-900 text-right">{data.tecnico.medico}</span>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2 text-center">
                                            <div className="text-[9px] font-bold text-blue-300 uppercase">Olho</div>
                                            <div className="text-[9px] font-bold text-blue-300 uppercase">Esf / Cil</div>
                                            <div className="text-[9px] font-bold text-blue-300 uppercase">Adi√ß√£o</div>
                                            <div className="font-black text-blue-600 text-sm">OD</div>
                                            <div className="bg-white rounded py-1 px-2 text-sm font-mono shadow-sm text-gray-700">{data.tecnico.longe_od}</div>
                                            <div className="bg-white rounded py-1 px-2 text-sm font-mono shadow-sm text-gray-700 row-span-2 flex items-center justify-center font-bold">{data.tecnico.adicao}</div>
                                            <div className="font-black text-blue-600 text-sm">OE</div>
                                            <div className="bg-white rounded py-1 px-2 text-sm font-mono shadow-sm text-gray-700">{data.tecnico.longe_oe}</div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-32 text-blue-300"><Eye className="h-8 w-8 opacity-50 mb-2" /><p className="text-xs italic">Venda sem grau (Solar/Balc√£o)</p></div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* ATUALIZA√á√ÉO 2: Exibindo a observa√ß√£o do cadastro na parte inferior do card */}
                    {customerObs && (
                        <div className="mt-6 pt-4 border-t border-gray-100">
                             <p className="text-[10px] font-bold text-red-600 uppercase mb-2 flex items-center gap-1 tracking-wider">
                                <AlertTriangle className="h-3 w-3" /> Observa√ß√µes do Cadastro
                             </p>
                             <div className="bg-red-50 text-red-900 text-xs p-3 rounded-lg border border-red-100 font-medium">
                                {customerObs}
                             </div>
                        </div>
                    )}

                </div>
            )}
        </div>
    )
}

// --- P√ÅGINA PRINCIPAL ---
export default function AtendimentoPage() {
  const params = useParams()
  const router = useRouter()
  const storeId = parseInt(params.storeId as string, 10)

  // UI States
  const [query, setQuery] = useState('')
  const [isSearching, startSearchTransition] = useTransition()
  const [isCreating, startCreateTransition] = useTransition()
  const [searchError, setSearchError] = useState<string | null>(null)
  const [isQuickModalOpen, setIsQuickModalOpen] = useState(false) 
  
  // Data States
  const [customers, setCustomers] = useState<CustomerSearchResult[]>([])
  const [selectedCustomer, setSelectedCustomer] = useState<CustomerSearchResult | null>(null)
  const [history, setHistory] = useState<CustomerSaleHistory[]>([]) 
  const [loadingHistory, startHistoryTransition] = useTransition()

  const [employees, setEmployees] = useState<Employee[]>([])
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string>('')

  useEffect(() => {
    if (!isNaN(storeId)) {
        getEmployees(storeId).then(data => setEmployees(data));
    }
  }, [storeId]);

  useEffect(() => {
      if (query.length >= 3 && !selectedCustomer) {
          const timer = setTimeout(() => handleSearch(), 600);
          return () => clearTimeout(timer);
      }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [query]); 

  const handleClear = () => {
    setQuery('')
    setCustomers([])
    setSelectedCustomer(null)
    setHistory([])
    setSearchError(null)
  }

  const handleSearch = () => {
    if (query.length < 2) return
    setSearchError(null)
 
    startSearchTransition(async () => {
      const result = await searchCustomersByName(query, storeId)
      if (result.success && result.data) {
        setCustomers(result.data)
      } else {
        setSearchError(result.message || 'Erro ao buscar.')
      }
    })
  }

  const handleSelectCustomer = (customer: CustomerSearchResult) => {
    setSelectedCustomer(customer)
    setCustomers([])
    setQuery(customer.full_name)
    setSearchError(null)

    startHistoryTransition(async () => {
        const res = await getLastSalesForCustomer(storeId, customer.id)
        if (res.success && res.data) setHistory(res.data)
    })
  }

  // Chamado quando o Modal cria um cliente novo com sucesso
  const handleQuickSuccess = (newCustomer: Customer) => {
      const simpleCustomer: CustomerSearchResult = {
          id: newCustomer.id,
          full_name: newCustomer.full_name,
          cpf: newCustomer.cpf,
          fone_movel: newCustomer.fone_movel,
          obs_debito: newCustomer.obs_debito
      }
      handleSelectCustomer(simpleCustomer)
  }

  const handleStartVenda = () => {
    if (!selectedCustomer) return
    if (!selectedEmployeeId) {
        alert("Selecione o vendedor para continuar.")
        return
    }
    startCreateTransition(async () => {
      const result = await createNewVenda(selectedCustomer.id, parseInt(selectedEmployeeId))
      if (result.success && result.data) {
        router.push(`/dashboard/loja/${storeId}/vendas/${result.data.id}`)
      } else {
        alert(result.message || 'Erro ao criar venda.')
      }
    })
  }

  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-hidden">
        
        <div className="bg-white border-b border-gray-200 px-6 py-2 flex items-center shrink-0 shadow-sm z-30 h-10">
            <ShoppingCart className="h-4 w-4 text-gray-700 mr-2" />
            <span className="text-sm font-bold text-gray-800 uppercase tracking-wide">Atendimento</span>
        </div>

        <div className="bg-gradient-to-r from-blue-600 to-indigo-700 px-6 py-3 flex items-center gap-4 shrink-0 shadow-lg z-20">
            <h1 className="text-base font-bold text-white whitespace-nowrap flex-shrink-0">
                Selecione o cliente
            </h1>

            <div className="flex-1 max-w-lg relative">
                <div className="relative">
                    <input
                        type="text"
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        disabled={!!selectedCustomer}
                        className={`w-full h-10 rounded-xl border-0 pl-10 pr-10 shadow-md focus:ring-2 focus:ring-blue-300 text-gray-800 font-bold ${selectedCustomer ? 'bg-blue-50 text-blue-900' : 'bg-white'}`}
                        placeholder={selectedCustomer ? '' : "Busque por nome ou CPF..."}
                    />
                    <Search className={`absolute left-3 top-2.5 h-5 w-5 ${selectedCustomer ? 'text-blue-600' : 'text-gray-400'}`} />
                    
                    {selectedCustomer && (
                        <button onClick={handleClear} className="absolute right-2 top-2 p-1 hover:bg-blue-200 rounded-full text-blue-500">
                            <X className="h-4 w-4" />
                        </button>
                    )}
                    
                    {isSearching && !selectedCustomer && (
                        <Loader2 className="absolute right-3 top-2.5 h-5 w-5 text-blue-500 animate-spin" />
                    )}
                </div>

                {/* DROPDOWN DE RESULTADOS + BOT√ÉO NOVO CADASTRO */}
                {!selectedCustomer && (query.length >= 2 || customers.length > 0) && (
                    <div className="absolute top-full left-0 w-full mt-2 bg-white rounded-xl shadow-2xl border border-gray-100 overflow-hidden z-50 animate-in fade-in slide-in-from-top-2">
                        <div className="max-h-60 overflow-y-auto">
                            {customers.map((cust) => (
                                <button
                                    key={cust.id}
                                    onClick={() => handleSelectCustomer(cust)}
                                    className="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-50 last:border-0 flex justify-between items-center group transition-colors"
                                >
                                    <div>
                                        <p className="font-bold text-gray-800 text-sm group-hover:text-blue-700">{cust.full_name}</p>
                                        <p className="text-xs text-gray-500">CPF: {cust.cpf || 'N/A'}</p>
                                    </div>
                                    <PlusCircle className="h-5 w-5 text-gray-300 group-hover:text-blue-500" />
                                </button>
                            ))}
                            
                            {/* OP√á√ÉO FIXA: CADASTRAR NOVO */}
                            <button 
                                onClick={() => setIsQuickModalOpen(true)}
                                className="w-full text-left px-4 py-3 bg-blue-50 hover:bg-blue-100 text-blue-700 font-bold flex items-center gap-2 border-t border-blue-100"
                            >
                                <UserPlus className="h-5 w-5" />
                                <span>+ Cadastrar Novo: "{query}"</span>
                            </button>
                        </div>
                    </div>
                )}
            </div>

            <div className="flex items-center gap-3 ml-auto flex-shrink-0">
                <div className={`transition-opacity duration-300 ${selectedCustomer ? 'opacity-100' : 'opacity-50 pointer-events-none'}`}>
                    <div className="relative">
                        <Briefcase className="absolute left-3 top-2.5 h-5 w-5 text-white/70" />
                        <select 
                            value={selectedEmployeeId} 
                            onChange={(e) => setSelectedEmployeeId(e.target.value)}
                            className="w-40 h-10 pl-10 rounded-lg border-0 focus:ring-white focus:border-white/50 bg-white/20 text-white font-medium cursor-pointer placeholder-white/70"
                        >
                            <option value="" disabled className="text-gray-700">Vendedor</option>
                            {employees.map(emp => (
                                <option key={emp.id} value={emp.id} className="text-gray-800">{emp.full_name}</option>
                            ))}
                        </select>
                    </div>
                </div>

                <button
                    onClick={handleStartVenda}
                    disabled={!selectedCustomer || !selectedEmployeeId || isCreating}
                    className={`
                        flex items-center gap-2 px-6 py-2.5 rounded-lg font-bold text-sm shadow-lg transition-all transform active:scale-95 whitespace-nowrap
                        ${(!selectedCustomer || !selectedEmployeeId) 
                            ? 'bg-white/10 text-white/50 cursor-not-allowed shadow-none' 
                            : 'bg-green-500 hover:bg-green-400 text-white border border-green-400'
                        }
                    `}
                >
                    {isCreating ? <Loader2 className="h-5 w-5 animate-spin" /> : <CheckCircle2 className="h-5 w-5" />}
                    INICIAR NOVA VENDA
                </button>
            </div>
        </div>

        <div className="flex-1 overflow-y-auto p-6">
            {selectedCustomer ? (
                <div className="max-w-5xl mx-auto space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                    <div className="flex justify-between items-end border-b border-gray-300 pb-2">
                        <div>
                            <h2 className="text-3xl font-black text-gray-800">{selectedCustomer.full_name}</h2>
                            <p className="text-gray-500 text-sm">Hist√≥rico Recente</p>
                        </div>
                        {selectedCustomer.obs_debito && (
                            <span className="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 border border-red-200">
                                <AlertTriangle className="h-3 w-3" />
                                {selectedCustomer.obs_debito}
                            </span>
                        )}
                    </div>
                    {loadingHistory ? (
                        <div className="flex flex-col items-center justify-center h-40 space-y-2 text-gray-400">
                            <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
                            <p className="text-sm">Buscando hist√≥rico completo...</p>
                        </div>
                    ) : history.length === 0 ? (
                        <div className="bg-white rounded-2xl p-8 text-center border border-dashed border-gray-300 shadow-sm">
                            <div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-400">
                                <PlusCircle className="h-8 w-8" />
                            </div>
                            <h3 className="text-lg font-bold text-gray-700">Primeira Compra?</h3>
                            <p className="text-gray-500 text-sm mt-1">N√£o encontramos vendas anteriores para este cliente.</p>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest">√öltimas Vendas</h3>
                            {/* ATUALIZA√á√ÉO 3: Passando o obs_debito para o card */}
                            {history.map((item) => (
                                <HistoryCard key={item.venda_id} data={item} customerObs={selectedCustomer.obs_debito} />
                            ))}
                        </div>
                    )}
                </div>
            ) : (
                <div className="h-full flex flex-col items-center justify-center text-center opacity-50">
                    <div className="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-6">
                        <Search className="h-10 w-10 text-gray-400" />
                    </div>
                    <h2 className="text-2xl font-bold text-gray-600">Inicie um Atendimento</h2>
                    <p className="text-gray-500 mt-2 max-w-sm">
                        Busque o cliente acima para carregar o dossi√™ financeiro e t√©cnico antes de abrir a venda.
                    </p>
                </div>
            )}
        </div>

        {/* Modal de Cadastro R√°pido */}
        <QuickCustomerModal 
            isOpen={isQuickModalOpen} 
            onClose={() => setIsQuickModalOpen(false)} 
            storeId={storeId} 
            initialName={query}
            onSuccess={handleQuickSuccess}
        />
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\cadastros\page.tsx
==================================================
// Caminho: src/app/dashboard/loja/[storeId]/cadastros/page.tsx
'use client';

import { useState, useEffect, useTransition } from 'react';
import Link from 'next/link';
import { useParams } from 'next/navigation';
import { 
  Search, Plus, Save, Trash2, Loader2, UploadCloud,
  Glasses, Eye, Sparkles, Stethoscope, ShoppingBag, ScanBarcode, 
  ArrowRightLeft, Lock, Truck, ChevronRight
} from 'lucide-react';
import { 
  fetchCatalogItems, 
  saveLente, saveArmacao, saveTratamento, saveOftalmo, saveProdutoGeral, saveSupplier, // <--- Import Novo
  deleteCatalogItem,
  fetchCategoriasProdutos,
  type CatalogItemResult,
  type CatalogActionResult 
} from '@/lib/actions/catalog.actions';

// --- CONFIGURA√á√ÉO DE ESTILO (DESIGN SYSTEM) ---
const labelStyle = "block text-[9px] font-bold text-slate-700 uppercase mb-0.5 tracking-wider";
const inputStyle = "block w-full rounded-md border border-slate-300 bg-white shadow-sm text-slate-900 h-8 text-xs px-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-bold placeholder:font-normal placeholder:text-slate-400 disabled:bg-slate-100 disabled:text-slate-500 transition-all";
const cardStyle = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-3";

type CategoryType = 'armacoes' | 'lentes' | 'tratamentos' | 'oftalmologistas' | 'fornecedores' | 'produtos_gerais';

export default function CatalogPage() {
  const params = useParams();
  const storeId = parseInt(params.storeId as string, 10);

  // --- Estados ---
  const [activeTab, setActiveTab] = useState<CategoryType>('armacoes'); // Padr√£o solicitado
  const [items, setItems] = useState<CatalogItemResult[]>([]);
  const [selectedId, setSelectedId] = useState<number | null>(null); // null = Novo
  const [search, setSearch] = useState('');
  
  const [loadingList, setLoadingList] = useState(false);
  const [isSaving, startTransition] = useTransition();
  
  // Dados do Formul√°rio (Gen√©rico)
  const [formData, setFormData] = useState<any>({});
  
  // Sugest√µes para Autocomplete (Produtos Gerais)
  const [sugestoesCategorias, setSugestoesCategorias] = useState<string[]>([]);

  // --- Carregar Lista ---
  useEffect(() => {
    const loadItems = async () => {
      setLoadingList(true);
      // @ts-ignore - Ignora erro de tipo tempor√°rio pois 'fornecedores' ainda n√£o est√° na assinatura da action original
      const data = await fetchCatalogItems(storeId, activeTab, search);
      setItems(data);
      setLoadingList(false);
    };
    const timer = setTimeout(loadItems, 300);
    return () => clearTimeout(timer);
  }, [storeId, activeTab, search]);

  // --- Carregar Categorias ---
  useEffect(() => {
      if (activeTab === 'produtos_gerais') {
          fetchCategoriasProdutos(storeId).then(cats => setSugestoesCategorias(cats));
      }
  }, [storeId, activeTab]);

  // --- Handlers ---
  const handleTabChange = (tab: CategoryType) => {
    setActiveTab(tab);
    setSearch('');
    handleNew(); 
  };

  const handleSelect = (item: CatalogItemResult) => {
    setSelectedId(item.id);
    setFormData(item.raw);
  };

  const handleNew = () => {
    setSelectedId(null);
    setFormData({});
  };

  const handleInputChange = (field: string, value: any) => {
    setFormData((prev: any) => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    const formPayload = new FormData();
    if (selectedId) formPayload.append('id', selectedId.toString());
    
    Object.keys(formData).forEach(key => {
      if (formData[key] !== null && formData[key] !== undefined) {
        formPayload.append(key, formData[key].toString());
      }
    });

startTransition(async () => {
      let result: CatalogActionResult;
      
      switch (activeTab) {
        case 'lentes': result = await saveLente({ success: false, message: '' }, formPayload); break;
        case 'armacoes': result = await saveArmacao({ success: false, message: '' }, formPayload); break;
        case 'tratamentos': result = await saveTratamento({ success: false, message: '' }, formPayload); break;
        case 'oftalmologistas': result = await saveOftalmo({ success: false, message: '' }, formPayload); break;
        case 'produtos_gerais': result = await saveProdutoGeral({ success: false, message: '' }, formPayload); break; 
        
        // NOVO CASE CONECTADO
        case 'fornecedores': result = await saveSupplier({ success: false, message: '' }, formPayload); break;
        
        default: result = { success: false, message: 'Erro interno' };
      }
      
      if (result.success) {
        if (result.generatedCode) {
            alert(`${result.message}\n\nC√ìDIGO GERADO: ${result.generatedCode}`);
        } else {
            alert(result.message);
        }
        
        // @ts-ignore
        const data = await fetchCatalogItems(storeId, activeTab, search);
        setItems(data);
        handleNew();
        
        if (activeTab === 'produtos_gerais') {
            fetchCategoriasProdutos(storeId).then(setSugestoesCategorias);
        }
      } else {
        if (activeTab !== 'fornecedores') alert(`Erro: ${result.message}`);
      }
    });
  };
   
  const handleDelete = async () => {
    if (!selectedId) return;
    if (!confirm('Tem certeza que deseja excluir este item?')) return;

    startTransition(async () => {
      // @ts-ignore
      const result = await deleteCatalogItem(selectedId, storeId, activeTab);
      if (result.success) {
        // @ts-ignore
        const data = await fetchCatalogItems(storeId, activeTab, search);
        setItems(data);
        handleNew();
      } else {
        alert(result.message);
      }
    });
  };

  return (
    <div className="flex h-[calc(100vh-64px)] overflow-hidden bg-slate-100">
      
      {/* --- COLUNA ESQUERDA (30%) --- */}
      <div className="w-1/3 flex flex-col border-r border-slate-200 bg-white z-10 shadow-sm">
        
        {/* Header Gradiente */}
        <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-4 flex flex-col gap-3 shadow-md z-20">
             <div className="flex justify-between items-center text-white">
                <h2 className="font-bold text-sm flex items-center gap-2 uppercase tracking-wide">
                    <ScanBarcode className="h-4 w-4" /> Cat√°logo
                </h2>
                <div className="flex gap-2">
                    {activeTab === 'lentes' && (
                        <Link
                            href={`/dashboard/loja/${storeId}/cadastros/importar-lentes`}
                            className="bg-white/20 hover:bg-white/30 text-white px-2 py-1 rounded text-[10px] font-bold flex items-center gap-1 transition-colors"
                            title="Importar Lentes via CSV"
                        >
                            <UploadCloud className="h-3 w-3" /> Importar
                        </Link>
                    )}
                    <span className="text-[10px] bg-white/20 px-2 py-1 rounded-full font-medium">
                        {items.length} itens
                    </span>
                </div>
             </div>
             <div className="relative">
                <input 
                    type="text" 
                    className="w-full h-9 pl-9 pr-3 rounded-lg border-0 bg-white shadow-lg text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-300 font-bold text-xs"
                    placeholder="Buscar item..."
                    value={search}
                    onChange={e => setSearch(e.target.value)}
                />
                <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-slate-400" />
             </div>
        </div>

        {/* Lista */}
        <div className="flex-1 overflow-y-auto">
            {loadingList ? (
              <div className="flex justify-center p-6"><Loader2 className="animate-spin text-blue-500 h-6 w-6"/></div>
            ) : items.length === 0 ? (
              <p className="text-center text-slate-400 text-xs p-6">Nenhum item encontrado.</p>
            ) : (
              items.map(item => (
                <div 
                  key={item.id}
                  onClick={() => handleSelect(item)}
                  className={`p-3 border-b border-slate-100 cursor-pointer transition-colors flex justify-between items-center group
                      ${selectedId === item.id ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'hover:bg-slate-50 border-l-4 border-l-transparent'}
                  `}
                >
                  <div className="min-w-0 flex-1">
                    <div className="flex justify-between items-start">
                        <span className={`font-bold text-xs truncate pr-2 ${selectedId === item.id ? 'text-blue-700' : 'text-slate-700'}`}>{item.title}</span>
                        {item.price !== undefined && (
                          <span className="text-[10px] font-bold text-green-700 bg-green-50 px-1.5 rounded border border-green-100 whitespace-nowrap">
                            R$ {item.price?.toFixed(2)}
                          </span>
                        )}
                    </div>
                    <div className="flex justify-between items-end mt-1">
                        <span className="text-[10px] text-slate-400 truncate max-w-[150px]">{item.subtitle || '-'}</span>
                        {item.stock !== undefined && (
                          <span className={`text-[9px] font-bold px-1.5 rounded ${item.stock > 0 ? 'bg-slate-100 text-slate-600' : 'bg-red-100 text-red-600'}`}>
                            Est: {item.stock}
                          </span>
                        )}
                    </div>
                  </div>
                  <ChevronRight className={`h-3 w-3 ml-2 text-slate-300 group-hover:text-blue-400 ${selectedId === item.id ? 'text-blue-500' : ''}`} />
                </div>
              ))
            )}
        </div>
      </div>

      {/* --- COLUNA DIREITA (70%) --- */}
      <div className="flex-1 flex flex-col bg-slate-50/50 relative overflow-hidden">
        
        {/* Abas */}
        <div className="bg-white border-b border-slate-200 px-4 pt-3 flex gap-4 shadow-sm flex-shrink-0 overflow-x-auto">
            <TabButton 
              label="Arma√ß√µes" icon={Eye} 
              active={activeTab === 'armacoes'} onClick={() => handleTabChange('armacoes')} 
            />
            <TabButton 
              label="Lentes" icon={Glasses} 
              active={activeTab === 'lentes'} onClick={() => handleTabChange('lentes')} 
            />
            <TabButton 
              label="Tratamentos" icon={Sparkles} 
              active={activeTab === 'tratamentos'} onClick={() => handleTabChange('tratamentos')} 
            />
            <TabButton 
              label="Oftalmologistas" icon={Stethoscope} 
              active={activeTab === 'oftalmologistas'} onClick={() => handleTabChange('oftalmologistas')} 
            />
            <TabButton 
              label="Fornecedores" icon={Truck} 
              active={activeTab === 'fornecedores'} onClick={() => handleTabChange('fornecedores')} 
            />
            <TabButton 
              label="Varejo / Outros" icon={ShoppingBag} 
              active={activeTab === 'produtos_gerais'} onClick={() => handleTabChange('produtos_gerais')} 
            />
        </div>

        {/* Formul√°rio */}
        <form id="catalog-form" onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div className="max-w-4xl mx-auto">
                <div className={cardStyle}>
                    {activeTab === 'lentes' && (
                        <FormLentes data={formData} onChange={handleInputChange} disabled={isSaving} />
                    )}
                    {activeTab === 'armacoes' && (
                        <FormArmacoes data={formData} onChange={handleInputChange} disabled={isSaving} storeId={storeId} />
                    )}
                    {activeTab === 'produtos_gerais' && (
                        <FormProdutosGerais 
                            data={formData} 
                            onChange={handleInputChange} 
                            disabled={isSaving}
                            sugestoes={sugestoesCategorias}
                            storeId={storeId}
                        />
                    )}
                    {activeTab === 'tratamentos' && (
                        <FormTratamentos data={formData} onChange={handleInputChange} disabled={isSaving} />
                    )}
                    {activeTab === 'oftalmologistas' && (
                        <FormOftalmos data={formData} onChange={handleInputChange} disabled={isSaving} />
                    )}
                    {activeTab === 'fornecedores' && (
                        <FormFornecedores data={formData} onChange={handleInputChange} disabled={isSaving} />
                    )}
                </div>
            </div>
        </form>

        {/* Rodap√© Fixo */}
        <div className="bg-white border-t border-slate-200 p-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] flex justify-end gap-2 z-20 shrink-0">
             <button 
                type="button"
                onClick={handleNew}
                className="px-4 py-2 text-xs font-bold text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2"
             >
                <Plus className="h-4 w-4" /> Novo
             </button>
             
             {selectedId && (
                <button 
                    type="button"
                    onClick={handleDelete}
                    disabled={isSaving}
                    className="px-4 py-2 text-xs font-bold text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg transition-colors flex items-center gap-2"
                >
                    <Trash2 className="h-4 w-4" /> Excluir
                </button>
             )}

             <button 
                type="submit" 
                form="catalog-form"
                disabled={isSaving}
                className="px-6 py-2 text-xs font-bold text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-md transition-transform active:scale-95 flex items-center gap-2"
             >
                {isSaving ? <Loader2 className="animate-spin h-4 w-4" /> : <Save className="h-4 w-4" />}
                SALVAR
             </button>
        </div>

      </div>
    </div>
  );
}

// --- Componentes Auxiliares ---

function TabButton({ label, icon: Icon, active, onClick }: any) {
  return (
    <button
      type="button"
      onClick={onClick}
      className={`flex items-center gap-2 pb-3 text-xs font-bold uppercase tracking-wider transition-all border-b-2 whitespace-nowrap ${
        active 
          ? 'text-blue-600 border-blue-600' 
          : 'text-slate-400 border-transparent hover:text-slate-600'
      }`}
    >
      <Icon className={`h-4 w-4 ${active ? 'text-blue-600' : 'text-slate-400'}`} /> {label}
    </button>
  );
}

// --- CAMPO DE ESTOQUE INTELIGENTE ---
function EstoqueInput({ value, onChange, disabled, isEditing, storeId }: any) {
    return (
        <div className="relative">
            <input 
                type="number" 
                value={value || 0} 
                onChange={onChange} 
                className={`${inputStyle} ${isEditing ? 'bg-slate-100 pr-9 text-slate-500 cursor-not-allowed' : ''}`} 
                disabled={disabled || isEditing} 
            />
            {isEditing && (
                <div className="absolute top-0 right-0 h-full flex items-center pr-1">
                     <Link 
                        href={`/dashboard/loja/${storeId}/estoque/movimentacoes`} 
                        title="Ir para Movimenta√ß√µes"
                        className="bg-amber-100 hover:bg-amber-200 text-amber-700 p-1 rounded transition-colors"
                    >
                        <ArrowRightLeft className="h-3 w-3" />
                     </Link>
                </div>
            )}
            {isEditing && (
                <p className="text-[9px] text-amber-600 mt-0.5 flex items-center gap-1 font-bold">
                    <Lock className="h-3 w-3"/> Gerencie em Movimenta√ß√µes
                </p>
            )}
        </div>
    )
}

// --- FORMUL√ÅRIOS ESPEC√çFICOS ---

function FormProdutosGerais({ data, onChange, disabled, sugestoes, storeId }: any) {
    const isEditing = !!data.id;
    return (
      <div className="grid grid-cols-12 gap-3 gap-y-4">
        <div className="col-span-6">
            <label className={labelStyle}>Categoria *</label>
            <input type="text" required list="sugestoes-cat" value={data.categoria || ''} onChange={e => onChange('categoria', e.target.value)} className={inputStyle} disabled={disabled} placeholder="Ex: Rel√≥gio, Acess√≥rio..."/>
            <datalist id="sugestoes-cat">{sugestoes?.map((s: string) => <option key={s} value={s} />)}</datalist>
        </div>
        <div className="col-span-6">
            <label className={labelStyle}>C√≥digo de Barras</label>
            <input type="text" value={data.codigo_barras || ''} onChange={e => onChange('codigo_barras', e.target.value)} className={`${inputStyle} bg-blue-50 border-blue-200 text-blue-900`} disabled={disabled} placeholder="Vazio = Autom√°tico"/>
        </div>
        <div className="col-span-8">
            <label className={labelStyle}>Descri√ß√£o do Produto *</label>
            <input type="text" required value={data.descricao || ''} onChange={e => onChange('descricao', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
        <div className="col-span-4">
            <label className={labelStyle}>Marca</label>
            <input type="text" value={data.marca || ''} onChange={e => onChange('marca', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
       
        <div className="col-span-12 border-t border-slate-100 my-1"></div>

        <div className="col-span-3">
            <label className={labelStyle}>Pre√ßo Custo (R$)</label>
            <input type="number" step="0.01" value={data.preco_custo || ''} onChange={e => onChange('preco_custo', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
        <div className="col-span-3">
            <label className={`${labelStyle} text-green-700`}>Pre√ßo Venda (R$) *</label>
            <input type="number" step="0.01" required value={data.preco_venda || ''} onChange={e => onChange('preco_venda', e.target.value)} className={`${inputStyle} border-green-300 bg-green-50 text-green-900`} disabled={disabled} />
        </div>
        <div className="col-span-3">
            <label className={labelStyle}>Estoque Atual</label>
            <EstoqueInput value={data.estoque_atual} onChange={(e: any) => onChange('estoque_atual', e.target.value)} disabled={disabled} isEditing={isEditing} storeId={storeId} />
        </div>
        <div className="col-span-3">
            <label className={labelStyle}>Estoque M√≠nimo</label>
            <input type="number" value={data.estoque_minimo || 1} onChange={e => onChange('estoque_minimo', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
      </div>
    );
}

function FormArmacoes({ data, onChange, disabled, storeId }: any) {
  const isEditing = !!data.id;
  return (
    <div className="grid grid-cols-12 gap-3 gap-y-4">
      <div className="col-span-12 bg-blue-50 p-3 rounded border border-blue-100 flex items-center gap-4">
         <div className="flex-1">
            <label className={`${labelStyle} text-blue-800`}>C√≥digo de Barras (EAN)</label>
            <div className="flex gap-2 items-center">
                 <ScanBarcode className="h-4 w-4 text-blue-500" />
                 <input type="text" value={data.codigo_barras || ''} onChange={e => onChange('codigo_barras', e.target.value)} className={`${inputStyle} border-blue-200 text-blue-900 bg-white`} disabled={disabled} placeholder="Vazio = Gerar Autom√°tico"/>
            </div>
         </div>
      </div>
      <div className="col-span-6">
        <label className={labelStyle}>Marca *</label>
        <input type="text" required value={data.marca || ''} onChange={e => onChange('marca', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-6">
        <label className={labelStyle}>Modelo</label>
        <input type="text" value={data.modelo || ''} onChange={e => onChange('modelo', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-4">
        <label className={labelStyle}>Refer√™ncia</label>
        <input type="text" value={data.referencia || ''} onChange={e => onChange('referencia', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-4">
        <label className={labelStyle}>Cor</label>
        <input type="text" value={data.cor || ''} onChange={e => onChange('cor', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-4">
        <label className={labelStyle}>Estoque Atual</label>
        <EstoqueInput value={data.quantidade_estoque} onChange={(e: any) => onChange('quantidade_estoque', e.target.value)} disabled={disabled} isEditing={isEditing} storeId={storeId} />
      </div>

      <div className="col-span-12 border-t border-slate-100 my-1 pt-2">
          <p className="text-[9px] font-bold text-slate-400 uppercase mb-2">Medidas T√©cnicas</p>
          <div className="grid grid-cols-3 gap-3">
            <div>
                <label className={labelStyle}>Aro</label>
                <input type="text" value={data.tamanho_aro || ''} onChange={e => onChange('tamanho_aro', e.target.value)} className={inputStyle} disabled={disabled} />
            </div>
            <div>
                <label className={labelStyle}>Ponte</label>
                <input type="text" value={data.tamanho_ponte || ''} onChange={e => onChange('tamanho_ponte', e.target.value)} className={inputStyle} disabled={disabled} />
            </div>
            <div>
                <label className={labelStyle}>Haste</label>
                <input type="text" value={data.tamanho_haste || ''} onChange={e => onChange('tamanho_haste', e.target.value)} className={inputStyle} disabled={disabled} />
            </div>
          </div>
      </div>

      <div className="col-span-12 border-t border-slate-100 my-1"></div>
      <div className="col-span-6">
        <label className={labelStyle}>Pre√ßo de Custo (R$)</label>
        <input type="number" step="0.01" value={data.preco_custo || ''} onChange={e => onChange('preco_custo', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-6">
        <label className={`${labelStyle} text-green-700`}>Pre√ßo de Venda (R$) *</label>
        <input type="number" step="0.01" required value={data.preco_venda || ''} onChange={e => onChange('preco_venda', e.target.value)} className={`${inputStyle} border-green-300 bg-green-50 text-green-900`} disabled={disabled} />
      </div>
    </div>
  );
}

function FormLentes({ data, onChange, disabled }: any) {
  return (
    <div className="grid grid-cols-2 gap-3 gap-y-4">
      <div className="col-span-2">
        <label className={labelStyle}>Nome da Lente *</label>
        <input type="text" required value={data.nome_lente || ''} onChange={e => onChange('nome_lente', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div>
        <label className={labelStyle}>Marca / Fabricante</label>
        <input type="text" value={data.marca || ''} onChange={e => onChange('marca', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div>
        <label className={labelStyle}>Material</label>
        <input type="text" value={data.material || ''} onChange={e => onChange('material', e.target.value)} className={inputStyle} disabled={disabled} placeholder="Ex: Policarbonato" />
      </div>
      <div>
         <label className={labelStyle}>Tipo / Desenho</label>
        <input type="text" value={data.tipo || ''} onChange={e => onChange('tipo', e.target.value)} className={inputStyle} disabled={disabled} placeholder="Ex: Multifocal" />
      </div>
      <div>
        <label className={labelStyle}>√çndice de Refra√ß√£o</label>
        <input type="text" value={data.indice_refracao || ''} onChange={e => onChange('indice_refracao', e.target.value)} className={inputStyle} disabled={disabled} placeholder="Ex: 1.59" />
      </div>
      <div className="border-t border-slate-100 col-span-2 my-1"></div>
      <div>
        <label className={labelStyle}>Pre√ßo de Custo (R$)</label>
        <input type="number" step="0.01" value={data.preco_custo || ''} onChange={e => onChange('preco_custo', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div>
        <label className={`${labelStyle} text-green-700`}>Pre√ßo de Venda (R$) *</label>
        <input type="number" step="0.01" required value={data.preco_venda || ''} onChange={e => onChange('preco_venda', e.target.value)} className={`${inputStyle} border-green-300 bg-green-50 text-green-900`} disabled={disabled} />
      </div>
    </div>
  );
}

function FormTratamentos({ data, onChange, disabled }: any) {
  return (
    <div className="grid grid-cols-1 gap-4">
      <div>
        <label className={labelStyle}>Nome do Tratamento *</label>
        <input type="text" required value={data.nome_tratamento || ''} onChange={e => onChange('nome_tratamento', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div>
        <label className={labelStyle}>Descri√ß√£o / Detalhes</label>
        <textarea rows={3} value={data.descricao || ''} onChange={e => onChange('descricao', e.target.value)} className="block w-full rounded-md border border-slate-300 shadow-sm text-slate-900 text-xs p-2 resize-none focus:ring-blue-500 focus:border-blue-500 font-bold" disabled={disabled} />
      </div>
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className={labelStyle}>Custo Adicional (R$)</label>
          <input type="number" step="0.01" value={data.preco_custo_adicional || ''} onChange={e => onChange('preco_custo_adicional', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
        <div>
          <label className={`${labelStyle} text-green-700`}>Venda Adicional (R$) *</label>
          <input type="number" step="0.01" required value={data.preco_venda_adicional || ''} onChange={e => onChange('preco_venda_adicional', e.target.value)} className={`${inputStyle} border-green-300 bg-green-50 text-green-900`} disabled={disabled} />
        </div>
      </div>
    </div>
  );
}

function FormOftalmos({ data, onChange, disabled }: any) {
  return (
    <div className="grid grid-cols-12 gap-3 gap-y-4">
      <div className="col-span-8">
        <label className={labelStyle}>Nome do M√©dico *</label>
        <input type="text" required value={data.nome_completo || ''} onChange={e => onChange('nome_completo', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-4">
        <label className={labelStyle}>CRM</label>
        <input type="text" value={data.crm || ''} onChange={e => onChange('crm', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-6">
        <label className={labelStyle}>Telefone</label>
        <input type="text" value={data.telefone || ''} onChange={e => onChange('telefone', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-6">
        <label className={labelStyle}>E-mail</label>
        <input type="email" value={data.email || ''} onChange={e => onChange('email', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
      <div className="col-span-12">
        <label className={labelStyle}>Cl√≠nica / Local de Atendimento</label>
        <input type="text" value={data.clinica || ''} onChange={e => onChange('clinica', e.target.value)} className={inputStyle} disabled={disabled} />
      </div>
    </div>
  );
}

// --- NOVO FORMUL√ÅRIO: FORNECEDORES ---
function FormFornecedores({ data, onChange, disabled }: any) {
    return (
      <div className="grid grid-cols-12 gap-3 gap-y-4">
        <div className="col-span-12 bg-amber-50 p-3 rounded border border-amber-100 mb-2">
             <p className="text-xs text-amber-800 font-bold flex items-center gap-2">
                 <Truck className="h-4 w-4" /> Dados Cadastrais da Empresa
             </p>
        </div>
        <div className="col-span-6">
          <label className={labelStyle}>Nome Fantasia *</label>
          <input type="text" required value={data.nome_fantasia || ''} onChange={e => onChange('nome_fantasia', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
        <div className="col-span-6">
          <label className={labelStyle}>Raz√£o Social</label>
          <input type="text" value={data.razao_social || ''} onChange={e => onChange('razao_social', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
        
        {/* LINHA TRIPLA: CNPJ | IE | TELEFONE */}
        <div className="col-span-4">
          <label className={labelStyle}>CNPJ</label>
          <input type="text" value={data.cnpj || ''} onChange={e => onChange('cnpj', e.target.value)} className={inputStyle} disabled={disabled} placeholder="00.000.000/0000-00" />
        </div>
        <div className="col-span-4">
          <label className={labelStyle}>Inscri√ß√£o Estadual</label>
          <input type="text" value={data.inscricao_estadual || ''} onChange={e => onChange('inscricao_estadual', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
        <div className="col-span-4">
          <label className={labelStyle}>Telefone / Contato</label>
          <input type="text" value={data.telefone || ''} onChange={e => onChange('telefone', e.target.value)} className={inputStyle} disabled={disabled} placeholder="(00) 0000-0000" />
        </div>

        <div className="col-span-8">
          <label className={labelStyle}>Cidade</label>
          <input type="text" value={data.cidade || ''} onChange={e => onChange('cidade', e.target.value)} className={inputStyle} disabled={disabled} />
        </div>
        <div className="col-span-4">
          <label className={labelStyle}>UF</label>
          <input type="text" value={data.uf || ''} onChange={e => onChange('uf', e.target.value)} className={inputStyle} disabled={disabled} maxLength={2} />
        </div>
      </div>
    );
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\cadastros\importar-lentes\page.tsx
==================================================
import ImportacaoLentesInterface from '@/components/cadastros/ImportacaoLentesInterface'

export default function ImportarLentesPage({ params }: { params: { storeId: string } }) {
    const storeId = parseInt(params.storeId, 10)
    
    return (
        <div className="h-[calc(100vh-64px)] p-6 bg-gray-100">
            <div className="max-w-5xl mx-auto h-full">
                <ImportacaoLentesInterface storeId={storeId} />
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\clientes\page.tsx
==================================================
// ARQUIVO: src/app/dashboard/loja/[storeId]/clientes/page.tsx
'use client';

import { useState, useEffect, useRef, useTransition } from 'react';
import { useParams, useRouter, useSearchParams } from 'next/navigation';
import { 
  Loader2, Save, Trash2, Search, X,
  ArrowLeftToLine, ArrowRightToLine, ChevronLeft, ChevronRight, 
  User, ClipboardList, ScrollText, Users2, UserPlus, Calendar, Pencil, 
  AlertTriangle, CheckCircle2, Briefcase
} from 'lucide-react';
import { Database } from '@/lib/database.types';
import { saveCustomerDetails, deleteCustomer } from '@/lib/actions/customer.actions';
import { searchCustomersByName, getCustomerById, fetchDefaultCustomers } from '@/lib/actions/vendas.actions';
import { getDependentes, deleteDependente, saveDependente } from '@/lib/actions/dependents.actions';

type Customer = Database['public']['Tables']['customers']['Row'];
type Dependente = Database['public']['Tables']['dependentes']['Row'];
type ActiveTab = 'principal' | 'detalhes' | 'referencias' | 'dependentes'; 

// --- HELPERS ---
const validaCPF = (strCPF: string) => {
    if (!strCPF) return true;
    const cpf = strCPF.replace(/[^\d]+/g, '');
    if (cpf == '') return true;
    if (cpf.length != 11 || /^(\d)\1+$/.test(cpf)) return false;
    let add = 0;
    for (let i = 0; i < 9; i++) add += parseInt(cpf.charAt(i)) * (10 - i);
    let rev = 11 - (add % 11);
    if (rev == 10 || rev == 11) rev = 0;
    if (rev != parseInt(cpf.charAt(9))) return false;
    add = 0;
    for (let i = 0; i < 10; i++) add += parseInt(cpf.charAt(i)) * (11 - i);
    rev = 11 - (add % 11);
    if (rev == 10 || rev == 11) rev = 0;
    if (rev != parseInt(cpf.charAt(10))) return false;
    return true;
};
const formatDate = (dateString: string | null | undefined) => { try { return dateString?.split('T')[0] || ''; } catch (e) { return ''; } };
const formatDateTime = (dateString: string | null | undefined) => { try { return dateString ? new Date(dateString).toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR'); } catch (e) { return 'Data inv√°lida'; } };
const maskCPF = (value: string) => value.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2').substring(0, 14);
const maskPhone = (value: string) => value.replace(/\D/g, '').replace(/^(\d{2})(\d)/g, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').substring(0, 15);
const formatRenda = (value: string) => { let v = value.replace(/\D/g, ''); if (!v) return '0,00'; let i = v.slice(0, -2); let d = v.slice(-2); if (i.length > 3) i = i.replace(/\B(?=(\d{3})+(?!\d))/g, "."); return `${i || '0'},${d}`; };

// --- DESIGN SYSTEM COMPACTO (ALTO CONTRASTE) ---
// Label mais escuro
const labelStyle = "block text-[9px] font-bold text-slate-700 uppercase mb-0.5 tracking-wider";
// Input branco com borda vis√≠vel
const inputStyle = "block w-full rounded-md border border-slate-300 bg-white shadow-sm text-slate-900 h-8 text-xs px-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-bold placeholder:font-normal placeholder:text-slate-400 disabled:bg-slate-100 disabled:text-slate-500 transition-all";
// Card branco
const cardStyle = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-3";

export default function StoreClientPage() {
  const params = useParams();
  const router = useRouter(); 
  const searchParams = useSearchParams(); 
  const urlClientId = searchParams.get('id'); 

  const storeId = parseInt(params.storeId as string, 10);

  const [loading, setLoading] = useState(true);
  const [isSaving, startSaveTransition] = useTransition();
  const [isDeleting, startDeleteTransition] = useTransition(); 
  const [customers, setCustomers] = useState<Customer[]>([]); 
  const [currentIndex, setCurrentIndex] = useState(-1);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<ActiveTab>('principal');

  const [dependentesList, setDependentesList] = useState<Dependente[]>([]);

  // Busca integrada na lista lateral
  const [searchQuery, setSearchQuery] = useState('');
  const [isSearching, startSearchTransition] = useTransition();

  // Formul√°rio Principal
  const [fullName, setFullName] = useState('');
  const [rg, setRg] = useState('');
  const [cpf, setCpf] = useState('');
  const [isCpfValid, setIsCpfValid] = useState(true);
  const [birthDate, setBirthDate] = useState('');
  const [naturalidade, setNaturalidade] = useState('');
  const [estadoCivil, setEstadoCivil] = useState('');
  const [pai, setPai] = useState('');
  const [mae, setMae] = useState('');
  const [conjugeNome, setConjugeNome] = useState('');
  const [conjugeNascimento, setConjugeNascimento] = useState('');
  const [conjugeNaturalidade, setConjugeNaturalidade] = useState('');
  const [conjugeTrabalho, setConjugeTrabalho] = useState('');
  const [conjugeFone, setConjugeFone] = useState('');
  const [rua, setRua] = useState('');
  const [numero, setNumero] = useState('');
  const [bairro, setBairro] = useState('');
  const [complemento, setComplemento] = useState('');
  const [cidade, setCidade] = useState('');
  const [uf, setUf] = useState('');
  const [cep, setCep] = useState('');
  const [phone, setPhone] = useState('');
  const [foneMovel, setFoneMovel] = useState(''); 
  const [email, setEmail] = useState('');
  const [comercialTrabalho, setComercialTrabalho] = useState('');
  const [comercialCargo, setComercialCargo] = useState('');
  const [comercialEndereco, setComercialEndereco] = useState('');
  const [comercialFone, setComercialFone] = useState(''); 
  const [comercialRenda, setComercialRenda] = useState('');
  const [obsComercial, setObsComercial] = useState('');
  const [refComercio1, setRefComercio1] = useState('');
  const [refComercio2, setRefComercio2] = useState('');
  const [refPessoal1, setRefPessoal1] = useState('');
  const [refPessoal2, setRefPessoal2] = useState('');
  const [obsGeral, setObsGeral] = useState(''); 
  const [faixaEtaria, setFaixaEtaria] = useState('');
  const [createdAt, setCreatedAt] = useState(new Date().toLocaleDateString('pt-BR'));

  const currentCustomer = (currentIndex >= 0 && currentIndex < customers.length) ? customers[currentIndex] : undefined;
  const isDepTab = activeTab === 'dependentes'; 

  // --- CARGA INICIAL ---
  const reloadDefaultList = async () => {
      if (isNaN(storeId)) return;
      setLoading(true);
      try {
          if (urlClientId) {
              const result = await getCustomerById(parseInt(urlClientId));
              if (result.success && result.data) {
                  setCustomers([result.data]); 
                  setCurrentIndex(0); 
              } else {
                  const listResult = await fetchDefaultCustomers(storeId);
                  if (listResult.success && listResult.data) {
                      setCustomers(listResult.data as Customer[]);
                      setCurrentIndex(listResult.data.length > 0 ? 0 : -1);
                  }
              }
          } else {
              const result = await fetchDefaultCustomers(storeId);
              if (result.success && result.data) {
                  const lista = result.data as Customer[];
                  setCustomers(lista);
                  if (!currentCustomer && lista.length > 0) setCurrentIndex(0); 
                  else if (lista.length === 0) setCurrentIndex(-1);
              }
          }
      } catch (error) { console.error("Erro cr√≠tico:", error); } 
      finally { setLoading(false); }
  };

  useEffect(() => { reloadDefaultList(); }, [storeId]);

  // --- BUSCA LATERAL (FILTRO) ---
  useEffect(() => {
      if (searchQuery.length < 2) {
          if (searchQuery.length === 0 && customers.length < 20) reloadDefaultList(); 
          return;
      }
      
      const timer = setTimeout(() => {
          startSearchTransition(async () => {
              const res = await searchCustomersByName(searchQuery, storeId);
              if (res.success && res.data) {
                  const fullCustomers = res.data.map(c => ({ ...c } as any));
                  setCustomers(fullCustomers);
              }
          });
      }, 500);
      return () => clearTimeout(timer);
  }, [searchQuery]);

  // --- POPULA FORMUL√ÅRIO ---
  useEffect(() => {
    if (!currentCustomer) { setDependentesList([]); }
    setCreatedAt(formatDateTime(currentCustomer?.created_at));
    setErrorMessage(null);
    
    if (currentCustomer?.id) { getDependentes(currentCustomer.id).then(data => setDependentesList(data)); } 
    else { setDependentesList([]); }

    setFullName(currentCustomer?.full_name ?? '');
    setRg(currentCustomer?.rg ?? '');
    const dbCpf = maskCPF(currentCustomer?.cpf ?? '');
    setCpf(dbCpf);
    setIsCpfValid(validaCPF(dbCpf));
    setBirthDate(formatDate(currentCustomer?.birth_date));
    setNaturalidade(currentCustomer?.naturalidade ?? '');
    setEstadoCivil(currentCustomer?.estado_civil ?? '');
    setPai(currentCustomer?.pai ?? '');
    setMae(currentCustomer?.mae ?? '');
    setConjugeNome(currentCustomer?.conjuge_nome ?? '');
    setConjugeNascimento(formatDate(currentCustomer?.conjuge_nascimento));
    setConjugeNaturalidade(currentCustomer?.conjuge_naturalidade ?? '');
    setConjugeTrabalho(currentCustomer?.conjuge_trabalho ?? '');
    setConjugeFone(maskPhone(currentCustomer?.conjuge_fone ?? ''));
    setRua(currentCustomer?.rua ?? '');
    setNumero(currentCustomer?.numero ?? '');
    setBairro(currentCustomer?.bairro ?? '');
    setComplemento(currentCustomer?.complemento ?? '');
    setCidade(currentCustomer?.cidade ?? '');
    setUf(currentCustomer?.uf ?? '');
    setCep(currentCustomer?.cep ?? '');
    setPhone(maskPhone(currentCustomer?.phone ?? '')); 
    setFoneMovel(maskPhone(currentCustomer?.fone_movel ?? ''));
    setEmail(currentCustomer?.email ?? '');
    setComercialTrabalho(currentCustomer?.comercial_trabalho ?? '');
    setComercialCargo(currentCustomer?.comercial_cargo ?? '');
    setComercialEndereco(currentCustomer?.comercial_endereco ?? '');
    setComercialFone(maskPhone(currentCustomer?.comercial_fone ?? ''));
    setComercialRenda(formatRenda(currentCustomer?.comercial_renda?.toString() ?? ''));
    setObsComercial(currentCustomer?.obs_comercial ?? '');
    setRefComercio1(currentCustomer?.ref_comercio_1 ?? '');
    setRefComercio2(currentCustomer?.ref_comercio_2 ?? '');
    setRefPessoal1(currentCustomer?.ref_pessoal_1 ?? '');
    setRefPessoal2(currentCustomer?.ref_pessoal_2 ?? '');
    setFaixaEtaria(currentCustomer?.faixa_etaria ?? '');
    // AQUI: setObsGeral recebe notes ou obs_debito
    setObsGeral(currentCustomer?.notes ?? currentCustomer?.obs_debito ?? '');
  }, [currentCustomer, currentIndex]); 

  // --- HANDLERS ---
  const handleCpfChange = (val: string) => {
      const masked = maskCPF(val);
      setCpf(masked);
      const numbersOnly = masked.replace(/\D/g, '');
      if (numbersOnly.length === 0) setIsCpfValid(true);
      else if (numbersOnly.length === 11) setIsCpfValid(validaCPF(masked));
      else setIsCpfValid(false);
  };

  const handleSaveSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    const formData = new FormData(e.currentTarget);
    formData.set('notes', obsGeral);
    formData.set('obs_debito', obsGeral); 
    formData.set('cpf', cpf.replace(/\D/g, ''));
    formData.set('phone', phone.replace(/\D/g, ''));
    formData.set('fone_movel', foneMovel.replace(/\D/g, ''));
    formData.set('conjuge_fone', conjugeFone.replace(/\D/g, ''));
    formData.set('comercial_fone', comercialFone.replace(/\D/g, ''));
    formData.set('comercial_renda', comercialRenda.replace(/\./g, '').replace(',', '.'));

    if (birthDate) formData.set('birth_date', birthDate); 
    if (conjugeNascimento) formData.set('conjuge_nascimento', conjugeNascimento);

    startSaveTransition(async () => {
      const result = await saveCustomerDetails({ success: false, message: '' }, formData);
      if (result.success && result.data) {
         alert(result.message);
         if (currentIndex === -1) reloadDefaultList(); 
         else {
             const updatedList = [...customers];
             updatedList[currentIndex] = result.data;
             setCustomers(updatedList);
         }
      } else {
         if (result.errors?.full_name || result.errors?.email) setActiveTab('principal');
         else if (result.errors?.ref_pessoal_1) setActiveTab('referencias');
         setErrorMessage(result.message || "Erro desconhecido.");
      }
    });
  };

  const handleDelete = async () => {
    if (!currentCustomer) return;
    if (confirm(`Deseja deletar ${currentCustomer.full_name}?`)) {
        startDeleteTransition(async () => {
            const result = await deleteCustomer(currentCustomer.id, storeId);
            if (result.success) {
                alert('Cliente deletado.');
                reloadDefaultList();
            } else { alert(result.message); }
        });
    }
  };

  const handleNavigate = (direction: 'first' | 'prev' | 'next' | 'last' | 'new') => {
      if (direction === 'new') { 
          handleNew(); // Chama a fun√ß√£o dedicada
          return; 
      }
      if (customers.length === 0) return;
      
      const lastIndex = customers.length - 1;
      let newIndex = currentIndex;

      if (currentIndex === -1) {
          if (direction === 'prev' || direction === 'last') newIndex = 0; 
          else newIndex = lastIndex;
      } else {
          if (direction === 'first') newIndex = 0;
          else if (direction === 'last') newIndex = lastIndex;
          else if (direction === 'prev') newIndex = (currentIndex <= 0) ? lastIndex : currentIndex - 1;
          else if (direction === 'next') newIndex = (currentIndex >= lastIndex) ? 0 : currentIndex + 1;
      }
      setCurrentIndex(newIndex);
  };

  // --- CORRE√á√ÉO: Fun√ß√£o handleNew declarada aqui ---
  const handleNew = () => {
      setCurrentIndex(-1);
      setActiveTab('principal');
      // O useEffect detecta currentIndex === -1 e limpa o form
  };

  const handleSelectCustomer = async (cust: Customer, index: number) => {
      if (!cust.rua && !cust.email && cust.id) {
          setLoading(true);
          const fullRes = await getCustomerById(cust.id);
          setLoading(false);
          if (fullRes.success && fullRes.data) {
              const newList = [...customers];
              newList[index] = fullRes.data;
              setCustomers(newList);
          }
      }
      setCurrentIndex(index);
  };

  const baseButtonStyle = "px-3 py-1.5 text-xs font-bold rounded-lg shadow-sm disabled:opacity-50 transition-all active:scale-95 flex items-center justify-center gap-1";

  return (
    <div className="flex h-[calc(100vh-64px)] overflow-hidden bg-slate-100">
        
        {/* --- COLUNA ESQUERDA (30%) --- */}
        <div className="w-1/3 flex flex-col border-r border-slate-200 bg-white z-10 shadow-sm">
            
            {/* Header de Busca (Gradiente) */}
            <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-4 flex flex-col gap-3 shadow-md z-20">
                <div className="flex justify-between items-center text-white">
                    <h2 className="font-bold text-sm flex items-center gap-2">
                        <Users2 className="h-4 w-4" /> LISTA DE CLIENTES
                    </h2>
                    <span className="text-[10px] bg-white/20 px-2 py-0.5 rounded-full font-medium">
                        {customers.length}
                    </span>
                </div>
                <div className="relative">
                    <input 
                        type="text" 
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        placeholder="Buscar por nome, CPF..." 
                        className="w-full h-9 pl-9 pr-3 rounded-lg border-0 bg-white shadow-lg text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-300 font-bold text-xs"
                    />
                    <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-slate-400" />
                    {isSearching && <Loader2 className="absolute right-2.5 top-2.5 h-4 w-4 animate-spin text-blue-500" />}
                </div>
            </div>

            {/* Lista Rol√°vel */}
            <div className="flex-1 overflow-y-auto">
                {loading ? (
                    <div className="flex justify-center p-10"><Loader2 className="h-6 w-6 animate-spin text-blue-500"/></div>
                ) : customers.length === 0 ? (
                    <div className="text-center p-10 text-slate-400">
                        <User className="h-10 w-10 mx-auto mb-2 opacity-20"/>
                        <p className="text-xs">Nenhum cliente encontrado.</p>
                    </div>
                ) : (
                    customers.map((c, idx) => (
                        <div 
                            key={c.id || idx}
                            onClick={() => handleSelectCustomer(c, idx)}
                            className={`p-3 border-b border-slate-100 cursor-pointer transition-colors flex justify-between items-center group
                                ${currentIndex === idx ? 'bg-blue-50 border-l-4 border-l-blue-600' : 'hover:bg-slate-50 border-l-4 border-l-transparent'}
                            `}
                        >
                            <div className="min-w-0">
                                <p className={`font-bold text-xs truncate ${currentIndex === idx ? 'text-blue-700' : 'text-slate-700'}`}>
                                    {c.full_name}
                                </p>
                                <p className="text-[10px] text-slate-400 mt-0.5 flex items-center gap-1">
                                    {c.cpf ? `CPF: ${c.cpf}` : 'Sem CPF'} 
                                    {c.obs_debito && <AlertTriangle className="h-3 w-3 text-red-500 ml-1" />}
                                </p>
                            </div>
                            <ChevronRight className={`h-3 w-3 text-slate-300 group-hover:text-blue-400 ${currentIndex === idx ? 'text-blue-500' : ''}`} />
                        </div>
                    ))
                )}
            </div>
        </div>

        {/* --- COLUNA DIREITA (70%) --- */}
        <div className="flex-1 flex flex-col bg-slate-50/50 relative overflow-hidden">
            <form onSubmit={handleSaveSubmit} className="flex flex-col h-full">
                <input type="hidden" name="store_id" value={storeId} />
                {currentCustomer?.id && <input type="hidden" name="id" value={currentCustomer.id} />}

                {/* Header das Abas */}
                <div className="bg-white border-b border-slate-200 px-4 pt-3 flex gap-4 shadow-sm flex-shrink-0">
                    <TabButton label="Dados Pessoais" icon={User} isActive={activeTab === 'principal'} onClick={() => setActiveTab('principal')} />
                    <TabButton label="Detalhes" icon={ClipboardList} isActive={activeTab === 'detalhes'} onClick={() => setActiveTab('detalhes')} />
                    <TabButton label="Ref. / Obs" icon={ScrollText} isActive={activeTab === 'referencias'} onClick={() => setActiveTab('referencias')} />
                    {currentCustomer?.id && (
                        <TabButton label={`Dependentes (${dependentesList.length})`} icon={Users2} isActive={activeTab === 'dependentes'} onClick={() => setActiveTab('dependentes')} />
                    )}
                </div>

                {/* Conte√∫do com Scroll */}
                <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                    <div className="max-w-5xl mx-auto">
                        {errorMessage && (
                            <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-2 mb-3 rounded-r text-xs flex items-center gap-2">
                                <AlertTriangle className="h-4 w-4" /> <strong>Erro:</strong> {errorMessage}
                            </div>
                        )}

                        {activeTab === 'principal' && (
                           <div className={cardStyle}>
                               <AbaPrincipal 
                                 state={{ fullName, cpf, rg, birthDate, faixaEtaria, estadoCivil, rua, numero, bairro, complemento, cidade, uf, cep, phone, foneMovel, email, isCpfValid, obsGeral }}
                                 handlers={{ setFullName, handleCpfChange, setRg, setBirthDate, setFaixaEtaria, setEstadoCivil, setRua, setNumero, setBairro, setComplemento, setCidade, setUf, setCep, setPhone, setFoneMovel, setEmail, setObsGeral }}
                                 isSaving={isSaving} inputStyle={inputStyle}
                               />
                           </div>
                        )}
                        {activeTab === 'detalhes' && (
                           <div className={cardStyle}>
                               <AbaDetalhes 
                                 state={{ pai, mae, conjugeNome, conjugeNascimento, conjugeFone, conjugeNaturalidade, conjugeTrabalho, comercialTrabalho, comercialCargo, comercialRenda, comercialFone, comercialEndereco, obsComercial }}
                                 handlers={{ setPai, setMae, setConjugeNome, setConjugeNascimento, setConjugeFone, setConjugeNaturalidade, setConjugeTrabalho, setComercialTrabalho, setComercialCargo, setComercialRenda, setComercialFone, setComercialEndereco, setObsComercial }}
                                 isSaving={isSaving} inputStyle={inputStyle}
                              />
                           </div>
                        )}
                        {activeTab === 'referencias' && (
                           <div className={cardStyle}>
                               <AbaReferencias 
                                 state={{ refPessoal1, refPessoal2, refComercio1, refComercio2 }}
                                 handlers={{ setRefPessoal1, setRefPessoal2, setRefComercio1, setRefComercio2 }}
                                 isSaving={isSaving} inputStyle={inputStyle}
                               />
                           </div>
                        )}
                        {activeTab === 'dependentes' && (
                           <AbaDependentes 
                                customerId={currentCustomer?.id}
                                storeId={storeId}
                                dependentes={dependentesList}
                                onUpdate={() => { if(currentCustomer?.id) getDependentes(currentCustomer.id).then(setDependentesList); }}
                                inputStyle={inputStyle}
                           />
                        )}
                    </div>
                </div>

                {/* RODAP√â FIXO (Some na aba Dependentes) */}
                {!isDepTab && (
                    <div className="bg-white border-t border-slate-200 p-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] flex justify-between items-center z-20 shrink-0">
                        <div className="flex gap-1">
                            <button type="button" onClick={() => handleNavigate('first')} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-500"><ArrowLeftToLine className="h-4 w-4"/></button>
                            <button type="button" onClick={() => handleNavigate('prev')} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-500"><ChevronLeft className="h-4 w-4"/></button>
                            <span className="bg-slate-800 text-white text-xs px-3 py-2 rounded-lg font-mono font-bold min-w-[70px] text-center">
                                 {currentIndex === -1 ? 'NOVO' : `${currentIndex + 1} / ${customers.length}`}
                            </span>
                            <button type="button" onClick={() => handleNavigate('next')} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-500"><ChevronRight className="h-4 w-4"/></button>
                            <button type="button" onClick={() => handleNavigate('last')} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-500"><ArrowRightToLine className="h-4 w-4"/></button>
                        </div>

                        <div className="flex gap-2">
                            <button type="button" onClick={handleNew} disabled={isSaving} className={`${baseButtonStyle} bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200`}>
                                <UserPlus className="h-4 w-4" /> Novo
                            </button>
                            {currentIndex !== -1 && (
                                <button type="button" onClick={handleDelete} disabled={isDeleting} className={`${baseButtonStyle} bg-red-50 text-red-700 hover:bg-red-100 border border-red-200`}>
                                    {isDeleting ? <Loader2 className="h-4 w-4 animate-spin"/> : <Trash2 className="h-4 w-4"/>} Excluir
                                </button>
                            )}
                            <button type="submit" disabled={isSaving} className={`${baseButtonStyle} bg-green-600 text-white hover:bg-green-700 shadow-md px-6`}>
                                {isSaving ? <Loader2 className="h-4 w-4 animate-spin"/> : <><Save className="h-4 w-4 mr-1"/> SALVAR</>}
                            </button>
                        </div>
                    </div>
                )}
            </form>
        </div>
    </div>
  );
}

function TabButton({ label, icon: Icon, isActive, onClick }: { label: string, icon: React.ElementType, isActive: boolean, onClick: () => void }) {
    return (
        <button type="button" onClick={onClick} className={`flex items-center gap-2 pb-3 text-xs font-bold uppercase tracking-wider transition-all border-b-2 ${isActive ? 'text-blue-600 border-blue-600' : 'text-slate-400 border-transparent hover:text-slate-600'}`}>
             <Icon className={`h-4 w-4 ${isActive ? 'text-blue-600' : 'text-slate-400'}`} /> {label}
        </button>
    );
}

function AbaPrincipal({ state, handlers, isSaving, inputStyle }: any) {
    const lbl = labelStyle; 
    const cpfStyle = state.isCpfValid ? inputStyle : "block w-full rounded-md border-red-300 shadow-sm text-red-900 h-8 text-xs bg-red-50 px-2 focus:ring-red-500 focus:border-red-500 font-bold";
    
    return (
       <div className="grid grid-cols-12 gap-3 gap-y-2">
             <h3 className="col-span-full font-bold text-xs text-blue-700 border-b border-slate-100 pb-1 mb-1 uppercase">Identifica√ß√£o</h3>
             <div className="col-span-8">
                 <label className={lbl}>Nome Completo *</label>
                 <input name="full_name" type="text" required value={state.fullName} onChange={e => handlers.setFullName(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-4">
                 <label className={lbl}>Data Nasc.</label>
                 <input name="birth_date" type="date" value={state.birthDate} onChange={e => handlers.setBirthDate(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-3 relative">
                  <label className={lbl}>CPF</label>
                  <input name="cpf" type="text" value={state.cpf} onChange={(e) => handlers.handleCpfChange(e.target.value)} className={cpfStyle} disabled={isSaving} />
                 {!state.isCpfValid && <span className="text-[9px] text-red-600 font-bold absolute -bottom-3 right-0">Inv√°lido</span>}
             </div>
             <div className="col-span-3">
                 <label className={lbl}>RG</label>
                 <input name="rg" type="text" value={state.rg} onChange={e => handlers.setRg(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-3">
                  <label className={lbl}>Celular</label>
                 <input name="fone_movel" type="text" value={state.foneMovel} onChange={(e) => handlers.setFoneMovel(maskPhone(e.target.value))} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-3">
               <label className={lbl}>Fixo</label>
                 <input name="phone" type="text" value={state.phone} onChange={(e) => handlers.setPhone(maskPhone(e.target.value))} className={inputStyle} disabled={isSaving} />
             </div>
             
             <h3 className="col-span-full font-bold text-xs text-blue-700 border-b border-slate-100 pb-1 mb-1 mt-2 uppercase">Endere√ßo</h3>
             <div className="col-span-2">
                 <label className={lbl}>CEP</label>
                 <input name="cep" type="text" value={state.cep} onChange={(e) => handlers.setCep(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-8">
                 <label className={lbl}>Logradouro</label>
                  <input name="rua" type="text" value={state.rua} onChange={e => handlers.setRua(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-2">
                 <label className={lbl}>N¬∫</label>
                 <input name="numero" type="text" value={state.numero} onChange={e => handlers.setNumero(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
            <div className="col-span-4">
                 <label className={lbl}>Bairro</label>
                 <input name="bairro" type="text" value={state.bairro} onChange={e => handlers.setBairro(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-4">
                 <label className={lbl}>Complemento</label>
                  <input name="complemento" type="text" value={state.complemento} onChange={handlers.setComplemento} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-3">
                  <label className={lbl}>Cidade</label>
                 <input name="cidade" type="text" value={state.cidade} onChange={e => handlers.setCidade(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-1">
                 <label className={lbl}>UF</label>
                 <input name="uf" type="text" value={state.uf} onChange={e => handlers.setUf(e.target.value)} maxLength={2} className={inputStyle} disabled={isSaving} />
             </div>
            <div className="col-span-12">
                 <label className={lbl}>E-mail</label>
                 <input name="email" type="email" value={state.email} onChange={e => handlers.setEmail(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>

             {/* --- NOVO LOCAL DA OBSERVA√á√ÉO --- */}
             <div className="col-span-12 mt-2 pt-2 border-t border-slate-100">
                <label className={`${lbl} text-red-600`}>Observa√ß√µes Gerais / Restri√ß√µes</label>
                <textarea 
                    name="notes" 
                    rows={3} 
                    value={state.obsGeral} 
                    onChange={e => handlers.setObsGeral(e.target.value)} 
                    className="block w-full rounded-md border border-slate-300 shadow-sm text-xs p-2 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none placeholder:text-slate-400 font-bold text-slate-700" 
                    disabled={isSaving} 
                    placeholder="Digite aqui restri√ß√µes de cr√©dito ou notas importantes..." 
                />
             </div>
        </div>
   );
}

function AbaDetalhes({ state, handlers, isSaving, inputStyle }: any) {
    const lbl = labelStyle;
    return (
        <div className="grid grid-cols-12 gap-3 gap-y-2">
             <h3 className="col-span-full font-bold text-xs text-blue-700 border-b border-slate-100 pb-1 mb-1 uppercase">Filia√ß√£o e Situa√ß√£o</h3>
             <div className="col-span-6">
                 <label className={lbl}>Pai</label>
                 <input name="pai" type="text" value={state.pai} onChange={e => handlers.setPai(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-6">
                 <label className={lbl}>M√£e</label>
                 <input name="mae" type="text" value={state.mae} onChange={e => handlers.setMae(e.target.value)} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-6">
                 <label className={lbl}>Naturalidade</label>
                 <input name="naturalidade" type="text" value={state.naturalidade} onChange={handlers.setNaturalidade} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-6">
                <label className={lbl}>Estado Civil</label>
                <input name="estado_civil" type="text" value={state.estadoCivil} onChange={handlers.setEstadoCivil} className={inputStyle} disabled={isSaving} />
             </div>
             
             <h3 className="col-span-full font-bold text-xs text-blue-700 border-b border-slate-100 pb-1 mb-1 mt-2 uppercase">C√¥njuge</h3>
             <div className="col-span-4">
                 <label className={lbl}>Nome</label>
                 <input name="conjuge_nome" type="text" value={state.conjugeNome} onChange={handlers.setConjugeNome} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-2">
                <label className={lbl}>Nasc.</label>
                  <input name="conjuge_nascimento" type="date" value={state.conjugeNascimento} onChange={handlers.setConjugeNascimento} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-2">
                  <label className={lbl}>Fone</label>
                  <input name="conjuge_fone" type="text" value={state.conjugeFone} onChange={(e) => handlers.setConjugeFone(maskPhone(e.target.value))} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-4">
                 <label className={lbl}>Trab. C√¥njuge</label>
                 <input name="conjuge_trabalho" type="text" value={state.conjugeTrabalho} onChange={handlers.setConjugeTrabalho} className={inputStyle} disabled={isSaving} />
            </div>
             
             <h3 className="col-span-full font-bold text-xs text-blue-700 border-b border-slate-100 pb-1 mb-1 mt-2 uppercase">Dados Comerciais</h3>
             <div className="col-span-4">
                 <label className={lbl}>Empresa</label>
                 <input name="comercial_trabalho" type="text" value={state.comercialTrabalho} onChange={handlers.setComercialTrabalho} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-3">
                  <label className={lbl}>Cargo</label>
                 <input name="comercial_cargo" type="text" value={state.comercialCargo} onChange={handlers.setComercialCargo} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-2">
                 <label className={lbl}>Renda</label>
                 <input name="comercial_renda" type="text" value={state.comercialRenda} onChange={(e) => handlers.setComercialRenda(formatRenda(e.target.value))} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-3">
                 <label className={lbl}>Fone Coml.</label>
                 <input name="comercial_fone" type="text" value={state.comercialFone} onChange={(e) => handlers.setComercialFone(maskPhone(e.target.value))} className={inputStyle} disabled={isSaving} />
             </div>
             <div className="col-span-12">
                 <label className={lbl}>Endere√ßo Coml.</label>
                 <input name="comercial_endereco" type="text" value={state.comercialEndereco} onChange={handlers.setComercialEndereco} className={inputStyle} disabled={isSaving} />
             </div>
        </div>
   );
}

function AbaReferencias({ state, handlers, isSaving, inputStyle }: any) {
    const lbl = labelStyle;
    return (
       <div className="grid grid-cols-12 gap-3 gap-y-2">
            <h3 className="col-span-full font-bold text-xs text-blue-700 border-b border-slate-100 pb-1 mb-1 uppercase">Refer√™ncias Pessoais</h3>
             <div className="col-span-6">
                 <label className={lbl}>Ref. Pessoal 1</label>
                 <input name="ref_pessoal_1" type="text" value={state.refPessoal1} onChange={handlers.setRefPessoal1} className={inputStyle} disabled={isSaving} placeholder="Nome e Telefone" />
             </div>
            <div className="col-span-6">
                 <label className={lbl}>Ref. Pessoal 2</label>
                  <input name="ref_pessoal_2" type="text" value={state.refPessoal2} onChange={handlers.setRefPessoal2} className={inputStyle} disabled={isSaving} placeholder="Nome e Telefone" />
            </div>
            
            <h3 className="col-span-full font-bold text-xs text-blue-700 border-b border-slate-100 pb-1 mb-1 mt-2 uppercase">Refer√™ncias Comerciais</h3>
            <div className="col-span-6">
                <label className={lbl}>Ref. Comercial 1</label>
                <input name="ref_comercio_1" type="text" value={state.refComercio1} onChange={handlers.setRefComercio1} className={inputStyle} disabled={isSaving} placeholder="Empresa e Telefone" />
            </div>
            <div className="col-span-6">
                <label className={lbl}>Ref. Comercial 2</label>
                <input name="ref_comercio_2" type="text" value={state.refComercio2} onChange={handlers.setRefComercio2} className={inputStyle} disabled={isSaving} placeholder="Empresa e Telefone" />
            </div>
       </div>
    );
}

function AbaDependentes({ customerId, storeId, dependentes, onUpdate, inputStyle }: { customerId?: number, storeId: number, dependentes: Dependente[], onUpdate: () => void, inputStyle: string }) {
  const [isSaving, startTransition] = useTransition();
  const [depNome, setDepNome] = useState('');
  const [depParentesco, setDepParentesco] = useState('Filho(a)');
  const [depNasc, setDepNasc] = useState('');
  const [editingId, setEditingId] = useState<number | null>(null);

  const handleSave = async () => {
    if (!customerId) return;
    if (!depNome.trim()) { alert("Nome √© obrigat√≥rio"); return; }

    const formData = new FormData();
    if (editingId) formData.set('id', editingId.toString());
    
    formData.set('store_id', storeId.toString());
    formData.set('customer_id', customerId.toString());
    formData.set('nome_completo', depNome);
    formData.set('parentesco', depParentesco);
    if (depNasc) formData.set('data_nascimento', depNasc);

    startTransition(async () => {
      const result = await saveDependente({ success: false, message: '' }, formData);
      if (result.success) {
        setDepNome('');
        setDepParentesco('Filho(a)');
        setDepNasc('');
        setEditingId(null); 
        onUpdate();
      } else {
        alert(result.message);
      }
    });
  };

  const handleEditClick = (dep: Dependente) => {
      setDepNome(dep.full_name);
      setDepParentesco(dep.parentesco || 'Filho(a)');
      setDepNasc(formatDate(dep.birth_date));
      setEditingId(dep.id);
  };
  
  const handleCancelEdit = () => {
      setDepNome('');
      setDepParentesco('Filho(a)');
      setDepNasc('');
      setEditingId(null);
  }

  const handleDelete = async (id: number) => {
    if (!confirm("Remover este dependente?")) return;
    const res = await deleteDependente(id);
    if (res.success) onUpdate(); else alert(res.message);
  };

  if (!customerId) {
    return <div className="flex h-full items-center justify-center text-slate-400 text-sm italic p-10">Salve o cliente titular primeiro para adicionar dependentes.</div>;
  }

  return (
    <div className="flex flex-col h-full gap-4">
      <div className={`p-4 rounded-xl border shadow-sm transition-colors ${editingId ? 'bg-amber-50 border-amber-200' : 'bg-white border-slate-200'}`}>
        <h4 className={`text-xs font-bold uppercase mb-3 flex items-center gap-2 ${editingId ? 'text-amber-700' : 'text-blue-700'}`}>
            {editingId ? <><Pencil className="h-4 w-4"/> Editando Dependente</> : <><UserPlus className="h-4 w-4"/> Adicionar Dependente</>}
        </h4>
        
        <div className="flex gap-2 items-end">
          <div className="flex-1">
            <label className={labelStyle}>Nome Completo</label>
            <input value={depNome} onChange={e => setDepNome(e.target.value)} className={inputStyle} placeholder="Nome do paciente" />
          </div>
          <div className="w-1/4">
             <label className={labelStyle}>Parentesco</label>
             <select value={depParentesco} onChange={e => setDepParentesco(e.target.value)} className={inputStyle}>
                <option value="Filho(a)">Filho(a)</option>
                <option value="C√¥njuge">C√¥njuge</option>
                <option value="Pai/M√£e">Pai/M√£e</option>
                <option value="Outro">Outro</option>
             </select>
          </div>
          <div className="w-1/4">
             <label className={labelStyle}>Nascimento</label>
             <input type="date" value={depNasc} onChange={e => setDepNasc(e.target.value)} className={inputStyle} />
          </div>
          <button type="button" onClick={handleSave} disabled={isSaving} className={`h-8 px-4 rounded-lg text-xs font-bold text-white flex items-center gap-1 shadow-sm transition-transform active:scale-95 ${editingId ? 'bg-amber-600 hover:bg-amber-700' : 'bg-green-600 hover:bg-green-700'}`}>
             {isSaving ? <Loader2 className="h-3 w-3 animate-spin"/> : <Save className="h-3 w-3"/>} {editingId ? 'Atualizar' : 'Adicionar'}
          </button>
          {editingId && (
              <button type="button" onClick={handleCancelEdit} className="h-8 px-2 rounded-lg text-slate-500 hover:bg-slate-100 border border-slate-200" title="Cancelar"><X className="h-4 w-4"/></button>
          )}
        </div>
      </div>

      <div className="space-y-2">
           {dependentes.length === 0 ? (
             <p className="text-center text-slate-400 text-xs py-4">Nenhum dependente cadastrado.</p>
           ) : (
             dependentes.map(dep => (
               <div key={dep.id} className={`flex justify-between items-center p-3 border rounded-xl bg-white shadow-sm transition-colors ${editingId === dep.id ? 'border-amber-400 ring-1 ring-amber-400' : 'border-slate-100 hover:border-blue-200'}`}>
                  <div className="flex-1">
                    <p className="font-bold text-slate-700 text-sm">{dep.full_name}</p>
                    <div className="flex gap-3 mt-1">
                       <span className="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded font-bold uppercase">{dep.parentesco || 'Outro'}</span>
                       {dep.birth_date && <span className="text-[10px] text-slate-400 flex items-center gap-1"><Calendar className="h-3 w-3"/> {formatDate(dep.birth_date)}</span>}
                    </div>
                  </div>
                  <div className="flex gap-1">
                       <button type="button" onClick={() => handleEditClick(dep)} className="text-slate-400 hover:text-blue-600 p-2 hover:bg-blue-50 rounded-lg transition-colors" title="Editar"><Pencil className="h-4 w-4"/></button>
                       <button type="button" onClick={() => handleDelete(dep.id)} className="text-slate-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-lg transition-colors" title="Remover"><Trash2 className="h-4 w-4"/></button>
                  </div>
               </div>
             ))
           )}
      </div>
    </div>
  );
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\cobranca\page.tsx
==================================================
import { getInadimplentes } from '@/lib/actions/collection.actions'
import { Megaphone } from 'lucide-react'
import CobrancaInterface from '@/components/cobranca/CobrancaInterface' // <-- Criaremos este componente a seguir

export default async function CobrancaPage({
  params,
  searchParams,
}: {
  params: { storeId: string }
  searchParams: { filtro?: string }
}) {
  const storeId = parseInt(params.storeId, 10)
  
  // Define o filtro baseado na URL (padr√£o 'todos')
  const filtroAtivo = searchParams.filtro === 'sem_spc' ? 'sem_spc' : 'todos'

  // Busca os dados direto do banco (Server Side)
  const devedores = await getInadimplentes(storeId, filtroAtivo)

  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-hidden">
      
      {/* Header da P√°gina */}
      <div className="bg-white border-b border-gray-300 px-6 py-3 shadow-sm flex-shrink-0 flex justify-between items-center">
        <div className="flex items-center gap-3">
            <div className="p-2 bg-red-100 rounded-lg text-red-600">
                <Megaphone className="h-6 w-6" />
            </div>
            <div>
                <h1 className="text-xl font-bold text-gray-800">Central de Cobran√ßa</h1>
                <p className="text-xs text-gray-500">Gerencie inadimpl√™ncia e hist√≥rico de contatos</p>
            </div>
        </div>
        
        <div className="text-right">
            <p className="text-sm font-bold text-gray-600">Total de Devedores</p>
            <p className="text-2xl font-black text-red-600">{devedores.length}</p>
        </div>
      </div>

      {/* √Årea Principal (Client Component) */}
      <div className="flex-1 overflow-hidden p-4">
         {/* Passamos os dados iniciais para o componente interativo */}
         <CobrancaInterface 
            initialDevedores={devedores} 
            storeId={storeId}
            filtroAtual={filtroAtivo}
         />
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\config\page.tsx
==================================================
// Caminho: src/app/dashboard/loja/[storeId]/config/page.tsx

import { createClient } from '@/lib/supabase/server'
import { getProfileByAdmin } from '@/lib/supabase/admin'
import { redirect } from 'next/navigation'
import ConfigInterface from '@/components/config/ConfigInterface'
import { ShieldAlert } from 'lucide-react'

export default async function ConfigPage({ params }: { params: { storeId: string } }) {
  const supabase = createClient()
  const storeId = parseInt(params.storeId, 10)

  // 1. Quem √© o usu√°rio?
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return redirect('/login')

  // 2. Qual o cargo dele?
  // CORRE√á√ÉO: Cast 'as any' para garantir o acesso a 'role'
  const profile = await getProfileByAdmin(user.id) as any
  
  // 3. SEGURAN√áA: Apenas Admin ou Gerente passam
  const isAllowed = profile?.role === 'admin' || profile?.role === 'manager'

  if (!isAllowed) {
    return (
        <div className="flex flex-col items-center justify-center h-[calc(100vh-64px)] bg-gray-100 p-6">
            <div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md border-t-4 border-red-500">
                <ShieldAlert className="h-16 w-16 text-red-500 mx-auto mb-4" />
                <h1 className="text-2xl font-black text-gray-800 mb-2">Acesso Negado</h1>
                <p className="text-gray-500 mb-6">
                    Esta √°rea √© restrita a Gerentes e Administradores.
                    <br/>Seu perfil atual √©: <strong className="uppercase">{profile?.role || 'Desconhecido'}</strong>
                </p>
                <a 
                    href={`/dashboard/loja/${storeId}`}
                    className="inline-block bg-gray-800 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-900 transition-colors"
                >
                    Voltar para o In√≠cio
                </a>
            </div>
        </div>
    )
  }

  // 4. Se passou, carrega a interface
  return <ConfigInterface storeId={storeId} />
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\consultas\page.tsx
==================================================
// Caminho: src/app/dashboard/loja/[storeId]/consultas/page.tsx
import { getAlertasOperacionais, getAniversariantes } from '@/lib/actions/consultas.actions'
import PaineisAlertas from '@/components/consultas/PaineisAlertas'
import BuscaUniversal from '@/components/consultas/BuscaUniversal'
import AniversariantesWidget from '@/components/consultas/AniversariantesWidget'

export default async function ConsultasPage({ params }: { params: { storeId: string } }) {
  const storeId = parseInt(params.storeId, 10)
  
  // Busca em paralelo para ser r√°pido
  const [alertas, aniversariantes] = await Promise.all([
      getAlertasOperacionais(storeId),
      getAniversariantes(storeId)
  ])

  return (
    <div className="h-[calc(100vh-64px)] bg-[radial-gradient(ellipse_at_top_left,_var(--tw-gradient-stops))] from-teal-100 via-slate-200 to-cyan-100 overflow-hidden p-6">
      
      <div className="max-w-screen-2xl mx-auto h-full grid grid-cols-12 gap-8">
        
        {/* COLUNA ESQUERDA (Busca) - Ocupa 8 colunas em telas grandes */}
        <div className="col-span-12 lg:col-span-8 flex flex-col gap-6 h-full overflow-y-auto pr-2 custom-scrollbar">
             <div className="mb-2 pl-1">
                  <h1 className="text-3xl font-black text-slate-800 tracking-tight drop-shadow-sm">Informa√ß√µes Gerais</h1>
                  <p className="text-slate-600 text-sm font-bold opacity-70">Central de intelig√™ncia da loja.</p>
             </div>

             <BuscaUniversal storeId={storeId} />
        </div>

        {/* COLUNA DIREITA (Alertas + Aniversariantes) - Ocupa 4 colunas */}
        <div className="col-span-12 lg:col-span-4 flex flex-col h-full overflow-y-auto custom-scrollbar pb-20 gap-6">
             
             {/* WIDGET DE ANIVERSARIANTES (Topo da Coluna Direita) */}
             <div className="shrink-0">
                <AniversariantesWidget clientes={aniversariantes} />
             </div>

             {/* RADAR OPERACIONAL (Abaixo dos Aniversariantes) */}
             <div className="flex-1 flex flex-col gap-4">
                <h2 className="text-xs font-black text-slate-500 uppercase tracking-widest ml-1 drop-shadow-sm opacity-80">
                    Radar Operacional
                </h2>
                
                <PaineisAlertas 
                    entregas={alertas.entregas} 
                    laboratorio={alertas.laboratorio} 
                    storeId={storeId} 
                />
             </div>
        </div>

      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\design-lab\page.tsx
==================================================
'use client'

import { useState } from 'react'
import { 
  Save, User, Eye, Ruler, 
  CalendarClock, Truck, QrCode, 
  History, Printer, ArrowLeft, MessageCircle
} from 'lucide-react'

// --- NOVO DESIGN SYSTEM (DARK MINIMAL V2) ---

const darkCard = "bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg mb-3"
const labelStyle = "block text-[9px] font-bold text-slate-400 uppercase mb-0.5 tracking-wider"
const inputStyle = "block w-full h-8 rounded-md border-0 bg-white text-slate-900 text-xs px-2 focus:ring-2 focus:ring-blue-500 font-bold placeholder:text-slate-300 transition-all disabled:opacity-50 disabled:bg-gray-200"

// T√≠tulo de Se√ß√£o com linha divis√≥ria
const SectionHeader = ({ icon: Icon, title }: { icon: any, title: string }) => (
    <div className="flex items-center gap-2 mb-2 pl-1 pt-2">
        <div className="p-1 bg-slate-200 rounded text-slate-700"><Icon className="h-3 w-3" /></div>
        <h3 className="text-xs font-black text-slate-700 uppercase">{title}</h3>
        <div className="flex-1 h-px bg-slate-300 ml-2"></div>
    </div>
)

export default function DesignLabOSPage() {
  return (
    // CONTAINER MESTRE (Ocupa toda a largura, sem sidebar)
    <div className="flex h-[calc(100vh-120px)] w-full overflow-hidden bg-slate-100 rounded-xl border border-slate-200 shadow-sm relative">
      
      {/* 1. HEADER FIXO (BARRA DE FERRAMENTAS) */}
      <div className="absolute top-0 left-0 right-0 h-16 bg-slate-900 border-b border-slate-800 px-6 flex justify-between items-center shadow-md z-20">
            <div className="flex items-center gap-4">
                <button className="text-slate-400 hover:text-white transition-colors">
                    <ArrowLeft className="h-5 w-5" />
                </button>
                
                {/* Protocolo em Destaque */}
                <div>
                    <label className="text-[9px] font-bold text-slate-500 uppercase block mb-0.5">Protocolo</label>
                    <div className="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded border border-slate-700">
                        <QrCode className="h-4 w-4 text-blue-400" />
                        <span className="text-sm font-mono font-bold text-white tracking-widest">550-2025</span>
                    </div>
                </div>

                <div className="h-8 w-px bg-slate-700 mx-2"></div>

                <div>
                    <label className="text-[9px] font-bold text-slate-500 uppercase block mb-0.5">Status</label>
                    <select className="h-8 rounded bg-blue-600 text-white text-xs font-bold border-none px-3 cursor-pointer hover:bg-blue-500 transition-colors">
                        <option>No Laborat√≥rio</option>
                        <option>Montagem</option>
                        <option>Aguardando Cliente</option>
                        <option>Entregue</option>
                    </select>
                </div>
            </div>

            <div className="text-right">
                <p className="text-[9px] text-slate-400 uppercase font-bold flex items-center justify-end gap-1">
                    <CalendarClock className="h-3 w-3" /> Prazo
                </p>
                <p className="text-base font-black text-green-400">20/12/2025</p>
            </div>
      </div>

      {/* 2. MIOLO DO FORMUL√ÅRIO (Rolagem Interna) */}
      <div className="absolute top-16 bottom-16 left-0 right-0 overflow-y-auto p-6 custom-scrollbar bg-gradient-to-br from-gray-100 to-gray-200">
         <div className="max-w-5xl mx-auto space-y-4">

            {/* --- BLOCO 1: IDENTIFICA√á√ÉO & PRODUTOS --- */}
            <div className="grid grid-cols-12 gap-4">
                {/* Coluna Esquerda: Pessoas */}
                <div className="col-span-5">
                    <SectionHeader icon={User} title="Cliente & M√©dico" />
                    <div className={darkCard}>
                        <div className="space-y-2">
                            <div>
                                <label className={labelStyle}>Paciente</label>
                                <div className="flex gap-2">
                                    <select className={inputStyle}>
                                        <option>Ana Souza (Titular)</option>
                                        <option>Pedro (Dependente)</option>
                                    </select>
                                    <button className="bg-green-600 w-10 rounded text-white flex items-center justify-center hover:bg-green-500 shadow-sm" title="WhatsApp">
                                        <MessageCircle className="h-4 w-4" />
                                    </button>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className={labelStyle}>Oftalmologista</label>
                                    <input className={inputStyle} placeholder="Nome ou CRM" />
                                </div>
                                <div>
                                    <label className={labelStyle}>Vendedor</label>
                                    <input className={inputStyle} value="Jo√£o Silva" disabled />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Coluna Direita: Produtos */}
                <div className="col-span-7">
                    <SectionHeader icon={Eye} title="Produtos Vinculados" />
                    <div className={darkCard}>
                        <div className="space-y-2">
                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className={labelStyle}>Lente OD</label>
                                    <input className={inputStyle} value="Hoya BlueControl 1.59" readOnly />
                                </div>
                                <div>
                                    <label className={labelStyle}>Lente OE</label>
                                    <input className={inputStyle} value="Hoya BlueControl 1.59" readOnly />
                                </div>
                            </div>
                            <div className="grid grid-cols-12 gap-2">
                                <div className="col-span-8">
                                    <label className={labelStyle}>Arma√ß√£o</label>
                                    <input className={inputStyle} value="Rayban Aviator Preto Met√°lico" readOnly />
                                </div>
                                <div className="col-span-4">
                                    <label className={labelStyle}>Tratamento</label>
                                    <input className={inputStyle} value="AR Premium" readOnly />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* --- BLOCO 2: DADOS T√âCNICOS (GRID DENSA) --- */}
            <div>
                <SectionHeader icon={Ruler} title="Receita & Medidas" />
                <div className={darkCard}>
                    {/* Linha de Cabe√ßalho da Tabela */}
                    <div className="grid grid-cols-12 gap-2 mb-1 text-center pr-2">
                        <div className="col-span-1"></div>
                        <div className="col-span-2 text-[9px] font-bold text-slate-400">ESF√âRICO</div>
                        <div className="col-span-2 text-[9px] font-bold text-slate-400">CIL√çNDRICO</div>
                        <div className="col-span-2 text-[9px] font-bold text-slate-400">EIXO</div>
                        <div className="col-span-1 text-[9px] font-bold text-slate-400">DNP</div>
                        <div className="col-span-1 text-[9px] font-bold text-slate-400">ALTURA</div>
                        <div className="col-span-3 text-[9px] font-bold text-slate-400 border-l border-slate-600 pl-1">OBS</div>
                    </div>

                    {/* OD */}
                    <div className="grid grid-cols-12 gap-2 items-center mb-2">
                        <div className="col-span-1 text-right font-black text-blue-400 text-sm">OD</div>
                        <div className="col-span-2"><input className={inputStyle + " text-center"} placeholder="-0.00" /></div>
                        <div className="col-span-2"><input className={inputStyle + " text-center"} placeholder="-0.00" /></div>
                        <div className="col-span-2"><input className={inputStyle + " text-center"} placeholder="0¬∫" /></div>
                        <div className="col-span-1"><input className={inputStyle + " text-center bg-blue-50 text-blue-900"} placeholder="mm" /></div>
                        <div className="col-span-1"><input className={inputStyle + " text-center bg-blue-50 text-blue-900"} placeholder="mm" /></div>
                        {/* Obs Unificada Rowspan */}
                        <div className="col-span-3 row-span-2 pl-2 border-l border-slate-600">
                             <textarea className="w-full h-[72px] rounded bg-white text-xs p-1 resize-none" placeholder="Obs t√©cnica..."></textarea>
                        </div>
                    </div>

                    {/* OE */}
                    <div className="grid grid-cols-12 gap-2 items-center mb-3">
                        <div className="col-span-1 text-right font-black text-blue-400 text-sm">OE</div>
                        <div className="col-span-2"><input className={inputStyle + " text-center"} placeholder="-0.00" /></div>
                        <div className="col-span-2"><input className={inputStyle + " text-center"} placeholder="-0.00" /></div>
                        <div className="col-span-2"><input className={inputStyle + " text-center"} placeholder="0¬∫" /></div>
                        <div className="col-span-1"><input className={inputStyle + " text-center bg-blue-50 text-blue-900"} placeholder="mm" /></div>
                        <div className="col-span-1"><input className={inputStyle + " text-center bg-blue-50 text-blue-900"} placeholder="mm" /></div>
                    </div>

                    {/* Linha Extra (Adi√ß√£o e Arma√ß√£o) */}
                    <div className="grid grid-cols-12 gap-2 pt-2 border-t border-slate-700 mt-2">
                        <div className="col-span-2">
                            <label className={labelStyle + " text-green-400"}>Adi√ß√£o</label>
                            <input className={inputStyle + " text-center font-black"} placeholder="+2.00" />
                        </div>
                        <div className="col-span-2">
                            <label className={labelStyle}>Ponte</label>
                            <input className={inputStyle + " text-center"} />
                        </div>
                        <div className="col-span-2">
                            <label className={labelStyle}>Vertical</label>
                            <input className={inputStyle + " text-center"} />
                        </div>
                        <div className="col-span-2">
                            <label className={labelStyle}>Horizontal</label>
                            <input className={inputStyle + " text-center"} />
                        </div>
                        <div className="col-span-2">
                            <label className={labelStyle}>Diagonal</label>
                            <input className={inputStyle + " text-center"} />
                        </div>
                         <div className="col-span-2">
                            <label className={labelStyle}>Di√¢metro</label>
                            <input className={inputStyle + " text-center"} />
                        </div>
                    </div>
                </div>
            </div>

            {/* --- BLOCO 3: LABORAT√ìRIO (Rastreio Detalhado) --- */}
            <div>
                <SectionHeader icon={Truck} title="Rastreio do Laborat√≥rio" />
                <div className={darkCard}>
                    <div className="grid grid-cols-5 gap-3">
                        <div className="col-span-2">
                            <label className={labelStyle}>Laborat√≥rio / Pedido</label>
                            <div className="flex gap-2">
                                <input className={inputStyle} placeholder="Nome do Lab" />
                                <input className={inputStyle} placeholder="N¬∫ Externo" />
                            </div>
                        </div>
                        <div>
                            <label className={labelStyle}>Enviado</label>
                            <input type="date" className={inputStyle} />
                        </div>
                         <div>
                            <label className={labelStyle}>Chegou Lente</label>
                            <input type="date" className={inputStyle} />
                        </div>
                         <div>
                            <label className={labelStyle}>Montado</label>
                            <input type="date" className={inputStyle} />
                        </div>
                    </div>
                </div>
            </div>

         </div>
      </div>

      {/* 3. RODAP√â FIXO (BOT√ïES DE A√á√ÉO) */}
      <div className="absolute bottom-0 left-0 right-0 h-16 bg-white border-t border-slate-200 px-6 flex justify-between items-center shadow-lg z-30">
            <div className="flex gap-2">
                 <button className="px-4 py-2 text-xs font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                    <History className="h-4 w-4" /> Hist√≥rico
                 </button>
                 <button className="px-4 py-2 text-xs font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors flex items-center gap-2">
                    <Printer className="h-4 w-4" /> Imprimir
                 </button>
            </div>
            <div className="flex gap-3">
                <button className="px-6 py-2.5 text-xs font-bold text-slate-600 hover:text-slate-800 transition-colors uppercase">
                    Cancelar
                </button>
                <button className="px-8 py-2.5 text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition-transform active:scale-95 flex items-center gap-2 uppercase tracking-wide">
                    <Save className="h-4 w-4" /> Salvar Ordem
                </button>
            </div>
      </div>

    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\estoque\movimentacoes\page.tsx
==================================================
import { getStockMovements } from '@/lib/actions/stock.actions'
import { 
    ArrowUpCircle, ArrowDownCircle, AlertTriangle, 
    Calendar, Package, User 
} from 'lucide-react'
import StockFiltersBar from './_components/StockFiltersBar'

// Helper de formata√ß√£o
const formatDate = (date: string) => new Date(date).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })

export default async function MovimentacoesPage({ 
    params, 
    searchParams 
}: { 
    params: { storeId: string },
    searchParams: { inicio?: string, fim?: string, tipo?: string, busca?: string } 
}) {
  const storeId = parseInt(params.storeId, 10)
  
  // Datas padr√£o se n√£o vier na URL (Hoje)
  const hoje = new Date().toISOString().split('T')[0]
  const inicio = searchParams.inicio || hoje
  const fim = searchParams.fim || hoje

  // Busca dados filtrados
  const movimentos = await getStockMovements(storeId, {
      dataInicio: inicio,
      dataFim: fim,
      tipo: searchParams.tipo,
      busca: searchParams.busca
  })

  // --- C√ÅLCULO DOS KPIS (Baseado na lista filtrada) ---
  // Isso d√° um resumo instant√¢neo do que est√° sendo visto
  const kpis = movimentos.reduce((acc: any, mov: any) => {
      if (mov.tipo === 'Entrada' || mov.tipo === 'Ajuste') {
          acc.entradas += mov.quantidade
      } else if (mov.tipo === 'Perda') {
          acc.perdas += mov.quantidade
      } else {
          // Saida, Brinde
          acc.saidas += mov.quantidade
      }
      return acc
  }, { entradas: 0, saidas: 0, perdas: 0 })

  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-slate-100 overflow-hidden">
      
      {/* HEADER / KPIs (Topo) */}
      <div className="bg-white border-b border-slate-200 px-6 py-3 shadow-sm flex-shrink-0">
          <div className="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4">
              {/* Card Entradas */}
              <div className="bg-emerald-50 border border-emerald-100 rounded-xl p-3 flex items-center gap-3">
                  <div className="p-2 bg-white rounded-lg text-emerald-600 shadow-sm"><ArrowUpCircle className="h-5 w-5"/></div>
                  <div>
                      <p className="text-[10px] font-bold text-emerald-700 uppercase tracking-wider">Entradas / Ajustes</p>
                      <p className="text-xl font-black text-slate-700">{kpis.entradas} <span className="text-xs font-medium text-slate-400">unid.</span></p>
                  </div>
              </div>
              
              {/* Card Sa√≠das */}
              <div className="bg-blue-50 border border-blue-100 rounded-xl p-3 flex items-center gap-3">
                  <div className="p-2 bg-white rounded-lg text-blue-600 shadow-sm"><ArrowDownCircle className="h-5 w-5"/></div>
                  <div>
                      <p className="text-[10px] font-bold text-blue-700 uppercase tracking-wider">Sa√≠das / Vendas</p>
                      <p className="text-xl font-black text-slate-700">{kpis.saidas} <span className="text-xs font-medium text-slate-400">unid.</span></p>
                  </div>
              </div>

              {/* Card Perdas */}
              <div className="bg-rose-50 border border-rose-100 rounded-xl p-3 flex items-center gap-3">
                  <div className="p-2 bg-white rounded-lg text-rose-600 shadow-sm"><AlertTriangle className="h-5 w-5"/></div>
                  <div>
                      <p className="text-[10px] font-bold text-rose-700 uppercase tracking-wider">Perdas / Quebras</p>
                      <p className="text-xl font-black text-rose-600">{kpis.perdas} <span className="text-xs font-medium text-slate-400">unid.</span></p>
                  </div>
              </div>
          </div>
      </div>

      {/* CORPO (SPLIT VIEW) */}
      <div className="flex flex-1 overflow-hidden">
        
        {/* Coluna Esquerda: Filtros */}
        <div className="w-1/4 min-w-[250px] max-w-[300px] border-r border-slate-200 bg-white z-10">
            <StockFiltersBar storeId={storeId} />
        </div>

        {/* Coluna Direita: Lista */}
        <div className="flex-1 bg-slate-50/50 overflow-y-auto p-4 custom-scrollbar">
            <div className="max-w-5xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table className="w-full text-left text-sm">
                    <thead className="bg-slate-50 text-slate-500 font-bold uppercase text-[10px] border-b border-slate-200 sticky top-0 z-10">
                        <tr>
                            <th className="px-4 py-3">Data / Hora</th>
                            <th className="px-4 py-3">Produto</th>
                            <th className="px-4 py-3 text-center">Tipo</th>
                            <th className="px-4 py-3 text-center">Qtd</th>
                            <th className="px-4 py-3">Motivo</th>
                            <th className="px-4 py-3 text-right">Resp.</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                        {movimentos.length === 0 ? (
                            <tr>
                                <td colSpan={6} className="p-10 text-center text-slate-400 flex flex-col items-center justify-center">
                                    <Package className="h-10 w-10 mb-2 opacity-20" />
                                    <p className="text-xs">Nenhuma movimenta√ß√£o neste per√≠odo.</p>
                                </td>
                            </tr>
                        ) : (
                            movimentos.map((mov: any) => (
                                <tr key={mov.id} className="hover:bg-slate-50 transition-colors">
                                    <td className="px-4 py-3 text-slate-500 whitespace-nowrap text-xs font-medium">
                                        <div className="flex items-center gap-1">
                                            <Calendar className="h-3 w-3 opacity-50" />
                                            {formatDate(mov.created_at)}
                                        </div>
                                    </td>
                                    <td className="px-4 py-3">
                                        <p className="font-bold text-slate-800 text-xs">{mov.products?.nome || 'Produto Removido'}</p>
                                        <p className="text-[10px] text-slate-400 font-mono mt-0.5">{mov.products?.codigo_barras || '-'}</p>
                                        {mov.product_variants && (
                                            <span className="inline-block text-[9px] bg-slate-100 border border-slate-200 px-1.5 rounded text-slate-500 mt-1">
                                                {mov.product_variants.nome_variante}
                                            </span>
                                        )}
                                    </td>
                                    <td className="px-4 py-3 text-center">
                                        <BadgeTipo tipo={mov.tipo} />
                                    </td>
                                    <td className="px-4 py-3 text-center font-bold text-slate-700 text-sm">
                                        {mov.quantidade}
                                    </td>
                                    <td className="px-4 py-3 text-slate-600 text-xs max-w-xs truncate" title={mov.motivo}>
                                        {mov.motivo}
                                    </td>
                                    <td className="px-4 py-3 text-right text-slate-500 text-xs">
                                        <div className="flex items-center justify-end gap-1">
                                            <User className="h-3 w-3 opacity-50" />
                                            {mov.employees?.full_name || 'Sistema'}
                                        </div>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>
        </div>

      </div>
    </div>
  )
}

function BadgeTipo({ tipo }: { tipo: string }) {
    let style = 'bg-slate-100 text-slate-600'
    
    if (tipo === 'Entrada') style = 'bg-emerald-100 text-emerald-700 border-emerald-200'
    if (tipo === 'Saida') style = 'bg-blue-100 text-blue-700 border-blue-200'
    if (tipo === 'Perda') style = 'bg-rose-100 text-rose-800 border-rose-200 font-black'
    if (tipo === 'Brinde') style = 'bg-purple-100 text-purple-700 border-purple-200'
    if (tipo === 'Ajuste') style = 'bg-amber-100 text-amber-800 border-amber-200'

    return (
        <span className={`px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide border border-transparent inline-flex items-center gap-1 ${style}`}>
            {tipo}
        </span>
    )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\estoque\movimentacoes\_components\StockFiltersBar.tsx
==================================================
'use client'

import { useRouter, usePathname, useSearchParams } from 'next/navigation'
import { useTransition, useState } from 'react'
import { Search, Filter, ArrowRightLeft, ArrowDownUp, Loader2, Plus } from 'lucide-react'
import StockMovementModalClientWrapper from './StockMovementModalClientWrapper'

// --- ESTILOS DO DESIGN SYSTEM (Alto Contraste) ---
const labelStyle = "block text-[9px] font-bold text-slate-700 uppercase mb-0.5 tracking-wider"
const inputStyle = "block w-full rounded-md border border-slate-300 bg-white shadow-sm text-slate-900 h-8 text-xs px-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 font-bold transition-all"

const getTodayString = () => new Date().toISOString().split('T')[0]
const getFirstDayOfMonthString = () => {
    const d = new Date(); d.setDate(1); return d.toISOString().split('T')[0]
}

export default function StockFiltersBar({ storeId }: { storeId: number }) {
    const router = useRouter()
    const pathname = usePathname()
    const searchParams = useSearchParams()
    const [isPending, startTransition] = useTransition()

    // Estado local sincronizado com URL ou Padr√£o
    const [tipo, setTipo] = useState(searchParams.get('tipo') || 'Todos')
    const [busca, setBusca] = useState(searchParams.get('busca') || '')
    const [dataInicio, setDataInicio] = useState(searchParams.get('inicio') || getTodayString())
    const [dataFim, setDataFim] = useState(searchParams.get('fim') || getTodayString())

    const applyFilter = () => {
        const params = new URLSearchParams(searchParams)
        
        if (tipo !== 'Todos') params.set('tipo', tipo); else params.delete('tipo')
        if (busca) params.set('busca', busca); else params.delete('busca')
        
        params.set('inicio', dataInicio)
        params.set('fim', dataFim)

        startTransition(() => {
            router.replace(`${pathname}?${params.toString()}`)
        })
    }

    const handlePresetDate = (preset: 'hoje' | 'mes') => {
        const hoje = getTodayString()
        if (preset === 'hoje') {
            setDataInicio(hoje); setDataFim(hoje);
        } else {
            setDataInicio(getFirstDayOfMonthString()); setDataFim(hoje);
        }
        // O usu√°rio clica em filtrar depois para confirmar
    }

    return (
        <div className="h-full flex flex-col">
            
            {/* Header Gradiente Laranja */}
            <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-4 flex flex-col gap-3 shadow-md z-20 shrink-0">
                <div className="flex justify-between items-center text-white">
                    <h2 className="font-bold text-sm flex items-center gap-2 uppercase tracking-wide">
                        <ArrowRightLeft className="h-4 w-4" /> Filtros
                    </h2>
                </div>
                
                {/* Busca Principal */}
                <div className="relative">
                    <input 
                        type="text" 
                        value={busca}
                        onChange={(e) => setBusca(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && applyFilter()}
                        placeholder="Buscar produto, motivo..." 
                        className="w-full h-9 pl-9 pr-3 rounded-lg border-0 bg-white shadow-lg text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-amber-300 font-bold text-xs"
                    />
                    <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-slate-400" />
                </div>
            </div>

            {/* Corpo dos Filtros */}
            <div className="flex-1 overflow-y-auto p-4 bg-white">
                <div className="space-y-4">
                    
                    {/* Bot√µes de Per√≠odo R√°pido */}
                    <div className="grid grid-cols-2 gap-2">
                        <button onClick={() => handlePresetDate('hoje')} className="px-2 py-1.5 bg-slate-100 hover:bg-amber-50 text-slate-600 hover:text-amber-700 text-[10px] font-bold rounded border border-slate-200 transition-colors">
                            Hoje
                        </button>
                        <button onClick={() => handlePresetDate('mes')} className="px-2 py-1.5 bg-slate-100 hover:bg-amber-50 text-slate-600 hover:text-amber-700 text-[10px] font-bold rounded border border-slate-200 transition-colors">
                            Este M√™s
                        </button>
                    </div>

                    <div>
                        <label className={labelStyle}>Data In√≠cio</label>
                        <input type="date" value={dataInicio} onChange={e => setDataInicio(e.target.value)} className={inputStyle} />
                    </div>
                    
                    <div>
                        <label className={labelStyle}>Data Fim</label>
                        <input type="date" value={dataFim} onChange={e => setDataFim(e.target.value)} className={inputStyle} />
                    </div>

                    <div className="border-t border-slate-100 my-2"></div>

                    <div>
                        <label className={labelStyle}>Tipo de Movimento</label>
                        <div className="relative">
                            <ArrowDownUp className="absolute left-2 top-2 h-4 w-4 text-slate-400 pointer-events-none" />
                            <select value={tipo} onChange={e => setTipo(e.target.value)} className={`${inputStyle} pl-8 cursor-pointer`}>
                                <option value="Todos">Todos</option>
                                <option value="Entrada">Entrada (Suprimento)</option>
                                <option value="Saida">Sa√≠da (Venda/Baixa)</option>
                                <option value="Perda">Perda / Quebra</option>
                                <option value="Brinde">Brinde / Cortesia</option>
                                <option value="Ajuste">Ajuste de Invent√°rio</option>
                            </select>
                        </div>
                    </div>

                    <button 
                        onClick={applyFilter}
                        disabled={isPending}
                        className="w-full bg-slate-800 hover:bg-slate-900 text-white h-9 rounded-lg font-bold text-xs flex items-center justify-center gap-2 shadow-sm transition-all active:scale-95"
                    >
                        {isPending ? <Loader2 className="h-3 w-3 animate-spin"/> : <Filter className="h-3 w-3" />}
                        FILTRAR RESULTADOS
                    </button>
                    
                    {/* NOVA POSI√á√ÉO: Abaixo do bot√£o Filtrar */}
                    <div className="pt-4 mt-4 border-t border-slate-100">
                        <StockMovementModalClientWrapper storeId={storeId} />
                    </div>

                </div>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\estoque\movimentacoes\_components\StockMovementModalClientWrapper.tsx
==================================================
'use client'

import { useState } from 'react'
import { Plus } from 'lucide-react'
import StockMovementModal from '@/components/modals/StockMovementModal'

export default function StockMovementModalClientWrapper({ storeId }: { storeId: number }) {
    const [isOpen, setIsOpen] = useState(false)

    return (
        <>
            <button 
                onClick={() => setIsOpen(true)}
                className="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 text-sm transition-colors"
            >
                <Plus className="h-4 w-4" />
                Nova Movimenta√ß√£o
            </button>

            <StockMovementModal 
                isOpen={isOpen} 
                onClose={() => {
                    setIsOpen(false)
                    // Opcional: router.refresh() √© chamado internamente no modal via revalidatePath na server action
                }} 
                storeId={storeId} 
            />
        </>
    )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\financeiro\caixa\page.tsx
==================================================
import { getResumoCaixa } from '@/lib/actions/cashflow.actions'
import CaixaInterface from '@/components/financeiro/CaixaInterface'
import { DollarSign } from 'lucide-react'

export default async function CaixaPage({ params }: { params: { storeId: string } }) {
  const storeId = parseInt(params.storeId, 10)
  const resumo = await getResumoCaixa(storeId)

  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-y-auto">
      {/* Header */}
      <div className="bg-white border-b border-gray-300 px-6 py-4 shadow-sm flex-shrink-0">
        <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <DollarSign className="h-6 w-6 text-emerald-600" />
            Livro Caixa (Movimento Di√°rio)
        </h1>
      </div>

      {/* Conte√∫do */}
      <div className="p-6 max-w-7xl mx-auto w-full">
         <CaixaInterface initialData={resumo} storeId={storeId} />
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\financeiro\comissoes\page.tsx
==================================================
// Caminho: src/app/dashboard/loja/[storeId]/financeiro/comissoes/page.tsx
import { getRelatorioComissoes } from '@/lib/actions/commission.actions'
import ComissoesInterface from '@/components/financeiro/ComissoesInterface'
import { Percent } from 'lucide-react'

export default async function ComissoesPage({ 
    params, 
    searchParams 
}: { 
    params: { storeId: string },
    searchParams: { inicio?: string, fim?: string }
}) {
    const storeId = parseInt(params.storeId, 10)
    
    // Datas padr√£o: M√™s Atual
    const hoje = new Date()
    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0]
    const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0]

    const dataInicio = searchParams.inicio || inicioMes
    const dataFim = searchParams.fim || fimMes

    // Busca dados
    const { data } = await getRelatorioComissoes(storeId, dataInicio, dataFim)

    return (
        <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-hidden">
            
            {/* Header */}
            <div className="bg-white border-b border-gray-300 px-6 py-4 shadow-sm flex-shrink-0">
                <div className="flex items-center gap-3">
                    <div className="p-2 bg-purple-100 text-purple-700 rounded-lg">
                        <Percent className="h-6 w-6" />
                    </div>
                    <div>
                        <h1 className="text-xl font-bold text-gray-800">Gest√£o de Comiss√µes</h1>
                        <p className="text-xs text-gray-500">Acompanhe e realize o pagamento de bonifica√ß√µes.</p>
                    </div>
                </div>
            </div>

            {/* Conte√∫do */}
            <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <ComissoesInterface 
                    data={data || []} 
                    storeId={storeId} 
                    periodo={{ inicio: dataInicio, fim: dataFim }} 
                />
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\financeiro\contas\page.tsx
==================================================
import { getBills } from '@/lib/actions/payable.actions'
import ContasInterface from '@/components/financeiro/ContasInterface'
import { CalendarRange } from 'lucide-react'

export default async function ContasPage({ 
    params,
    searchParams 
}: { 
    params: { storeId: string },
    searchParams: { mes?: string } 
}) {
    const storeId = parseInt(params.storeId, 10)
    
    // Padr√£o: M√™s Atual se n√£o vier na URL
    const dateRef = searchParams.mes || new Date().toISOString()
    
    const { data: bills } = await getBills(storeId, dateRef)

    // Formata√ß√£o do M√™s para Exibi√ß√£o
    const mesExtenso = new Date(dateRef).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })

    return (
        <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-hidden">
            <div className="bg-white border-b border-gray-300 px-6 py-4 shadow-sm flex justify-between items-center flex-shrink-0">
                <div className="flex items-center gap-3">
                    <div className="p-2 bg-indigo-100 text-indigo-700 rounded-lg">
                        <CalendarRange className="h-6 w-6" />
                    </div>
                    <div>
                        <h1 className="text-xl font-bold text-gray-800">Contas a Pagar</h1>
                        <p className="text-xs text-gray-500 capitalize">Refer√™ncia: {mesExtenso}</p>
                    </div>
                </div>
            </div>

            <div className="flex-1 overflow-y-auto p-6">
                <ContasInterface bills={bills || []} storeId={storeId} />
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\gaveta\page.tsx
==================================================
import { getGavetaItems } from '@/lib/actions/gaveta.actions'
import Link from 'next/link'
import { Archive, User, DollarSign, MessageCircle, Clock, AlertTriangle } from 'lucide-react'

// For√ßa a p√°gina a ser din√¢mica para sempre buscar dados frescos do banco
export const dynamic = 'force-dynamic'

export default async function GavetaPage({
  params
}: {
  params: { storeId: string }
}) {
  const storeId = parseInt(params.storeId)
  const { data: itens, success } = await getGavetaItems(storeId)

  // Fun√ß√£o auxiliar para limpar telefone
  const formatPhoneForWhatsapp = (phone: string) => {
    return phone.replace(/\D/g, '')
  }

  // Calcula dias na gaveta
  const getDaysWaiting = (dateString: string) => {
    const readyDate = new Date(dateString)
    const today = new Date()
    const diffTime = Math.abs(today.getTime() - readyDate.getTime())
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) 
  }

  return (
    <div className="p-6 max-w-7xl mx-auto min-h-[calc(100vh-64px)] flex flex-col">
      
      {/* Header */}
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-3xl font-black text-gray-800 flex items-center gap-3 tracking-tight">
            <Archive className="h-8 w-8 text-amber-600" />
            Gaveta de Prontos
          </h1>
          <p className="text-gray-500 font-medium mt-1">
            √ìculos prontos aguardando retirada pelo cliente.
          </p>
        </div>
        <div className="bg-amber-100 text-amber-800 px-4 py-2 rounded-xl font-bold flex items-center gap-2">
            <span className="text-2xl">{itens?.length || 0}</span>
            <span className="text-xs uppercase opacity-70">Aguardando</span>
        </div>
      </div>

      {!success || !itens || itens.length === 0 ? (
        <div className="flex-1 flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-200 rounded-3xl m-4">
          <Archive className="h-16 w-16 mb-4 opacity-20" />
          <p className="text-lg font-bold">A gaveta est√° vazia!</p>
          <p className="text-sm">Todos os √≥culos prontos j√° foram entregues.</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {itens.map((item: any) => {
            const diasEspera = getDaysWaiting(item.dt_montado_em)
            const isAtrasado = diasEspera > 7 // Mais de uma semana esperando
            
            // L√ìGICA DE IDENTIFICA√á√ÉO (CRUCIAL):
            // Prioriza o nome do Dependente (quem usa o √≥culos). Se n√£o houver, usa o Cliente.
            const nomePaciente = item.dependente?.nome_completo || item.customers?.full_name || 'Consumidor';
            const nomeCliente = item.customers?.full_name || 'Cliente'; // Para o WhatsApp
            
            // CORRE√á√ÉO DO BUG DO TELEFONE:
            // Tenta 'fone_movel' primeiro, depois 'mobile_phone' (fallback)
            const telefoneRaw = item.customers?.fone_movel || item.customers?.mobile_phone || '';

            // Mensagem Personalizada
            const whatsappMessage = `Ol√° ${nomeCliente.split(' ')[0]}! Tudo bem? Aqui √© da √ìtica. Os √≥culos de *${nomePaciente}* ficaram prontos! Quando puder, passe aqui para retirar e ajustar. üòé`
            const whatsappLink = `https://wa.me/55${formatPhoneForWhatsapp(telefoneRaw)}?text=${encodeURIComponent(whatsappMessage)}`

            return (
              <div key={item.id} className={`bg-white rounded-2xl shadow-sm border overflow-hidden hover:shadow-md transition-all group ${isAtrasado ? 'border-red-200 ring-1 ring-red-100' : 'border-slate-200'}`}>
                
                {/* Faixa de Status */}
                <div className={`px-4 py-2 text-xs font-black uppercase tracking-widest flex justify-between items-center ${isAtrasado ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>
                    <span className="flex items-center gap-1">
                        <Clock className="h-3 w-3" />
                        Pronto h√° {diasEspera} dia{diasEspera !== 1 && 's'}
                    </span>
                    <span className="opacity-70">OS #{item.id}</span>
                </div>

                <div className="p-5">
                    {/* Identifica√ß√£o do Paciente (Dono do √ìculos) */}
                    <div className="mb-6">
                        <h3 className="font-bold text-slate-800 text-lg truncate flex items-center gap-2" title={nomePaciente}>
                            <User className="h-5 w-5 text-slate-400 shrink-0" />
                            {nomePaciente}
                        </h3>
                        {/* Se for dependente, mostra quem √© o respons√°vel logo abaixo */}
                        {item.dependente && (
                            <p className="text-xs text-slate-500 pl-7 truncate">
                                Resp: {nomeCliente}
                            </p>
                        )}
                        <p className="text-xs text-slate-400 pl-7 mt-1">
                            Montado em: {new Date(item.dt_montado_em).toLocaleDateString('pt-BR')}
                        </p>
                    </div>

                    {/* A√ß√µes */}
                    <div className="grid grid-cols-2 gap-3">
                        <Link 
                            href={`/dashboard/loja/${storeId}/vendas/${item.venda_id || ''}`}
                            className="flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl text-xs font-bold bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors"
                        >
                            <DollarSign className="h-4 w-4" />
                            Ver Venda
                        </Link>

                        {telefoneRaw ? (
                            <a 
                                href={whatsappLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl text-xs font-bold bg-green-500 text-white hover:bg-green-600 shadow-lg shadow-green-200 transition-transform active:scale-95"
                            >
                                <MessageCircle className="h-4 w-4" />
                                Avisar
                            </a>
                        ) : (
                            <button disabled className="flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl text-xs font-bold bg-gray-100 text-gray-400 cursor-not-allowed">
                                <AlertTriangle className="h-4 w-4" />
                                Sem Whats
                            </button>
                        )}
                    </div>
                </div>
              </div>
            )
          })}
        </div>
      )}
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\importacao\page.tsx
==================================================
'use client'

import { useState, useTransition, useRef } from 'react'
import { useParams, useRouter } from 'next/navigation'
import { UploadCloud, FileText, CheckCircle, AlertTriangle, Loader2, Save, ArrowLeft, Package } from 'lucide-react'
import { parseNfeAndPreview, saveImportedData, type XmlPreviewData } from '@/lib/actions/xml.actions'

// Helper para formatar moeda
const money = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

export default function ImportacaoPage() {
    const params = useParams()
    const router = useRouter()
    const storeId = parseInt(params.storeId as string, 10)

    // Estados
    const [file, setFile] = useState<File | null>(null)
    const [previewData, setPreviewData] = useState<XmlPreviewData | null>(null)
    const [isProcessing, startTransition] = useTransition()
    const [isSaving, startSaveTransition] = useTransition()
    const [errorMessage, setErrorMessage] = useState<string | null>(null)
    const [successMessage, setSuccessMessage] = useState<string | null>(null)
    
    // Estado para anima√ß√£o de arrastar
    const [isDragging, setIsDragging] = useState(false)
    
    const fileInputRef = useRef<HTMLInputElement>(null)

    // 1. Lidar com Sele√ß√£o via Clique
    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            validateAndSetFile(e.target.files[0])
        }
    }

    // 2. Lidar com Arrastar e Soltar (Drag & Drop)
    const handleDragOver = (e: React.DragEvent) => {
        e.preventDefault() // Impede o navegador de abrir o arquivo
        e.stopPropagation()
        setIsDragging(true)
    }

    const handleDragLeave = (e: React.DragEvent) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(false)
    }

    const handleDrop = (e: React.DragEvent) => {
        e.preventDefault() // Impede o navegador de abrir o arquivo
        e.stopPropagation()
        setIsDragging(false)

        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            validateAndSetFile(e.dataTransfer.files[0])
        }
    }

    const validateAndSetFile = (file: File) => {
        // Valida√ß√£o simples de tipo (XML)
        if (file.type === "text/xml" || file.name.toLowerCase().endsWith(".xml")) {
            setFile(file)
            setErrorMessage(null)
            setSuccessMessage(null)
            setPreviewData(null)
        } else {
            setErrorMessage("Arquivo inv√°lido. Por favor, envie um arquivo XML.")
        }
    }

    // 3. Enviar para Leitura (Preview)
    const handleProcessar = () => {
        if (!file) return
        
        const formData = new FormData()
        formData.append('xml_file', file)

        startTransition(async () => {
            const result = await parseNfeAndPreview(formData)
            if (result.success && result.data) {
                setPreviewData(result.data)
            } else {
                setErrorMessage(result.message || "Erro desconhecido ao ler XML.")
            }
        })
    }

    // 4. Confirmar e Gravar no Banco
    const handleConfirmarImportacao = () => {
        if (!previewData) return

        if (!confirm("Tem certeza? Isso ir√° cadastrar/atualizar o estoque dos produtos listados.")) return

        startSaveTransition(async () => {
            const result = await saveImportedData(previewData, storeId)
            if (result.success) {
                setSuccessMessage(result.message!)
                setPreviewData(null)
                setFile(null)
            } else {
                setErrorMessage(result.message || "Erro ao salvar dados.")
            }
        })
    }

    const handleReset = () => {
        setFile(null)
        setPreviewData(null)
        setSuccessMessage(null)
        setErrorMessage(null)
        if (fileInputRef.current) fileInputRef.current.value = ''
    }

    // --- RENDERIZA√á√ÉO ---

    return (
        <div className="p-6 max-w-7xl mx-auto h-[calc(100vh-64px)] flex flex-col overflow-hidden">
            
            {/* Cabe√ßalho */}
            <div className="mb-6 flex justify-between items-center flex-shrink-0">
                <div>
                    <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <FileText className="h-6 w-6 text-blue-600" /> 
                        Importa√ß√£o de Nota Fiscal (XML)
                    </h1>
                    <p className="text-sm text-gray-500">Cadastre produtos e estoque automaticamente.</p>
                </div>
                <button 
                    onClick={() => router.back()}
                    className="text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1 px-3 py-2 rounded border hover:bg-gray-50 transition-colors"
                >
                    <ArrowLeft className="h-4 w-4" /> Voltar
                </button>
            </div>

            {/* Mensagens de Sucesso/Erro */}
            {errorMessage && (
                <div className="mb-4 p-4 bg-red-100 border border-red-200 text-red-700 rounded-lg flex items-center gap-2 animate-in fade-in slide-in-from-top-2">
                    <AlertTriangle className="h-5 w-5" /> {errorMessage}
                </div>
            )}
            
            {successMessage && (
                <div className="mb-4 p-6 bg-green-50 border border-green-200 text-green-800 rounded-xl flex flex-col items-center justify-center text-center animate-in zoom-in duration-300">
                    <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-3">
                        <CheckCircle className="h-8 w-8 text-green-600" />
                    </div>
                    <h3 className="text-xl font-bold mb-1">Sucesso!</h3>
                    <p className="mb-4">{successMessage}</p>
                    <button onClick={handleReset} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 shadow-sm">
                        Importar Outra Nota
                    </button>
                </div>
            )}

            {/* √ÅREA 1: UPLOAD (Se n√£o houver preview e n√£o for sucesso) */}
            {!previewData && !successMessage && (
                <div 
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                    className={`flex-1 flex flex-col items-center justify-center border-2 border-dashed rounded-xl transition-all duration-200 p-10 group 
                        ${isDragging ? 'border-blue-500 bg-blue-50 scale-[1.01]' : 'border-gray-300 bg-gray-50 hover:bg-blue-50'}`}
                >
                    <div className={`p-4 rounded-full shadow-sm mb-4 transition-transform ${isDragging ? 'bg-blue-200 scale-110' : 'bg-white group-hover:scale-110'}`}>
                        <UploadCloud className={`h-10 w-10 ${isDragging ? 'text-blue-700' : 'text-blue-500'}`} />
                    </div>
                    <label className="block text-center cursor-pointer">
                        <span className="text-lg font-semibold text-gray-700">
                            {isDragging ? "Pode soltar o XML agora!" : "Clique para selecionar o arquivo XML"}
                        </span>
                        <span className="block text-sm text-gray-400 mt-1">
                            {isDragging ? "Solte para processar" : "ou arraste e solte aqui"}
                        </span>
                        <input 
                            ref={fileInputRef}
                            type="file" 
                            accept=".xml" 
                            onChange={handleFileChange} 
                            className="hidden" 
                        />
                    </label>
                    
                    {file && (
                        <div className="mt-6 flex items-center gap-3 bg-white px-4 py-2 rounded-lg shadow-sm border border-blue-200 animate-in fade-in slide-in-from-bottom-2">
                            <FileText className="h-5 w-5 text-blue-600" />
                            <span className="font-medium text-gray-800">{file.name}</span>
                            <span className="text-xs text-gray-400">({(file.size / 1024).toFixed(1)} KB)</span>
                        </div>
                    )}

                    {file && (
                        <button 
                            onClick={handleProcessar}
                            disabled={isProcessing}
                            className="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-md flex items-center gap-2 disabled:opacity-50"
                        >
                            {isProcessing ? <Loader2 className="h-5 w-5 animate-spin" /> : "PROCESSAR ARQUIVO"}
                        </button>
                    )}
                </div>
            )}

            {/* √ÅREA 2: PREVIEW (Tabela de Confer√™ncia) */}
            {previewData && !successMessage && (
                <div className="flex-1 flex flex-col overflow-hidden bg-white rounded-xl shadow border border-gray-200 animate-in fade-in slide-in-from-bottom-4">
                    
                    {/* Resumo da Nota */}
                    <div className="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center flex-shrink-0">
                        <div className="flex gap-6">
                            <div>
                                <p className="text-xs text-gray-500 uppercase font-bold">Fornecedor</p>
                                <p className="font-bold text-gray-800">{previewData.fornecedor.fantasia}</p>
                                <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${previewData.fornecedor.status_sistema === 'Novo' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>
                                    {previewData.fornecedor.status_sistema}
                                </span>
                            </div>
                            <div>
                                <p className="text-xs text-gray-500 uppercase font-bold">Nota Fiscal</p>
                                <p className="text-sm text-gray-700">N¬∫ {previewData.nfe_numero} - S√©rie {previewData.nfe_serie}</p>
                            </div>
                        </div>

                        <div className="text-right">
                            <p className="text-xs text-gray-500 uppercase font-bold">Total dos Produtos</p>
                            <p className="text-xl font-black text-blue-700">
                                {money(previewData.itens.reduce((acc, i) => acc + i.valor_total, 0))}
                            </p>
                        </div>
                    </div>

                    {/* Tabela de Itens */}
                    <div className="flex-1 overflow-auto custom-scrollbar">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-white sticky top-0 z-10 shadow-sm text-xs font-bold text-gray-500 uppercase">
                                <tr>
                                    <th className="px-4 py-3 border-b">Status</th>
                                    <th className="px-4 py-3 border-b">C√≥d. Forn.</th>
                                    <th className="px-4 py-3 border-b">Descri√ß√£o</th>
                                    <th className="px-4 py-3 border-b">NCM</th>
                                    <th className="px-4 py-3 border-b text-center">Qtd</th>
                                    <th className="px-4 py-3 border-b text-right">Custo Unit.</th>
                                    <th className="px-4 py-3 border-b text-right text-emerald-600">Venda Sugerida</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {previewData.itens.map((item, idx) => (
                                    <tr key={idx} className="hover:bg-blue-50 transition-colors">
                                        <td className="px-4 py-3">
                                            {item.status_sistema === 'Novo' ? (
                                                <span className="inline-flex items-center gap-1 px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold border border-green-200">
                                                    <Package className="h-3 w-3" /> Novo
                                                </span>
                                            ) : (
                                                <span className="inline-flex items-center gap-1 px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold border border-blue-200">
                                                    <CheckCircle className="h-3 w-3" /> Somar ({item.estoque_atual})
                                                </span>
                                            )}
                                        </td>
                                        <td className="px-4 py-3 text-gray-500 font-mono text-xs">{item.codigo_fornecedor}</td>
                                        <td className="px-4 py-3 font-medium text-gray-800">{item.descricao}</td>
                                        <td className="px-4 py-3 text-gray-500">{item.ncm}</td>
                                        <td className="px-4 py-3 text-center font-bold bg-gray-50">{item.quantidade}</td>
                                        <td className="px-4 py-3 text-right">{money(item.valor_unitario)}</td>
                                        <td className="px-4 py-3 text-right font-bold text-emerald-600 bg-emerald-50/30">
                                            {money(item.valor_unitario * 2)}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Footer de A√ß√£o */}
                    <div className="p-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3 flex-shrink-0">
                        <button 
                            onClick={handleReset}
                            className="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-white font-bold text-sm"
                        >
                            Cancelar
                        </button>
                        <button 
                            onClick={handleConfirmarImportacao}
                            disabled={isSaving}
                            className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md flex items-center gap-2 disabled:opacity-70"
                        >
                            {isSaving ? <Loader2 className="h-4 w-4 animate-spin" /> : <Save className="h-4 w-4" />}
                            CONFIRMAR IMPORTA√á√ÉO
                        </button>
                    </div>
                </div>
            )}
        </div>
    )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\pdv-express\page.tsx
==================================================
import { getEmployees } from '@/lib/actions/employee.actions'
import PdvExpressInterface from '@/components/vendas/PdvExpressInterface'
import { Zap } from 'lucide-react'

export const dynamic = 'force-dynamic'

export default async function PdvExpressPage({ params }: { params: { storeId: string } }) {
  const storeId = parseInt(params.storeId, 10)

  // Apenas buscamos os funcion√°rios. 
  // N√ÉO INICIAMOS MAIS A VENDA AQUI (Isso corrige o bug de vendas fantasmas)
  const employees = await getEmployees(storeId)
  
  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-hidden">
      
      {/* Header Simplificado */}
      <div className="bg-white border-b border-gray-300 px-6 py-3 shadow-sm flex justify-between items-center flex-shrink-0">
        <div className="flex items-center gap-2">
            <div className="p-1.5 bg-yellow-100 text-yellow-700 rounded-lg">
                <Zap className="h-6 w-6" />
            </div>
            <div>
                <h1 className="text-xl font-bold text-gray-800">PDV Express</h1>
                <p className="text-xs text-gray-500">Venda R√°pida (Balc√£o)</p>
            </div>
        </div>
      </div>

      {/* √Årea de Trabalho */}
      <div className="flex-1 p-4 overflow-hidden">
         <PdvExpressInterface 
            storeId={storeId}
            employees={employees} 
      />
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\pos-venda\page.tsx
==================================================
// Caminho: src/app/dashboard/loja/[storeId]/pos-venda/page.tsx
import { getFilaPosVenda } from '@/lib/actions/postsales.actions'
import PostSalesInterface from '@/components/pos-venda/PostSalesInterface'
import { HeartHandshake } from 'lucide-react'

export default async function PosVendaPage({ params }: { params: { storeId: string } }) {
  const storeId = parseInt(params.storeId, 10)
  const fila = await getFilaPosVenda(storeId)

  return (
    // 1. FUNDO GRADIENTE "SOFT UI"
    <div className="flex flex-col h-[calc(100vh-64px)] bg-gradient-to-br from-slate-100 via-blue-50 to-slate-100 overflow-hidden">
      
      {/* Header Flutuante/Transparente */}
      <div className="px-8 py-5 flex-shrink-0 backdrop-blur-sm bg-white/50 border-b border-white/20">
        <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3 drop-shadow-sm">
            <div className="p-2.5 bg-white rounded-xl shadow-md text-pink-500">
                <HeartHandshake className="h-7 w-7" />
            </div>
            Sucesso do Cliente
        </h1>
        <p className="text-sm font-medium text-slate-500 mt-1 ml-14">
            Gest√£o de adapta√ß√£o e satisfa√ß√£o.
        </p>
      </div>

      {/* √Årea de Trabalho */}
      <div className="flex-1 overflow-hidden p-6">
         <PostSalesInterface initialQueue={fila} storeId={storeId} />
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\reports\page.tsx
==================================================
'use client'; 
import { useParams } from 'next/navigation';

export default function PlaceholderPage() {
    const params = useParams();
    const storeId = params.storeId;
    
    return (
        <div className="p-10">
            <h1 className="text-3xl font-bold">P√°gina de Destino: {storeId}</h1>
            <p className="mt-4 text-gray-600">Conte√∫do em constru√ß√£o.</p>
        </div>
    );
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\reports\vendas\page.tsx
==================================================
import { getRelatorioVendas } from '@/lib/actions/reports.actions'
import TabelaVendas from '@/components/relatorios/TabelaVendas'
import { Calendar, Filter } from 'lucide-react'
import { redirect } from 'next/navigation'

export default async function RelatorioVendasPage({
  params,
  searchParams,
}: {
  params: { storeId: string }
  searchParams: { inicio?: string; fim?: string }
}) {
  const storeId = parseInt(params.storeId, 10)

  // Datas Padr√£o: M√™s Atual
  const hoje = new Date()
  const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0]
  const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0]

  const dataInicio = searchParams.inicio || inicioMes
  const dataFim = searchParams.fim || fimMes

  // Busca Dados no Server
  const dados = await getRelatorioVendas(storeId, dataInicio, dataFim)

  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-hidden">
      
      {/* HEADER DE FILTROS GLOBAIS */}
      <div className="bg-white border-b border-gray-300 px-4 py-3 flex items-center justify-between shadow-sm flex-shrink-0">
        <h1 className="text-lg font-bold text-gray-800 flex items-center gap-2">
            <Filter className="h-5 w-5 text-blue-600" />
            Relat√≥rio de Vendas Detalhado
        </h1>

        {/* Formul√°rio de Filtro de Data (Server Side Navigation) */}
        <form className="flex items-center gap-2">
            <div className="flex items-center bg-gray-100 rounded border border-gray-300 px-2 py-1">
                <Calendar className="h-4 w-4 text-gray-500 mr-2" />
                <input 
                    name="inicio" 
                    type="date" 
                    defaultValue={dataInicio} 
                    className="bg-transparent border-none text-xs font-bold text-gray-700 focus:ring-0 p-0" 
                    required
                />
                <span className="mx-2 text-gray-400">-</span>
                <input 
                    name="fim" 
                    type="date" 
                    defaultValue={dataFim} 
                    className="bg-transparent border-none text-xs font-bold text-gray-700 focus:ring-0 p-0" 
                    required
                />
            </div>
            <button type="submit" className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-bold shadow-sm">
                FILTRAR
            </button>
        </form>
      </div>

      {/* √ÅREA DA TABELA */}
      <div className="flex-1 p-4 overflow-hidden">
         <TabelaVendas data={dados} storeId={storeId} />
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\vendas\page.tsx
==================================================
// Caminho: src/app/dashboard/loja/[storeId]/vendas/page.tsx
import { getSalesList } from '@/lib/actions/vendas.actions'
import Link from 'next/link'
// CORRE√á√ÉO: Adicionei RefreshCcw na lista de imports abaixo
import { Plus, ShoppingCart, Calendar, User, ArrowRight, AlertCircle, CheckCircle2, XCircle, Clock, RefreshCcw } from 'lucide-react'
import { formatCurrency } from '@/lib/utils'
import VendasFilter from '@/components/vendas/VendasFilter'

export const dynamic = 'force-dynamic'

export default async function VendasListPage({
  params,
  searchParams
}: {
  params: { storeId: string }
  searchParams: { mode?: string, inicio?: string, fim?: string }
}) {
  const storeId = parseInt(params.storeId)

  // Recupera filtros da URL
  const mode = (searchParams.mode as 'pendencias' | 'historico') || 'pendencias'
  const startDate = searchParams.inicio
  const endDate = searchParams.fim

  // Busca dados filtrados
  const { data: vendas, success } = await getSalesList(storeId, { mode, startDate, endDate })

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    })
  }

  // Helper de Status Visual
  const getStatusBadge = (status: string) => {
      if (status === 'Fechada') return <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-black bg-green-100 text-green-700 border border-green-200 uppercase"><CheckCircle2 className="h-3 w-3"/> Fechada</span>
      if (status === 'Cancelada') return <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-black bg-red-100 text-red-700 border border-red-200 uppercase"><XCircle className="h-3 w-3"/> Cancelada</span>
      // Agora o √≠cone RefreshCcw vai funcionar
      if (status === 'Devolvida') return <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-black bg-purple-100 text-purple-700 border border-purple-200 uppercase"><RefreshCcw className="h-3 w-3"/> Devolvida</span>
      return <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-black bg-yellow-100 text-yellow-800 border border-yellow-200 uppercase"><Clock className="h-3 w-3"/> Em Aberto</span>
  }

  return (
    <div className="p-6 max-w-7xl mx-auto flex flex-col h-[calc(100vh-64px)]">
      
      {/* Header */}
      <div className="flex justify-between items-center mb-6 flex-shrink-0">
        <div>
          <h1 className="text-3xl font-black text-gray-800 flex items-center gap-2 tracking-tight">
            <ShoppingCart className="h-8 w-8 text-blue-600" />
            Central de Vendas
          </h1>
          <p className="text-gray-500 text-sm font-medium mt-1">Gerencie fechamentos e hist√≥rico.</p>
        </div>
        <Link
          href={`/dashboard/loja/${storeId}/atendimento`}
          className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-green-200 transition-all hover:-translate-y-0.5 active:scale-95"
        >
          <Plus className="h-5 w-5" />
          NOVA VENDA
        </Link>
      </div>

      {/* Componente de Filtro */}
      <VendasFilter />

      {/* Tabela de Resultados */}
      <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col flex-1">
        
        <div className={`px-6 py-3 border-b border-slate-200 flex items-center justify-between flex-shrink-0 ${mode === 'pendencias' ? 'bg-yellow-50' : 'bg-slate-50'}`}>
            <h2 className={`font-bold flex items-center gap-2 ${mode === 'pendencias' ? 'text-yellow-800' : 'text-slate-700'}`}>
                {mode === 'pendencias' ? <AlertCircle className="h-5 w-5" /> : <Calendar className="h-5 w-5" />}
                {mode === 'pendencias' ? 'Fila de Pend√™ncias' : 'Hist√≥rico do Per√≠odo'} 
                <span className="opacity-60 text-sm ml-1">({vendas?.length || 0})</span>
            </h2>
        </div>

        <div className="overflow-y-auto flex-1 p-0">
          <table className="w-full text-left border-collapse">
            <thead className="bg-slate-50 sticky top-0 z-10">
              <tr className="text-slate-500 text-xs uppercase font-bold border-b border-slate-200">
                <th className="p-4 w-40">ID / Data</th>
                <th className="p-4">Cliente</th>
                <th className="p-4 text-center">Status</th>
                <th className="p-4 text-right">Total</th>
                <th className="p-4 text-right">Falta Pagar</th>
                <th className="p-4 text-center w-24">A√ß√£o</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {!success || !vendas || vendas.length === 0 ? (
                <tr>
                  <td colSpan={6} className="p-12 text-center text-gray-400">
                    <p className="text-lg font-medium">Nenhum registro encontrado.</p>
                    {mode === 'pendencias' ? (
                        <p className="text-sm">Tudo limpo! Nenhuma venda em aberto.</p>
                    ) : (
                        <p className="text-sm">Tente ajustar as datas do filtro.</p>
                    )}
                  </td>
                </tr>
              ) : (
                vendas.map((venda: any) => (
                  <tr key={venda.id} className="hover:bg-slate-50 transition-colors group">
                    <td className="p-4">
                      <div className="font-bold text-slate-800">#{venda.id}</div>
                      <div className="text-[10px] text-slate-500 flex items-center gap-1 mt-0.5">
                        <Calendar className="h-3 w-3" />
                        {formatDate(venda.created_at)}
                      </div>
                    </td>
                    <td className="p-4">
                      <div className="font-bold text-slate-700 flex items-center gap-2">
                        <User className="h-4 w-4 text-blue-400" />
                        {venda.customers?.full_name || 'Consumidor Final'}
                      </div>
                    </td>
                    <td className="p-4 text-center">
                      {getStatusBadge(venda.status)}
                    </td>
                    <td className="p-4 text-right font-bold text-slate-600">
                      {formatCurrency(venda.valor_final)}
                    </td>
                    <td className="p-4 text-right">
                      <span className={`font-black ${venda.valor_restante > 0.01 ? 'text-red-600' : 'text-emerald-600'}`}>
                        {formatCurrency(venda.valor_restante)}
                      </span>
                    </td>
                    <td className="p-4 text-center">
                      <Link
                        href={`/dashboard/loja/${storeId}/vendas/${venda.id}`}
                        className="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all"
                        title="Ver Detalhes"
                      >
                        <ArrowRight className="h-4 w-4" />
                      </Link>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\vendas\[vendaId]\page.tsx
==================================================
// ARQUIVO: src/app/dashboard/loja/[storeId]/vendas/[vendaId]/page.tsx

import { notFound } from 'next/navigation'
import { revalidatePath } from 'next/cache'
import { getVendaPageData, type VendaPageData } from '@/lib/actions/vendas.actions'
import VendaInterface from '@/components/vendas/VendaInterface'

type Props = {
  params: { storeId: string; vendaId: string }
  searchParams: { employee_id?: string; employee_name?: string; open_payment?: string }
}

export default async function VendaPage({ params, searchParams }: Props) {
  const storeId = parseInt(params.storeId)
  const vendaId = parseInt(params.vendaId)
  
  if (isNaN(storeId) || isNaN(vendaId)) return notFound()

  // CORRE√á√ÉO: Usamos 'success' e 'message' em vez de 'error' [cite: 1483]
  const { success, data, message } = await getVendaPageData(vendaId, storeId)
  
  // Verifica se a busca falhou ou se os dados essenciais n√£o vieram
  if (!success || !data || !data.venda) {
    console.error('Erro venda:', message)
    return notFound()
  }

  // Agora 'data' √© seguro. Desestruturamos as propriedades necess√°rias.
  const {
    venda, 
    customer, 
    employee, 
    vendaItens, 
    pagamentos, 
    serviceOrders, 
    financiamento,
    lentes,
    armacoes,
    tratamentos
  } = data

  const handleDataReload = async () => {
    'use server'
    revalidatePath(`/dashboard/loja/${storeId}/vendas/${vendaId}`)
  }

  const isVendaFechadaOuCancelada = ['Fechada', 'Cancelada'].includes(venda.status)
  const isQuitado = (venda.valor_restante ?? 0) <= 0.01;

  return (
    <VendaInterface 
      venda={venda}
      customer={customer}
      employee={employee}
      vendaItens={vendaItens}
      serviceOrders={serviceOrders}
      pagamentos={pagamentos}
      financiamento={financiamento}
      lentes={lentes || []}
      armacoes={armacoes || []}
      tratamentos={tratamentos || []}
      isQuitado={isQuitado}
      isVendaFechadaOuCancelada={isVendaFechadaOuCancelada}
      onDataReload={handleDataReload}
    />
  )
}

==================================================
ARQUIVO: .\src\app\dashboard\loja\[storeId]\vendas\[vendaId]\os\page.tsx
==================================================
// ARQUIVO: src/app/dashboard/loja/[storeId]/vendas/[vendaId]/os/page.tsx
'use client'

import {
  useState,
  useEffect,
  useCallback,
  useTransition,
  useRef,
} from 'react'
import { useFormState, useFormStatus } from 'react-dom'
import { useParams, useRouter, useSearchParams } from 'next/navigation'
import {
  Loader2, Save, Trash2, ChevronLeft, ChevronRight, 
  Eye, Glasses, User, Ruler, Truck, Plus, History, FileDown, CalendarClock,
  MessageCircle, Sparkles 
} from 'lucide-react'
import {
  saveServiceOrder,
  deleteServiceOrder,
  type OSPageData,
  type SaveSOResult,
  type PrescriptionHistoryItem
} from '@/lib/actions/vendas.actions'
import { findCompatibleLeftover, type LeftoverMatch } from '@/lib/actions/stock.actions'
import { Database } from '@/lib/database.types'
import AddDependenteModal from '@/components/modals/AddDependenteModal'
import PrescriptionHistoryModal from '@/components/modals/PrescriptionHistoryModal'

type ServiceOrderWithLinks = any
type Dependente = Database['public']['Tables']['dependentes']['Row']

const toDateTimeInput = (isoString: string | null | undefined) => {
    if (!isoString) return '';
    return new Date(isoString).toISOString().slice(0, 16);
}

const formatDate = (d: string) => {
    if (!d) return ''
    return new Date(d).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
}

// --- ESTILOS DO DESIGN SYSTEM (COMPACTO) ---
const cardBase = "rounded-xl shadow-sm border border-white/20 p-3 flex flex-col relative overflow-hidden" // p-5 -> p-3
const cardBlue = `${cardBase} bg-gradient-to-br from-blue-600 to-indigo-700 shadow-blue-100`
const cardSlate = `${cardBase} bg-gradient-to-br from-slate-600 to-slate-700 shadow-slate-200` 
const cardViolet = `${cardBase} bg-gradient-to-br from-indigo-600 to-violet-700 shadow-indigo-100` 
const cardTeal = `${cardBase} bg-gradient-to-br from-teal-500 to-emerald-600 shadow-emerald-100` 
const cardAmber = `${cardBase} bg-gradient-to-br from-amber-500 to-orange-600 shadow-orange-100` 

const labelStyle = 'block text-[10px] font-bold text-white/80 mb-0.5 uppercase tracking-wider' // mb-1 -> mb-0.5
const inputStyle = 'block w-full rounded border-0 bg-white shadow-sm text-gray-900 h-7 text-xs px-2 focus:ring-1 focus:ring-white/50 focus:outline-none font-semibold placeholder:font-normal placeholder:text-gray-400 disabled:bg-gray-200 disabled:text-gray-500' // h-10 -> h-7, text-sm -> text-xs
const gridInput = `${inputStyle} text-center` // removido text-lg

const baseButtonStyle = 'px-3 py-1.5 text-xs rounded-lg shadow-sm disabled:opacity-50 focus:outline-none transition-all duration-200 font-bold flex items-center gap-2'

// --- COMPONENTE: INPUT DE GRAU ---
function DegreeInput({ name, value, onChange, placeholder, className }: { name: string, value: string, onChange: (val: string) => void, placeholder?: string, className?: string }) {
    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        let raw = e.target.value.replace(/\D/g, '') 
        if (!raw) { onChange(''); return }
        const val = parseInt(raw, 10) / 100 
        const isNegative = value.includes('-')
        const formatted = val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
        const finalValue = isNegative ? `-${formatted}` : `+${formatted}`
        onChange(finalValue)
    }

    const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === '-') {
            e.preventDefault()
            if (!value.includes('-')) onChange(value.replace('+', '').replace('-', '') ? `-${value.replace('+', '')}` : '-')
        }
        if (e.key === '+') {
            e.preventDefault()
            if (value.includes('-')) onChange(value.replace('-', '+'))
            else if (!value.includes('+')) onChange(`+${value}`)
        }
    }

    const isNegative = value.includes('-')
    const isPositive = value.includes('+')
    const textColor = isNegative ? 'text-red-600' : isPositive ? 'text-green-600' : 'text-gray-900'

    return (
        <input 
            name={name}
            value={value}
            onChange={handleChange}
            onKeyDown={handleKeyDown}
            className={`${className} ${textColor}`}
            placeholder={placeholder || "0,00"}
            autoComplete="off"
        />
    )
}

// --- BADGE DE SOBRAS ---
const LeftoverBadge = ({ matches, label }: { matches: LeftoverMatch[], label: string }) => {
      if (matches.length === 0) return null
      return (
          <div className="col-span-7 bg-amber-100/90 backdrop-blur-sm border border-amber-200 rounded p-1 mb-1 flex items-center justify-between animate-in slide-in-from-top-2 shadow-sm">
              <div className="flex items-center gap-1 text-[10px] text-amber-900 font-bold">
                  <Sparkles className="h-3 w-3 text-amber-600 fill-amber-600 animate-pulse" />
                  {matches.length} Lente(s) de Sobra ({label})
              </div>
              <div className="flex gap-1">
                  {matches.map(m => (
                      <span key={m.id} className="text-[9px] bg-white border border-amber-300 px-1 rounded text-amber-800 font-mono font-bold" title={m.nome_variante}>
                          √ò{m.diametro}
                      </span>
                  ))}
              </div>
          </div>
      )
}

// TIPO DO FORMUL√ÅRIO
type FormProps = Omit<OSPageData, 'oftalmologistas'> & {
    storeId: number
    vendaId: number
    oftalmosList: OSPageData['oftalmologistas']
    authedEmployeeName: string
    onListChange: (l: any) => void
    saveState: SaveSOResult
    dispatch: (payload: FormData) => void
    venda: any
}

function ServiceOrderFormContent({
  storeId, vendaId, customer, vendaItens, dependentes: initialDependentes, oftalmosList, employees, existingOrders, authedEmployeeName, onListChange, saveState, dispatch,
  venda 
}: FormProps) {
  
  const router = useRouter()
  const searchParams = useSearchParams()
  const targetOsId = searchParams.get('os_id')

  const { pending: isSaving } = useFormStatus()
  const [isDeleting, startDeleteTransition] = useTransition()
  
  const [currentIndex, setCurrentIndex] = useState(() => {
      if (targetOsId && existingOrders.length > 0) {
          const foundIndex = existingOrders.findIndex((o: any) => o.id === parseInt(targetOsId))
          return foundIndex !== -1 ? foundIndex : -1
      }
      return -1
  })

  const [isDepModalOpen, setIsDepModalOpen] = useState(false)
  const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false)
  const [localDependentes, setLocalDependentes] = useState<Dependente[]>(initialDependentes)

  const lastSuccessRef = useRef<number | undefined>(0);

  // --- STATES DO FORM ---
  const [protocolo, setProtocolo] = useState('') 
  const [dependenteId, setDependenteId] = useState('') 
  const [oftalmologistaId, setOftalmologistaId] = useState('')
  
  // V√≠nculos
  const [lenteOdItemId, setLenteOdItemId] = useState('')
  const [lenteOeItemId, setLenteOeItemId] = useState('')
  const [armacaoItemId, setArmacaoItemId] = useState('')
  
  // Receita
  const [longeOdEsf, setLongeOdEsf] = useState(''); const [longeOdCil, setLongeOdCil] = useState(''); const [longeOdEixo, setLongeOdEixo] = useState('')
  const [longeOeEsf, setLongeOeEsf] = useState(''); const [longeOeCil, setLongeOeCil] = useState(''); const [longeOeEixo, setLongeOeEixo] = useState('')
  const [pertoOdEsf, setPertoOdEsf] = useState(''); const [pertoOdCil, setPertoOdCil] = useState(''); const [pertoOdEixo, setPertoOdEixo] = useState('')
  const [pertoOeEsf, setPertoOeEsf] = useState(''); const [pertoOeCil, setPertoOeCil] = useState(''); const [pertoOeEixo, setPertoOeEixo] = useState('')
  const [adicao, setAdicao] = useState('')
  
  // Medidas
  const [medH, setMedH] = useState(''); const [medV, setMedV] = useState(''); const [medDiag, setMedDiag] = useState(''); const [medPonte, setMedPonte] = useState('')
  const [dnpOd, setDnpOd] = useState(''); const [dnpOe, setDnpOe] = useState('');
  const [altOd, setAltOd] = useState(''); const [altOe, setAltOe] = useState(''); const [diametro, setDiametro] = useState('')
  
  // Lab e Prazos
  const [dtPedido, setDtPedido] = useState(''); const [pedidoPorId, setPedidoPorId] = useState(''); const [labNome, setLabNome] = useState('')
  const [dtChegou, setDtChegou] = useState(''); const [dtMontado, setDtMontado] = useState(''); const [dtEntregue, setDtEntregue] = useState('')
  const [dtPrometido, setDtPrometido] = useState(''); const [obsOs, setObsOs] = useState('')
  
  // Sobras
  const [odMatches, setOdMatches] = useState<LeftoverMatch[]>([])
  const [oeMatches, setOeMatches] = useState<LeftoverMatch[]>([])

  // Monitora OD para sobras
  useEffect(() => {
      const timer = setTimeout(async () => {
          if (longeOdEsf && longeOdCil) {
              const matches = await findCompatibleLeftover(storeId, longeOdEsf, longeOdCil)
              setOdMatches(matches)
          } else setOdMatches([])
      }, 800)
      return () => clearTimeout(timer)
  }, [longeOdEsf, longeOdCil, storeId])

  // Monitora OE para sobras
  useEffect(() => {
      const timer = setTimeout(async () => {
          if (longeOeEsf && longeOeCil) {
              const matches = await findCompatibleLeftover(storeId, longeOeEsf, longeOeCil)
              setOeMatches(matches)
          } else setOeMatches([])
      }, 800)
      return () => clearTimeout(timer)
  }, [longeOeEsf, longeOeCil, storeId])

  const itensLente = vendaItens.filter(i => i.item_tipo === 'Lente')
  const itensArmacao = vendaItens.filter(i => i.item_tipo === 'Armacao')
  
  // Cast 'as any' no currentOrder
  const currentOrder = (currentIndex >= 0 && currentIndex < existingOrders.length ? existingOrders[currentIndex] : undefined) as any

  useEffect(() => {
    if (saveState.success && saveState.data && saveState.timestamp !== lastSuccessRef.current) {
      alert(saveState.message)
      const savedOS = saveState.data as ServiceOrderWithLinks
      let newList = [...existingOrders]
      const idx = newList.findIndex(o => o.id === savedOS.id)
      if (idx > -1) newList[idx] = savedOS; else newList.push(savedOS)
      newList.sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())
      onListChange(newList)
      setCurrentIndex(newList.findIndex(o => o.id === savedOS.id))
      lastSuccessRef.current = saveState.timestamp;
    }
  }, [saveState, onListChange, existingOrders])

  const resetForm = useCallback(() => {
    setDependenteId(''); setOftalmologistaId(''); setLenteOdItemId(''); setLenteOeItemId(''); setArmacaoItemId('')
    setLongeOdEsf(''); setLongeOdCil(''); setLongeOdEixo(''); setLongeOeEsf(''); setLongeOeCil(''); setLongeOeEixo('')
    setPertoOdEsf(''); setPertoOdCil(''); setPertoOdEixo(''); setPertoOeEsf(''); setPertoOeCil(''); setPertoOeEixo(''); setAdicao('')
    setMedH(''); setMedV(''); setMedDiag(''); setMedPonte(''); setDnpOd(''); setDnpOe(''); setAltOd(''); setAltOe(''); setDiametro('')
    setDtPedido(''); setPedidoPorId(''); setLabNome(''); setDtChegou(''); setDtMontado(''); setDtEntregue(''); setDtPrometido(''); setObsOs('')
    setProtocolo('')
  }, [])

  useEffect(() => {
    if (!currentOrder) { resetForm() } else {
      const os = currentOrder
      setDependenteId(os.dependente_id?.toString() ?? '')
      setOftalmologistaId(os.oftalmologista_id?.toString() ?? '')
      const linkLenteOd = os.links?.find((l: any) => l.uso_na_os === 'lente_od'); setLenteOdItemId(linkLenteOd?.venda_item_id.toString() ?? '')
      const linkLenteOe = os.links?.find((l: any) => l.uso_na_os === 'lente_oe'); setLenteOeItemId(linkLenteOe?.venda_item_id.toString() ?? '')
      const linkArmacao = os.links?.find((l: any) => l.uso_na_os === 'armacao'); setArmacaoItemId(linkArmacao?.venda_item_id.toString() ?? '')
      setLongeOdEsf(os.receita_longe_od_esferico ?? ''); setLongeOdCil(os.receita_longe_od_cilindrico ?? ''); setLongeOdEixo(os.receita_longe_od_eixo ?? '')
      setLongeOeEsf(os.receita_longe_oe_esferico ?? ''); setLongeOeCil(os.receita_longe_oe_cilindrico ?? ''); setLongeOeEixo(os.receita_longe_oe_eixo ?? '')
      setPertoOdEsf(os.receita_perto_od_esferico ?? ''); setPertoOdCil(os.receita_perto_od_cilindrico ?? ''); setPertoOdEixo(os.receita_perto_od_eixo ?? '')
      setPertoOeEsf(os.receita_perto_oe_esferico ?? ''); setPertoOeCil(os.receita_perto_oe_cilindrico ?? ''); setPertoOeEixo(os.receita_perto_oe_eixo ?? '')
      setAdicao(os.receita_adicao ?? '')
      setMedH(os.medida_horizontal ?? ''); setMedV(os.medida_vertical ?? ''); setMedDiag(os.medida_diagonal ?? ''); setMedPonte(os.medida_ponte ?? '')
      setDnpOd(os.medida_dnp_od ?? ''); setDnpOe(os.medida_dnp_oe ?? ''); setAltOd(os.medida_altura_od ?? ''); setAltOe(os.medida_altura_oe ?? ''); setDiametro(os.medida_diametro ?? '')
      setDtPedido(toDateTimeInput(os.dt_pedido_em)); setPedidoPorId(os.lab_pedido_por_id?.toString() ?? ''); setLabNome(os.lab_nome ?? '')
      setDtChegou(toDateTimeInput(os.dt_lente_chegou)); setDtMontado(toDateTimeInput(os.dt_montado_em)); setDtEntregue(toDateTimeInput(os.dt_entregue_em))
      setDtPrometido(toDateTimeInput(os.dt_prometido_para)); setObsOs(os.obs_os ?? '')
      setProtocolo(os.protocolo_fisico || os.id.toString())
    }
  }, [currentIndex, currentOrder, resetForm])

  const handleNavigate = (dir: 'prev' | 'next' | 'new') => {
     if (dir === 'new') { setCurrentIndex(-1); return; }
     if (existingOrders.length === 0) return;
     let newIndex = currentIndex
     if (dir === 'prev') newIndex = currentIndex <= 0 ? existingOrders.length - 1 : currentIndex - 1
     else newIndex = currentIndex >= existingOrders.length - 1 ? 0 : currentIndex + 1
     setCurrentIndex(newIndex)
  }

  const handleDelete = () => {
    if (!currentOrder) return; if(!confirm('Excluir OS?')) return;
    startDeleteTransition(async () => {
        const res = await deleteServiceOrder(currentOrder.id, storeId, vendaId)
        if (res.success) { onListChange(existingOrders.filter((o: any) => o.id !== currentOrder.id)); setCurrentIndex(-1) } 
        else { alert(res.message) }
    })
  }

  const handleDependenteAdded = (newDep: Dependente) => {
    setLocalDependentes(prev => [...prev, newDep])
    setDependenteId(newDep.id.toString())
  }

  const handleImportPrescription = (data: PrescriptionHistoryItem) => {
      if (confirm("Deseja preencher os campos com os dados desta receita antiga?")) {
          setLongeOdEsf(data.receita_longe_od_esferico || ''); setLongeOdCil(data.receita_longe_od_cilindrico || ''); setLongeOdEixo(data.receita_longe_od_eixo || '');
          setLongeOeEsf(data.receita_longe_oe_esferico || ''); setLongeOeCil(data.receita_longe_oe_cilindrico || ''); setLongeOeEixo(data.receita_longe_oe_eixo || '');
          setAdicao(data.receita_adicao || ''); setDnpOd(data.medida_dnp_od || ''); setDnpOe(data.medida_dnp_oe || '');
          setIsHistoryModalOpen(false);
      }
  }

  const sendWhatsAppPedido = () => {
      const lenteOdDesc = vendaItens.find(i => i.id === parseInt(lenteOdItemId))?.descricao || 'N√£o informado';
      const lenteOeDesc = vendaItens.find(i => i.id === parseInt(lenteOeItemId))?.descricao || 'N√£o informado';
      const medico = oftalmosList.find(o => o.id === parseInt(oftalmologistaId));
      const medicoTexto = medico ? `${medico.nome_completo} ${medico.crm ? 'CRM ' + medico.crm : ''}` : 'N√£o informado';
      const clienteNome = customer?.full_name || 'Cliente';
      const prometidoPara = dtPrometido ? formatDate(dtPrometido) : 'A combinar';

      const msg = `
*Pedido de Lentes*

Protocolo/OS #${protocolo || 'Nova'}
Prometido para: ${prometidoPara}

--Receita--
Lente OD: ${lenteOdDesc}
Lente OE: ${lenteOeDesc}
OD: ${longeOdEsf} ${longeOdCil} ${longeOdEixo}
OE: ${longeOeEsf} ${longeOeCil} ${longeOeEixo}
AD: ${adicao}

--Medidas--
Hor: ${medH}
Vert: ${medV}
Diag: ${medDiag}
Ponte: ${medPonte}
DP: ${dnpOd}/${dnpOe}
Diam: ${diametro}
Alt: ${altOd}/${altOe}

--Dados Pessoais--
Cliente: ${clienteNome}
M√©dico: ${medicoTexto}

Obs.: ${obsOs}
`.trim();

      const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, '_blank');
  }

  if (!customer) return <div className="p-4">Carregando dados do cliente...</div>

  return (
    <>
      <form action={dispatch} className="flex-1 flex flex-col h-[calc(100vh-64px)]">

          {/* √ÅREA DE SCROLL (HEADER + CONTE√öDO) */}
          <div className="flex-1 overflow-y-auto overflow-x-hidden p-2">
              
              {/* HEADER INFO */}
              <div className="p-2 rounded-lg bg-white shadow-sm border border-gray-200 flex justify-between items-center mb-2">
                  <div className="flex items-center gap-2">
                      <div className="p-1.5 bg-blue-100 rounded-full text-blue-700">
                          <User className="h-4 w-4" />
                      </div>
                      <div>
                          <p className="text-[10px] font-bold text-gray-500 uppercase">Cliente</p>
                          <p className="font-bold text-gray-800 text-sm leading-none">{customer.full_name}</p>
                      </div>
                  </div>
                  <div className="text-right">
                      <p className="text-[10px] font-bold text-gray-500 uppercase">Atendente</p>
                      <p className="font-bold text-gray-800 text-xs">{authedEmployeeName}</p>
                  </div>
              </div>

              {/* NAV BAR */}
              <div className="bg-white p-1 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center gap-2 mb-2">
                  <div className="flex items-center gap-2 ml-2 min-w-fit">
                      <Eye className="h-4 w-4 text-blue-600" />
                      <h2 className="text-sm font-bold text-gray-800 hidden sm:block">
                        {currentOrder ? `Ficha #${currentOrder.id}` : 'Nova Ficha'}
                      </h2>
                      <span className="bg-gray-100 text-gray-600 text-[10px] px-2 py-0.5 rounded-full font-bold border border-gray-300 whitespace-nowrap">
                          {currentIndex === -1 ? 'NOVA' : `${currentIndex + 1}/${existingOrders.length}`}
                      </span>
                  </div>

                  <div className="flex-1 flex justify-center">
                      <div className="flex items-center gap-2 bg-gray-50 px-2 py-0.5 rounded border border-gray-200 w-full max-w-[200px]">
                          <label htmlFor="protocolo_input" className="text-[9px] font-bold text-gray-500 uppercase whitespace-nowrap">
                              Protocolo
                          </label>
                          <input 
                              id="protocolo_input"
                              name="protocolo_fisico"
                              type="text"
                              value={protocolo}
                              onChange={(e) => setProtocolo(e.target.value)}
                              className="bg-transparent border-none text-gray-900 text-xs focus:ring-0 block w-full h-6 px-1 font-bold text-center uppercase p-0"
                              placeholder="Auto"
                          />
                      </div>
                  </div>

                  <div className="flex gap-1 min-w-fit">
                      <button type="button" onClick={() => handleNavigate('prev')} className="p-1.5 hover:bg-gray-100 rounded text-gray-600"><ChevronLeft className="h-4 w-4"/></button>
                      <button type="button" onClick={() => handleNavigate('next')} className="p-1.5 hover:bg-gray-100 rounded text-gray-600"><ChevronRight className="h-4 w-4"/></button>
                      <button type="button" onClick={() => handleNavigate('new')} className="bg-green-600 text-white text-[10px] font-bold px-3 py-1 rounded hover:bg-green-700 ml-1 shadow-sm">NOVA</button>
                  </div>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-12 gap-2">
                
                {/* COLUNA 1: Dados Gerais e Medidas (4 colunas) */}
                <div className="lg:col-span-4 space-y-2 flex flex-col">
                  
                  {/* CARD AZUL (DADOS) */}
                  <div className={cardBlue}>
                      <h3 className="text-white font-bold text-xs mb-2 flex items-center gap-2 border-b border-white/20 pb-1">
                          <User className="h-3 w-3"/> DADOS E V√çNCULOS
                      </h3>
                      <div className="space-y-2 flex-1">
                          <div>
                            <label className={labelStyle}>Paciente</label>
                            <div className="flex gap-1">
                              <select name="dependente_id" value={dependenteId} onChange={e => setDependenteId(e.target.value)} className={inputStyle}>
                                  <option value="">{customer.full_name} (Titular)</option>
                                  {localDependentes.map(dep => (
                                    <option key={dep.id} value={dep.id}>
                                      {dep.full_name} ({dep.parentesco || 'Dep.'})
                                    </option>
                                  ))}
                              </select>
                              <button type="button" onClick={() => setIsDepModalOpen(true)} className="bg-white/20 hover:bg-white/30 text-white p-1 rounded shadow-sm border border-white/20 h-7 w-7 flex items-center justify-center" title="Novo Dependente">
                                <Plus className="h-4 w-4" />
                              </button>
                            </div>
                          </div>

                          <div>
                            <label className={labelStyle}>M√©dico</label>
                            <select name="oftalmologista_id" value={oftalmologistaId} onChange={e => setOftalmologistaId(e.target.value)} className={inputStyle}>
                                <option value="">Selecione...</option>
                                {oftalmosList.map(oft => <option key={oft.id} value={oft.id}>{oft.nome_completo}</option>)}
                            </select>
                          </div>
                          
                          <div className="pt-2 border-t border-white/20 mt-1 space-y-2">
                              <div>
                                <label className={labelStyle}>Lente OD</label>
                                <select value={lenteOdItemId} onChange={e => setLenteOdItemId(e.target.value)} className={inputStyle}>
                                    <option value="">-- Selecione --</option>
                                    {itensLente.map(i => <option key={i.id} value={i.id}>{i.descricao}</option>)}
                                </select>
                              </div>
                              <div>
                                <label className={labelStyle}>Lente OE</label>
                                <select value={lenteOeItemId} onChange={e => setLenteOeItemId(e.target.value)} className={inputStyle}>
                                    <option value="">-- Selecione --</option>
                                    {itensLente.map(i => <option key={i.id} value={i.id}>{i.descricao}</option>)}
                                </select>
                              </div>
                              <div>
                                <label className={labelStyle}>Arma√ß√£o</label>
                                <select value={armacaoItemId} onChange={e => setArmacaoItemId(e.target.value)} className={inputStyle}>
                                    <option value="">-- Selecione --</option>
                                    {itensArmacao.map(i => <option key={i.id} value={i.id}>{i.descricao}</option>)}
                                </select>
                              </div>
                          </div>
                      </div>
                  </div>

                  {/* CARD SLATE (MEDIDAS) */}
                  <div className={cardSlate}>
                      <h3 className="text-white font-bold text-xs mb-2 flex items-center gap-2 border-b border-white/20 pb-1">
                          <Ruler className="h-3 w-3"/> MEDIDAS T√âCNICAS
                      </h3>
                      <div className="grid grid-cols-3 gap-1 mb-2 items-end">
                          <div className="col-span-1"></div>
                          <div className="text-center text-[10px] font-bold text-white/70">OD</div>
                          <div className="text-center text-[10px] font-bold text-white/70">OE</div>
                          
                          <label className="text-right text-[10px] font-bold text-white/90 pr-1 self-center">DNP</label>
                          <input name="medida_dnp_od" value={dnpOd} onChange={e => setDnpOd(e.target.value)} className={gridInput} />
                          <input name="medida_dnp_oe" value={dnpOe} onChange={e => setDnpOe(e.target.value)} className={gridInput} />
                          
                          <label className="text-right text-[10px] font-bold text-white/90 pr-1 self-center">Altura</label>
                          <input name="medida_altura_od" value={altOd} onChange={e => setAltOd(e.target.value)} className={gridInput} />
                          <input name="medida_altura_oe" value={altOe} onChange={e => setAltOe(e.target.value)} className={gridInput} />
                      </div>
                      
                      <div className="grid grid-cols-2 gap-2 border-t border-white/20 pt-2">
                          <div><label className={labelStyle}>Horizontal</label><input name="medida_horizontal" value={medH} onChange={e => setMedH(e.target.value)} className={inputStyle} /></div>
                          <div><label className={labelStyle}>Vertical</label><input name="medida_vertical" value={medV} onChange={e => setMedV(e.target.value)} className={inputStyle} /></div>
                          <div><label className={labelStyle}>Diagonal</label><input name="medida_diagonal" value={medDiag} onChange={e => setMedDiag(e.target.value)} className={inputStyle} /></div>
                          <div><label className={labelStyle}>Ponte</label><input name="medida_ponte" value={medPonte} onChange={e => setMedPonte(e.target.value)} className={inputStyle} /></div>
                          
                          {/* DI√ÇMETRO COM WHATSAPP */}
                          <div className="col-span-2 flex items-end gap-1">
                              <div className="flex-1">
                                  <label className={labelStyle}>Di√¢metro</label>
                                  <input name="medida_diametro" value={diametro} onChange={e => setDiametro(e.target.value)} className={inputStyle} />
                              </div>
                              <button 
                                type="button" 
                                onClick={sendWhatsAppPedido}
                                className="h-7 px-2 bg-green-500 hover:bg-green-600 text-white rounded shadow-md flex items-center gap-1 transition-all hover:scale-105"
                                title="Enviar Pedido via WhatsApp"
                              >
                                  <MessageCircle className="h-4 w-4" /> <span className="font-bold text-[10px] hidden xl:inline">PEDIR</span>
                              </button>
                          </div>
                      </div>
                  </div>
                </div>

                {/* COLUNA 2: Receita, Prazos e Lab (8 colunas) */}
                <div className="lg:col-span-8 space-y-2 flex flex-col">
                    
                    {/* CARD VIOLETA (RECEITA) */}
                    <div className={cardViolet}>
                        <div className="flex justify-between border-b border-white/20 pb-1 mb-2 items-center">
                            <h3 className="font-bold text-white flex items-center gap-2 text-xs">
                                <Glasses className="h-3 w-3"/> RECEITA
                            </h3>
                            <div className="flex gap-1">
                                <button 
                                    type="button" 
                                    onClick={() => setIsHistoryModalOpen(true)}
                                    className="text-[10px] font-bold text-indigo-900 bg-white hover:bg-indigo-50 px-2 py-0.5 rounded shadow-sm flex items-center gap-1 transition-colors uppercase tracking-wide"
                                >
                                    <History className="h-3 w-3" /> Hist√≥rico
                                </button>
                                <button 
                                    type="button" 
                                    onClick={() => { setLongeOdEsf('+0,00'); setLongeOdCil('+0,00'); setLongeOdEixo('0'); setLongeOeEsf('+0,00'); setLongeOeCil('+0,00'); setLongeOeCil('+0,00'); setLongeOeEixo('0'); }} 
                                    className="text-[10px] font-bold text-white border border-white/40 hover:bg-white/10 px-2 py-0.5 rounded transition-colors uppercase tracking-wide"
                                >
                                    <FileDown className="h-3 w-3 inline mr-1"/> Zerar
                                </button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-7 gap-1 mb-1 text-center text-[10px] font-bold text-white/60 uppercase tracking-wider">
                            <div className="col-span-1"></div><div className="col-span-2">Esf√©rico</div><div className="col-span-2">Cil√≠ndrico</div><div className="col-span-2">Eixo</div>
                        </div>
                        
                        <LeftoverBadge matches={odMatches} label="OD" />

                        {/* OD */}
                        <div className="grid grid-cols-7 gap-1 mb-2 items-center p-2 bg-white/10 rounded-lg border border-white/10">
                            <div className="col-span-1 font-black text-right pr-2 text-xl text-white">OD</div>
                            <div className="col-span-2"><DegreeInput name="receita_longe_od_esferico" value={longeOdEsf} onChange={setLongeOdEsf} className={gridInput} /></div>
                            <div className="col-span-2"><DegreeInput name="receita_longe_od_cilindrico" value={longeOdCil} onChange={setLongeOdCil} className={gridInput} /></div>
                            <div className="col-span-2"><input name="receita_longe_od_eixo" value={longeOdEixo} onChange={e => setLongeOdEixo(e.target.value)} className={gridInput} placeholder="0¬∫" /></div>
                        </div>
                        
                        <LeftoverBadge matches={oeMatches} label="OE" />
                        
                        {/* OE */}
                        <div className="grid grid-cols-7 gap-1 mb-2 items-center p-2 bg-white/10 rounded-lg border border-white/10">
                            <div className="col-span-1 font-black text-right pr-2 text-xl text-white">OE</div>
                            <div className="col-span-2"><DegreeInput name="receita_longe_oe_esferico" value={longeOeEsf} onChange={setLongeOeEsf} className={gridInput} /></div>
                            <div className="col-span-2"><DegreeInput name="receita_longe_oe_cilindrico" value={longeOeCil} onChange={setLongeOeCil} className={gridInput} /></div>
                            <div className="col-span-2"><input name="receita_longe_oe_eixo" value={longeOeEixo} onChange={e => setLongeOeEixo(e.target.value)} className={gridInput} placeholder="0¬∫" /></div>
                        </div>

                        <div className="flex justify-center mt-1">
                            <div className="w-32 bg-white/10 border border-white/20 p-2 rounded-lg text-center">
                                <label className="text-[10px] font-bold text-white uppercase block mb-1">Adi√ß√£o</label>
                                <DegreeInput name="receita_adicao" value={adicao} onChange={setAdicao} className={`${gridInput} h-9 text-xl`} />
                            </div>
                        </div>
                    </div>

                    {/* CARD TEAL (PRAZOS E OBS) */}
                    <div className={cardTeal}>
                        <h3 className="text-white font-bold text-xs mb-2 flex items-center gap-2 border-b border-white/20 pb-1">
                            <CalendarClock className="h-3 w-3"/> PRAZOS E OBS
                        </h3>
                        <div className="flex gap-2 items-start">
                            <div className="w-1/3">
                                <label className={labelStyle}>Prometido Para</label>
                                <input 
                                    type="datetime-local" 
                                    name="dt_prometido_para" 
                                    value={dtPrometido} 
                                    onChange={e => setDtPrometido(e.target.value)} 
                                    className={`${inputStyle} h-10 font-bold`} 
                                />
                            </div>
                            <div className="flex-1">
                                 <label className={labelStyle}>Observa√ß√µes</label>
                                 <input 
                                    name="obs_os" 
                                    value={obsOs} 
                                    onChange={e => setObsOs(e.target.value)} 
                                    className={`${inputStyle} h-10`} 
                                    placeholder="Detalhes..." 
                                 />
                            </div>
                        </div>
                    </div>

                    {/* CARD AMBER (LAB) */}
                    <div className={cardAmber}>
                        <h3 className="text-white font-bold text-xs mb-2 flex items-center gap-2 border-b border-white/20 pb-1">
                            <Truck className="h-3 w-3"/> LABORAT√ìRIO
                        </h3>
                        <div className="grid grid-cols-3 gap-2">
                            <div><label className={labelStyle}>Pedido Em</label><input type="datetime-local" name="dt_pedido_em" value={dtPedido} onChange={e => setDtPedido(e.target.value)} className={inputStyle}/></div>
                            <div><label className={labelStyle}>Pedido Por</label>
                                <select name="lab_pedido_por_id" value={pedidoPorId} onChange={e => setPedidoPorId(e.target.value)} className={inputStyle}>
                                    <option value="">Selecione...</option>
                                    {employees.map(emp => <option key={emp.id} value={emp.id}>{emp.full_name}</option>)}
                                </select>
                            </div>
                            <div><label className={labelStyle}>Laborat√≥rio</label><input type="text" name="lab_nome" value={labNome} onChange={e => setLabNome(e.target.value)} className={inputStyle} placeholder="Ex: Hoya"/></div>
                            
                            <div><label className={labelStyle}>Lente Chegou</label><input type="datetime-local" name="dt_lente_chegou" value={dtChegou} onChange={e => setDtChegou(e.target.value)} className={inputStyle}/></div>
                            <div><label className={labelStyle}>Montado Em</label><input type="datetime-local" name="dt_montado_em" value={dtMontado} onChange={e => setDtMontado(e.target.value)} className={inputStyle}/></div>
                            <div><label className={labelStyle}>Entregue</label><input type="datetime-local" name="dt_entregue_em" value={dtEntregue} onChange={e => setDtEntregue(e.target.value)} className={inputStyle}/></div>
                        </div>
                    </div>
                </div>
              </div>
          </div>

          {/* FOOTER FIXO (Barra Branca) */}
          <div className="shrink-0 bg-white border-t border-gray-300 px-4 py-3 flex justify-end gap-2 z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
              <button type="button" onClick={() => router.back()} className={`${baseButtonStyle} bg-gray-500 text-white hover:bg-gray-600`}>VOLTAR</button>
              {currentOrder && (
                  <button type="button" onClick={handleDelete} disabled={isDeleting} className={`${baseButtonStyle} bg-red-100 text-red-700 hover:bg-red-200 border border-red-200`}>
                      {isDeleting ? <Loader2 className="animate-spin h-3 w-3"/> : <Trash2 className="h-3 w-3"/>} EXCLUIR
                  </button>
              )}
              <button type="submit" disabled={isSaving} className={`${baseButtonStyle} bg-blue-600 text-white hover:bg-blue-700 px-6 text-sm shadow-md`}>
                  {isSaving ? <Loader2 className="animate-spin h-4 w-4"/> : <Save className="h-4 w-4"/>} SALVAR OS
              </button>
          </div>

          {/* Hidden Inputs */}
          {currentOrder && <input type="hidden" name="id" value={currentOrder.id} />}
          <input type="hidden" name="store_id" value={storeId} />
          <input type="hidden" name="venda_id" value={vendaId} />
          <input type="hidden" name="customer_id" value={customer.id} />
          <input type="hidden" name="item_links_json" value={JSON.stringify([{ item_id: lenteOdItemId, uso: 'lente_od' }, { item_id: lenteOeItemId, uso: 'lente_oe' }, { item_id: armacaoItemId, uso: 'armacao' }].filter(x => x.item_id))} />

      </form>

      {/* --- MODAIS EXTERNOS --- */}
      <AddDependenteModal
        isOpen={isDepModalOpen}
        onClose={() => setIsDepModalOpen(false)}
        onSuccess={handleDependenteAdded}
        storeId={storeId}
        customerId={customer.id}
      />

      <PrescriptionHistoryModal 
        isOpen={isHistoryModalOpen}
        onClose={() => setIsHistoryModalOpen(false)}
        onSelect={handleImportPrescription}
        customerId={customer.id}
        storeId={storeId}
        dependenteId={dependenteId ? parseInt(dependenteId) : null}
        dependenteNome={dependenteId ? localDependentes.find(d => d.id === parseInt(dependenteId))?.full_name : customer.full_name}
      />
    </>
  )
}

function ServiceOrderPageWrapper({ storeId, vendaId, authedEmployeeName }: { storeId: number, vendaId: number, authedEmployeeName: string }) {
  const [data, setData] = useState<OSPageData | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
      const load = async () => {
         const { getVendaPageData, getOSPageData } = await import('@/lib/actions/vendas.actions')
         const vendaData = await getVendaPageData(vendaId, storeId)
         if(vendaData.success && vendaData.data?.venda) {
             const customerId = vendaData.data.venda.customer_id
             const osData = await getOSPageData(vendaId, storeId, customerId)
             if(osData.success && osData.data) {
                 setData({ ...osData.data, venda: vendaData.data.venda })
             }
         }
         setLoading(false)
      }
      load()
  }, [vendaId, storeId])

  const initialState: SaveSOResult = { success: false, message: '', timestamp: 0 }
  const [saveState, dispatch] = useFormState(saveServiceOrder, initialState)

  if (loading) return <div className="flex h-screen items-center justify-center bg-gray-100"><Loader2 className="animate-spin h-10 w-10 text-gray-400"/></div>
  if (!data) return <div className="p-10 text-center">Erro ao carregar. Verifique a venda.</div>

  return (
    <div className="flex-1 flex flex-col bg-gray-100 p-2 h-[calc(100vh-64px)] overflow-hidden">
        <ServiceOrderFormContent 
            storeId={storeId} vendaId={vendaId} 
            customer={data.customer} 
            venda={data.venda} 
            vendaItens={data.vendaItens}
            dependentes={data.dependentes} oftalmosList={data.oftalmologistas} employees={data.employees}
            existingOrders={data.existingOrders} authedEmployeeName={authedEmployeeName}
            onListChange={(newList) => setData({ ...data, existingOrders: newList })}
            saveState={saveState}
            dispatch={dispatch} 
         />
    </div>
  )
}

export default function ServiceOrderPage() {
    const params = useParams()
    const searchParams = useSearchParams()
    const storeId = parseInt(params.storeId as string, 10)
    const vendaId = parseInt(params.vendaId as string, 10)
    const employeeName = searchParams.get('employee_name') || 'Vendedor'
    return <ServiceOrderPageWrapper storeId={storeId} vendaId={vendaId} authedEmployeeName={employeeName} />
}

==================================================
ARQUIVO: .\src\app\dashboard\manager\page.tsx
==================================================
export default function ManagerDashboardPage() {
  return (
    <div className="text-center p-10">
      <h1 className="text-4xl font-bold">Painel Gerencial</h1>
      <p className="mt-4 text-blue-600">Bem-vindo, Gerente. Acesse sua loja pelo menu.</p>
    </div>
  );
}

==================================================
ARQUIVO: .\src\app\login\page.tsx
==================================================
// Caminho: src/app/login/page.tsx (CORRE√á√ÉO DE LAYOUT)

'use client'

import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'
import { useState } from 'react'
import { useFormStatus } from 'react-dom'
import { Loader2 } from 'lucide-react'
import Link from 'next/link'
import { getLoginRoute } from '@/lib/actions/auth.actions'

// --- Componente do Bot√£o de Submit (Mantido) ---
function SubmitButton() {
  const { pending } = useFormStatus()
  return (
    <button
      type="submit"
      disabled={pending}
      className="flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:bg-blue-400"
    >
      {pending ? <Loader2 className="h-5 w-5 animate-spin" /> : 'Entrar'}
    </button>
  )
}

// --- Componente Principal da P√°gina ---
export default function LoginPage() {
  const router = useRouter()
  const supabase = createClient()
  const [errorMessage, setErrorMessage] = useState<string | null>(null)

  const handleSubmit = async (formData: FormData) => {
    setErrorMessage(null)
    const email = formData.get('email') as string
    const password = formData.get('password') as string

    try {
      const { error: authError } =
        await supabase.auth.signInWithPassword({
          email: email.trim(),
          password: password,
        })

      if (authError) {
        setErrorMessage(authError.message || 'Credenciais inv√°lidas')
        return
      }

      const { route, message } = await getLoginRoute();

      if (route.startsWith('/dashboard')) {
          router.push(route);
      } else {
          await supabase.auth.signOut();
          setErrorMessage(message || 'Erro no roteamento. Tente novamente.');
      }

    } catch (error: any) {
      setErrorMessage(error.message || 'Ocorreu um erro inesperado.')
    }
  }

  return (
    <main 
        // CORRE√á√ÉO: Removemos 'flex-1' e garantimos a centraliza√ß√£o na tela.
        className="flex min-h-screen flex-col items-center justify-center bg-gray-100 p-4"
    >
      {/* A classe 'text-white' √© crucial para manter a caixa escura (gray-800) */}
      <div className="w-full max-w-md rounded-lg bg-gray-800 p-8 shadow-lg text-white">
        <h1 className="mb-6 text-center text-3xl font-bold">
          Gest√£o √ìtica Pro
        </h1>

        <form action={handleSubmit} className="space-y-4">
          {errorMessage && (
            // Mensagem de erro fica em cores claras sobre o fundo escuro
            <div className="mb-4 rounded border border-red-400 bg-red-100 p-3 text-sm text-red-700">
              <p>
                <strong>Erro:</strong> {errorMessage}
              </p>
            </div>
          )}
          <div>
            {/* O label deve ser branco para contraste */}
            <label htmlFor="email" className="block text-sm font-medium text-white">
              E-mail
            </label>
            <input
              id="email"
              name="email"
              type="email"
              required
              // O input continua branco com texto escuro
              className="mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm text-gray-900 h-10 text-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div>
            <label htmlFor="password" className="block text-sm font-medium text-white">
              Senha
            </label>
            <input
              id="password"
              name="password"
              type="password"
              required
              className="mt-1 block w-full rounded-md border-gray-300 bg-white shadow-sm text-gray-900 h-10 text-sm focus:border-blue-500 focus:ring-blue-500"
            />
          </div>
          <div className="pt-2">
            <SubmitButton />
          </div>
          <div className="text-center text-sm">
            <Link
              href="/forgot-password"
              // Link em tom de azul claro para contraste no fundo escuro
              className="font-medium text-blue-400 hover:text-blue-300"
            >
              Esqueceu sua senha?
            </Link>
          </div>
        </form>
      </div>
    </main>
  )
}

==================================================
ARQUIVO: .\src\app\print\layout.tsx
==================================================
export default function PrintLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="min-h-screen bg-white text-black font-sans print:bg-white print:text-black">
      {/* Removemos o SideNav e Header aqui. √â uma p√°gina 'crua'. */}
      {children}
    </div>
  )
}

==================================================
ARQUIVO: .\src\app\print\recibo\[id]\page.tsx
==================================================
// ARQUIVO: src/app/print/recibo/[id]/page.tsx

import { notFound } from 'next/navigation'
import { createAdminClient } from '@/lib/supabase/admin'
import { ReceiptPhantom } from '@/components/print/ReceiptPhantom'

export default async function PrintReciboPage({ params, searchParams }: { params: { id: string }, searchParams: { reprint?: string } }) {
    const idsString = params.id
    const ids = idsString.split('-').map(id => parseInt(id)).filter(n => !isNaN(n))
    
    if (ids.length === 0) return notFound()

    const isReprint = searchParams.reprint === 'true'

    const supabase = createAdminClient()

    // 1. Busca OS Pagamentos
    // CORRE√á√ÉO: Cast 'as any' para garantir o select
    const { data: pagamentos } = await (supabase
        .from('pagamentos') as any)
        .select('*')
        .in('id', ids)

    if (!pagamentos || pagamentos.length === 0) return <div className="p-10">Pagamentos n√£o encontrados.</div>

    // Como pagamentos √© 'any' no retorno do supabase acima (se n√£o tipado estritamente), garantimos acesso seguro
    const vendaId = pagamentos[0].venda_id

    // 2. Busca a Venda e Cliente
    // CORRE√á√ÉO: Cast 'as any' para permitir os joins (customers, venda_itens)
    const { data: vendaRaw } = await (supabase
        .from('vendas') as any)
        .select('*, customers(*), venda_itens(*)')
        .eq('id', vendaId)
        .single()

    if (!vendaRaw) return <div className="p-10">Venda original n√£o encontrada.</div>

    // CORRE√á√ÉO: Tratamos vendaRaw como any para acessar .customers e .venda_itens sem erro
    const venda = vendaRaw as any

    const receiptData = {
        pagamentos,
        venda,
        cliente: venda.customers,
        itens: venda.venda_itens || [],
        isReprint
    }

    return (
        <div className="w-full h-screen flex items-start justify-center pt-4 print:pt-0">
            <style>{`
                @page { size: A4 landscape; margin: 0; }
                body { margin: 0; }
            `}</style>
            {/* O 'as any' aqui garante que o componente aceite o objeto montado manualmente */}
            <ReceiptPhantom data={receiptData as any} />
        </div>
    )
}

==================================================
ARQUIVO: .\src\app\rastreio\[token]\page.tsx
==================================================
import { getPublicTicket } from '@/lib/actions/assistance.actions'
import { CheckCircle2, Clock, MapPin, Package, Store, Search, FileText, AlertTriangle, MessageCircle } from 'lucide-react'
import { notFound } from 'next/navigation'

export const metadata = {
  title: 'Rastreio de Garantia | √ìtica Pro',
}

// Mapa de Status do Banco -> √çndice da Timeline (0 a 4)
const STATUS_MAP: Record<string, number> = {
  'Triagem': 0,            // Solicita√ß√£o Aberta
  'EmTratativa': 1,        // Em An√°lise
  'AguardandoChegada': 2,  // Aguardando Pe√ßa
  'AguardandoCliente': 3,  // Pe√ßa na Loja
  'LogisticaReversa': 4,   // Finalizado / Devolu√ß√£o
  'Concluido': 4,          // Finalizado
}

export default async function RastreioPage({ params }: { params: { token: string } }) {
  const ticket = await getPublicTicket(params.token)

  if (!ticket) return notFound()

  // Define o √≠ndice ativo com base no Status do Banco
  const currentStepIndex = STATUS_MAP[ticket.status as string] ?? 0
  const isCancelado = ticket.status === 'Cancelado'

  // L√≥gica do Link do WhatsApp Din√¢mico
  const whatsappLoja = ticket.stores?.whatsapp 
      ? `55${ticket.stores.whatsapp.replace(/\D/g, '')}` 
      : '' 
  
  const linkFalar = whatsappLoja 
      ? `https://wa.me/${whatsappLoja}?text=${encodeURIComponent(`Ol√°, estou vendo o rastreio da minha garantia (Produto: ${ticket.product_descricao}) e gostaria de uma informa√ß√£o.`)}`
      : '#'

  const steps = [
    { 
      label: 'Solicita√ß√£o Aberta', 
      date: ticket.dt_abertura, 
      icon: FileText, 
    },
    { 
      label: 'Em Tratativa com Fabricante', 
      date: ticket.dt_solicitacao_peca, 
      icon: Search, 
    },
    { 
      label: 'Aguardando Chegada da Pe√ßa', 
      date: null, 
      icon: Clock, 
    },
    { 
      label: 'Pronto para Retirada', 
      date: ticket.dt_chegada_peca || ticket.dt_troca_cliente, 
      icon: MapPin, 
    },
    { 
      label: 'Processo Finalizado', 
      date: ticket.dt_conclusao || ticket.dt_envio_fornecedor, 
      icon: CheckCircle2, 
    }
  ]

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-4 font-sans">
      <div className="max-w-md w-full bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
        
        {/* Header da Loja */}
        <div className={`p-8 text-center text-white relative overflow-hidden ${isCancelado ? 'bg-red-600' : 'bg-blue-600'}`}>
          <div className="absolute top-0 left-0 w-full h-full bg-white/10 opacity-20 transform -skew-y-6"></div>
          
          <div className="relative z-10">
            {isCancelado ? <AlertTriangle className="h-12 w-12 mx-auto mb-3 text-white/90" /> : <Store className="h-12 w-12 mx-auto mb-3 text-white/80" />}
            
            <h1 className="text-xl font-black tracking-wide uppercase drop-shadow-md">
              {ticket.stores?.name || '√ìTICA PARCEIRA'}
            </h1>
            <p className="text-white/80 text-xs mt-1 font-medium tracking-wider">Central de Relacionamento</p>
          </div>
        </div>

        {/* Resumo do Produto */}
        <div className="p-6 border-b border-slate-100 bg-slate-50/50">
          <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Produto em Assist√™ncia</p>
          <p className="text-lg font-black text-slate-800 leading-tight">
            {ticket.product_descricao}
          </p>
          
          <div className={`mt-4 inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm ${isCancelado ? 'bg-red-100 text-red-700' : 'bg-blue-50 text-blue-700'}`}>
            {!isCancelado && <div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>}
            {isCancelado ? 'ATENDIMENTO CANCELADO' : (ticket.status_publico || 'Em Andamento')}
          </div>
        </div>

        {/* Timeline Vertical */}
        {!isCancelado ? (
          <div className="p-8 bg-white">
            <div className="relative border-l-2 border-slate-100 ml-3 space-y-10 pb-2">
              {steps.map((step, idx) => {
                const isCompleted = idx <= currentStepIndex
                const isCurrent = idx === currentStepIndex
                
                return (
                  <div key={idx} className="relative pl-8 group">
                    {/* Linha Conectora Colorida */}
                    {idx < currentStepIndex && (
                        <div className="absolute left-[-2px] top-6 w-[2px] h-[calc(100%+24px)] bg-blue-500 -z-10 transition-all duration-700"></div>
                    )}

                    {/* √çcone Bolinha */}
                    <div className={`
                      absolute -left-[14px] top-0 w-8 h-8 rounded-full border-2 flex items-center justify-center z-10 transition-all duration-300
                      ${isCompleted ? 'bg-blue-600 border-blue-600 text-white shadow-md shadow-blue-200' : 'bg-white border-slate-200 text-slate-300'}
                      ${isCurrent ? 'ring-4 ring-blue-100 scale-110' : ''}
                    `}>
                        <step.icon className="h-4 w-4" />
                    </div>
                    
                    {/* Texto */}
                    <div className={`transition-all duration-500 ${isCompleted ? 'opacity-100 translate-x-0' : 'opacity-40 translate-x-1'}`}>
                      <p className={`text-sm font-bold leading-none ${isCurrent ? 'text-blue-700 scale-105 origin-left' : 'text-slate-700'}`}>
                        {step.label}
                      </p>
                      {step.date && (
                        <p className="text-[10px] text-slate-500 mt-1.5 font-medium uppercase tracking-wide bg-slate-50 inline-block px-2 py-0.5 rounded border border-slate-100">
                          {new Date(step.date).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' })}
                        </p>
                      )}
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        ) : (
            <div className="p-12 text-center text-slate-400 bg-slate-50">
                <p className="text-sm font-medium text-slate-500">O processo foi encerrado sem conclus√£o.</p>
                <p className="text-xs mt-2">Por favor, entre em contato com a loja.</p>
            </div>
        )}

        {/* Footer */}
        <div className="bg-slate-50 p-6 text-center border-t border-slate-100">
           <p className="text-xs text-slate-400 mb-4 font-medium">Precisa falar com a gente?</p>
           <a 
             href={linkFalar} 
             target="_blank"  
             className={`block w-full py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-green-200/50 transition-all active:scale-95 flex items-center justify-center gap-2 ${!whatsappLoja ? 'opacity-50 cursor-not-allowed pointer-events-none' : ''}`}
           >
             <MessageCircle className="h-5 w-5" />
             Falar com Atendente
           </a>
        </div>
      </div>
      
      <p className="mt-8 text-[10px] text-slate-400 uppercase font-bold tracking-widest opacity-50">
        Rastreio Seguro ‚Ä¢ Gest√£o √ìtica Pro
      </p>
    </div>
  )
}
