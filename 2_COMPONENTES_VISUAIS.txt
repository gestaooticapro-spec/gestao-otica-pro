=== CONTEÚDO: 2_COMPONENTES_VISUAIS.txt ===


==================================================
ARQUIVO: .\src\components\header.tsx
==================================================
// Caminho: src/components/Header.tsx
'use client'

import Link from 'next/link'
import { LogOut } from 'lucide-react'
import LogoutButton from './LogoutButton' // Importamos o componente recém-criado

// O Header é um componente de cliente porque contém o LogoutButton e interatividade
export default function Header() {
  return (
    <header className="fixed top-0 left-0 w-full z-30 bg-white shadow-md">
      <div className="max-w-screen-2xl mx-auto flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
        
        {/* Logo/Título */}
        <Link href="/dashboard/manager" className="text-xl font-bold text-gray-800 hover:text-blue-600 transition-colors">
          Gestão Ótica Pro
        </Link>

        {/* Informações da Sessão e Logout */}
        <div className="flex items-center space-x-4">
          
          {/* Ocultamos o LogoutButton para telas muito pequenas, ou o substituímos por um ícone se necessário. 
             Mantendo simples por enquanto. */}
          <div className="hidden sm:block">
            <LogoutButton />
          </div>
        </div>
      </div>
    </header>
  )
}

==================================================
ARQUIVO: .\src\components\LogoutButton.tsx
==================================================
// Caminho: src/components/LogoutButton.tsx
'use client'

import { LogOut } from 'lucide-react'
import { useRouter } from 'next/navigation'
import { createClient } from '@/lib/supabase/client'

export default function LogoutButton() {
  const router = useRouter()
  const supabase = createClient()

  const handleLogout = async () => {
    // Apaga a sessão do usuário no Supabase
    const { error } = await supabase.auth.signOut()

    if (error) {
      console.error('Erro ao fazer logout:', error)
      alert('Ocorreu um erro ao sair. Tente novamente.')
      return
    }

    // Redireciona para a tela de login
    router.push('/login')
  }

  return (
    <button
      onClick={handleLogout}
      className="flex w-full items-center justify-center gap-2 p-3 rounded-lg text-red-400 bg-gray-800 hover:bg-red-700 hover:text-white transition-colors duration-150 shadow-md"
      title="Sair do Sistema"
    >
      <LogOut className="h-5 w-5" />
      <span className="font-medium text-sm">Sair</span>
    </button>
  )
}

==================================================
ARQUIVO: .\src\components\SideNav.tsx
==================================================
// ARQUIVO: src/components/SideNav.tsx
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname, useRouter } from 'next/navigation';
import { 
  // Ícones
  ShoppingCart, Users, DollarSign, Archive, 
  Settings, BarChart3, Megaphone, Wallet, Zap, Search,
  LogOut, HeartHandshake, FileText,
  FileInput, ArrowLeftRight, FileSpreadsheet, CalendarRange, Percent, Home, LifeBuoy,
  CheckCircle2, Tag, ChevronRight, ChevronLeft, PanelLeftClose, PanelLeftOpen, X, Globe
} from 'lucide-react';
import { createClient } from '@/lib/supabase/client';

// IMPORTS DOS MODAIS
import ParcelaSearchModal from '@/components/modals/ParcelaSearchModal';
import LabTrackingModal from '@/components/modals/LabTrackingModal';
import EntregaModal from '@/components/modals/EntregaModal'; 

type Role = 'admin' | 'manager' | 'store_operator' | 'vendedor' | 'tecnico';

// --- DEFINIÇÃO DE TIPOS ---
interface SubItem {
    label: string;
    icon: React.ElementType;
    route: string;
    allowedRoles: Role[];
    action?: string; 
    withSeparator?: boolean; // <--- NOVA PROPRIEDADE PARA A LINHA
}

interface MenuGroup {
    id: string;
    label: string; 
    icon: React.ElementType;
    allowedRoles: Role[];
    subItems?: SubItem[]; 
    route?: string;       
}

interface SideNavProps {
    userRole: Role;
    storeId: number; 
    storeName: string;
}

// --- CONFIGURAÇÃO DA ESTRUTURA DO MENU ---
const MENU_STRUCTURE: MenuGroup[] = [
    {
        id: 'inicio',
        label: 'Início',
        icon: Home,
        route: '/dashboard/loja/[id]',
        allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico']
    },
    {
        id: 'atendimento',
        label: 'Atendimento',
        icon: ShoppingCart,
        allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'],
        subItems: [
            { label: 'Venda Rápida', icon: Zap, route: '/dashboard/loja/[id]/pdv-express', allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'] },
            { label: 'Venda Óculos', icon: FileText, route: '/dashboard/loja/[id]/atendimento', allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'] }, 
            
            // Separador após Entrega
            { 
                label: 'Entrega Óculos', 
                icon: CheckCircle2, 
                route: '#', 
                action: 'openEntregaModal', 
                allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'],
                withSeparator: true // <--- LINHA AQUI
            }, 
            
            { 
                label: 'Baixa Parcelas', 
                icon: Wallet, 
                route: '#', 
                action: 'openParcelaModal', 
                allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor'] 
            },
            
            // Separador após Nova Assistência
            { 
                label: 'Nova Assistência', 
                icon: LifeBuoy, 
                route: '/dashboard/loja/[id]/assistencia', 
                allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'],
                withSeparator: true // <--- LINHA AQUI
            },
            
            { label: 'Clientes', icon: Users, route: '/dashboard/loja/[id]/clientes', allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'] }, 
            { label: 'Busca Universal', icon: Globe, route: '/dashboard/loja/[id]/busca', allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'] }, 
        ]
    },
    {
        id: 'loja_vazia',
        label: 'Loja Vazia',
        icon: Archive,
        allowedRoles: ['admin', 'manager', 'store_operator'],
        subItems: [
            // Separador após Livro Caixa
            { label: 'Livro Caixa', icon: DollarSign, route: '/dashboard/loja/[id]/financeiro/caixa', allowedRoles: ['admin', 'manager', 'store_operator'], withSeparator: true },
            
            { label: 'Pós-Venda', icon: HeartHandshake, route: '/dashboard/loja/[id]/pos-venda', allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor'] },
            
            // Separador após Cobrança
            { label: 'Cobrança', icon: Megaphone, route: '/dashboard/loja/[id]/cobranca', allowedRoles: ['admin', 'manager', 'store_operator'], withSeparator: true }, 
            
            { label: 'Gaveta (Prontos)', icon: Archive, route: '/dashboard/loja/[id]/gaveta', allowedRoles: ['admin', 'manager', 'store_operator', 'vendedor', 'tecnico'] },
            
            { 
                label: 'Rastrear Lentes', 
                icon: Search, 
                route: '#', 
                action: 'openLabModal', 
                allowedRoles: ['admin', 'manager', 'store_operator', 'tecnico'] 
            }, 

            { label: 'Movimentações', icon: ArrowLeftRight, route: '/dashboard/loja/[id]/estoque/movimentacoes', allowedRoles: ['admin', 'manager', 'store_operator', 'tecnico'] },
            
            // Separador após Importar XML
            { label: 'Importar XML', icon: FileInput, route: '/dashboard/loja/[id]/importacao', allowedRoles: ['admin', 'manager', 'store_operator', 'tecnico'], withSeparator: true },
            
            { label: 'Produtos & Preços', icon: Tag, route: '/dashboard/loja/[id]/cadastros', allowedRoles: ['admin', 'manager', 'store_operator', 'tecnico'] },
            { label: 'Histórico Vendas', icon: FileSpreadsheet, route: '/dashboard/loja/[id]/vendas', allowedRoles: ['admin', 'manager', 'store_operator'] },
        ]
    },
    {
        id: 'gerencia',
        label: 'Gerência',
        icon: Settings,
        allowedRoles: ['admin', 'manager'],
        subItems: [
            { label: 'Contas a Pagar', icon: CalendarRange, route: '/dashboard/loja/[id]/financeiro/contas', allowedRoles: ['admin', 'manager'] },
            { label: 'Comissões', icon: Percent, route: '/dashboard/loja/[id]/financeiro/comissoes', allowedRoles: ['admin', 'manager'] },
            
            // Separador após Relatórios
            { label: 'Relat. Vendas', icon: BarChart3, route: '/dashboard/loja/[id]/reports/vendas', allowedRoles: ['admin', 'manager'], withSeparator: true },
            
            { label: 'Configuração', icon: Settings, route: '/dashboard/loja/[id]/config', allowedRoles: ['admin', 'manager'] },
        ]
    }
];

export default function SideNav({ userRole, storeId, storeName }: SideNavProps) {
    const router = useRouter();
    const pathname = usePathname();
    const supabase = createClient();
    
    // --- ESTADOS ---
    const [isMainCollapsed, setIsMainCollapsed] = useState(true); 
    const [activePanel, setActivePanel] = useState<string | null>(null); 
    const [isSubCollapsed, setIsSubCollapsed] = useState(false); 

    // Modais
    const [isParcelaModalOpen, setIsParcelaModalOpen] = useState(false);
    const [isLabModalOpen, setIsLabModalOpen] = useState(false);
    const [isEntregaModalOpen, setIsEntregaModalOpen] = useState(false); 

    useEffect(() => {
        // Opcional: Fecha o painel ao navegar
        // setActivePanel(null); 
    }, [pathname]);

    const handleLogout = async () => {
        const { error } = await supabase.auth.signOut();
        if (error) alert('Erro ao sair');
        router.push('/login');
    };

    const handleMainClick = (group: MenuGroup) => {
        if (group.route) {
            setActivePanel(null);
            router.push(group.route.replace('[id]', storeId.toString()));
            return;
        }

        if (activePanel === group.id) {
            setActivePanel(null);
        } else {
            setActivePanel(group.id);
            setIsSubCollapsed(false); 
        }
    };

    const getActiveColor = (id: string) => {
        if (id === 'atendimento') return 'bg-blue-600 text-white shadow-blue-200';
        if (id === 'loja_vazia') return 'bg-amber-600 text-white shadow-amber-200';
        if (id === 'gerencia') return 'bg-purple-600 text-white shadow-purple-200';
        if (id === 'inicio') return 'bg-slate-800 text-white shadow-slate-300';
        return 'bg-slate-100 text-slate-600';
    };

    const renderSubPanel = () => {
        const group = MENU_STRUCTURE.find(g => g.id === activePanel);
        if (!group || !group.subItems) return null;

        return (
            <div className={`bg-slate-50 border-r border-gray-200 h-full flex flex-col transition-all duration-300 ease-in-out shadow-xl z-40 relative ${isSubCollapsed ? 'w-20' : 'w-64'}`}>
                <div className="h-20 border-b border-gray-200 flex items-center justify-between px-4 bg-white shrink-0">
                    {!isSubCollapsed && (
                        <h3 className="font-black text-slate-700 uppercase tracking-widest text-xs truncate animate-in fade-in">
                            {group.label}
                        </h3>
                    )}
                    <div className="flex gap-1 ml-auto">
                        <button onClick={() => setIsSubCollapsed(!isSubCollapsed)} className="p-1.5 hover:bg-slate-100 rounded text-slate-400 hover:text-slate-600 transition-colors">
                            {isSubCollapsed ? <PanelLeftOpen className="h-4 w-4" /> : <PanelLeftClose className="h-4 w-4" />}
                        </button>
                        {!isSubCollapsed && (
                            <button onClick={() => setActivePanel(null)} className="p-1.5 hover:bg-red-50 rounded text-slate-400 hover:text-red-500 transition-colors">
                                <X className="h-4 w-4" />
                            </button>
                        )}
                    </div>
                </div>

                <div className="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar">
                    {group.subItems.filter(sub => sub.allowedRoles.includes(userRole)).map(sub => {
                        let activeClass = 'bg-slate-200 text-slate-900 font-bold';
                        let iconActiveColor = 'text-slate-700';

                        if (group.id === 'atendimento') { activeClass = 'bg-blue-100 text-blue-800 font-bold'; iconActiveColor = 'text-blue-600'; }
                        if (group.id === 'loja_vazia') { activeClass = 'bg-amber-100 text-amber-800 font-bold'; iconActiveColor = 'text-amber-600'; }
                        if (group.id === 'gerencia') { activeClass = 'bg-purple-100 text-purple-800 font-bold'; iconActiveColor = 'text-purple-600'; }

                        const baseClass = `flex items-center rounded-lg transition-all duration-200 group/item relative ${isSubCollapsed ? 'justify-center p-3 aspect-square' : 'gap-3 p-3 w-full text-left'}`;

                        // LÓGICA DE AÇÃO
                        const isAction = !!sub.action;
                        const finalRoute = isAction ? '#' : sub.route.replace('[id]', storeId.toString());
                        const isActive = !isAction && pathname === finalRoute;

                        const content = (
                            <>
                                <sub.icon className={`flex-shrink-0 transition-transform duration-200 ${isSubCollapsed ? 'h-6 w-6' : 'h-4 w-4'} ${isActive ? iconActiveColor : 'opacity-70 group-hover/item:opacity-100 group-hover/item:scale-110 text-slate-500'}`} />
                                {!isSubCollapsed && <span className="text-sm truncate">{sub.label}</span>}
                                {!isSubCollapsed && isActive && <ChevronRight className="h-3 w-3 ml-auto opacity-50" />}
                            </>
                        );

                        // Decide se renderiza Link ou Button
                        const itemElement = isAction ? (
                             <button
                                onClick={() => {
                                    if (sub.action === 'openParcelaModal') setIsParcelaModalOpen(true);
                                    if (sub.action === 'openLabModal') setIsLabModalOpen(true); 
                                    if (sub.action === 'openEntregaModal') setIsEntregaModalOpen(true); 
                                }}
                                className={`${baseClass} ${isActive ? activeClass : 'hover:bg-white hover:shadow-sm text-slate-600 hover:text-slate-900'}`}
                                title={isSubCollapsed ? sub.label : ''}
                            >
                                {content}
                            </button>
                        ) : (
                            <Link href={finalRoute} className={`${baseClass} ${isActive ? activeClass : 'hover:bg-white hover:shadow-sm text-slate-600 hover:text-slate-900'}`} title={isSubCollapsed ? sub.label : ''}>
                                {content}
                            </Link>
                        );

                        return (
                            <div key={sub.label} className="block">
                                {itemElement}
                                {/* RENDERIZA A LINHA APENAS SE FOR SOLICITADO E O MENU ESTIVER ABERTO */}
                                {sub.withSeparator && !isSubCollapsed && (
                                    <div className="my-2 border-b border-gray-200 mx-2" />
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    };

    return (
        <div className="flex h-full relative z-50">
            <nav className={`bg-white border-r border-gray-200 h-full flex flex-col py-4 z-50 shadow-md relative transition-all duration-300 ease-in-out ${isMainCollapsed ? 'w-20 items-center' : 'w-64 px-4'}`}>
                <div className={`mb-8 flex items-center ${isMainCollapsed ? 'justify-center' : 'justify-between'}`}>
                    <div className="h-10 w-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center text-white font-black text-xs shadow-lg cursor-default select-none shrink-0">PRO</div>
                    {!isMainCollapsed && (
                        <div className="ml-3 overflow-hidden">
                            <h2 className="text-sm font-bold text-slate-800 whitespace-nowrap">Gestão Ótica</h2>
                            <p className="text-[10px] text-slate-400 font-medium uppercase truncate">{storeName}</p>
                        </div>
                    )}
                </div>

                <div className="flex-1 w-full space-y-3">
                    {MENU_STRUCTURE.filter(grp => grp.allowedRoles.includes(userRole)).map(group => {
                        const isActive = activePanel === group.id || (group.id === 'inicio' && pathname === `/dashboard/loja/${storeId}`);
                        return (
                            <button
                                key={group.id}
                                onClick={() => handleMainClick(group)}
                                className={`flex items-center rounded-2xl transition-all duration-200 group relative ${isMainCollapsed ? 'justify-center w-14 h-14' : 'w-full px-4 py-3 gap-4'} ${isActive ? `${getActiveColor(group.id)} shadow-lg` : 'text-slate-400 hover:bg-slate-50 hover:text-slate-600'}`}
                                title={isMainCollapsed ? group.label : ''}
                            >
                                <group.icon className={`transition-transform flex-shrink-0 ${isMainCollapsed ? 'h-6 w-6' : 'h-5 w-5'} ${isActive && isMainCollapsed ? 'scale-110' : 'group-hover:scale-110'}`} />
                                {!isMainCollapsed && <span className={`text-sm font-bold uppercase tracking-wide ${isActive ? 'opacity-100' : 'text-slate-500 group-hover:text-slate-700'}`}>{group.label}</span>}
                                {activePanel === group.id && group.id !== 'inicio' && isMainCollapsed && <div className="absolute -right-3 top-1/2 -translate-y-1/2 w-0 h-0 border-t-[6px] border-t-transparent border-l-[6px] border-l-white border-b-[6px] border-b-transparent drop-shadow-sm filter"></div>}
                                {activePanel === group.id && group.id !== 'inicio' && !isMainCollapsed && <ChevronRight className="ml-auto h-4 w-4 opacity-50" />}
                            </button>
                        );
                    })}
                </div>

                <div className="mt-auto pt-4 border-t border-gray-100 w-full flex flex-col gap-2">
                    <button onClick={() => setIsMainCollapsed(!isMainCollapsed)} className={`flex items-center rounded-xl text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-all ${isMainCollapsed ? 'justify-center w-14 h-14' : 'w-full px-4 py-3 gap-3'}`} title={isMainCollapsed ? "Expandir Menu" : "Recolher Menu"}>
                         {isMainCollapsed ? <ChevronRight className="h-5 w-5" /> : <ChevronLeft className="h-5 w-5" />}
                         {!isMainCollapsed && <span className="font-bold text-xs uppercase">Recolher</span>}
                    </button>
                    <button onClick={handleLogout} className={`flex items-center rounded-xl text-red-300 hover:bg-red-50 hover:text-red-500 transition-all ${isMainCollapsed ? 'justify-center w-14 h-14' : 'w-full px-4 py-3 gap-3'}`} title="Sair">
                        <LogOut className="h-5 w-5" />
                        {!isMainCollapsed && <span className="font-bold text-sm">Sair</span>}
                    </button>
                </div>
            </nav>

            {activePanel && renderSubPanel()}

            {/* MODAIS GLOBAIS */}
            <ParcelaSearchModal 
                isOpen={isParcelaModalOpen}
                onClose={() => setIsParcelaModalOpen(false)}
                storeId={storeId}
            />
            
            <LabTrackingModal 
                isOpen={isLabModalOpen} 
                onClose={() => setIsLabModalOpen(false)} 
                storeId={storeId} 
            />

            <EntregaModal 
                isOpen={isEntregaModalOpen}
                onClose={() => setIsEntregaModalOpen(false)}
                storeId={storeId}
            />

        </div>
    );
}

==================================================
ARQUIVO: .\src\components\assistencia\AssistanceKanban.tsx
==================================================
'use client'

import { useState, useTransition } from 'react'
import { updateTicketStatus } from '@/lib/actions/assistance.actions'
import NewAssistanceModal from '@/components/modals/NewAssistanceModal'
import AssistanceTimelineModal from '@/components/modals/AssistanceTimelineModal' // Novo Import
import { 
  Plus, ArrowRight, Clock, CheckCircle, 
  Package, MessageCircle, RefreshCw, MessageSquare 
} from 'lucide-react'

const COLUMNS = {
  'Triagem': { label: 'Triagem / Análise', color: 'bg-slate-100 border-slate-200' },
  'EmTratativa': { label: 'Em Tratativa', color: 'bg-blue-50 border-blue-100' },
  'AguardandoChegada': { label: 'Aguardando Peça', color: 'bg-amber-50 border-amber-100' },
  'AguardandoCliente': { label: 'Pronto / Retirada', color: 'bg-emerald-50 border-emerald-100' },
  'LogisticaReversa': { label: 'Logística Reversa', color: 'bg-rose-50 border-rose-100' }
}

export default function AssistanceKanban({ initialData, storeId }: { initialData: any[], storeId: number }) {
  const [tickets, setTickets] = useState(initialData)
  
  const [isNewModalOpen, setIsNewModalOpen] = useState(false)
  
  // Controle do Modal de Timeline
  const [selectedTicket, setSelectedTicket] = useState<any>(null)
  const [isTimelineOpen, setIsTimelineOpen] = useState(false)

  const [isPending, startTransition] = useTransition()

  const moveTicket = (ticketId: number, nextStatus: string, actionMsg: string) => {
    if (!confirm(actionMsg)) return

    startTransition(async () => {
       const res = await updateTicketStatus(ticketId, nextStatus, storeId)
       if (res.success) {
         setTickets(prev => prev.map(t => t.id === ticketId ? { ...t, status: nextStatus } : t))
       } else {
         alert(res.message)
       }
    })
  }

  const sendTrackingLink = (ticket: any) => {
     if (!ticket.customers?.fone_movel) return alert('Cliente sem telefone.')
     const num = ticket.customers.fone_movel.replace(/\D/g, '')
     const link = `${window.location.origin}/rastreio/${ticket.tracking_token}`
     const msg = `Olá ${ticket.customers.full_name.split(' ')[0]}, acompanhe sua garantia aqui: ${link}`
     window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank')
  }

  const openTimeline = (ticket: any) => {
      setSelectedTicket(ticket)
      setIsTimelineOpen(true)
  }

  const handleTicketCreated = (newTicket: any) => {
      // Adiciona o novo ticket no topo da lista local
      setTickets(prev => [newTicket, ...prev])
  }

  return (
    <div className="h-full flex flex-col">
      <div className="px-6 py-4 flex justify-end bg-slate-50 border-b border-slate-200">
         <button 
           onClick={() => setIsNewModalOpen(true)}
           className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 text-sm transition-all"
         >
           <Plus className="h-5 w-5" /> Nova Assistência
         </button>
      </div>

      <div className="flex-1 overflow-x-auto overflow-y-hidden p-6">
        <div className="flex gap-4 h-full min-w-[1200px]">
          
          {Object.entries(COLUMNS).map(([key, config]) => {
            const items = tickets.filter(t => t.status === key)
            
            return (
              <div key={key} className={`flex-1 flex flex-col rounded-xl border ${config.color} min-w-[280px]`}>
                <div className="p-3 border-b border-white/50 bg-white/30 backdrop-blur-sm">
                   <h3 className="font-bold text-slate-700 text-xs uppercase tracking-wider flex justify-between">
                     {config.label}
                     <span className="bg-white px-2 py-0.5 rounded-full text-slate-500 shadow-sm">{items.length}</span>
                   </h3>
                </div>

                <div className="flex-1 overflow-y-auto p-2 space-y-3 custom-scrollbar">
                  {items.map(ticket => (
                    <div key={ticket.id} className="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-md transition-all relative group">
                       
                       <div className="flex justify-between items-start mb-2">
                          <span className={`text-[9px] font-black uppercase px-1.5 py-0.5 rounded border 
                             ${ticket.modalidade === 'TrocaGarantida' ? 'bg-purple-100 text-purple-700 border-purple-200' : 
                               ticket.modalidade === 'TrocaImediata' ? 'bg-orange-100 text-orange-700 border-orange-200' : 
                               'bg-blue-100 text-blue-700 border-blue-200'}`}>
                             {ticket.modalidade === 'TrocaGarantida' ? 'Troca Garantida' : 
                              ticket.modalidade === 'TrocaImediata' ? 'Troca Imediata' : 'Padrão'}
                          </span>
                          <span className="text-[10px] text-slate-400 font-mono">#{ticket.id}</span>
                       </div>

                       <p className="font-bold text-slate-800 text-sm mb-1">{ticket.product_descricao}</p>
                       <p className="text-xs text-slate-500 flex items-center gap-1 mb-3">
                         <span className="truncate max-w-[150px]">{ticket.customers.full_name}</span>
                       </p>

                       <div className="border-t border-slate-100 pt-2 mt-2 flex justify-between items-center">
                          <div className="flex gap-1">
                              <button onClick={() => sendTrackingLink(ticket)} className="p-1.5 hover:bg-green-50 rounded text-slate-400 hover:text-green-600 transition-colors" title="Rastreio WhatsApp">
                                 <MessageCircle className="h-4 w-4" />
                              </button>
                              <button onClick={() => openTimeline(ticket)} className="p-1.5 hover:bg-blue-50 rounded text-slate-400 hover:text-blue-600 transition-colors" title="Histórico / Chat">
                                 <MessageSquare className="h-4 w-4" />
                              </button>
                          </div>

                          {/* Ações de Transição */}
                          {key === 'Triagem' && (
                             <button onClick={() => moveTicket(ticket.id, 'EmTratativa', 'Confirmar contato com fornecedor?')} className="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100 flex items-center gap-1">
                                Iniciar <ArrowRight className="h-3 w-3"/>
                             </button>
                          )}
                          
                          {key === 'EmTratativa' && (
                             <button onClick={() => moveTicket(ticket.id, 'AguardandoChegada', 'A peça foi solicitada?')} className="text-[10px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded hover:bg-indigo-100 flex items-center gap-1">
                                Solicitado <Clock className="h-3 w-3"/>
                             </button>
                          )}

                          {key === 'AguardandoChegada' && (
                             <button onClick={() => moveTicket(ticket.id, 'AguardandoCliente', 'A peça chegou?')} className="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded hover:bg-emerald-100 flex items-center gap-1">
                                Chegou <Package className="h-3 w-3"/>
                             </button>
                          )}

                          {key === 'AguardandoCliente' && (
                             <button onClick={() => moveTicket(ticket.id, ticket.modalidade === 'Padrao' ? 'Concluido' : 'LogisticaReversa', 'Cliente retirou?')} className="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded hover:bg-orange-100 flex items-center gap-1">
                                Entregue <RefreshCw className="h-3 w-3"/>
                             </button>
                          )}

                          {key === 'LogisticaReversa' && (
                             <button onClick={() => moveTicket(ticket.id, 'Concluido', 'Peça enviada ao fornecedor?')} className="text-[10px] font-bold text-green-600 bg-green-50 px-2 py-1 rounded hover:bg-green-100 flex items-center gap-1">
                                Finalizar <CheckCircle className="h-3 w-3"/>
                             </button>
                          )}
                       </div>
                    </div>
                  ))}
                </div>
              </div>
            )
          })}
        </div>
      </div>

      <NewAssistanceModal 
        isOpen={isNewModalOpen} 
        onClose={() => setIsNewModalOpen(false)} 
        storeId={storeId} 
        onSuccess={handleTicketCreated} // Atualização sem F5
      />

      <AssistanceTimelineModal 
        isOpen={isTimelineOpen}
        onClose={() => setIsTimelineOpen(false)}
        ticket={selectedTicket}
      />
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\cadastros\ImportacaoLentesInterface.tsx
==================================================
// ARQUIVO: src/components/cadastros/ImportacaoLentesInterface.tsx
'use client'

import { useState, useTransition, useRef } from 'react'
import { UploadCloud, FileText, ArrowRight, Save, Loader2, CheckCircle, Calculator } from 'lucide-react'
import { processarImportacaoLentes, type LenteImportada } from '@/lib/actions/import.actions'

// Parser simples de CSV
const parseCSV = (text: string) => {
    const lines = text.split('\n').filter(l => l.trim() !== '')
    const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''))
    
    const separator = headers.length > 1 ? ';' : ','
    const finalHeaders = lines[0].split(separator).map(h => h.trim().replace(/"/g, ''))

    const data = lines.slice(1).map(line => {
        const regex = new RegExp(`(?:${separator}|\\r?\\n|^)(?:"([^"]*)"|([^"${separator}\\r\\n]*))`, 'gi');
        const row: string[] = []
        let matches
        while ((matches = regex.exec(line)) !== null) {
            if (matches[1] !== undefined || matches[2] !== undefined) {
                 row.push((matches[1] || matches[2] || '').trim())
            }
        }
        if (row.length > finalHeaders.length) row.shift() 
        return row
    })
    return { headers: finalHeaders, data }
}

const formatMoney = (v: number) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

export default function ImportacaoLentesInterface({ storeId }: { storeId: number }) {
    const [step, setStep] = useState(1)
    const [csvData, setCsvData] = useState<{ headers: string[], data: string[][] } | null>(null)
    const [fileName, setFileName] = useState('')
    const [isDragging, setIsDragging] = useState(false)
    
    const [mapping, setMapping] = useState({
        nome: -1,
        linha: -1,
        material: -1,
        tipo: -1,
        valor: -1
    })

    const [config, setConfig] = useState({
        marcaPadrao: '',
        tipoTabela: 'venda' as 'venda' | 'custo',
        fator: 40,
        isPar: true
    })

    const [previewItens, setPreviewItens] = useState<LenteImportada[]>([])
    const [isSaving, startTransition] = useTransition()
    const [result, setResult] = useState<any>(null)
    const fileInputRef = useRef<HTMLInputElement>(null)

    const processFile = (file: File) => {
        if (file) {
            setFileName(file.name)
            const reader = new FileReader()
            reader.onload = (evt) => {
                const text = evt.target?.result as string
                const parsed = parseCSV(text)
                setCsvData(parsed)
                setStep(2)
            }
            reader.readAsText(file)
        }
    }

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0]
        if (file) processFile(file)
    }

    const handleDragOver = (e: React.DragEvent) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(true)
    }

    const handleDragLeave = (e: React.DragEvent) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(false)
    }

    const handleDrop = (e: React.DragEvent) => {
        e.preventDefault()
        e.stopPropagation()
        setIsDragging(false)
        
        const file = e.dataTransfer.files?.[0]
        if (file && file.name.toLowerCase().endsWith('.csv')) {
            processFile(file)
        } else {
            alert('Por favor, solte um arquivo CSV válido.')
        }
    }

    const handleGeneratePreview = () => {
        if (!csvData) return
        if (mapping.valor === -1 || mapping.nome === -1) {
            alert("É obrigatório mapear pelo menos a coluna de Nome e Valor.")
            return
        }
        if (!config.marcaPadrao) {
            alert("Digite a marca padrão para estas lentes.")
            return
        }

        const itensProcessados: LenteImportada[] = []

        csvData.data.forEach(row => {
            const nomeRaw = row[mapping.nome] || ''
            const linhaRaw = mapping.linha > -1 ? row[mapping.linha] : ''
            const matRaw = mapping.material > -1 ? row[mapping.material] : ''
            const tipoRaw = mapping.tipo > -1 ? row[mapping.tipo] : 'Visão Simples'
            
            let valorRawStr = row[mapping.valor] || '0'
            valorRawStr = valorRawStr.replace(/[R$\s.]/g, '').replace(',', '.')
            let valorBase = parseFloat(valorRawStr) || 0

            if (config.isPar) {
                valorBase = valorBase / 2
            }

            let custoFinal = 0
            let vendaFinal = 0

            if (config.tipoTabela === 'venda') {
                vendaFinal = valorBase
                custoFinal = valorBase * (config.fator / 100)
            } else {
                custoFinal = valorBase
                vendaFinal = valorBase * config.fator
            }

            const partesNome = [config.marcaPadrao, linhaRaw, nomeRaw, matRaw].filter(Boolean)
            const nomeCompleto = [...new Set(partesNome)].join(' ')

            if (nomeRaw && valorBase > 0) {
                itensProcessados.push({
                    nome_completo: nomeCompleto,
                    marca: config.marcaPadrao,
                    linha: linhaRaw || '-',
                    material: matRaw || '-',
                    tipo_lente: tipoRaw,
                    preco_custo: parseFloat(custoFinal.toFixed(2)),
                    preco_venda: parseFloat(vendaFinal.toFixed(2)),
                    detalhes: {}
                })
            }
        })

        setPreviewItens(itensProcessados)
        setStep(3)
    }

    const handleConfirm = () => {
        startTransition(async () => {
            const res = await processarImportacaoLentes(storeId, previewItens)
            setResult(res)
            setStep(4)
        })
    }

    if (step === 4 && result) {
        return (
            <div className="flex flex-col items-center justify-center h-full space-y-6 animate-in zoom-in">
                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                    <CheckCircle className="h-10 w-10" />
                </div>
                <h2 className="text-2xl font-bold text-gray-800">Importação Concluída!</h2>
                <div className="bg-white p-6 rounded-lg shadow border border-gray-200 w-full max-w-md text-sm">
                    <div className="flex justify-between py-2 border-b">
                        <span>Lentes Processadas:</span>
                        <strong>{result.processed}</strong>
                    </div>
                    <div className="flex justify-between py-2 border-b text-green-600">
                        <span>Novas Criadas:</span>
                        <strong>{result.created}</strong>
                    </div>
                    <div className="flex justify-between py-2 border-b text-blue-600">
                        <span>Preços Atualizados:</span>
                        <strong>{result.updated}</strong>
                    </div>
                    {result.errors.length > 0 && (
                        <div className="mt-4 p-3 bg-red-50 text-red-700 rounded text-xs">
                            <strong>Erros ({result.errors.length}):</strong>
                            <ul className="list-disc pl-4 mt-1">
                                {result.errors.slice(0, 5).map((e: string, i: number) => <li key={i}>{e}</li>)}
                            </ul>
                        </div>
                    )}
                </div>
                <button onClick={() => window.location.href = `/dashboard/loja/${storeId}/cadastros`} className="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-black">
                    Ir para Catálogo
                </button>
            </div>
        )
    }

    return (
        <div className="flex flex-col h-full bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            
            <div className="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center">
                <h1 className="font-bold text-lg text-gray-700 flex items-center gap-2">
                    <FileText className="h-5 w-5 text-blue-600" /> Importador de Lentes (CSV)
                </h1>
                <div className="flex gap-2">
                    <StepBadge num={1} active={step===1} label="Arquivo" />
                    <StepBadge num={2} active={step===2} label="Mapeamento" />
                    <StepBadge num={3} active={step===3} label="Confirmação" />
                </div>
            </div>

            <div className="flex-1 overflow-y-auto p-6">
                
                {step === 1 && (
                    <div 
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        className={`h-full flex flex-col items-center justify-center border-2 border-dashed rounded-xl p-10 transition-all duration-200
                          ${isDragging ? 'border-blue-500 bg-blue-50 scale-[1.01]' : 'border-gray-300 bg-gray-50/50 hover:bg-blue-50'}
                        `}
                    >
                        <div className={`p-4 rounded-full mb-4 transition-transform ${isDragging ? 'bg-blue-200 scale-110' : 'bg-transparent'}`}>
                            <UploadCloud className={`h-16 w-16 ${isDragging ? 'text-blue-600' : 'text-gray-300'}`} />
                        </div>
                        
                        <label className="cursor-pointer text-center">
                            <span className="text-lg font-bold text-gray-700 block mb-2">
                                {isDragging ? 'Pode soltar o arquivo!' : 'Arraste e solte aqui'}
                            </span>
                            <span className="block text-sm text-gray-500 mb-4">ou</span>
                            <span className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md inline-block">
                                Selecionar Arquivo CSV
                            </span>
                            <input 
                                ref={fileInputRef}
                                type="file" 
                                accept=".csv" 
                                className="hidden" 
                                onChange={handleFileChange} 
                            />
                        </label>
                        <p className="mt-6 text-sm text-gray-400">
                            Recomendado: Arquivo separado por ponto-e-vírgula (;) ou vírgula.
                        </p>
                    </div>
                )}

                {step === 2 && csvData && (
                    <div className="space-y-8 animate-in slide-in-from-right-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="font-bold text-gray-800 mb-4 border-b pb-2">1. O que é cada coluna?</h3>
                                <div className="space-y-3">
                                    <MappingSelect 
                                        label="Tratamento (Obrigatório)" 
                                        value={mapping.nome} 
                                        onChange={(v: string) => setMapping({...mapping, nome: parseInt(v)})} 
                                        options={csvData.headers} 
                                    />
                                    <MappingSelect 
                                        label="Coluna de Valor (Obrigatório)" 
                                        value={mapping.valor} 
                                        onChange={(v: string) => setMapping({...mapping, valor: parseInt(v)})} 
                                        options={csvData.headers} 
                                    />
                                    <MappingSelect 
                                        label="Linha (Ex: Varilux)" 
                                        value={mapping.linha} 
                                        onChange={(v: string) => setMapping({...mapping, linha: parseInt(v)})} 
                                        options={csvData.headers} 
                                    />
                                    <MappingSelect 
                                        label="Material" 
                                        value={mapping.material} 
                                        onChange={(v: string) => setMapping({...mapping, material: parseInt(v)})} 
                                        options={csvData.headers} 
                                    />
                                    <MappingSelect 
                                        label="Tipo (Multifocal/Visão)" 
                                        value={mapping.tipo} 
                                        onChange={(v: string) => setMapping({...mapping, tipo: parseInt(v)})} 
                                        options={csvData.headers} 
                                    />
                                </div>
                            </div>

                            <div className="bg-blue-50 p-5 rounded-xl border border-blue-100 shadow-sm">
                                <h3 className="font-bold text-blue-900 mb-4 border-b border-blue-200 pb-2 flex items-center gap-2">
                                     <Calculator className="h-4 w-4" /> 2. Regras de Preço
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Marca Padrão</label>
                                        <input type="text" value={config.marcaPadrao} onChange={e => setConfig({...config, marcaPadrao: e.target.value})} className="w-full rounded border-gray-300 h-9 px-2" placeholder="Ex: Hoya" />
                                    </div>
                                    <div className="flex items-center gap-2 bg-white p-2 rounded border border-gray-200">
                                        <input type="checkbox" checked={config.isPar} onChange={e => setConfig({...config, isPar: e.target.checked})} className="rounded text-blue-600 focus:ring-blue-500" />
                                        <span className="text-sm font-medium text-gray-700">Tabela é por PAR (Dividir valor por 2)</span>
                                    </div>
                                    <div className="border-t border-blue-200 pt-3">
                                        <p className="text-sm font-bold text-blue-800 mb-2">O valor no CSV é:</p>
                                        <div className="flex gap-4 mb-3">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input type="radio" name="tipoTabela" checked={config.tipoTabela === 'venda'} onChange={() => setConfig({...config, tipoTabela: 'venda'})} />
                                                <span className="text-sm">Preço de Venda</span>
                                            </label>
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input type="radio" name="tipoTabela" checked={config.tipoTabela === 'custo'} onChange={() => setConfig({...config, tipoTabela: 'custo'})} />
                                                <span className="text-sm">Preço de Custo</span>
                                            </label>
                                        </div>
                                        {config.tipoTabela === 'venda' ? (
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Margem de Custo (%)</label>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={config.fator} onChange={e => setConfig({...config, fator: parseFloat(e.target.value)})} className="w-24 rounded border-gray-300 h-9 px-2 text-right" />
                                                    <span className="text-xs text-gray-500">Ex: Se venda é 100 e margem 40%, custo será 40.</span>
                                                </div>
                                            </div>
                                        ) : (
                                            <div>
                                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Markup (Multiplicador)</label>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" value={config.fator} onChange={e => setConfig({...config, fator: parseFloat(e.target.value)})} className="w-24 rounded border-gray-300 h-9 px-2 text-right" />
                                                    <span className="text-xs text-gray-500">Ex: Se custo é 100 e markup 2.5, venda será 250.</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="flex justify-end pt-4">
                            <button onClick={handleGeneratePreview} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md flex items-center gap-2">
                                Gerar Prévia <ArrowRight className="h-5 w-5" />
                            </button>
                        </div>
                    </div>
                )}

                {step === 3 && (
                    <div className="flex flex-col h-full animate-in slide-in-from-bottom-4">
                        <div className="mb-4 flex justify-between items-center">
                            <h3 className="font-bold text-gray-800">Confira os dados antes de importar ({previewItens.length} itens)</h3>
                            <button onClick={handleConfirm} disabled={isSaving} className="bg-green-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-green-700 shadow-md flex items-center gap-2 disabled:opacity-50">
                                {isSaving ? <Loader2 className="h-5 w-5 animate-spin"/> : <Save className="h-5 w-5" />}
                                Confirmar Importação
                            </button>
                        </div>
                        <div className="flex-1 overflow-auto border border-gray-300 rounded-lg">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-gray-100 text-gray-600 font-bold uppercase text-xs sticky top-0">
                                    <tr>
                                        <th className="p-3 border-b">Nome Gerado</th>
                                        <th className="p-3 border-b">Marca</th>
                                        <th className="p-3 border-b">Linha</th>
                                        <th className="p-3 border-b">Material</th>
                                        <th className="p-3 border-b text-right bg-blue-50">Custo (Unit)</th>
                                        <th className="p-3 border-b text-right bg-green-50">Venda (Unit)</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {previewItens.map((item, i) => (
                                        <tr key={i} className="hover:bg-gray-50">
                                            <td className="p-3 font-medium text-gray-800">{item.nome_completo}</td>
                                            <td className="p-3 text-gray-500">{item.marca}</td>
                                            <td className="p-3 text-gray-500">{item.linha}</td>
                                            <td className="p-3 text-gray-500">{item.material}</td>
                                            <td className="p-3 text-right bg-blue-50/30 text-blue-800 font-mono">{formatMoney(item.preco_custo)}</td>
                                            <td className="p-3 text-right bg-green-50/30 text-green-800 font-bold font-mono">{formatMoney(item.preco_venda)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="mt-4">
                            <button onClick={() => setStep(2)} className="text-gray-500 hover:text-gray-800 underline text-sm">Voltar e ajustar regras</button>
                        </div>
                    </div>
                )}

            </div>
        </div>
    )
}

function StepBadge({ num, active, label }: { num: number, active: boolean, label: string }) {
    return (
        <div className={`flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold ${active ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
            <span className={`w-4 h-4 rounded-full flex items-center justify-center text-[9px] ${active ? 'bg-white text-blue-600' : 'bg-gray-400 text-white'}`}>{num}</span>
            {label}
        </div>
    )
}

function MappingSelect({ label, value, onChange, options }: any) {
    return (
        <div className="flex flex-col">
            <label className="text-xs font-bold text-gray-600 mb-1">{label}</label>
            <select value={value} onChange={e => onChange(e.target.value)} className="rounded border-gray-300 text-sm h-9">
                <option value={-1}>-- Ignorar / Não tem --</option>
                {options.map((opt: string, i: number) => (
                    <option key={i} value={i}>{opt}</option>
                ))}
            </select>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\cobranca\CobrancaInterface.tsx
==================================================
// Caminho: src/components/cobranca/CobrancaInterface.tsx
'use client'

import { useState, useEffect, useTransition, useRef } from 'react'
import { useRouter } from 'next/navigation'
import { 
  DevedorResumo, 
  CobrancaHistoricoItem, 
  registrarCobranca, 
  toggleSpcStatus,
  getHistoricoCobranca,
  getDetalhesDivida 
} from '@/lib/actions/collection.actions'
import { 
  User, Phone, MessageCircle, AlertTriangle, 
  CheckCircle2, History, Send, ShieldAlert, Loader2, Filter,
  ShoppingBag, Calendar, ChevronDown, ChevronUp, Wallet, Megaphone
} from 'lucide-react'

// --- Helpers de Formatação ---
const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (dateStr: string | null) => dateStr ? new Date(dateStr).toLocaleDateString('pt-BR') : '-'
const formatDateTime = (dateStr: string) => new Date(dateStr).toLocaleString('pt-BR')

// --- DESIGN SYSTEM (ALTO CONTRASTE) ---
const labelStyle = "block text-[10px] font-bold text-slate-700 uppercase mb-0.5 tracking-wider"
const inputStyle = "block w-full rounded-md border border-slate-300 bg-white shadow-sm text-slate-900 h-9 text-xs px-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-bold transition-all placeholder:font-normal"

// --- Componente: Badge de Atraso ---
function AtrasoBadge({ dias }: { dias: number }) {
    let color = 'bg-slate-100 text-slate-600 border-slate-200'
    let label = 'Em dia'
    
    if (dias > 30) { color = 'bg-red-100 text-red-700 border-red-200'; label = `${dias} dias` }
    else if (dias > 5) { color = 'bg-orange-100 text-orange-700 border-orange-200'; label = `${dias} dias` }
    else if (dias > 0) { color = 'bg-amber-100 text-amber-800 border-amber-200'; label = `${dias} dias` }
    
    return <span className={`text-[10px] font-bold px-2 py-0.5 rounded border uppercase tracking-wide ${color}`}>{label} atraso</span>
}

// --- Componente: Card de Venda Detalhada ---
function CardVendaDetalhada({ dados }: { dados: any }) {
    const [isExpanded, setIsExpanded] = useState(false)
    
    const venda = dados.vendas
    const parcelas = dados.financiamento_parcelas || []
    
    parcelas.sort((a: any, b: any) => a.numero_parcela - b.numero_parcela)

    const parcelasAtrasadas = parcelas.filter((p: any) => {
         if (p.status !== 'Pendente') return false;
        return new Date(p.data_vencimento) < new Date();
    });

    const isCritical = parcelasAtrasadas.length > 0;
    const valorTotal = venda ? venda.valor_final : dados.valor_total;
    const dataVenda = venda ? venda.created_at : dados.created_at;

    return (
        <div className={`mb-3 rounded-xl border ${isCritical ? 'border-red-200 bg-white' : 'border-slate-200 bg-white'} shadow-sm overflow-hidden`}>
            <div 
                onClick={() => setIsExpanded(!isExpanded)}
                className={`p-3 flex justify-between items-center cursor-pointer transition-colors ${isCritical ? 'bg-red-50 hover:bg-red-100' : 'bg-slate-50 hover:bg-slate-100'}`}
            >
                <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-lg ${isCritical ? 'bg-white text-red-600 shadow-sm' : 'bg-white text-slate-500 shadow-sm'}`}>
                        <ShoppingBag className="h-5 w-5" />
                    </div>
                    <div>
                        <p className="text-sm font-bold text-slate-800">
                            {venda ? `Venda #${venda.id}` : `Carnê Avulso #${dados.id}`}
                        </p>
                        <p className="text-[10px] text-slate-500 flex items-center gap-1 font-medium">
                            <Calendar className="h-3 w-3" /> {formatDate(dataVenda)}
                        </p>
                    </div>
                </div>
                <div className="flex items-center gap-4">
                    <div className="text-right">
                        <p className="text-[10px] font-bold text-slate-400 uppercase">Total</p>
                        <p className="text-sm font-black text-slate-800">{formatCurrency(valorTotal)}</p>
                    </div>
                    {isExpanded ? <ChevronUp className="h-4 w-4 text-slate-400"/> : <ChevronDown className="h-4 w-4 text-slate-400"/>}
                </div>
            </div>

            {isExpanded && (
                <div className="p-4 border-t border-slate-100 animate-in slide-in-from-top-2">
                    {venda && venda.venda_itens && (
                        <div className="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                             <p className="text-[10px] font-bold text-slate-500 uppercase mb-2">Itens Comprados</p>
                            <ul className="space-y-1">
                                {venda.venda_itens.map((item: any, idx: number) => (
                                    <li key={idx} className="text-xs text-slate-700 flex justify-between border-b border-slate-200 pb-1 last:border-0">
                                         <span className="font-medium">{item.quantidade}x {item.descricao}</span>
                                        <span className="font-bold text-slate-600">{formatCurrency(item.valor_total_item)}</span>
                                    </li>
                                ))}
                             </ul>
                        </div>
                    )}

                    <div>
                        <p className="text-[10px] font-bold text-slate-500 uppercase mb-2">Parcelamento</p>
                        <div className="bg-white rounded border border-slate-200 overflow-hidden">
                            {parcelas.map((p: any) => {
                                const vencimento = new Date(p.data_vencimento);
                                vencimento.setHours(0,0,0,0)
                                const hoje = new Date();
                                hoje.setHours(0,0,0,0);

                                const isVencida = p.status === 'Pendente' && vencimento < hoje;
                                const isPaga = p.status === 'Pago';
                                
                                let rowClass = 'bg-white text-slate-600';
                                let statusLabel = 'A Vencer';
                                let statusColor = 'text-slate-400';
                                
                                if (isPaga) {
                                    rowClass = 'bg-emerald-50/50';
                                    statusLabel = `Pago ${p.data_pagamento ? formatDate(p.data_pagamento) : ''}`;
                                    statusColor = 'text-emerald-600 font-bold';
                                } else if (isVencida) {
                                    rowClass = 'bg-red-50/50';
                                    statusLabel = 'VENCIDA';
                                    statusColor = 'text-red-600 font-black';
                                }

                                return (
                                     <div key={p.id} className={`flex justify-between items-center p-2 text-xs border-b border-slate-100 last:border-0 ${rowClass}`}>
                                        <span className="w-8 text-center font-bold text-slate-500">{p.numero_parcela}ª</span>
                                        <span className="flex-1 text-center font-mono">{formatDate(p.data_vencimento)}</span>
                                        <span className="flex-1 text-right pr-4 font-bold">{formatCurrency(p.valor_parcela)}</span>
                                        <span className={`w-24 text-right text-[9px] uppercase tracking-wide ${statusColor}`}>{statusLabel}</span>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
}

interface Props {
    initialDevedores: DevedorResumo[]
    storeId: number
    filtroAtual: string
}

export default function CobrancaInterface({ initialDevedores, storeId, filtroAtual }: Props) {
    const router = useRouter()
    const [selectedId, setSelectedId] = useState<number | null>(null)
    
    const [historico, setHistorico] = useState<CobrancaHistoricoItem[]>([])
    const [detalhesVendas, setDetalhesVendas] = useState<any[]>([])
    
    const [loadingData, setLoadingData] = useState(false)
    const [isPending, startTransition] = useTransition()
    const formRef = useRef<HTMLFormElement>(null)

    const selectedClient = initialDevedores.find(d => d.customer_id === selectedId)

    useEffect(() => {
        if (selectedId) {
            setLoadingData(true)
            Promise.all([
                getHistoricoCobranca(selectedId),
                getDetalhesDivida(selectedId, storeId)
            ]).then(([histData, dividaData]) => {
                setHistorico(histData as CobrancaHistoricoItem[])
                setDetalhesVendas(dividaData)
                setLoadingData(false)
            })
        } else {
            setHistorico([])
            setDetalhesVendas([])
        }
    }, [selectedId, storeId])

    const handleFilterChange = (novoFiltro: string) => {
        router.push(`/dashboard/loja/${storeId}/cobranca?filtro=${novoFiltro}`)
        router.refresh()
    }

    const handleToggleSpc = () => {
        if(!selectedClient) return
        const novoStatus = !selectedClient.is_spc
        if(!confirm(`Confirma ${novoStatus ? 'NEGATIVAR' : 'REMOVER DO SPC'} o cliente ${selectedClient.full_name}?`)) return

        startTransition(async () => {
            await toggleSpcStatus(selectedClient.customer_id, selectedClient.is_spc, storeId)
            router.refresh()
        })
    }

    const handleRegistrarContato = async (formData: FormData) => {
        if(!selectedClient) return
        formData.append('customer_id', selectedClient.customer_id.toString())
        
        startTransition(async () => {
            const res = await registrarCobranca(null, formData)
            if (res.success) {
                formRef.current?.reset()
                getHistoricoCobranca(selectedClient.customer_id).then(data => setHistorico(data as any))
            } else {
                alert(res.message)
            }
        })
    }

    const abrirWhatsApp = () => {
        if (!selectedClient?.fone_movel) return alert("Cliente sem celular cadastrado.")
        const refVenda = detalhesVendas[0] ? `(Ref: Venda #${detalhesVendas[0].vendas?.id || detalhesVendas[0].id})` : '';
        const num = selectedClient.fone_movel.replace(/\D/g, '')
        const msg = `Olá ${selectedClient.full_name}, tudo bem? Aqui é da Ótica. Notamos uma pendência financeira em seu cadastro ${refVenda} e gostaríamos de regularizar. Podemos conversar?`
        window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank')
    }

    return (
        <div className="flex h-full overflow-hidden bg-slate-100">
            
            {/* --- COLUNA ESQUERDA (LISTA) --- */}
            <div className="w-1/3 flex flex-col border-r border-slate-200 bg-white z-10 shadow-sm">
                
                {/* Header Gradiente (Alerta/Laranja) */}
                <div className="bg-gradient-to-br from-orange-500 to-rose-600 p-4 flex flex-col gap-3 shadow-md z-20">
                    <div className="flex justify-between items-center text-white">
                        <h2 className="font-bold text-sm flex items-center gap-2 uppercase tracking-wide">
                            <Megaphone className="h-4 w-4" /> Cobrança
                        </h2>
                        <span className="text-[10px] bg-white/20 px-2 py-0.5 rounded-full font-medium">
                            {initialDevedores.length} pendentes
                        </span>
                    </div>
                    
                    {/* Filtros Integrados */}
                    <div className="flex p-1 bg-black/10 rounded-lg">
                         <button 
                            onClick={() => handleFilterChange('todos')}
                            className={`flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-md transition-all ${filtroAtual === 'todos' ? 'bg-white text-rose-600 shadow-sm' : 'text-white/70 hover:bg-white/10'}`}
                        >
                            Todos
                        </button>
                        <button 
                            onClick={() => handleFilterChange('sem_spc')}
                            className={`flex-1 py-1.5 text-[10px] font-bold uppercase tracking-wider rounded-md transition-all ${filtroAtual === 'sem_spc' ? 'bg-white text-rose-600 shadow-sm' : 'text-white/70 hover:bg-white/10'}`}
                        >
                            Sem SPC
                        </button>
                    </div>
                </div>

                {/* Lista Rolável */}
                <div className="flex-1 overflow-y-auto">
                    {initialDevedores.length === 0 ? (
                        <div className="flex flex-col items-center justify-center h-64 text-center text-slate-400 p-6">
                            <CheckCircle2 className="h-12 w-12 mb-2 text-emerald-400 opacity-50" />
                            <p className="text-sm">Nenhuma pendência encontrada.</p>
                        </div>
                    ) : (
                        initialDevedores.map(dev => (
                            <div 
                                key={dev.customer_id}
                                onClick={() => setSelectedId(dev.customer_id)}
                                className={`p-3 border-b border-slate-100 cursor-pointer transition-colors group
                                    ${selectedId === dev.customer_id ? 'bg-orange-50 border-l-4 border-l-orange-500' : 'hover:bg-slate-50 border-l-4 border-l-transparent'}
                                `}
                            >
                                <div className="flex justify-between items-start mb-1">
                                    <span className={`font-bold text-xs truncate pr-2 ${selectedId === dev.customer_id ? 'text-orange-800' : 'text-slate-700'}`}>{dev.full_name}</span>
                                    <span className="text-rose-600 font-black text-xs whitespace-nowrap">{formatCurrency(dev.total_atrasado)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2">
                                        <AtrasoBadge dias={dev.dias_atraso} />
                                        {dev.is_spc && <span className="text-[9px] bg-slate-800 text-white px-1.5 py-0.5 rounded font-bold">SPC</span>}
                                    </div>
                                    <span className="text-[10px] text-slate-400">{dev.quantidade_parcelas_atrasadas} parc.</span>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>

            {/* --- COLUNA DIREITA (DETALHES) --- */}
            <div className="flex-1 flex flex-col bg-slate-50 relative overflow-hidden">
                {selectedClient ? (
                    <>
                        {/* 1. Header do Cliente */}
                        <div className="bg-white px-6 py-4 border-b border-slate-200 flex justify-between items-start shadow-sm shrink-0">
                            <div>
                                <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                    <User className="h-5 w-5 text-slate-400" />
                                    {selectedClient.full_name}
                                </h2>
                                <div className="flex gap-4 mt-1 text-xs text-slate-500 font-medium">
                                    <span className="flex items-center gap-1"><Phone className="h-3 w-3"/> {selectedClient.fone_movel || 'S/ Celular'}</span>
                                    <span className="flex items-center gap-1 text-rose-600 font-bold"><AlertTriangle className="h-3 w-3"/> Atraso Máx: {selectedClient.dias_atraso} dias</span>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2">
                                <button onClick={abrirWhatsApp} className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-sm font-bold text-xs flex items-center gap-2 transition-all hover:-translate-y-0.5">
                                     <MessageCircle className="h-4 w-4" /> WhatsApp
                                </button>
                                <button onClick={handleToggleSpc} disabled={isPending} className={`text-[10px] border px-3 py-2 rounded-lg font-bold flex items-center gap-1 transition-colors uppercase tracking-wide ${selectedClient.is_spc ? 'border-emerald-200 text-emerald-700 bg-emerald-50 hover:bg-emerald-100' : 'border-slate-300 text-slate-500 hover:text-rose-600 hover:border-rose-300'}`}>
                                    {isPending ? <Loader2 className="h-3 w-3 animate-spin"/> : <ShieldAlert className="h-3 w-3" />}
                                    {selectedClient.is_spc ? 'Remover SPC' : 'Negativar'}
                                </button>
                            </div>
                        </div>

                        {/* 2. Área de Conteúdo (Scroll) */}
                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar pb-40"> {/* pb-40 para dar espaço ao form fixo */}
                            
                            {/* Card de Resumo da Dívida */}
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
                                <h3 className="text-slate-800 font-bold text-sm mb-3 flex items-center gap-2 uppercase tracking-wide border-b border-slate-100 pb-2">
                                    <Wallet className="h-4 w-4 text-orange-500"/> Detalhamento da Dívida
                                </h3>
                                {loadingData ? (
                                    <div className="py-8 text-center text-slate-400">
                                        <Loader2 className="h-6 w-6 animate-spin mx-auto mb-2 text-orange-400"/>
                                        <p className="text-xs">Carregando contratos...</p>
                                    </div>
                                ) : detalhesVendas.length === 0 ? (
                                    <p className="text-xs text-slate-500 italic">Nenhum detalhe encontrado.</p>
                                ) : (
                                    detalhesVendas.map(dado => <CardVendaDetalhada key={dado.id} dados={dado} />)
                                )}
                            </div>

                            {/* Histórico de Conversas */}
                            <h3 className="text-slate-500 font-bold text-xs uppercase tracking-wide mb-3 flex items-center gap-2 px-1">
                                <History className="h-4 w-4"/> Histórico de Contatos
                            </h3>
                            <div className="space-y-3 pl-2 border-l-2 border-slate-200 ml-2">
                                {historico.length === 0 ? (
                                     <p className="text-slate-400 text-xs italic pl-4">Nenhum contato registrado.</p>
                                ) : (
                                    historico.map(item => (
                                        <div key={item.id} className="relative pl-6">
                                            <div className="absolute -left-[5px] top-1.5 h-2.5 w-2.5 rounded-full bg-slate-300 border-2 border-slate-100"></div>
                                            <div className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                                <div className="flex justify-between text-[10px] text-slate-400 mb-1 font-bold uppercase">
                                                    <span>{formatDateTime(item.created_at)}</span>
                                                    <span className="text-slate-600 bg-slate-100 px-1.5 py-0.5 rounded">{item.tipo_contato}</span>
                                                </div>
                                                <p className="text-xs text-slate-700 leading-relaxed">{item.resumo_conversa}</p>
                                                {item.proxima_acao && (
                                                    <div className="mt-2 pt-2 border-t border-slate-50 flex items-center gap-1 text-[10px] font-bold text-orange-600">
                                                        <Calendar className="h-3 w-3"/> Lembrar: {formatDate(item.proxima_acao)}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* 3. Painel Fixo de Registro (Novo Visual) */}
                        <div className="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 z-30 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                             <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                <h3 className="text-orange-800 font-bold text-xs uppercase mb-3 flex items-center gap-2">
                                    <Send className="h-3 w-3" /> Registrar Novo Contato
                                </h3>
                                <form ref={formRef} action={handleRegistrarContato} className="flex gap-3 items-end">
                                    <div className="w-32 shrink-0">
                                        <label className={labelStyle}>Meio</label>
                                        <select name="tipo_contato" className={inputStyle}>
                                            <option value="WhatsApp">WhatsApp</option>
                                            <option value="Ligação">Ligação</option>
                                            <option value="Presencial">Presencial</option>
                                            <option value="Email">Email</option>
                                        </select>
                                    </div>
                                    <div className="w-32 shrink-0">
                                        <label className={labelStyle}>Lembrar Em</label>
                                        <input type="date" name="proxima_acao" className={inputStyle} />
                                    </div>
                                    <div className="flex-1">
                                        <label className={labelStyle}>Resumo da Conversa</label>
                                        <input 
                                            name="resumo" 
                                            type="text" 
                                            placeholder="Ex: Cliente prometeu pagar dia 15..." 
                                            className={inputStyle}
                                            required
                                            autoComplete="off"
                                        />
                                    </div>
                                    <button type="submit" disabled={isPending} className="h-9 bg-orange-600 hover:bg-orange-700 text-white px-4 rounded-lg shadow-sm font-bold text-xs flex items-center gap-2 transition-all active:scale-95">
                                        {isPending ? <Loader2 className="h-3 w-3 animate-spin"/> : 'SALVAR'}
                                    </button>
                                </form>
                             </div>
                        </div>

                    </>
                ) : (
                    <div className="flex-1 flex flex-col items-center justify-center text-slate-300">
                        <Filter className="h-16 w-16 mb-4 opacity-20" />
                        <p className="text-lg font-light">Selecione um cliente para ver detalhes</p>
                    </div>
                )}
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\config\ConfigInterface.tsx
==================================================
'use client';

import { useState, useEffect, useTransition } from 'react';
import { 
  Users, Plus, Save, Power, Loader2, Lock, User, 
  ShieldCheck, Briefcase, Wrench, BadgeCheck, Percent, CheckCircle2, 
  Store, MapPin, Phone 
} from 'lucide-react';
import { getEmployees, saveEmployee, toggleEmployeeStatus } from '@/lib/actions/employee.actions';
import { getStoreProfile, updateStoreProfile } from '@/lib/actions/store.actions';
import { Database } from '@/lib/database.types';

type Employee = Database['public']['Tables']['employees']['Row'];

const labelStyle = "block text-[10px] font-bold text-slate-500 uppercase mb-1 tracking-wider";
const inputStyle = "block w-full rounded-md border border-slate-300 bg-white shadow-sm text-slate-900 h-9 text-sm px-3 focus:ring-2 focus:ring-violet-500 focus:border-violet-500 font-bold placeholder:font-normal placeholder:text-slate-400 disabled:bg-slate-100 disabled:text-slate-500 transition-all";
const cardStyle = "bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-4 relative overflow-hidden";

// --- SUB-COMPONENTE: FORMULÁRIO DA LOJA ---
function StoreDataForm({ storeId }: { storeId: number }) {
    const [data, setData] = useState<any>(null)
    const [loading, setLoading] = useState(true)
    const [isSaving, startTransition] = useTransition()

    useEffect(() => {
        getStoreProfile(storeId).then(res => {
            setData(res)
            setLoading(false)
        })
    }, [storeId])

    const handleSave = (formData: FormData) => {
        startTransition(async () => {
            const res = await updateStoreProfile(null, formData)
            if(res.success) alert(res.message)
            else alert("Erro: " + res.message)
        })
    }

    if (loading) return <div className="p-10 text-center"><Loader2 className="animate-spin h-8 w-8 text-slate-300 mx-auto"/></div>

    return (
        <form action={handleSave} className="max-w-4xl mx-auto space-y-6 animate-in fade-in">
            <input type="hidden" name="id" value={storeId} />
            
            <div className={cardStyle}>
                <h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2 border-b border-slate-100 pb-2">
                    <Store className="h-4 w-4 text-blue-500" /> Identidade & Fiscal
                </h3>
                <div className="grid grid-cols-2 gap-4">
                    <div className="col-span-2 md:col-span-1">
                        <label className={labelStyle}>Nome Fantasia (Marca)</label>
                        <input name="name" defaultValue={data.name} className={inputStyle} required />
                    </div>
                    <div className="col-span-2 md:col-span-1">
                        <label className={labelStyle}>Razão Social</label>
                        <input name="razao_social" defaultValue={data.razao_social} className={inputStyle} />
                    </div>
                    <div>
                        <label className={labelStyle}>CNPJ</label>
                        <input name="cnpj" defaultValue={data.cnpj} className={inputStyle} placeholder="00.000.000/0000-00" />
                    </div>
                    <div>
                        <label className={labelStyle}>Inscrição Estadual</label>
                        <input name="inscricao_estadual" defaultValue={data.inscricao_estadual} className={inputStyle} />
                    </div>
                </div>
            </div>

            <div className={cardStyle}>
                <h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2 border-b border-slate-100 pb-2">
                    <Phone className="h-4 w-4 text-green-500" /> Contato
                </h3>
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className={labelStyle}>WhatsApp da Loja (Link Rastreio)</label>
                        <div className="relative">
                            <span className="absolute left-3 top-2.5 text-green-600 font-bold text-xs">WA</span>
                            <input name="whatsapp" defaultValue={data.whatsapp} className={`${inputStyle} pl-10 border-green-200 focus:ring-green-500`} placeholder="(00) 90000-0000" />
                        </div>
                        <p className="text-[9px] text-slate-400 mt-1">Este número será usado no botão "Falar com Atendente" do rastreio.</p>
                    </div>
                    <div>
                        <label className={labelStyle}>Telefone Fixo</label>
                        <input name="phone" defaultValue={data.phone} className={inputStyle} />
                    </div>
                    <div>
                        <label className={labelStyle}>E-mail</label>
                        <input name="email" type="email" defaultValue={data.email} className={inputStyle} />
                    </div>
                    <div>
                        <label className={labelStyle}>Website / Instagram</label>
                        <input name="website" defaultValue={data.website} className={inputStyle} />
                    </div>
                </div>
            </div>

            <div className={cardStyle}>
                <h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2 border-b border-slate-100 pb-2">
                    <MapPin className="h-4 w-4 text-rose-500" /> Endereço
                </h3>
                <div className="grid grid-cols-6 gap-3">
                    <div className="col-span-2">
                        <label className={labelStyle}>CEP</label>
                        <input name="cep" defaultValue={data.cep} className={inputStyle} />
                    </div>
                    <div className="col-span-3">
                        <label className={labelStyle}>Cidade</label>
                        <input name="city" defaultValue={data.city} className={inputStyle} />
                    </div>
                    <div className="col-span-1">
                        <label className={labelStyle}>UF</label>
                        <input name="state" defaultValue={data.state} className={inputStyle} maxLength={2} />
                    </div>
                    <div className="col-span-4">
                        <label className={labelStyle}>Logradouro</label>
                        <input name="street" defaultValue={data.street} className={inputStyle} />
                    </div>
                    <div className="col-span-2">
                        <label className={labelStyle}>Número</label>
                        <input name="number" defaultValue={data.number} className={inputStyle} />
                    </div>
                    <div className="col-span-3">
                        <label className={labelStyle}>Bairro</label>
                        <input name="neighborhood" defaultValue={data.neighborhood} className={inputStyle} />
                    </div>
                </div>
            </div>

            <div className="flex justify-end pb-10">
                <button disabled={isSaving} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 disabled:opacity-50">
                    {isSaving ? <Loader2 className="h-5 w-5 animate-spin"/> : <Save className="h-5 w-5"/>}
                    SALVAR DADOS DA LOJA
                </button>
            </div>
        </form>
    )
}

// --- SUB-COMPONENTE: EQUIPE (Lógica original preservada) ---
function TeamManagement({ storeId }: { storeId: number }) {
    const [employees, setEmployees] = useState<Employee[]>([]);
    const [selectedId, setSelectedId] = useState<number | null>(null);
    const [loadingList, setLoadingList] = useState(true);
    const [isSaving, startTransition] = useTransition();
    
    // Formulário
    const [formData, setFormData] = useState({ 
        full_name: '', 
        pin: '', 
        role: 'vendedor' as 'vendedor' | 'gerente' | 'tecnico',
        comm_rate_guaranteed: 0,
        comm_rate_store_credit: 0,
        comm_rate_store_total: 0,
        comm_rate_received: 0,
        comm_rate_profit: 0
    });

    useEffect(() => {
        loadData();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [storeId]);

    const loadData = async () => {
        setLoadingList(true);
        const data = await getEmployees(storeId);
        setEmployees(data);
        setLoadingList(false);
    };

    const handleSelect = (emp: Employee) => {
        setSelectedId(emp.id);
        setFormData({ 
            full_name: emp.full_name || '', 
            pin: emp.pin || '',
            role: (emp.role as any) || 'vendedor',
            comm_rate_guaranteed: emp.comm_rate_guaranteed || 0,
            comm_rate_store_credit: emp.comm_rate_store_credit || 0,
            comm_rate_store_total: emp.comm_rate_store_total || 0,
            comm_rate_received: emp.comm_rate_received || 0,
            comm_rate_profit: emp.comm_rate_profit || 0
        });
    };

    const handleNew = () => {
        setSelectedId(null);
        setFormData({ 
            full_name: '', pin: '', role: 'vendedor',
            comm_rate_guaranteed: 0, comm_rate_store_credit: 0, comm_rate_store_total: 0, comm_rate_received: 0, comm_rate_profit: 0
        });
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        const payload = new FormData();
        if (selectedId) payload.append('id', selectedId.toString());
        payload.append('full_name', formData.full_name);
        payload.append('pin', formData.pin);
        payload.append('role', formData.role);
        
        payload.append('comm_rate_guaranteed', formData.comm_rate_guaranteed.toString());
        payload.append('comm_rate_store_credit', formData.comm_rate_store_credit.toString());
        payload.append('comm_rate_store_total', formData.comm_rate_store_total.toString());
        payload.append('comm_rate_received', formData.comm_rate_received.toString());
        payload.append('comm_rate_profit', formData.comm_rate_profit.toString());

        startTransition(async () => {
            const result = await saveEmployee({ success: false, message: '' }, payload);
            if (result.success) {
                alert(result.message);
                if (!selectedId) handleNew();
                loadData();
            } else {
                alert(`Erro: ${result.message}`);
            }
        });
    };

    const handleToggleStatus = async (emp: Employee) => {
        if (!confirm(`Deseja ${emp.is_active ? 'INATIVAR' : 'ATIVAR'} o acesso de ${emp.full_name}?`)) return;
        
        startTransition(async () => {
            const result = await toggleEmployeeStatus(emp.id, emp.is_active ?? true, storeId);
            if (result.success) {
                loadData();
                if (selectedId === emp.id) handleNew();
            } else {
                alert(result.message);
            }
        });
    }

    const RoleIcon = ({ role }: { role: string }) => {
        if (role === 'gerente') return <Briefcase className="h-3 w-3" />
        if (role === 'tecnico') return <Wrench className="h-3 w-3" />
        return <BadgeCheck className="h-3 w-3" />
    }

    return (
        <div className="flex h-full gap-4">
             {/* ESQUERDA: LISTA */}
             <div className="w-1/3 flex flex-col bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="bg-gradient-to-br from-violet-600 to-purple-700 p-4 flex flex-col gap-3 shadow-md z-20">
                    <div className="flex justify-between items-center text-white">
                        <h2 className="font-bold text-sm flex items-center gap-2 uppercase tracking-wide">
                            <ShieldCheck className="h-5 w-5" /> Equipe
                        </h2>
                        <button onClick={handleNew} className="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-lg text-[10px] font-bold flex items-center gap-1 transition-colors">
                            <Plus className="h-3 w-3" /> NOVO
                        </button>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto">
                    {loadingList ? (
                        <div className="flex justify-center p-8"><Loader2 className="animate-spin text-violet-500 h-6 w-6"/></div>
                    ) : employees.length === 0 ? (
                        <p className="text-center text-slate-400 text-xs p-6">Nenhum colaborador.</p>
                    ) : (
                        employees.map(emp => (
                            <div 
                                key={emp.id} 
                                className={`p-4 border-b border-slate-100 cursor-pointer transition-colors flex justify-between items-center group
                                    ${selectedId === emp.id ? 'bg-violet-50 border-l-4 border-l-violet-600' : 'hover:bg-slate-50 border-l-4 border-l-transparent'}
                                `}
                                onClick={() => handleSelect(emp)}
                            >
                                <div>
                                    <div className="flex items-center gap-2">
                                        <p className={`font-bold text-sm ${selectedId === emp.id ? 'text-violet-800' : 'text-slate-700'}`}>{emp.full_name}</p>
                                        {!emp.is_active && <span className="text-[9px] bg-red-100 text-red-600 px-1.5 rounded font-bold uppercase">Inativo</span>}
                                    </div>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className={`text-[9px] font-bold px-2 py-0.5 rounded-md flex items-center gap-1 uppercase tracking-wide
                                            ${emp.role === 'gerente' ? 'bg-purple-100 text-purple-700 border border-purple-200' : 
                                            emp.role === 'tecnico' ? 'bg-amber-100 text-amber-800 border border-amber-200' : 
                                            'bg-slate-100 text-slate-600 border border-slate-200'}`}>
                                            <RoleIcon role={emp.role || 'vendedor'} />
                                            {emp.role || 'Vendedor'}
                                        </span>
                                    </div>
                                </div>
                                {selectedId === emp.id && <CheckCircle2 className="h-4 w-4 text-violet-500" />}
                            </div>
                        ))
                    )}
                </div>
             </div>

             {/* DIREITA: FORMULÁRIO */}
             <div className="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                  <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 shadow-sm shrink-0">
                     <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                        {selectedId ? `Editando: ${formData.full_name}` : 'Novo Cadastro'}
                     </h2>
                  </div>
                  <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                      <form onSubmit={handleSubmit} className="space-y-6">
                            {/* SEÇÃO 1: ACESSO */}
                            <div className={cardStyle}>
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                                    <Lock className="h-4 w-4" /> Credenciais
                                </h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2">
                                        <label className={labelStyle}>Nome Completo</label>
                                        <div className="relative">
                                            <User className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                                            <input type="text" required value={formData.full_name} onChange={e => setFormData({...formData, full_name: e.target.value})} className={`${inputStyle} pl-9`} placeholder="Ex: Fábio Silva" disabled={isSaving} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className={labelStyle}>Cargo / Função</label>
                                        <select value={formData.role} onChange={e => setFormData({...formData, role: e.target.value as any})} className={inputStyle} disabled={isSaving}>
                                            <option value="vendedor">Vendedor (Padrão)</option>
                                            <option value="gerente">Gerente (Acesso Total)</option>
                                            <option value="tecnico">Técnico / Estoquista</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className={labelStyle}>PIN (4+ Dígitos)</label>
                                        <div className="relative">
                                            <Lock className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                                            <input type="text" required value={formData.pin} onChange={e => setFormData({...formData, pin: e.target.value.replace(/\D/g, '')})} maxLength={6} className={`${inputStyle} pl-9 tracking-widest`} placeholder="****" disabled={isSaving} />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* SEÇÃO 2: COMISSÕES */}
                            <div className={cardStyle}>
                                <div className="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                                <h3 className="text-xs font-bold text-green-700 uppercase mb-4 flex items-center gap-2">
                                    <Percent className="h-4 w-4" /> Comissões (%)
                                </h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-6">
                                    <div className="col-span-full p-3 bg-green-50/50 rounded-lg border border-green-100">
                                        <p className="text-[10px] font-bold text-green-800 uppercase mb-2">Vendas Próprias</p>
                                        <div className="flex gap-4">
                                            <div className="flex-1">
                                                <label className={labelStyle}>Garantida</label>
                                                <input type="number" step="0.01" value={formData.comm_rate_guaranteed} onChange={e => setFormData({...formData, comm_rate_guaranteed: parseFloat(e.target.value)})} className={`${inputStyle} text-right`} />
                                            </div>
                                            <div className="flex-1">
                                                <label className={labelStyle}>Risco (Carnê)</label>
                                                <input type="number" step="0.01" value={formData.comm_rate_store_credit} onChange={e => setFormData({...formData, comm_rate_store_credit: parseFloat(e.target.value)})} className={`${inputStyle} text-right`} />
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label className={labelStyle}>Sobre Loja</label>
                                        <input type="number" step="0.01" value={formData.comm_rate_store_total} onChange={e => setFormData({...formData, comm_rate_store_total: parseFloat(e.target.value)})} className={`${inputStyle} text-right`} />
                                    </div>
                                    <div>
                                        <label className={labelStyle}>Recebimento</label>
                                        <input type="number" step="0.01" value={formData.comm_rate_received} onChange={e => setFormData({...formData, comm_rate_received: parseFloat(e.target.value)})} className={`${inputStyle} text-right`} />
                                    </div>
                                    <div>
                                        <label className={labelStyle}>Lucro</label>
                                        <input type="number" step="0.01" value={formData.comm_rate_profit} onChange={e => setFormData({...formData, comm_rate_profit: parseFloat(e.target.value)})} className={`${inputStyle} text-right`} />
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-between items-center pt-4 border-t border-slate-100">
                                {selectedId ? (
                                    <button type="button" onClick={() => { const emp = employees.find(e => e.id === selectedId); if (emp) handleToggleStatus(emp); }} disabled={isSaving} className="px-4 py-2 bg-white border border-slate-300 text-slate-600 hover:text-red-600 rounded-lg font-bold text-xs shadow-sm transition-colors flex items-center gap-2">
                                        <Power className="h-4 w-4" /> {employees.find(e => e.id === selectedId)?.is_active ? 'BLOQUEAR' : 'DESBLOQUEAR'}
                                    </button>
                                ) : <div></div>}
                                <button type="submit" disabled={isSaving} className="px-6 py-2 bg-violet-600 hover:bg-violet-700 text-white rounded-lg font-bold text-xs shadow-md transition-transform active:scale-95 flex items-center gap-2 disabled:opacity-50">
                                    {isSaving ? <Loader2 className="h-4 w-4 animate-spin" /> : <Save className="h-4 w-4" />}
                                    SALVAR DADOS
                                </button>
                            </div>
                      </form>
                  </div>
             </div>
        </div>
    )
}

// --- COMPONENTE PRINCIPAL (COM ABAS) ---
export default function ConfigInterface({ storeId }: { storeId: number }) {
    const [activeTab, setActiveTab] = useState<'loja' | 'equipe'>('loja')

    return (
        <div className="flex flex-col h-full bg-slate-100 overflow-hidden">
            {/* Header de Abas */}
            <div className="bg-white px-6 border-b border-slate-200 flex gap-6 shadow-sm shrink-0">
                <button 
                    onClick={() => setActiveTab('loja')}
                    className={`py-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${activeTab === 'loja' ? 'border-blue-600 text-blue-700' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                >
                    <Store className="h-4 w-4" /> Dados da Loja
                </button>
                <button 
                    onClick={() => setActiveTab('equipe')}
                    className={`py-4 text-sm font-bold border-b-2 transition-colors flex items-center gap-2 ${activeTab === 'equipe' ? 'border-violet-600 text-violet-700' : 'border-transparent text-slate-500 hover:text-slate-700'}`}
                >
                    <Users className="h-4 w-4" /> Equipe & Acesso
                </button>
            </div>

            <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                {activeTab === 'loja' ? (
                    <StoreDataForm storeId={storeId} />
                ) : (
                    <TeamManagement storeId={storeId} />
                )}
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\consultas\AniversariantesWidget.tsx
==================================================
'use client'

import { Gift } from 'lucide-react'
import { Aniversariante } from '@/lib/actions/consultas.actions'

export default function AniversariantesWidget({ clientes }: { clientes: Aniversariante[] }) {

    const handleZap = (fone: string | null, nome: string) => {
        const numero = fone ? fone.replace(/\D/g, '') : ''
        const msg = `Parabéns ${nome.split(' ')[0]}! 🎉 A Ótica Pro deseja um feliz aniversário!`
        window.open(`https://wa.me/${numero ? '55' + numero : ''}?text=${encodeURIComponent(msg)}`, '_blank')
    }

    return (
        <div className="bg-white rounded-3xl shadow-[0_10px_30px_-10px_rgba(236,72,153,0.15)] border border-pink-100 overflow-hidden h-fit">
            
            <div className="px-6 py-5 flex justify-between items-center bg-pink-50/30">
                <div className="flex items-center gap-3">
                    <div className="p-2.5 bg-pink-100 text-pink-600 rounded-2xl shadow-sm">
                        <Gift className="h-5 w-5" />
                    </div>
                    <h3 className="font-bold text-slate-700 text-sm">Aniversariantes do Dia</h3>
                </div>

                {clientes.length > 0 && (
                    <span className="bg-pink-100 text-pink-600 text-xs font-black px-2.5 py-1 rounded-full">
                        {clientes.length}
                    </span>
                )}
            </div>

            <div className="p-4 space-y-3">
                {clientes.length === 0 ? (
                    <p className="text-center text-xs text-slate-400 py-6 font-medium">
                        Ninguém sopra velinhas hoje. 🎂
                    </p>
                ) : (
                    clientes.map(c => (
                        <div
                            key={c.id}
                            className="group p-3 rounded-2xl bg-white border border-slate-100 
                            hover:border-pink-200 hover:shadow-md transition-all flex justify-between items-center"
                        >
                            <div>
                                <p className="font-bold text-slate-700 text-xs truncate max-w-[150px]">
                                    {c.nome}
                                </p>
                                <p className="text-[10px] text-slate-400">{c.fone || 'Sem fone'}</p>
                            </div>

                            {/* BOTÃO WHATSAPP */}
                            <button
                                onClick={() => handleZap(c.fone, c.nome)}
                                className="flex items-center justify-center w-8 h-8 rounded-full 
                                bg-green-50 text-green-600 hover:bg-green-600 hover:text-white transition-all"
                                title="Enviar pelo WhatsApp"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    className="h-4 w-4"
                                    fill="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path d="M20.52 3.48A11.8 11.8 0 0 0 12 0C5.37 0 0 5.37 0 12a11.9 11.9 0 0 0 1.64 6L0 24l6.25-1.64A11.9 11.9 0 0 0 12 24c6.63 0 12-5.37 12-12 0-3.19-1.24-6.2-3.48-8.52zM12 22a10 10 0 0 1-5.12-1.42l-.37-.22L3 21l.63-3.5-.23-.36A10 10 0 1 1 12 22zm5.13-7.53c-.28-.14-1.68-.83-1.94-.92-.26-.1-.45-.14-.64.14-.19.28-.74.92-.9 1.11-.17.19-.33.21-.62.07-.28-.14-1.17-.43-2.24-1.38-.83-.74-1.39-1.65-1.55-1.93-.16-.28-.02-.43.12-.57.13-.13.28-.33.42-.49.14-.16.19-.28.28-.47.1-.19.05-.36-.02-.5-.07-.14-.64-1.54-.88-2.11-.23-.55-.47-.47-.64-.48h-.55c-.19 0-.5.07-.76.36-.26.28-1 1-1 2.43s1.02 2.82 1.16 3.01c.14.19 2 3.06 4.93 4.29.69.3 1.23.48 1.65.61.69.22 1.31.19 1.81.12.55-.08 1.68-.69 1.92-1.36.24-.66.24-1.23.17-1.36-.07-.14-.26-.21-.54-.35z" />
                                </svg>
                            </button>
                        </div>
                    ))
                )}
            </div>
        </div>
    )
}


==================================================
ARQUIVO: .\src\components\consultas\BuscaUniversal.tsx
==================================================
// ARQUIVO: src/components/consultas/BuscaUniversal.tsx
'use client'

import { useState, useTransition } from 'react'
import { realizarBuscaUniversal, type ResultadoBusca } from '@/lib/actions/consultas.actions'
import { Search, Loader2, User, ShoppingCart, FileText, ArrowRight, Tag, Barcode, Package, Wrench } from 'lucide-react'
import Link from 'next/link'

const currency = (v: number) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const date = (d: string) => new Date(d).toLocaleDateString('pt-BR')

export default function BuscaUniversal({ storeId }: { storeId: number }) {
    const [termo, setTermo] = useState('')
    const [resultados, setResultados] = useState<ResultadoBusca | null>(null)
    const [isSearching, startTransition] = useTransition()

    const handleSearch = (e: React.ChangeEvent<HTMLInputElement>) => {
        const valor = e.target.value
        setTermo(valor)

        const isNum = /^\d+$/.test(valor)
        
        if ((isNum && valor.length < 1) || (!isNum && valor.length < 2)) {
            setResultados(null)
            return
        }

        startTransition(async () => {
            const res = await realizarBuscaUniversal(valor, storeId)
            setResultados(res)
        })
    }

    return (
        <div className="w-full space-y-6 pb-10">
            
            {/* 1. CARD DE BUSCA (HERO SECTION) */}
            <div className="bg-gradient-to-r from-cyan-600 to-blue-700 p-8 rounded-3xl shadow-xl shadow-cyan-100 border border-white/20 relative overflow-hidden">
                <div className="absolute top-0 right-0 p-6 opacity-10">
                    <Search className="h-32 w-32 text-white" />
                </div>
                
                <div className="relative z-10 max-w-3xl mx-auto text-center">
                    <h2 className="text-2xl font-black text-white mb-6 tracking-tight drop-shadow-sm">
                        O que você precisa encontrar?
                    </h2>
            
                    <div className="relative group">
                        <div className="absolute -inset-1 bg-gradient-to-r from-cyan-300 to-blue-300 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-200"></div>
                        <div className="relative">
                            <input 
                                type="text" 
                                value={termo}
                                onChange={handleSearch}
                                placeholder="Digite nome, CPF, código de barras ou número da OS..."
                                className="w-full h-16 pl-14 pr-16 rounded-2xl border-0 bg-white shadow-2xl text-xl font-bold text-slate-800 placeholder-slate-400 focus:ring-4 focus:ring-cyan-400/50 transition-all"
                                autoFocus
                            />
                            <div className="absolute left-5 top-5 text-slate-400">
                                <Search className="h-6 w-6" />
                            </div>
                            <div className="absolute right-5 top-5">
                                {isSearching ? (
                                    <Loader2 className="h-6 w-6 animate-spin text-cyan-500" />
                                ) : (
                                    <span className="bg-slate-100 text-slate-400 text-[10px] font-black px-2 py-1 rounded border border-slate-200">AUTO</span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* 2. RESULTADOS */}
            {resultados && (
                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    
                    {/* A. PRODUTOS (ROXO) */}
                    <div className="flex flex-col gap-3">
                        <h3 className="text-xs font-black text-purple-600 uppercase tracking-widest pl-1 flex items-center gap-2">
                            <Package className="h-4 w-4" /> Produtos ({resultados.produtos.length})
                        </h3>
                        {resultados.produtos.length === 0 ? (
                            <div className="bg-slate-50 rounded-xl p-6 text-center border border-slate-200 text-slate-400 text-xs font-medium">Nada encontrado.</div>
                        ) : (
                            <div className="space-y-2">
                                {resultados.produtos.map(p => (
                                    <div key={`${p.tipo}-${p.id}`} className="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:border-purple-300 hover:shadow-md transition-all cursor-default">
                                        <div className="flex justify-between items-start mb-1">
                                            <span className="text-[9px] font-bold text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded uppercase">{p.tipo}</span>
                                            <span className="text-[10px] font-mono text-slate-400 flex items-center gap-1"><Barcode className="h-3 w-3"/> {p.codigo || '-'}</span>
                                        </div>
                                        <p className="font-bold text-slate-700 text-sm line-clamp-1 leading-tight" title={p.nome}>{p.nome}</p>
                                        <div className="mt-2 flex justify-between items-end">
                                            <span className="text-xs text-slate-500">Est: <strong>{p.estoque}</strong></span>
                                            <span className="font-black text-purple-700">{currency(p.preco)}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* B. CLIENTES (AZUL) */}
                    <div className="flex flex-col gap-3">
                        <h3 className="text-xs font-black text-blue-600 uppercase tracking-widest pl-1 flex items-center gap-2">
                            <User className="h-4 w-4" /> Clientes ({resultados.clientes.length})
                        </h3>
                        {resultados.clientes.length === 0 ? (
                            <div className="bg-slate-50 rounded-xl p-6 text-center border border-slate-200 text-slate-400 text-xs font-medium">Nada encontrado.</div>
                        ) : (
                            <div className="space-y-2">
                                {resultados.clientes.map(c => (
                                    <Link key={c.id} href={`/dashboard/loja/${storeId}/clientes?id=${c.id}`}>
                                        <div className="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:border-blue-400 hover:shadow-md transition-all cursor-pointer relative overflow-hidden">
                                            <div className="absolute right-0 top-0 w-1 h-full bg-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                            <p className="font-bold text-slate-700 text-sm group-hover:text-blue-700 transition-colors">{c.nome}</p>
                                            <div className="flex justify-between items-center mt-1">
                                                <p className="text-xs text-slate-400 font-mono">{c.cpf || 'CPF N/A'}</p>
                                                <ArrowRight className="h-4 w-4 text-blue-400 opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0 transition-all" />
                                            </div>
                                        </div>
                                    </Link>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* C. VENDAS (VERDE) */}
                    <div className="flex flex-col gap-3">
                        <h3 className="text-xs font-black text-emerald-600 uppercase tracking-widest pl-1 flex items-center gap-2">
                            <ShoppingCart className="h-4 w-4" /> Vendas ({resultados.vendas.length})
                        </h3>
                        {resultados.vendas.length === 0 ? (
                            <div className="bg-slate-50 rounded-xl p-6 text-center border border-slate-200 text-slate-400 text-xs font-medium">Nada encontrado.</div>
                        ) : (
                            <div className="space-y-2">
                                {resultados.vendas.map(v => (
                                    <Link key={v.id} href={`/dashboard/loja/${storeId}/vendas/${v.id}`}>
                                        <div className="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:border-emerald-400 hover:shadow-md transition-all cursor-pointer">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="font-black text-slate-800 text-sm">#{v.id}</span>
                                                <span className="text-[10px] font-bold text-slate-400 uppercase">{v.status}</span>
                                            </div>
                                            <p className="text-xs text-slate-500 truncate mb-2">{v.cliente}</p>
                                            <div className="flex justify-between items-center border-t border-slate-50 pt-2">
                                                <span className="text-[10px] text-slate-400">{date(v.data)}</span>
                                                <span className="font-bold text-emerald-600 text-sm">{currency(v.valor)}</span>
                                            </div>
                                        </div>
                                    </Link>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* D. FICHAS OS (LARANJA) */}
                    <div className="flex flex-col gap-3">
                        <h3 className="text-xs font-black text-orange-600 uppercase tracking-widest pl-1 flex items-center gap-2">
                            <Wrench className="h-4 w-4" /> Fichas OS ({resultados.os.length})
                        </h3>
                        {resultados.os.length === 0 ? (
                            <div className="bg-slate-50 rounded-xl p-6 text-center border border-slate-200 text-slate-400 text-xs font-medium">Nada encontrado.</div>
                        ) : (
                            <div className="space-y-2">
                                {resultados.os.map(o => (
                                    <Link key={o.id} href={`/dashboard/loja/${storeId}/vendas/${o.venda_id}/os?os_id=${o.id}`}>
                                        <div className="group bg-white p-3 rounded-xl shadow-sm border border-slate-100 hover:border-orange-400 hover:shadow-md transition-all cursor-pointer">
                                            <div className="flex justify-between items-center mb-1">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold text-slate-700 text-sm">OS #{o.id}</span>
                                                    {o.protocolo && <span className="text-[9px] bg-orange-50 text-orange-700 px-1.5 py-0.5 rounded font-mono font-bold">{o.protocolo}</span>}
                                                </div>
                                            </div>
                                            <p className="text-xs text-slate-500 truncate mb-1">{o.cliente}</p>
                                            <div className="flex justify-end items-center mt-2">
                                                <span className="text-[10px] font-bold text-orange-600 flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                                    ABRIR FICHA <ArrowRight className="h-3 w-3"/>
                                                </span>
                                            </div>
                                        </div>
                                    </Link>
                                ))}
                            </div>
                        )}
                    </div>

                </div>
            )}
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\consultas\PaineisAlertas.tsx
==================================================
// Caminho: src/components/consultas/PaineisAlertas.tsx
'use client'

import { AlertaEntrega, AlertaLaboratorio } from '@/lib/actions/consultas.actions'
import { AlertCircle, Clock, CalendarCheck, ArrowRight } from 'lucide-react'
import Link from 'next/link'

const formatDate = (d: string) => new Date(d).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' })

// --- WIDGET 1: LABORATÓRIO (Lentes Paradas) ---
export function WidgetLaboratorio({ data, storeId }: { data: AlertaLaboratorio[], storeId: number }) {
    return (
        <div className="flex flex-col bg-white rounded-3xl shadow-[0_10px_30px_-10px_rgba(225,29,72,0.15)] border border-white/50 overflow-hidden h-fit max-h-[400px]">
            <div className="px-6 py-5 flex justify-between items-center">
                <div className="flex items-center gap-3">
                    <div className="p-2.5 bg-rose-50 text-rose-500 rounded-2xl shadow-sm">
                        <AlertCircle className="h-5 w-5" />
                    </div>
                    <div>
                        <h3 className="font-bold text-slate-700 text-sm">Lentes Paradas</h3>
                    </div>
                </div>
                {data.length > 0 && <span className="bg-rose-100 text-rose-600 text-xs font-black px-2.5 py-1 rounded-full">{data.length}</span>}
            </div>

            <div className="p-4 pt-0 overflow-y-auto custom-scrollbar space-y-3">
                {data.length === 0 ? (
                    <p className="text-center text-xs text-slate-400 py-6 font-medium">Laboratório em dia.</p>
                ) : (
                    data.map(item => (
                        <div key={item.id} className="group p-3 rounded-2xl bg-slate-50/50 border border-transparent hover:border-rose-200 hover:bg-white hover:shadow-md transition-all flex justify-between items-center">
                            <div>
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="font-bold text-slate-700 text-xs">{item.customer_name}</span>
                                    <span className="text-[10px] bg-white border border-slate-200 px-1.5 rounded text-slate-400 font-mono">#{item.id}</span>
                                </div>
                                <div className="flex gap-2 text-xs">
                                    <span className="text-rose-500 font-bold flex items-center gap-1">
                                        <Clock className="h-3 w-3" /> {item.tempo_decorrido_horas}h parado
                                    </span>
                                </div>
                            </div>
                            <Link href={`/dashboard/loja/${storeId}/vendas/${item.venda_id}/os?os_id=${item.id}`}>
                                <div className="flex items-center justify-center w-9 h-9 rounded-full bg-rose-100 text-rose-600 hover:bg-rose-500 hover:text-white transition-all shadow-sm cursor-pointer">
                                    <ArrowRight className="h-5 w-5" />
                                </div>
                            </Link>
                        </div>
                    ))
                )}
            </div>
        </div>
    )
}

// --- WIDGET 2: ENTREGAS (Entregar Hoje) ---
export function WidgetEntregas({ data, storeId }: { data: AlertaEntrega[], storeId: number }) {
    return (
        <div className="flex flex-col bg-white rounded-3xl shadow-[0_10px_30px_-10px_rgba(79,70,229,0.15)] border border-white/50 overflow-hidden h-fit max-h-[400px]">
            <div className="px-6 py-5 flex justify-between items-center">
                <div className="flex items-center gap-3">
                    <div className="p-2.5 bg-indigo-50 text-indigo-500 rounded-2xl shadow-sm">
                        <CalendarCheck className="h-5 w-5" />
                    </div>
                    <div>
                        <h3 className="font-bold text-slate-700 text-sm">Entregar Hoje</h3>
                    </div>
                </div>
                {data.length > 0 && <span className="bg-indigo-100 text-indigo-600 text-xs font-black px-2.5 py-1 rounded-full">{data.length}</span>}
            </div>

            <div className="p-4 pt-0 overflow-y-auto custom-scrollbar space-y-3">
                {data.length === 0 ? (
                    <p className="text-center text-xs text-slate-400 py-6 font-medium">Sem entregas urgentes.</p>
                ) : (
                    data.map(item => {
                        const isAtrasado = new Date(item.dt_prometido_para) < new Date(new Date().setHours(0,0,0,0));
                        return (
                            <div key={item.id} className="p-3 rounded-2xl bg-slate-50/50 border border-transparent hover:border-indigo-200 hover:bg-white hover:shadow-md transition-all flex justify-between items-center">
                                <div>
                                    <div className="flex justify-between items-start mb-1 gap-2">
                                        <span className="font-bold text-slate-700 text-xs truncate max-w-[150px]">{item.customer_name}</span>
                                        {isAtrasado && <span className="text-[9px] font-black text-white bg-rose-500 px-1.5 py-0.5 rounded">ATRASADO</span>}
                                    </div>
                                    <div className="flex justify-between text-[10px] items-center gap-2">
                                        <span className="text-slate-400">OS #{item.id}</span>
                                        <span className="text-indigo-600 font-bold">{formatDate(item.dt_prometido_para)}</span>
                                    </div>
                                </div>

                                <Link href={`/dashboard/loja/${storeId}/vendas/${item.venda_id}/os?os_id=${item.id}`}>
                                    <div className="flex items-center justify-center w-9 h-9 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-500 hover:text-white transition-all shadow-sm cursor-pointer">
                                        <ArrowRight className="h-5 w-5" />
                                    </div>
                                </Link>
                            </div>
                        )
                    })
                )}
            </div>
        </div>
    )
}

// --- MANTIDO PARA COMPATIBILIDADE COM PÁGINA DE CONSULTAS ---
export default function PaineisAlertas({ 
    entregas, 
    laboratorio, 
    storeId 
}: { 
    entregas: AlertaEntrega[], 
    laboratorio: AlertaLaboratorio[], 
    storeId: number 
}) {
    return (
        <div className="flex flex-col gap-6">
            <WidgetLaboratorio data={laboratorio} storeId={storeId} />
            <WidgetEntregas data={entregas} storeId={storeId} />
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\consultas\WidgetVencimentos.tsx
==================================================
'use client'

import { CalendarClock, MessageCircle } from 'lucide-react'
import { VencimentoProximo } from '@/lib/actions/consultas.actions'

const formatMoney = (v: number) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

export default function WidgetVencimentos({ 
    dados, 
    storeName 
}: { 
    dados: VencimentoProximo[], 
    storeName: string 
}) {

    const handleZap = (item: VencimentoProximo) => {
        if (!item.fone_movel) return alert("Cliente sem celular cadastrado.")
        
        const num = item.fone_movel.replace(/\D/g, '')
        const primeiroNome = item.customer_name.split(' ')[0]
        const hoje = new Date().toISOString().split('T')[0]
        const venceHoje = item.data_vencimento === hoje
        const textoDia = venceHoje ? "hoje" : "amanhã"

        // MENSAGEM PERSONALIZADA COM NOME DA LOJA
        const msg = `Olá ${primeiroNome}, tudo bem? Aqui é da ${storeName}. Passando apenas para lembrar que sua parcela (${item.numero_parcela}ª) vence ${textoDia}. Se precisar da chave Pix, é só pedir!`
        
        window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank')
    }

    return (
        <div className="bg-white rounded-3xl shadow-[0_10px_30px_-10px_rgba(245,158,11,0.15)] border border-amber-100 overflow-hidden h-fit">
            
            <div className="px-6 py-5 flex justify-between items-center bg-amber-50/30">
                <div className="flex items-center gap-3">
                    <div className="p-2.5 bg-amber-100 text-amber-600 rounded-2xl shadow-sm">
                        <CalendarClock className="h-5 w-5" />
                    </div>
                    <div>
                        <h3 className="font-bold text-slate-700 text-sm">Vencimentos (Hoje/Amanhã)</h3>
                        <p className="text-[10px] text-slate-400 font-medium">Lembrete preventivo</p>
                    </div>
                </div>
                {dados.length > 0 && (
                    <span className="bg-amber-100 text-amber-700 text-xs font-black px-2.5 py-1 rounded-full">
                        {dados.length}
                    </span>
                )}
            </div>

            <div className="p-4 space-y-3">
                {dados.length === 0 ? (
                    <p className="text-center text-xs text-slate-400 py-6 font-medium">
                        Nenhuma parcela vencendo agora. ☀️
                    </p>
                ) : (
                    dados.map(item => (
                        <div key={item.id} className="group p-3 rounded-2xl bg-white border border-slate-100 hover:border-amber-200 hover:shadow-md transition-all flex justify-between items-center">
                            <div>
                                <p className="font-bold text-slate-700 text-xs truncate max-w-[140px]">
                                    {item.customer_name}
                                </p>
                                <p className="text-[10px] text-slate-500 font-mono mt-0.5">
                                    {formatMoney(item.valor_parcela)} • {new Date(item.data_vencimento).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'})}
                                </p>
                            </div>

                            <button
                                onClick={() => handleZap(item)}
                                className="flex items-center justify-center w-8 h-8 rounded-full bg-green-50 text-green-600 hover:bg-green-600 hover:text-white transition-all shadow-sm"
                                title="Enviar Lembrete WhatsApp"
                            >
                                <MessageCircle className="h-4 w-4" />
                            </button>
                        </div>
                    ))
                )}
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\dashboard\ActionMenuDashboard.tsx
==================================================
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { 
  ShoppingCart, Zap, DollarSign, 
  HeartHandshake, Megaphone, Search, 
  ArrowRight, BellRing, AlertCircle, FileText, CheckCircle, Wallet, CheckCircle2
} from 'lucide-react'
import AniversariantesWidget from '@/components/consultas/AniversariantesWidget'
import { WidgetEntregas, WidgetLaboratorio } from '@/components/consultas/PaineisAlertas'
import WidgetVencimentos from '@/components/consultas/WidgetVencimentos' // <--- Import Novo
import { AlertaEntrega, AlertaLaboratorio, Aniversariante, VencimentoProximo } from '@/lib/actions/consultas.actions'
import ParcelaSearchModal from '@/components/modals/ParcelaSearchModal'

interface Props {
    storeId: number
    storeName: string // <--- Recebe o nome da loja
    alerts: {
        entregas: AlertaEntrega[]
        laboratorio: AlertaLaboratorio[]
        vendasEmAberto: number 
    }
    birthdays: Aniversariante[]
    vencimentos: VencimentoProximo[] // <--- Recebe os vencimentos
}

export default function ActionMenuDashboard({ storeId, storeName, alerts, birthdays, vencimentos }: Props) {
  const [isParcelaModalOpen, setIsParcelaModalOpen] = useState(false)

  // LINHA 1: ATENDIMENTO (Frente de Loja)
  const topRow = [
    {
      title: "Venda de Grau",
      desc: "Receituário Completo",
      icon: FileText,
      href: `/dashboard/loja/${storeId}/atendimento`,
      color: "bg-blue-600",
      shadow: "shadow-blue-200"
    },
    {
      title: "Venda Rápida",
      desc: "Solar / Acessórios",
      icon: Zap,
      href: `/dashboard/loja/${storeId}/pdv-express`,
      color: "bg-violet-600",
      shadow: "shadow-violet-200"
    },
    {
      title: "Entrega / Baixa",
      desc: "Finalizar OS",
      icon: CheckCircle2,
      href: `/dashboard/loja/${storeId}/consultas`, // Vai para busca universal
      color: "bg-amber-500",
      shadow: "shadow-amber-200"
    },
    {
      title: "Baixa Parcelas",
      desc: "Receber Dinheiro/Pix",
      icon: DollarSign,
      action: () => setIsParcelaModalOpen(true),
      color: "bg-emerald-600",
      shadow: "shadow-emerald-200"
    }
  ]

  // LINHA 2: RETAGUARDA (Loja Vazia)
  const bottomRow = [
    {
      title: "Livro Caixa",
      icon: Wallet,
      href: `/dashboard/loja/${storeId}/financeiro/caixa`,
      color: "bg-white border border-slate-200 text-slate-700 hover:border-slate-300"
    },
    {
      title: "Cobrança",
      icon: Megaphone,
      href: `/dashboard/loja/${storeId}/cobranca`,
      color: "bg-white border border-slate-200 text-slate-700 hover:border-orange-300 hover:text-orange-600"
    },
    {
      title: "Pós-Venda",
      icon: HeartHandshake,
      href: `/dashboard/loja/${storeId}/pos-venda`,
      color: "bg-white border border-slate-200 text-slate-700 hover:border-pink-300 hover:text-pink-600"
    },
    {
      title: "Rastrear Lentes",
      icon: Search,
      href: `/dashboard/loja/${storeId}/consultas`,
      color: "bg-white border border-slate-200 text-slate-700 hover:border-blue-300 hover:text-blue-600"
    }
  ]

  return (
    <div className="h-full overflow-y-auto custom-scrollbar bg-slate-50">
      <div className="max-w-7xl mx-auto w-full p-6 space-y-8">
        
        {/* 0. ALERTAS CRÍTICOS */}
        {alerts.vendasEmAberto > 0 && (
            <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 flex flex-col md:flex-row md:items-center justify-between gap-4 animate-in slide-in-from-top-2">
                <div className="flex items-center gap-3">
                    <div className="p-2 bg-amber-100 text-amber-600 rounded-lg">
                        <AlertCircle className="h-6 w-6" />
                    </div>
                    <div>
                        <p className="font-bold text-amber-900 text-sm">Atenção Operacional</p>
                        <p className="text-amber-700 text-xs mt-0.5">
                            Você tem <strong className="text-amber-900 underline">{alerts.vendasEmAberto} vendas em aberto</strong>.
                        </p>
                    </div>
                </div>
                <Link 
                    href={`/dashboard/loja/${storeId}/vendas`}
                    className="whitespace-nowrap px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white text-xs font-bold rounded-lg shadow-sm transition-colors flex items-center gap-2"
                >
                    RESOLVER AGORA <ArrowRight className="h-3 w-3" />
                </Link>
            </div>
        )}

        <div className="flex flex-col lg:flex-row gap-8">
            
            {/* --- COLUNA ESQUERDA: AÇÃO (MESA DE CONTROLE) --- */}
            <div className="flex-1 space-y-6">
                
                <h1 className="text-2xl font-black text-slate-800 tracking-tight flex items-center gap-2">
                    <Zap className="h-6 w-6 text-blue-600" /> Painel de Controle
                </h1>

                {/* GRADE 1: ATENDIMENTO (Grandes) */}
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {topRow.map((item, idx) => {
                        const content = (
                            <div className={`
                                h-32 rounded-2xl p-5 relative overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-xl cursor-pointer flex flex-col justify-between
                                ${item.color} ${item.shadow} text-white shadow-lg
                            `}>
                                <div className="absolute top-0 right-0 p-4 opacity-20 transform scale-150 rotate-12">
                                    <item.icon className="w-24 h-24" />
                                </div>
                                <div className="relative z-10">
                                    <item.icon className="w-8 h-8 mb-3 opacity-90" />
                                    <h3 className="text-xl font-black leading-none">{item.title}</h3>
                                </div>
                                <p className="relative z-10 text-xs font-medium opacity-80 uppercase tracking-wider">{item.desc}</p>
                            </div>
                        )

                        return item.action ? (
                            <div key={idx} onClick={item.action}>{content}</div>
                        ) : (
                            <Link key={idx} href={item.href}>{content}</Link>
                        )
                    })}
                </div>

                {/* GRADE 2: RETAGUARDA (Menores) */}
                <h2 className="text-xs font-bold text-slate-400 uppercase tracking-widest mt-6 mb-3 px-1">Loja Vazia & Gestão</h2>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    {bottomRow.map((item, idx) => (
                        <Link key={idx} href={item.href} className={`
                            flex flex-col items-center justify-center text-center p-4 rounded-xl shadow-sm transition-all duration-200 hover:shadow-md hover:-translate-y-0.5 cursor-pointer
                            ${item.color}
                        `}>
                            <item.icon className="h-6 w-6 mb-2 opacity-80" />
                            <span className="text-xs font-bold leading-tight">{item.title}</span>
                        </Link>
                    ))}
                </div>
            </div>

            {/* --- COLUNA DIREITA: RADAR --- */}
            <div className="w-full lg:w-80 flex flex-col gap-6 shrink-0">
                 <div className="flex items-center gap-2 text-slate-400 uppercase text-xs font-bold tracking-widest px-1">
                     <BellRing className="h-4 w-4" /> Radar Operacional
                 </div>
                 
                 {/* Widget Vencimentos (Novo) */}
                 <WidgetVencimentos dados={vencimentos} storeName={storeName} />
                 
                 {/* Widget Aniversariantes */}
                 <AniversariantesWidget clientes={birthdays} />

                 {/* Widget Entregas */}
                 <WidgetEntregas data={alerts.entregas} storeId={storeId} />

                 {/* Widget Laboratório */}
                 <WidgetLaboratorio data={alerts.laboratorio} storeId={storeId} />
            </div>

        </div>
      </div>

      <ParcelaSearchModal 
        isOpen={isParcelaModalOpen}
        onClose={() => setIsParcelaModalOpen(false)}
        storeId={storeId}
      />
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\dashboard\DashboardViews.tsx
==================================================
'use client'

import { StoreKPIs, NetworkKPIs } from '@/lib/actions/dashboard.actions'
import { 
  TrendingUp, DollarSign, ShoppingBag, AlertTriangle, 
  Store, Calendar, Users, Package, Award 
} from 'lucide-react'

const formatMoney = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

// --- COMPONENTE 1: VISÃO DO GERENTE (LOJA) ---
export function ManagerDashboard({ data }: { data: StoreKPIs }) {
  return (
    <div className="space-y-6 animate-in fade-in duration-500">
      
      {/* 1. Cards de Topo */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
            <div className="flex justify-between items-start">
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Vendas Hoje</p>
                    <h3 className="text-2xl font-black text-slate-800 mt-1">{formatMoney(data.faturamentoDia)}</h3>
                </div>
                <div className="p-2 bg-emerald-50 text-emerald-600 rounded-lg">
                    <TrendingUp className="h-5 w-5" />
                </div>
            </div>
            <p className="text-xs text-slate-400 mt-2 font-medium">{data.qtdVendasDia} vendas realizadas</p>
        </div>

        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
            <div className="flex justify-between items-start">
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Acumulado Mês</p>
                    <h3 className="text-2xl font-black text-blue-900 mt-1">{formatMoney(data.faturamentoMes)}</h3>
                </div>
                <div className="p-2 bg-blue-50 text-blue-600 rounded-lg">
                    <Calendar className="h-5 w-5" />
                </div>
            </div>
            <p className="text-xs text-slate-400 mt-2 font-medium">Meta: (Não definida)</p>
        </div>

        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
            <div className="flex justify-between items-start">
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Ticket Médio</p>
                    <h3 className="text-2xl font-black text-slate-700 mt-1">{formatMoney(data.ticketMedio)}</h3>
                </div>
                <div className="p-2 bg-amber-50 text-amber-600 rounded-lg">
                    <Award className="h-5 w-5" />
                </div>
            </div>
            <p className="text-xs text-slate-400 mt-2 font-medium">Performance de Venda</p>
        </div>

        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between">
            <div className="flex justify-between items-start">
                <div>
                    <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Estoque Crítico</p>
                    <h3 className="text-2xl font-black text-rose-600 mt-1">{data.estoqueCritico}</h3>
                </div>
                <div className="p-2 bg-rose-50 text-rose-600 rounded-lg">
                    <AlertTriangle className="h-5 w-5" />
                </div>
            </div>
            <p className="text-xs text-slate-400 mt-2 font-medium">Produtos abaixo do mínimo</p>
        </div>
      </div>

      {/* 2. Área de Conteúdo (Placeholder para Gráficos Futuros) */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 bg-white rounded-2xl p-6 border border-slate-100 shadow-sm min-h-[300px] flex items-center justify-center text-slate-300">
              <div className="text-center">
                  <TrendingUp className="h-12 w-12 mx-auto mb-2 opacity-20"/>
                  <p>Gráfico de Desempenho (Em Breve)</p>
              </div>
          </div>
          <div className="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
              <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                  <Users className="h-5 w-5 text-blue-500" /> Aniversariantes
              </h3>
              {data.aniversariantes.length === 0 ? (
                  <p className="text-sm text-slate-400 italic">Nenhum aniversariante hoje.</p>
              ) : (
                  <ul className="space-y-2">
{data.aniversariantes.map((cli, i) => (
  <li key={i} className="text-sm text-slate-600 flex justify-between items-center">
    <span>{cli.nome}</span>

    <div className="flex items-center gap-2">

      <a
        href={`https://wa.me/${cli.fone ? '55' + cli.fone.replace(/\D/g, '') : ''}?text=${encodeURIComponent(
          `Parabéns ${cli.nome.split(' ')[0]}! 🎉 A Ótica Pro deseja um feliz aniversário!`
        )}`}
        target="_blank"
        rel="noopener noreferrer"
        className="text-green-500 hover:text-green-600"
        title="Enviar felicitações pelo WhatsApp"
      >
        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5"
          fill="currentColor" viewBox="0 0 24 24">
          <path d="M20.52 3.48A11.8 11.8 0 0 0 12 0C5.37 0 0 5.37 0 12a11.9 11.9 0 0 0 1.64 6L0 24l6.25-1.64A11.9 11.9 0 0 0 12 24c6.63 0 12-5.37 12-12 0-3.19-1.24-6.2-3.48-8.52zM12 22a10 10 0 0 1-5.12-1.42l-.37-.22L3 21l.63-3.5-.23-.36A10 10 0 1 1 12 22zm5.13-7.53c-.28-.14-1.68-.83-1.94-.92-.26-.1-.45-.14-.64.14-.19.28-.74.92-.9 1.11-.17.19-.33.21-.62.07-.28-.14-1.17-.43-2.24-1.38-.83-.74-1.39-1.65-1.55-1.93-.16-.28-.02-.43.12-.57.13-.13.28-.33.42-.49.14-.16.19-.28.28-.47.1-.19.05-.36-.02-.5-.07-.14-.64-1.54-.88-2.11-.23-.55-.47-.47-.64-.48h-.55c-.19 0-.5.07-.76.36-.26.28-1 1-1 2.43s1.02 2.82 1.16 3.01c.14.19 2 3.06 4.93 4.29.69.3 1.23.48 1.65.61.69.22 1.31.19 1.81.12.55-.08 1.68-.69 1.92-1.36.24-.66.24-1.23.17-1.36-.07-.14-.26-.21-.54-.35z" />
        </svg>
      </a>

      <span className="text-xs text-slate-400 px-2">
        {cli.fone ?? '—'}
      </span>

    </div>
  </li>
))}


                  </ul>
              )}
          </div>
      </div>
    </div>
  )
}

// --- COMPONENTE 2: VISÃO DO ADMIN (REDE) ---
export function AdminDashboard({ data }: { data: NetworkKPIs }) {
    return (
      <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
          
          {/* Resumo da Rede */}
          <div className="bg-slate-900 text-white p-8 rounded-3xl shadow-xl flex justify-between items-center relative overflow-hidden">
              <div className="relative z-10">
                  <p className="text-slate-400 font-bold uppercase tracking-widest text-sm mb-1">Faturamento Rede (Hoje)</p>
                  <h2 className="text-5xl font-black tracking-tight">{formatMoney(data.totalRedeDia)}</h2>
                  <p className="mt-2 text-slate-400 text-sm">Acumulado Mês: <span className="text-emerald-400 font-bold">{formatMoney(data.totalRedeMes)}</span></p>
              </div>
              <div className="p-4 bg-white/10 rounded-2xl backdrop-blur-sm relative z-10">
                  <Store className="h-10 w-10 text-emerald-400" />
              </div>
              {/* Decorativo */}
              <div className="absolute -right-10 -bottom-20 w-64 h-64 bg-emerald-500/20 rounded-full blur-3xl"></div>
          </div>

          {/* Ranking de Lojas */}
          <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
              <div className="p-6 border-b border-slate-100 bg-slate-50">
                  <h3 className="font-bold text-slate-800 text-lg">Ranking de Filiais (Hoje)</h3>
              </div>
              <div className="divide-y divide-slate-100">
                  {data.lojas.map((loja, idx) => (
                      <div key={loja.id} className="p-4 flex items-center justify-between hover:bg-slate-50 transition-colors">
                          <div className="flex items-center gap-4">
                              <span className={`
                                  w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm
                                  ${idx === 0 ? 'bg-amber-100 text-amber-700' : 
                                    idx === 1 ? 'bg-slate-200 text-slate-600' : 
                                    idx === 2 ? 'bg-orange-100 text-orange-700' : 'bg-slate-50 text-slate-400'}
                              `}>
                                  {idx + 1}
                              </span>
                              <span className="font-bold text-slate-700">{loja.nome}</span>
                          </div>
                          <span className="font-mono font-bold text-slate-900">{formatMoney(loja.vendasDia)}</span>
                      </div>
                  ))}
              </div>
          </div>
      </div>
    )
}

// --- COMPONENTE 3: VISÃO DO OPERADOR (SIMPLES) ---
export function OperatorDashboard({ storeName }: { storeName: string }) {
    return (
        <div className="h-full flex flex-col items-center justify-center text-center p-10 animate-in zoom-in duration-300">
            <div className="w-32 h-32 bg-blue-50 rounded-full flex items-center justify-center mb-6 shadow-inner">
                <ShoppingBag className="h-16 w-16 text-blue-500" />
            </div>
            <h1 className="text-3xl font-bold text-slate-800 mb-2">Bem-vindo à {storeName}</h1>
            <p className="text-slate-500 max-w-md">
                Utilize o menu lateral para iniciar um atendimento, consultar estoque ou verificar ordens de serviço.
            </p>
            <div className="mt-8 flex gap-4">
                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 w-32">
                    <p className="text-xs text-slate-400 uppercase font-bold">Atalhos</p>
                    <p className="text-blue-600 font-bold mt-1">F2: Venda</p>
                </div>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\financeiro\CaixaInterface.tsx
==================================================
'use client'

import { useState, useRef, useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { 
  ResumoCaixa, 
  abrirCaixa, 
  adicionarMovimento, 
  fecharCaixa 
} from '@/lib/actions/cashflow.actions'
import { 
  Wallet, ArrowUpCircle, ArrowDownCircle, Lock, Unlock, 
  Save, Loader2, DollarSign, AlertTriangle, TrendingUp, TrendingDown, Package
} from 'lucide-react'

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatTime = (dateStr: string) => new Date(dateStr).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })

// --- DESIGN SYSTEM (ALTO CONTRASTE) ---
const labelStyle = "block text-[10px] font-bold text-emerald-100 uppercase mb-1 tracking-wider"
const inputStyle = "block w-full rounded-lg border-0 bg-white shadow-sm text-slate-900 h-10 text-sm px-3 focus:ring-2 focus:ring-emerald-300 focus:outline-none font-bold placeholder:font-normal placeholder:text-slate-400 disabled:bg-slate-100 disabled:text-slate-500 transition-all"

export default function CaixaInterface({ initialData, storeId }: { initialData: ResumoCaixa | null, storeId: number }) {
    const router = useRouter()
    const [isPending, startTransition] = useTransition()
    const formRef = useRef<HTMLFormElement>(null)
    
    // --- AÇÕES ---
    const handleAbrir = async (formData: FormData) => {
        startTransition(async () => {
            const res = await abrirCaixa(null, formData)
            if (res.success) router.refresh()
            else alert(res.message)
        })
    }

    const handleMovimento = async (formData: FormData) => {
        if (!initialData?.caixa) return
        formData.append('caixa_id', initialData.caixa.id.toString())
        
        startTransition(async () => {
            const res = await adicionarMovimento(null, formData)
            if (res.success) {
                formRef.current?.reset()
                router.refresh()
            } else {
                alert(res.message)
            }
        })
    }

    const handleFechar = async (formData: FormData) => {
        if (!initialData?.caixa) return
        if (!confirm("Tem certeza que deseja fechar o caixa agora?")) return

        formData.append('caixa_id', initialData.caixa.id.toString())
        formData.append('saldo_esperado', initialData.totais.saldo_esperado_dinheiro.toString())

        startTransition(async () => {
            const res = await fecharCaixa(null, formData)
            if (res.success) router.refresh()
            else alert(res.message)
        })
    }

    // --- RENDERIZAÇÃO CONDICIONAL ---

    // 1. MODO CAIXA FECHADO (Tela de Abertura Estilizada)
    if (!initialData || !initialData.caixa) {
        return (
            <div className="flex flex-col items-center justify-center h-[calc(100vh-150px)] animate-in zoom-in duration-300">
                <div className="bg-gradient-to-br from-emerald-600 to-teal-700 p-8 rounded-3xl shadow-2xl shadow-emerald-200 w-full max-w-md text-center relative overflow-hidden border border-white/20">
                    {/* Efeito de fundo */}
                    <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                    
                    <div className="bg-white/20 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 backdrop-blur-sm shadow-inner border border-white/10">
                        <Lock className="h-10 w-10 text-white" />
                    </div>
                    
                    <h2 className="text-3xl font-black text-white mb-2">Caixa Fechado</h2>
                    <p className="text-emerald-100 mb-8 font-medium">Informe o fundo de troco para iniciar.</p>
                    
                    <form action={handleAbrir} className="space-y-6">
                        <input type="hidden" name="store_id" value={storeId} />
                        <div>
                            <label className="block text-xs font-bold text-emerald-200 uppercase mb-2">Saldo Inicial (Dinheiro)</label>
                            <div className="relative">
                                <span className="absolute left-4 top-3 text-emerald-700 font-bold">R$</span>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    name="saldo_inicial" 
                                    placeholder="0,00" 
                                    className="w-full h-12 text-2xl font-black text-center rounded-xl border-0 shadow-lg text-emerald-800 bg-white focus:ring-4 focus:ring-emerald-400/50"
                                    autoFocus
                                    required
                                />
                            </div>
                        </div>
                        <button 
                            disabled={isPending}
                            className="w-full bg-emerald-900 hover:bg-emerald-950 text-white h-12 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg transition-transform active:scale-95"
                        >
                            {isPending ? <Loader2 className="animate-spin"/> : <Unlock className="h-5 w-5" />}
                            ABRIR OPERAÇÃO
                        </button>
                    </form>
                </div>
            </div>
        )
    }

    // 2. MODO CAIXA ABERTO (Dashboard)
    const { totais, vendas, movimentacoes, categoriasUsadas } = initialData

    return (
        <div className="flex flex-col h-full space-y-4">
            
            {/* --- TOPO: INDICADORES (KPIs) --- */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
                {/* Card Saldo Gaveta */}
                <div className="bg-emerald-600 text-white p-4 rounded-2xl shadow-lg shadow-emerald-100 flex items-center justify-between border border-white/10 relative overflow-hidden">
                     <div className="relative z-10">
                        <p className="text-[10px] font-bold uppercase tracking-wider opacity-80">Saldo em Dinheiro (Gaveta)</p>
                        <p className="text-3xl font-black mt-1">{formatCurrency(totais.saldo_esperado_dinheiro)}</p>
                        <p className="text-[10px] mt-1 opacity-60">Fundo Inicial: {formatCurrency(initialData.caixa.saldo_inicial)}</p>
                     </div>
                     <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm"><Wallet className="h-6 w-6 text-white" /></div>
                </div>

                {/* Card Entradas Vendas */}
                <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col justify-between">
                    <div className="flex justify-between items-start">
                        <div>
                             <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Vendas (Hoje)</p>
                             <p className="text-2xl font-black text-slate-700">{formatCurrency(totais.saldo_geral_acumulado)}</p>
                        </div>
                        <div className="p-2 bg-blue-50 text-blue-600 rounded-lg"><TrendingUp className="h-5 w-5" /></div>
                    </div>
                    <div className="flex gap-2 mt-2">
                        <span className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500 font-bold">Pix: {formatCurrency(vendas.total_pix)}</span>
                        <span className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500 font-bold">Cartão: {formatCurrency(vendas.total_cartao)}</span>
                    </div>
                </div>

                {/* Card Saídas */}
                <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Saídas / Sangrias</p>
                        <p className="text-2xl font-black text-red-600">{formatCurrency(totais.saidas_manuais)}</p>
                        <p className="text-[10px] text-slate-400 mt-1 font-medium">{movimentacoes.filter(m => m.tipo === 'Saida').length} lançamentos</p>
                    </div>
                    <div className="p-2 bg-red-50 text-red-600 rounded-lg"><TrendingDown className="h-5 w-5" /></div>
                </div>
            </div>

            {/* --- CORPO: SPLIT VIEW --- */}
            <div className="flex-1 flex gap-6 overflow-hidden">
                
                {/* ESQUERDA (30%): CONTROLES */}
                <div className="w-1/3 flex flex-col gap-4 overflow-y-auto custom-scrollbar pr-1">
                    
                    {/* CARD 1: NOVO LANÇAMENTO (GRADIENTE) */}
                    <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-5 rounded-2xl shadow-lg shadow-emerald-100 border border-white/20">
                        <div className="flex items-center gap-2 mb-4 border-b border-white/20 pb-2">
                            <div className="p-1 bg-white/20 rounded text-white"><Save className="h-4 w-4" /></div>
                            <h3 className="text-sm font-bold text-white">Lançamento Manual</h3>
                        </div>
                        
                        <form ref={formRef} action={handleMovimento} className="space-y-3">
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className={labelStyle}>Tipo</label>
                                    <select name="tipo" className={`${inputStyle} cursor-pointer`}>
                                        <option value="Saida">Saída (Sangria)</option>
                                        <option value="Entrada">Entrada (Suprimento)</option>
                                    </select>
                                </div>
                                <div>
                                    <label className={labelStyle}>Valor (R$)</label>
                                    <input name="valor" type="number" step="0.01" required className={`${inputStyle} text-right`} placeholder="0.00" />
                                </div>
                            </div>
                            
                            <div>
                                <label className={labelStyle}>Categoria</label>
                                <input 
                                    name="categoria" 
                                    list="categorias-list" 
                                    className={inputStyle} 
                                    placeholder="Ex: Limpeza, Motoboy..."
                                />
                                <datalist id="categorias-list">
                                    {categoriasUsadas.map(cat => <option key={cat} value={cat} />)}
                                </datalist>
                            </div>

                            <div>
                                <label className={labelStyle}>Descrição / Motivo</label>
                                <input name="descricao" type="text" required className={inputStyle} placeholder="Detalhes do lançamento..." />
                            </div>

                            <button disabled={isPending} className="w-full mt-2 bg-white text-emerald-700 h-10 rounded-xl font-bold text-sm hover:bg-emerald-50 shadow-sm transition-all active:scale-95 flex items-center justify-center gap-2">
                                {isPending ? <Loader2 className="h-4 w-4 animate-spin"/> : <Save className="h-4 w-4"/>} 
                                LANÇAR
                            </button>
                        </form>
                    </div>

                    {/* CARD 2: FECHAMENTO (BRANCO/ALERTA) */}
                    <div className="bg-white border border-red-100 p-5 rounded-2xl shadow-sm mt-auto">
                        <h3 className="text-red-800 font-bold text-sm mb-3 flex items-center gap-2">
                            <Lock className="h-4 w-4" /> Fechar Caixa
                        </h3>
                        <form action={handleFechar} className="space-y-3">
                            <div>
                                <label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Contagem Física (Dinheiro)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-400 font-bold">R$</span>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        name="saldo_final" 
                                        className="w-full h-10 pl-9 rounded-lg border border-slate-300 bg-slate-50 focus:bg-white focus:ring-red-500 focus:border-red-500 font-bold text-slate-900 transition-all" 
                                        placeholder="0.00"
                                        required 
                                    />
                                </div>
                            </div>
                            
                            <div className="bg-red-50 p-2 rounded border border-red-100 text-[10px] text-red-600 font-medium flex gap-2">
                                <AlertTriangle className="h-3 w-3 shrink-0 mt-0.5" />
                                Diferenças serão registradas como Quebra de Caixa.
                            </div>

                            <button 
                                disabled={isPending}
                                className="w-full bg-red-600 hover:bg-red-700 text-white h-10 rounded-xl font-bold shadow-md flex justify-center items-center gap-2 transition-all active:scale-95"
                            >
                                {isPending ? <Loader2 className="animate-spin h-4 w-4"/> : "ENCERRAR O DIA"}
                            </button>
                        </form>
                    </div>
                </div>

                {/* DIREITA (70%): EXTRATO */}
                <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                    <div className="bg-slate-50 px-5 py-3 border-b border-slate-200">
                         <h3 className="font-bold text-slate-700 text-sm flex items-center gap-2">
                             <Package className="h-4 w-4 text-slate-400" /> Extrato de Movimentações
                         </h3>
                    </div>
                    <div className="flex-1 overflow-y-auto p-0 custom-scrollbar">
                        {movimentacoes.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-slate-300">
                                <DollarSign className="h-12 w-12 mb-2 opacity-20" />
                                <p className="text-xs">Nenhuma movimentação manual hoje.</p>
                            </div>
                        ) : (
                            <table className="w-full text-sm text-left">
                                <thead className="bg-white sticky top-0 text-[10px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                    <tr>
                                        <th className="px-5 py-3">Hora</th>
                                        <th className="px-5 py-3">Categoria</th>
                                        <th className="px-5 py-3">Descrição</th>
                                        <th className="px-5 py-3 text-right">Valor</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {movimentacoes.map(mov => (
                                        <tr key={mov.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="px-5 py-3 text-slate-500 w-24 font-mono text-xs">{formatTime(mov.created_at)}</td>
                                            <td className="px-5 py-3 w-40">
                                                {mov.categoria ? (
                                                    <span className="text-[10px] bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200 font-bold">{mov.categoria}</span>
                                                ) : (
                                                    <span className="text-[10px] text-slate-300">-</span>
                                                )}
                                            </td>
                                            <td className="px-5 py-3 font-medium text-slate-700">{mov.descricao}</td>
                                            <td className={`px-5 py-3 font-bold text-right w-32 ${mov.tipo === 'Entrada' ? 'text-emerald-600' : 'text-red-600'}`}>
                                                {mov.tipo === 'Entrada' ? '+' : '-'} {formatCurrency(mov.valor)}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </div>
                </div>

            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\financeiro\CashGuard.tsx
==================================================
// ARQUIVO: src/components/financeiro/CashGuard.tsx
'use client'

import { useState, useEffect, useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { Lock, Unlock, AlertTriangle, X, Loader2 } from 'lucide-react'
import { verificarStatusCaixa, abrirCaixa } from '@/lib/actions/cashflow.actions'

export default function CashGuard({ storeId }: { storeId: number }) {
    const router = useRouter()
    
    // O Guard começa "invisível" até checarmos o status
    const [isVisible, setIsVisible] = useState(false)
    const [isPending, startTransition] = useTransition()
    
    // Checagem inicial ao carregar a página
    useEffect(() => {
        const check = async () => {
            const caixaAberto = await verificarStatusCaixa(storeId)
            // Se NÃO estiver aberto, mostramos o Guard
            if (!caixaAberto) {
                setIsVisible(true)
            }
        }
        check()
    }, [storeId])

    const handleAbrir = async (formData: FormData) => {
        startTransition(async () => {
            const res = await abrirCaixa(null, formData)
            if (res.success) {
                setIsVisible(false) // Fecha o modal
                router.refresh()    // Atualiza a tela
            } else {
                alert(res.message)
            }
        })
    }

    const handlePular = () => {
        if (confirm("Tem certeza? O caixa continuará fechado e as movimentações não serão registradas corretamente.")) {
            setIsVisible(false)
        }
    }

    if (!isVisible) return null

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/90 backdrop-blur-md p-4 animate-in fade-in duration-500">
            <div className="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden relative">
                
                {/* Botão de Fechar discreto (Pular) */}
                <button 
                    onClick={handlePular}
                    className="absolute top-4 right-4 text-slate-400 hover:text-slate-600 transition-colors"
                    title="Pular abertura (Emergência)"
                >
                    <X className="h-6 w-6" />
                </button>

                <div className="p-8 text-center">
                    <div className="w-20 h-20 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                        <Lock className="h-10 w-10" />
                    </div>
                    
                    <h2 className="text-2xl font-black text-slate-800 mb-2">Caixa Fechado</h2>
                    <p className="text-slate-500 mb-8">
                        Bom dia! Antes de começar a vender, precisamos abrir o caixa.
                    </p>

                    <form action={handleAbrir} className="space-y-4 text-left">
                        <input type="hidden" name="store_id" value={storeId} />
                        
                        <div>
                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Fundo de Troco (Dinheiro)</label>
                            <div className="relative">
                                <span className="absolute left-4 top-3.5 text-slate-400 font-bold">R$</span>
                                <input 
                                    name="saldo_inicial" 
                                    type="number" 
                                    step="0.01" 
                                    className="w-full h-14 pl-12 rounded-xl border-2 border-slate-200 text-2xl font-black text-slate-800 focus:border-amber-500 focus:ring-amber-500 transition-all"
                                    placeholder="0.00"
                                    autoFocus
                                    required
                                />
                            </div>
                        </div>

                        <button 
                            disabled={isPending}
                            className="w-full py-4 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold shadow-lg shadow-amber-200 flex items-center justify-center gap-2 transition-transform active:scale-95 disabled:opacity-70"
                        >
                            {isPending ? <Loader2 className="h-6 w-6 animate-spin"/> : <Unlock className="h-6 w-6" />}
                            ABRIR CAIXA AGORA
                        </button>
                    </form>

                    <button 
                        onClick={handlePular}
                        className="mt-6 text-xs font-bold text-slate-400 hover:text-red-500 flex items-center justify-center gap-1 mx-auto transition-colors"
                    >
                        <AlertTriangle className="h-3 w-3" />
                        Pular abertura (Atender emergência)
                    </button>
                </div>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\financeiro\ComissoesInterface.tsx
==================================================
'use client'

import { useState, useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { 
  Calendar, DollarSign, CheckCircle2, Loader2, 
  User, Wallet, Filter, ChevronRight, TrendingUp, AlertCircle 
} from 'lucide-react'
import { pagarComissoesEmLote, type ResumoComissao } from '@/lib/actions/commission.actions'

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (d: string) => new Date(d).toLocaleDateString('pt-BR')

// --- DESIGN SYSTEM (Roxo/Fúcsia) ---
const labelStyle = "block text-[9px] font-bold text-white/80 uppercase mb-0.5 tracking-wider"
const inputHeaderStyle = "block w-full rounded-lg border-0 bg-white shadow-lg text-slate-800 h-9 text-xs px-2 focus:ring-2 focus:ring-fuchsia-300 font-bold"

export default function ComissoesInterface({ 
    data, 
    storeId, 
    periodo 
}: { 
    data: ResumoComissao[], 
    storeId: number,
    periodo: { inicio: string, fim: string }
}) {
    const router = useRouter()
    const [selectedId, setSelectedId] = useState<number | null>(null)
    const [isPending, startTransition] = useTransition()

    // Filtros de Data locais
    const [dataInicio, setDataInicio] = useState(periodo.inicio)
    const [dataFim, setDataFim] = useState(periodo.fim)

    const selectedEmployee = data.find(d => d.employee_id === selectedId)

    const handleFilter = () => {
        router.push(`/dashboard/loja/${storeId}/financeiro/comissoes?inicio=${dataInicio}&fim=${dataFim}`)
    }

    const handlePagar = () => {
        if (!selectedEmployee) return
        
        const pendentes = selectedEmployee.detalhes.filter(d => d.status === 'Pendente')
        if (pendentes.length === 0) return

        const ids = pendentes.map(d => d.id)
        const total = pendentes.reduce((acc, curr) => acc + curr.valor_comissao, 0)

        if (!confirm(`Confirmar pagamento de ${formatCurrency(total)} para ${selectedEmployee.employee_name}?`)) return

        startTransition(async () => {
            const res = await pagarComissoesEmLote(storeId, selectedEmployee.employee_id, ids)
            if (res.success) {
                alert('Pagamento registrado com sucesso!')
                router.refresh()
            } else {
                alert('Erro: ' + res.message)
            }
        })
    }

    return (
        <div className="flex h-full overflow-hidden bg-slate-100">
            
            {/* --- ESQUERDA (30%): FILTROS E LISTA --- */}
            <div className="w-1/3 flex flex-col border-r border-slate-200 bg-white z-10 shadow-sm">
                
                {/* Header Gradiente */}
                <div className="bg-gradient-to-br from-violet-600 to-fuchsia-700 p-5 flex flex-col gap-4 shadow-md z-20">
                    <div className="flex justify-between items-center text-white">
                        <h2 className="font-bold text-sm flex items-center gap-2 uppercase tracking-wide">
                            <Wallet className="h-4 w-4" /> Comissões
                        </h2>
                        <span className="text-[10px] bg-white/20 px-2 py-0.5 rounded-full font-medium">
                            {data.length} colab.
                        </span>
                    </div>

                    {/* Filtros de Data Integrados */}
                    <div className="flex gap-2 items-end">
                        <div className="flex-1">
                            <label className={labelStyle}>De</label>
                            <input 
                                type="date" 
                                value={dataInicio} 
                                onChange={e => setDataInicio(e.target.value)} 
                                className={inputHeaderStyle}
                            />
                        </div>
                        <div className="flex-1">
                            <label className={labelStyle}>Até</label>
                            <input 
                                type="date" 
                                value={dataFim} 
                                onChange={e => setDataFim(e.target.value)} 
                                className={inputHeaderStyle}
                            />
                        </div>
                        <button 
                            onClick={handleFilter}
                            className="h-9 w-9 bg-white/20 hover:bg-white/30 text-white rounded-lg flex items-center justify-center shadow-sm transition-colors"
                            title="Filtrar"
                        >
                            <Filter className="h-4 w-4" />
                        </button>
                    </div>
                </div>

                {/* Lista de Funcionários */}
                <div className="flex-1 overflow-y-auto">
                    {data.length === 0 ? (
                        <div className="text-center p-10 text-slate-400 flex flex-col items-center">
                            <User className="h-10 w-10 mb-2 opacity-20"/>
                            <p className="text-xs">Nenhum registro no período.</p>
                        </div>
                    ) : (
                        data.map((item) => (
                            <div 
                                key={item.employee_id} 
                                onClick={() => setSelectedId(item.employee_id)}
                                className={`p-4 border-b border-slate-100 cursor-pointer transition-colors flex justify-between items-center group
                                    ${selectedId === item.employee_id ? 'bg-fuchsia-50 border-l-4 border-l-fuchsia-600' : 'hover:bg-slate-50 border-l-4 border-l-transparent'}
                                `}
                            >
                                <div>
                                    <p className={`font-bold text-sm ${selectedId === item.employee_id ? 'text-fuchsia-900' : 'text-slate-700'}`}>
                                        {item.employee_name}
                                    </p>
                                    <p className="text-[10px] text-slate-400 mt-1">
                                        Vendas: {formatCurrency(item.total_vendas)}
                                    </p>
                                </div>
                                <div className="text-right">
                                    {item.comissao_pendente > 0 ? (
                                        <span className="block font-black text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-100">
                                            {formatCurrency(item.comissao_pendente)}
                                        </span>
                                    ) : (
                                        <span className="block font-bold text-xs text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100 flex items-center gap-1">
                                            <CheckCircle2 className="h-3 w-3" /> Quitada
                                        </span>
                                    )}
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>

            {/* --- DIREITA (70%): DETALHES --- */}
            <div className="flex-1 flex flex-col bg-slate-50 relative overflow-hidden">
                {selectedEmployee ? (
                    <>
                        {/* Header do Funcionário */}
                        <div className="bg-white px-6 py-4 border-b border-slate-200 shadow-sm shrink-0">
                             <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                <User className="h-6 w-6 text-slate-400" />
                                {selectedEmployee.employee_name}
                             </h2>
                        </div>

                        {/* KPIs e Tabela */}
                        <div className="flex-1 overflow-y-auto p-6 custom-scrollbar">
                            <div className="max-w-5xl mx-auto space-y-6 pb-20">
                                
                                {/* KPIs */}
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Vendas no Período</p>
                                        <p className="text-2xl font-black text-slate-700">{formatCurrency(selectedEmployee.total_vendas)}</p>
                                        <div className="mt-2 flex items-center gap-1 text-[10px] text-blue-600 font-bold">
                                            <TrendingUp className="h-3 w-3" /> Performance
                                        </div>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl border border-amber-200 shadow-sm relative overflow-hidden">
                                        <div className="absolute right-0 top-0 p-2 opacity-10"><AlertCircle className="h-12 w-12 text-amber-500"/></div>
                                        <p className="text-[10px] font-bold text-amber-600 uppercase tracking-wider mb-1">A Pagar (Pendente)</p>
                                        <p className="text-2xl font-black text-amber-600">{formatCurrency(selectedEmployee.comissao_pendente)}</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl border border-emerald-200 shadow-sm relative overflow-hidden">
                                        <div className="absolute right-0 top-0 p-2 opacity-10"><CheckCircle2 className="h-12 w-12 text-emerald-500"/></div>
                                        <p className="text-[10px] font-bold text-emerald-600 uppercase tracking-wider mb-1">Já Pago (Período)</p>
                                        <p className="text-2xl font-black text-emerald-600">{formatCurrency(selectedEmployee.comissao_paga)}</p>
                                    </div>
                                </div>

                                {/* Tabela Detalhada */}
                                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="bg-slate-50 px-5 py-3 border-b border-slate-200">
                                        <h3 className="font-bold text-slate-700 text-sm">Extrato de Vendas</h3>
                                    </div>
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-white text-[10px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                            <tr>
                                                <th className="px-5 py-3">Data</th>
                                                <th className="px-5 py-3">Venda ID</th>
                                                <th className="px-5 py-3 text-right">Valor Venda</th>
                                                <th className="px-5 py-3 text-right">Comissão</th>
                                                <th className="px-5 py-3 text-center">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {selectedEmployee.detalhes.map((det) => (
                                                <tr key={det.id} className="hover:bg-slate-50 transition-colors">
                                                    <td className="px-5 py-3 text-slate-500 font-mono text-xs">{formatDate(det.data)}</td>
                                                    <td className="px-5 py-3 font-bold text-blue-600 text-xs">#{det.venda_id}</td>
                                                    <td className="px-5 py-3 text-right text-slate-600">{formatCurrency(det.valor_venda)}</td>
                                                    <td className="px-5 py-3 text-right font-bold text-slate-800">{formatCurrency(det.valor_comissao)}</td>
                                                    <td className="px-5 py-3 text-center">
                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${det.status === 'Pago' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>
                                                            {det.status}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                            </div>
                        </div>

                        {/* Rodapé Fixo (Ação) */}
                        {selectedEmployee.comissao_pendente > 0 && (
                            <div className="bg-white border-t border-slate-200 p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] flex justify-between items-center z-20 shrink-0">
                                <div>
                                    <p className="text-xs text-slate-500 font-bold uppercase">Total a Pagar Agora</p>
                                    <p className="text-2xl font-black text-slate-800">{formatCurrency(selectedEmployee.comissao_pendente)}</p>
                                </div>
                                <button 
                                    onClick={handlePagar}
                                    disabled={isPending}
                                    className="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl shadow-lg shadow-green-200 font-bold flex items-center gap-2 transition-transform active:scale-95"
                                >
                                    {isPending ? <Loader2 className="h-5 w-5 animate-spin"/> : <DollarSign className="h-5 w-5"/>}
                                    CONFIRMAR PAGAMENTO
                                </button>
                            </div>
                        )}

                    </>
                ) : (
                    <div className="flex-1 flex flex-col items-center justify-center text-slate-300">
                        <Filter className="h-16 w-16 mb-4 opacity-20" />
                        <p className="text-lg font-light">Selecione um colaborador para ver o extrato</p>
                    </div>
                )}
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\financeiro\ContasInterface.tsx
==================================================
// ARQUIVO: src/components/financeiro/ContasInterface.tsx
'use client'

import { useState } from 'react'
import { useRouter, useSearchParams } from 'next/navigation' 
import { Database } from '@/lib/database.types'
import { Plus, Calendar, AlertCircle, CheckCircle, Clock, Trash2, Filter, ArrowRight, DollarSign, TrendingDown } from 'lucide-react'
import NewBillModal from '@/components/modals/NewBillModal'
import PayBillModal from '@/components/modals/PayBillModal'
import { deleteBill } from '@/lib/actions/payable.actions'

// CORREÇÃO: Definir Bill como 'any' para evitar conflitos de tipagem com o banco desatualizado
type Bill = any

const formatMoney = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (dateStr: string) => new Date(dateStr).toLocaleDateString('pt-BR', { timeZone: 'UTC' })

// --- DESIGN SYSTEM ---
const labelStyle = "block text-[10px] font-bold text-slate-600 uppercase mb-0.5 tracking-wider"
const activeFilterClass = "w-full text-left px-4 py-3 rounded-lg bg-rose-50 text-rose-700 border border-rose-200 font-bold text-sm flex justify-between items-center shadow-sm transition-all"
const inactiveFilterClass = "w-full text-left px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-50 font-medium text-sm flex justify-between items-center transition-all"

export default function ContasInterface({ bills, storeId }: { bills: Bill[], storeId: number }) {
    const router = useRouter()
    const searchParams = useSearchParams() 
    
    const [isNewOpen, setIsNewOpen] = useState(false)
    const [payBill, setPayBill] = useState<Bill | null>(null)
    const [filter, setFilter] = useState<'Todos' | 'Pendente' | 'Pago'>('Pendente')

    // Pega o mês atual da URL ou usa o mês corrente (Formato YYYY-MM)
    const currentMonth = searchParams.get('mes') 
        ? searchParams.get('mes')?.slice(0, 7) 
        : new Date().toISOString().slice(0, 7)

    // Função para trocar o mês
    const handleMonthChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const novoMes = e.target.value // Retorna "2024-02"
        // Recarrega a página passando o dia 01 do novo mês para o backend filtrar
        router.push(`/dashboard/loja/${storeId}/financeiro/contas?mes=${novoMes}-01`)
    }

    // Cálculos Rápidos (CORREÇÃO: .getTime() para comparação segura de datas)
    const totalVencido = bills.filter(b => b.status === 'Pendente' && new Date(b.due_date).getTime() < new Date(new Date().setHours(0,0,0,0)).getTime()).reduce((acc, b) => acc + b.amount, 0)
    const totalPendente = bills.filter(b => b.status === 'Pendente').reduce((acc, b) => acc + b.amount, 0)
    const totalPago = bills.filter(b => b.status === 'Pago').reduce((acc, b) => acc + (b.amount_paid || b.amount), 0)

    const filteredBills = bills.filter(b => filter === 'Todos' ? true : b.status === filter)

    const handleDelete = async (id: number) => {
        if (confirm("Tem certeza que deseja excluir esta conta?")) {
            await deleteBill(id, storeId)
        }
    }

    return (
        <div className="flex flex-col h-full space-y-4">
            
            {/* 1. KPIs (TOPO) */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 shrink-0">
                
                {/* Vencidas (Alerta) */}
                <div className="bg-white p-4 rounded-2xl border-l-4 border-rose-500 shadow-sm flex items-center justify-between relative overflow-hidden group">
                    <div className="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><AlertCircle className="h-16 w-16 text-rose-500" /></div>
                    <div className="relative z-10">
                        <p className="text-[10px] font-bold text-rose-500 uppercase tracking-wider">Vencidas / Atrasadas</p>
                        <p className="text-2xl font-black text-rose-600 mt-1">{formatMoney(totalVencido)}</p>
                    </div>
                </div>

                {/* A Pagar (Info) */}
                <div className="bg-white p-4 rounded-2xl border-l-4 border-blue-500 shadow-sm flex items-center justify-between relative overflow-hidden group">
                    <div className="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><Clock className="h-16 w-16 text-blue-500" /></div>
                    <div className="relative z-10">
                        <p className="text-[10px] font-bold text-blue-500 uppercase tracking-wider">A Pagar (Total)</p>
                        <p className="text-2xl font-black text-blue-600 mt-1">{formatMoney(totalPendente)}</p>
                    </div>
                </div>

                {/* Pago (Sucesso) */}
                <div className="bg-white p-4 rounded-2xl border-l-4 border-emerald-500 shadow-sm flex items-center justify-between relative overflow-hidden group">
                    <div className="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><CheckCircle className="h-16 w-16 text-emerald-500" /></div>
                    <div className="relative z-10">
                         <p className="text-[10px] font-bold text-emerald-500 uppercase tracking-wider">Pago no Mês</p>
                         <p className="text-2xl font-black text-emerald-600 mt-1">{formatMoney(totalPago)}</p>
                    </div>
                </div>
            </div>

            {/* 2. CORPO (SPLIT VIEW) */}
            <div className="flex-1 flex gap-6 overflow-hidden">
                
                {/* ESQUERDA: PAINEL DE CONTROLE */}
                <div className="w-1/4 min-w-[240px] flex flex-col gap-4">
                    
                    {/* --- NOVO SELETOR DE MÊS --- */}
                    <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                        <label className={labelStyle}>Mês de Referência</label>
                        <input 
                            type="month" 
                            value={currentMonth || ''} 
                            onChange={handleMonthChange}
                            className="block w-full rounded-lg border border-slate-300 bg-slate-50 shadow-sm text-slate-900 h-10 px-3 focus:ring-2 focus:ring-rose-500 focus:border-rose-500 font-bold cursor-pointer"
                        />
                    </div>

                    {/* Botão Principal */}
                    <button 
                        onClick={() => setIsNewOpen(true)}
                        className="w-full py-4 bg-gradient-to-r from-rose-600 to-red-700 hover:from-rose-700 hover:to-red-800 text-white rounded-2xl shadow-lg shadow-rose-200 flex items-center justify-center gap-2 font-bold transition-transform active:scale-95"
                    >
                        <Plus className="h-5 w-5" />
                        NOVA CONTA
                    </button>

                    {/* Filtros Laterais */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-2 flex flex-col gap-1 flex-1">
                        <p className="px-4 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">Filtrar por Status</p>
                        
                        <button onClick={() => setFilter('Pendente')} className={filter === 'Pendente' ? activeFilterClass : inactiveFilterClass}>
                            <span>Pendentes</span>
                            <span className="bg-white/50 px-2 py-0.5 rounded text-xs border border-slate-200">{bills.filter(b=>b.status === 'Pendente').length}</span>
                        </button>
                        
                        <button onClick={() => setFilter('Pago')} className={filter === 'Pago' ? activeFilterClass : inactiveFilterClass}>
                            <span>Pagos</span>
                            <span className="bg-white/50 px-2 py-0.5 rounded text-xs border border-slate-200">{bills.filter(b=>b.status === 'Pago').length}</span>
                        </button>

                        <button onClick={() => setFilter('Todos')} className={filter === 'Todos' ? activeFilterClass : inactiveFilterClass}>
                            <span>Todos</span>
                            <span className="bg-white/50 px-2 py-0.5 rounded text-xs border border-slate-200">{bills.length}</span>
                        </button>
                    </div>
                </div>

                {/* DIREITA: LISTA */}
                <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                    <div className="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700 text-sm flex items-center gap-2 uppercase tracking-wide">
                            <TrendingDown className="h-4 w-4 text-rose-500" /> Lista de Contas
                        </h3>
                        <span className="text-xs font-bold text-slate-400 bg-white px-2 py-1 rounded border border-slate-200">
                            {(currentMonth || '').split('-').reverse().join('/')}
                        </span>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-0 custom-scrollbar">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-white sticky top-0 z-10 text-[10px] font-bold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                <tr>
                                    <th className="px-6 py-3">Vencimento</th>
                                    <th className="px-6 py-3">Descrição / Fornecedor</th>
                                    <th className="px-6 py-3 text-right">Valor</th>
                                    <th className="px-6 py-3 text-center">Status</th>
                                    <th className="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-50">
                                {filteredBills.length === 0 ? (
                                    <tr><td colSpan={5} className="p-10 text-center text-slate-400 italic">Nenhuma conta encontrada neste mês.</td></tr>
                                ) : (
                                    filteredBills.map(bill => {
                                        // CORREÇÃO: Comparação de data segura com .getTime()
                                        const isLate = bill.status === 'Pendente' && new Date(bill.due_date).getTime() < new Date(new Date().setHours(0,0,0,0)).getTime();
                                        return (
                                            <tr key={bill.id} className="hover:bg-slate-50 transition-colors group">
                                                <td className="px-6 py-3 font-mono text-slate-500 text-xs">
                                                    {formatDate(bill.due_date)}
                                                </td>
                                                <td className="px-6 py-3">
                                                    <p className="font-bold text-slate-700 text-sm">{bill.description}</p>
                                                    <div className="flex gap-2 mt-0.5">
                                                        {bill.category && <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 rounded border border-slate-200">{bill.category}</span>}
                                                        {bill.suppliers && <span className="text-[10px] text-blue-600 font-medium">{bill.suppliers.nome_fantasia}</span>}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-3 text-right font-bold text-slate-800">
                                                    {formatMoney(bill.amount)}
                                                </td>
                                                <td className="px-6 py-3 text-center">
                                                    {bill.status === 'Pago' ? (
                                                        <span className="inline-flex items-center gap-1 text-[10px] font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded border border-emerald-100 uppercase">
                                                            Pago
                                                        </span>
                                                    ) : isLate ? (
                                                        <span className="inline-flex items-center gap-1 text-[10px] font-black text-white bg-rose-500 px-2 py-1 rounded uppercase shadow-sm">
                                                            Atrasado
                                                        </span>
                                                    ) : (
                                                        <span className="inline-flex items-center gap-1 text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded border border-slate-200 uppercase">
                                                            A Vencer
                                                        </span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-3 text-right">
                                                    <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        {bill.status === 'Pendente' && (
                                                            <button onClick={() => setPayBill(bill)} className="text-[10px] bg-green-600 text-white px-3 py-1.5 rounded font-bold hover:bg-green-700 shadow-sm flex items-center gap-1">
                                                                <CheckCircle className="h-3 w-3" /> BAIXAR
                                                            </button>
                                                        )}
                                                        <button onClick={() => handleDelete(bill.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors">
                                                            <Trash2 className="h-4 w-4" />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {/* Modais */}
            {isNewOpen && <NewBillModal isOpen={isNewOpen} onClose={() => setIsNewOpen(false)} storeId={storeId} />}
            {payBill && <PayBillModal bill={payBill} onClose={() => setPayBill(null)} />}
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\AddDependenteModal.tsx
==================================================
// ARQUIVO: src/components/modals/AddDependenteModal.tsx
'use client'

import { useState, useEffect, useRef } from 'react'
import { useFormState, useFormStatus } from 'react-dom'
import { Loader2, X, Save, UserPlus } from 'lucide-react'
import { saveDependente, type SaveDependenteResult } from '@/lib/actions/dependents.actions'
import { Database } from '@/lib/database.types'

type Dependente = Database['public']['Tables']['dependentes']['Row']

type AddDependenteModalProps = {
  isOpen: boolean
  onClose: () => void
  onSuccess: (newDep: Dependente) => void
  storeId: number
  customerId: number
}

function SubmitButton() {
  const { pending } = useFormStatus()
  return (
    <button
      type="submit"
      disabled={pending}
      className="flex w-full justify-center items-center gap-2 rounded-md bg-blue-600 py-2 px-4 text-sm font-bold text-white shadow-sm hover:bg-blue-700 disabled:opacity-50"
    >
      {pending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Save className="h-4 w-4" />}
      SALVAR DEPENDENTE
    </button>
  )
}

export default function AddDependenteModal({
  isOpen,
  onClose,
  onSuccess,
  storeId,
  customerId
}: AddDependenteModalProps) {
  const initialState: SaveDependenteResult = { success: false, message: '' }
  const [state, dispatch] = useFormState(saveDependente, initialState)
  const formRef = useRef<HTMLFormElement>(null)

  // Fecha e notifica sucesso
  useEffect(() => {
    if (state.success && state.data) {
      onSuccess(state.data)
      onClose()
      // Limpa o estado para a próxima abertura (opcional, pois o modal será desmontado se condicional)
    }
  }, [state, onSuccess, onClose])

  if (!isOpen) return null

  const inputStyle = "block w-full rounded-md border-gray-300 shadow-sm h-9 text-sm px-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
  const labelStyle = "block text-xs font-bold text-gray-700 mb-1"

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onClick={onClose}>
      <div 
        className="relative w-full max-w-md bg-gray-100 rounded-lg shadow-xl border border-gray-300 overflow-hidden"
        onClick={e => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex justify-between items-center px-4 py-3 bg-white border-b border-gray-200">
          <h3 className="text-sm font-bold text-gray-800 flex items-center gap-2">
            <UserPlus className="h-5 w-5 text-blue-600" />
            Novo Dependente / Paciente
          </h3>
          <button onClick={onClose} className="text-gray-400 hover:text-red-500">
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* Form */}
        <form action={dispatch} ref={formRef} className="p-5 space-y-4">
          <input type="hidden" name="store_id" value={storeId} />
          <input type="hidden" name="customer_id" value={customerId} />

          <div>
            <label className={labelStyle}>Nome Completo *</label>
            <input type="text" name="nome_completo" required className={inputStyle} placeholder="Ex: João Silva Jr." />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className={labelStyle}>Parentesco *</label>
              <select name="parentesco" className={inputStyle}>
                <option value="Filho(a)">Filho(a)</option>
                <option value="Cônjuge">Cônjuge</option>
                <option value="Pai/Mãe">Pai/Mãe</option>
                <option value="Outro">Outro</option>
              </select>
            </div>
            <div>
              <label className={labelStyle}>Data Nasc.</label>
              <input type="date" name="data_nascimento" className={inputStyle} />
            </div>
          </div>

          {state.message && !state.success && (
            <div className="p-2 bg-red-100 border border-red-200 text-red-700 text-xs rounded">
              {state.message}
            </div>
          )}

          <div className="pt-2">
            <SubmitButton />
          </div>
        </form>
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\modals\AssistanceTimelineModal.tsx
==================================================
'use client'

import { useState, useEffect, useTransition, useRef } from 'react'
import { X, Send, Loader2, MessageSquare, Phone, Globe, User, Bell, Mail } from 'lucide-react'
import { getAssistanceTimeline, saveAssistanceInteraction } from '@/lib/actions/assistance.actions'

type TimelineItem = {
    id: number
    tipo: string // 'Comentario', 'MudancaStatus', 'Alerta', 'WhatsApp', 'Sistema', 'Site', 'Email'
    mensagem: string
    created_at: string
}

const formatDate = (d: string) => new Date(d).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' })

export default function AssistanceTimelineModal({ isOpen, onClose, ticket }: { isOpen: boolean, onClose: () => void, ticket: any }) {
    const [history, setHistory] = useState<TimelineItem[]>([])
    const [loading, setLoading] = useState(true)
    const [tipo, setTipo] = useState('WhatsApp')
    const [mensagem, setMensagem] = useState('')
    const [isSaving, startTransition] = useTransition()
    const scrollRef = useRef<HTMLDivElement>(null)

    useEffect(() => {
        if (isOpen && ticket) {
            setLoading(true)
            getAssistanceTimeline(ticket.id).then(data => {
                setHistory(data)
                setLoading(false)
            })
        }
    }, [isOpen, ticket])

    const handleSend = (e: React.FormEvent) => {
        e.preventDefault()
        if (!mensagem.trim()) return

        const formData = new FormData()
        formData.append('ticket_id', ticket.id.toString())
        formData.append('tipo', tipo)
        formData.append('mensagem', mensagem)

        startTransition(async () => {
            const res = await saveAssistanceInteraction(formData)
            if (res.success) {
                setMensagem('')
                // Recarrega lista
                const newData = await getAssistanceTimeline(ticket.id)
                setHistory(newData)
            } else {
                alert(res.message)
            }
        })
    }

    if (!isOpen) return null

    // Ícones por tipo
    const getIcon = (t: string) => {
        if (t === 'WhatsApp') return <MessageSquare className="h-4 w-4 text-green-600" />
        if (t === 'Ligação') return <Phone className="h-4 w-4 text-blue-600" />
        if (t === 'Site') return <Globe className="h-4 w-4 text-cyan-600" /> // <--- Ícone para Site
        if (t === 'Email') return <Mail className="h-4 w-4 text-indigo-500" />
        if (t === 'Sistema') return <Globe className="h-4 w-4 text-gray-400 opacity-50" />
        if (t === 'Alerta') return <Bell className="h-4 w-4 text-amber-600" />
        return <User className="h-4 w-4 text-slate-500" />
    }

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in">
            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                
                {/* Header */}
                <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                    <div>
                        <h3 className="font-bold text-slate-800 text-lg">Histórico de Interações</h3>
                        <p className="text-xs text-slate-500">Ticket #{ticket.id} • {ticket.customers?.full_name}</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-400 hover:text-slate-600"><X className="h-5 w-5"/></button>
                </div>

                {/* Área de Mensagens (Scroll) */}
                <div className="flex-1 overflow-y-auto p-6 bg-slate-50 space-y-4" ref={scrollRef}>
                    {loading ? (
                        <div className="flex justify-center py-10"><Loader2 className="h-8 w-8 animate-spin text-slate-300"/></div>
                    ) : history.length === 0 ? (
                        <p className="text-center text-slate-400 text-sm italic">Nenhum registro ainda.</p>
                    ) : (
                        history.map((item) => (
                            <div key={item.id} className={`flex gap-3 ${item.tipo === 'Sistema' ? 'opacity-70' : ''}`}>
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center border shrink-0 bg-white shadow-sm border-slate-200`}>
                                    {getIcon(item.tipo)}
                                </div>
                                <div className="flex-1">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs font-bold text-slate-700">{item.tipo}</span>
                                        <span className="text-[10px] text-slate-400">{formatDate(item.created_at)}</span>
                                    </div>
                                    <div className="bg-white p-3 rounded-lg rounded-tl-none border border-slate-200 text-sm text-slate-600 shadow-sm">
                                        {item.mensagem}
                                    </div>
                                </div>
                            </div>
                        ))
                    )}
                </div>

                {/* Input Fixo */}
                <form onSubmit={handleSend} className="p-4 bg-white border-t border-slate-200">
                    <div className="flex gap-2 mb-2 flex-wrap">
                         {/* Lista de Opções Atualizada */}
                         {['WhatsApp', 'Ligação', 'Site', 'Email', 'Presencial', 'Interno'].map(t => (
                             <button 
                                key={t} 
                                type="button"
                                onClick={() => setTipo(t)}
                                className={`px-3 py-1 rounded-full text-[10px] font-bold border transition-colors ${tipo === t ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-400'}`}
                             >
                                {t}
                             </button>
                         ))}
                    </div>
                    <div className="flex gap-2">
                        <input 
                            value={mensagem} 
                            onChange={e => setMensagem(e.target.value)} 
                            placeholder="Descreva a interação ou observação..." 
                            className="flex-1 h-10 px-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 text-sm"
                            autoFocus
                        />
                        <button 
                            type="submit" 
                            disabled={isSaving || !mensagem.trim()} 
                            className="h-10 w-12 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isSaving ? <Loader2 className="h-5 w-5 animate-spin"/> : <Send className="h-5 w-5"/>}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\EmployeeAuthModal.tsx
==================================================
'use client'

import {
  useState,
  useEffect,
} from 'react'
import { useFormState, useFormStatus } from 'react-dom'
import { Loader2, X } from 'lucide-react'
import {
  autenticarFuncionarioPorPin,
  type AuthEmployeeResult,
} from '@/lib/actions/vendas.actions'
import { Database } from '@/lib/database.types'

type AuthedEmployee = Pick<
  Database['public']['Tables']['employees']['Row'],
  'id' | 'full_name' | 'role'
>

type EmployeeAuthModalProps = {
  storeId: number
  isOpen: boolean
  onClose: () => void
  onSuccess: (employee: AuthedEmployee) => void
  title?: string
  description?: string
}

function SubmitButton() {
  const { pending } = useFormStatus()
  return (
    <button
      type="submit"
      disabled={pending}
      className="flex w-full justify-center rounded-md border border-transparent bg-blue-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:bg-blue-400"
    >
      {pending ? (
        <Loader2 className="h-5 w-5 animate-spin mx-auto" />
      ) : (
        'Login'
      )}
    </button>
  )
}

export default function EmployeeAuthModal({
  storeId,
  isOpen,
  onClose,
  onSuccess,
  title = 'Autenticação de Funcionário',
  description = 'Por favor, insira seu PIN para continuar.',
}: EmployeeAuthModalProps) {
  
  const initialState: AuthEmployeeResult = { success: false, message: '' }
  const [state, dispatch] = useFormState(autenticarFuncionarioPorPin, initialState)
  
  const [pin, setPin] = useState('')

  useEffect(() => {
    if (state.success && state.employee) {
      onSuccess(state.employee) 
      onClose()
      setPin('')
    }
  }, [state, onSuccess, onClose])

  // LÓGICA DE KEYDOWN REMOVIDA: O formulário HTML já lida com o Enter nativamente

  if (!isOpen) return null

  const inputStyle = 'block w-full rounded-md border-gray-400 shadow-sm text-gray-900 h-10 text-lg text-center bg-white disabled:bg-gray-100'
  const labelStyle = 'text-sm font-medium text-gray-700'

  return (
    <div
      className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-70"
      onClick={onClose}
    >
      <div
        className="relative w-full max-w-sm p-6 bg-gray-200 rounded-lg shadow-lg"
        onClick={(e) => e.stopPropagation()}
      >
        <button
          onClick={onClose}
          className="absolute top-2 right-2 p-1 text-gray-500 hover:text-gray-800"
          title="Fechar"
        >
          <X className="h-5 w-5" />
        </button>

        <h2 className="text-xl font-bold text-gray-800 text-center mb-4">
          {title}
        </h2>
        <p className="text-sm text-gray-600 mb-4 text-center">{description}</p>

        <form action={dispatch} className="space-y-4">
          <input type="hidden" name="store_id" value={storeId} />
          
          <div>
            <label htmlFor="auth_pin" className={labelStyle}>
              Senha (PIN)
            </label>
            <input
              id="auth_pin"
              name="pin"
              type="password"
              value={pin}
              onChange={(e) => setPin(e.target.value)}
              // onKeyDown removido daqui
              className={inputStyle}
              required
              autoFocus
              maxLength={6}
              autoComplete="off"
            />
          </div>
          
          {state.message && !state.success && (
             <p className="text-sm text-red-600 text-center font-bold bg-red-100 p-2 rounded">{state.message}</p>
          )}

          <SubmitButton />
        </form>
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\modals\EntregaModal.tsx
==================================================
// ARQUIVO: src/components/modals/EntregaModal.tsx
'use client'

import { useState, useEffect, useTransition } from 'react'
import { useRouter } from 'next/navigation'
import { Search, X, Loader2, Save, Truck, User, AlertCircle } from 'lucide-react'
import { searchOSForLab, updateLabTracking, getEmployees, LabOSResult, EmployeeSimple } from '@/lib/actions/lab.actions'

interface Props {
    isOpen: boolean
    onClose: () => void
    storeId: number
}

export default function EntregaModal({ isOpen, onClose, storeId }: Props) {
    const router = useRouter()
    const [step, setStep] = useState<'search' | 'edit'>('search')
    const [query, setQuery] = useState('')
    const [results, setResults] = useState<LabOSResult[]>([])
    // Estado para controlar se a busca já foi feita (para exibir "Nenhum resultado" só na hora certa)
    const [hasSearched, setHasSearched] = useState(false) 
    
    const [selectedOS, setSelectedOS] = useState<LabOSResult | null>(null)
    const [employees, setEmployees] = useState<EmployeeSimple[]>([])
    const [isPending, startTransition] = useTransition()

    // Reseta tudo quando o modal abre/fecha
    useEffect(() => {
        if (isOpen) {
            getEmployees(storeId).then(setEmployees)
            setStep('search')
            setQuery('')
            setResults([])
            setHasSearched(false) // Reset
            setSelectedOS(null)
        }
    }, [isOpen, storeId])

    if (!isOpen) return null

    const handleSearch = async (e: React.FormEvent) => {
        e.preventDefault() // Impede reload da página
        if (!query.trim()) return
        
        // Limpa resultados anteriores antes de buscar
        setResults([])
        setHasSearched(false)

        startTransition(async () => {
            const data = await searchOSForLab(storeId, query)
            setResults(data)
            setHasSearched(true) // Marca que a busca terminou
        })
    }

    const handleSelect = (os: LabOSResult) => {
        if (os.status === 'Em Aberto') {
            onClose()
            if (os.venda_id) {
                router.push(`/dashboard/loja/${storeId}/vendas/${os.venda_id}`)
            } else {
                router.push(`/dashboard/loja/${storeId}/vendas`)
            }
            return
        }

        setSelectedOS(os)
        setStep('edit')
    }

    const handleSave = async (formData: FormData) => {
        if (!selectedOS) return
        startTransition(async () => {
            const res = await updateLabTracking(selectedOS.id, storeId, formData)
            if (res.success) {
                onClose()
            } else {
                alert("Erro ao salvar.")
            }
        })
    }

    const formatForInput = (isoString: string | null) => {
        if (!isoString) return ''
        return new Date(isoString).toISOString().slice(0, 16)
    }

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in">
            <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                
                <div className="bg-emerald-700 p-4 flex justify-between items-center text-white shrink-0">
                    <div className="flex items-center gap-2">
                        <Truck className="h-5 w-5 text-emerald-300" />
                        <h2 className="font-bold text-lg">
                            {step === 'search' ? 'Entrega de Óculos' : `Entregar OS #${selectedOS?.id}`}
                        </h2>
                    </div>
                    <button onClick={onClose} className="text-emerald-200 hover:text-white transition-colors">
                        <X className="h-6 w-6" />
                    </button>
                </div>

                {step === 'search' && (
                    <div className="p-6 flex-1 overflow-y-auto">
                        <form onSubmit={handleSearch} className="flex gap-2 mb-6">
                            <input 
                                autoFocus
                                type="text" 
                                placeholder="Nº OS, Nome Cliente ou Dependente..." 
                                className="flex-1 border-2 border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:border-emerald-500 focus:outline-none"
                                value={query}
                                onChange={e => setQuery(e.target.value)}
                            />
                            {/* type="submit" garante que o Enter funcione e chame handleSearch */}
                            <button type="submit" disabled={isPending} className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 rounded-xl font-bold transition-colors flex items-center gap-2">
                                {isPending ? <Loader2 className="h-5 w-5 animate-spin"/> : <Search className="h-5 w-5"/>}
                                Buscar
                            </button>
                        </form>

                        <div className="space-y-2">
                            {results.map(os => (
                                <button 
                                    key={os.id}
                                    onClick={() => handleSelect(os)}
                                    className="w-full text-left p-4 rounded-xl border border-slate-100 hover:border-emerald-200 hover:bg-emerald-50 transition-all group relative overflow-hidden"
                                >
                                    {os.status === 'Em Aberto' && (
                                        <div className="absolute right-0 top-0 bottom-0 w-1.5 bg-yellow-400" />
                                    )}

                                    <div className="flex justify-between items-center mb-1">
                                        <span className="font-black text-slate-700 text-lg group-hover:text-emerald-800">OS #{os.id}</span>
                                        <span className={`text-[10px] font-black uppercase tracking-wider px-2 py-1 rounded flex items-center gap-1 ${
                                            os.status === 'Fechada' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                        }`}>
                                            {os.status === 'Em Aberto' && <AlertCircle className="h-3 w-3" />}
                                            {os.status}
                                        </span>
                                    </div>
                                    <div className="flex flex-col gap-1 text-slate-500 text-sm">
                                        <div className="flex items-center gap-2">
                                            <User className="h-4 w-4" />
                                            <span className="font-bold">{os.customer_name}</span>
                                        </div>
                                        {os.dependente_name && (
                                            <div className="flex items-center gap-2 pl-6 text-xs text-emerald-600 font-medium">
                                                <span>↳ Dep: {os.dependente_name}</span>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="mt-2 text-[10px] font-bold uppercase tracking-wide text-slate-400">
                                        {os.status === 'Em Aberto' 
                                            ? 'Ir para pagamento →' 
                                            : 'Realizar entrega →'}
                                    </div>
                                </button>
                            ))}
                            
                            {/* Só exibe mensagem se JÁ buscou e não achou nada */}
                            {hasSearched && results.length === 0 && !isPending && (
                                <p className="text-center text-slate-400 py-8 font-medium">
                                    Nenhuma OS encontrada para "{query}".
                                </p>
                            )}
                        </div>
                    </div>
                )}

                {step === 'edit' && selectedOS && (
                    <form action={handleSave} className="flex flex-col h-full">
                        <div className="p-6 bg-slate-50 flex-1 overflow-y-auto">
                            
                            <div className="bg-emerald-600 rounded-xl p-5 shadow-lg text-white">
                                <h3 className="flex items-center gap-2 text-xs font-black uppercase tracking-widest mb-4 opacity-90 border-b border-emerald-400/50 pb-2">
                                    <Truck className="h-4 w-4" /> Confirmar Entrega
                                </h3>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 opacity-70 hover:opacity-100 transition-opacity">
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Pedido Em</label>
                                        <input type="datetime-local" name="dt_pedido_em" defaultValue={formatForInput(selectedOS.dt_pedido_em)} className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm outline-none" />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Pedido Por</label>
                                        <div className="relative text-slate-800">
                                            <User className="absolute left-2.5 top-2.5 h-4 w-4 text-slate-400 z-10" />
                                            <select name="lab_pedido_por_id" defaultValue={selectedOS.lab_pedido_por_id || ''} className="w-full rounded-lg pl-9 pr-3 py-2 text-xs font-bold bg-white text-slate-800 shadow-sm outline-none appearance-none cursor-pointer">
                                                <option value="">Selecione...</option>
                                                {employees.map(emp => (<option key={emp.id} value={emp.id}>{emp.name}</option>))}
                                            </select>
                                        </div>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Laboratório</label>
                                        <input type="text" name="lab_nome" defaultValue={selectedOS.lab_nome || ''} className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm outline-none" />
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="space-y-1 opacity-70 hover:opacity-100">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Lente Chegou</label>
                                        <input type="datetime-local" name="dt_lente_chegou" defaultValue={formatForInput(selectedOS.dt_lente_chegou)} className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm outline-none" />
                                    </div>
                                    <div className="space-y-1 opacity-70 hover:opacity-100">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Montado Em</label>
                                        <input type="datetime-local" name="dt_montado_em" defaultValue={formatForInput(selectedOS.dt_montado_em)} className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm outline-none" />
                                    </div>

                                    <div className="space-y-1 scale-105 origin-left">
                                        <label className="text-[10px] font-bold uppercase text-white bg-emerald-800 px-2 py-0.5 rounded-full inline-block mb-1 shadow-sm">
                                            Entregue Cliente (Hoje)
                                        </label>
                                        <input 
                                            type="datetime-local" 
                                            name="dt_entregue_em"
                                            defaultValue={formatForInput(selectedOS.dt_entregue_em) || formatForInput(new Date().toISOString())}
                                            className="w-full rounded-lg px-3 py-2 text-sm font-black text-slate-800 shadow-lg ring-4 ring-emerald-400/30 focus:ring-emerald-300 outline-none" 
                                            autoFocus
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                            <button type="button" onClick={() => setStep('search')} className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded-lg transition-colors">Voltar</button>
                            <button disabled={isPending} className="px-6 py-2 bg-emerald-700 hover:bg-emerald-800 text-white font-bold rounded-lg shadow-lg flex items-center gap-2 transition-colors">
                                {isPending ? <Loader2 className="h-4 w-4 animate-spin"/> : <Save className="h-4 w-4" />}
                                Confirmar Entrega
                            </button>
                        </div>
                    </form>
                )}
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\LabTrackingModal.tsx
==================================================
'use client'

import { useState, useEffect, useTransition } from 'react'
import { Search, X, Loader2, Save, Truck, User, Microscope } from 'lucide-react'
import { searchOSForLab, updateLabTracking, getEmployees, LabOSResult, EmployeeSimple } from '@/lib/actions/lab.actions'

interface Props {
    isOpen: boolean
    onClose: () => void
    storeId: number
}

export default function LabTrackingModal({ isOpen, onClose, storeId }: Props) {
    const [step, setStep] = useState<'search' | 'edit'>('search')
    const [query, setQuery] = useState('')
    const [results, setResults] = useState<LabOSResult[]>([])
    const [selectedOS, setSelectedOS] = useState<LabOSResult | null>(null)
    const [employees, setEmployees] = useState<EmployeeSimple[]>([]) // Lista de Funcionários
    const [isPending, startTransition] = useTransition()

    // Carrega funcionários ao abrir o modal
    useEffect(() => {
        if (isOpen) {
            getEmployees(storeId).then(setEmployees)
        }
    }, [isOpen, storeId])

    if (!isOpen) return null

    const handleSearch = async (e: React.FormEvent) => {
        e.preventDefault()
        if (!query.trim()) return
        startTransition(async () => {
            const data = await searchOSForLab(storeId, query)
            setResults(data)
        })
    }

    const handleSelect = (os: LabOSResult) => {
        setSelectedOS(os)
        setStep('edit')
    }

    const handleSave = async (formData: FormData) => {
        if (!selectedOS) return
        startTransition(async () => {
            const res = await updateLabTracking(selectedOS.id, storeId, formData)
            if (res.success) {
                onClose()
                setStep('search')
                setQuery('')
                setResults([])
                setSelectedOS(null)
            } else {
                alert("Erro ao salvar.")
            }
        })
    }

    const formatForInput = (isoString: string | null) => {
        if (!isoString) return ''
        return new Date(isoString).toISOString().slice(0, 16)
    }

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in">
            <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                
                {/* HEADER */}
                <div className="bg-slate-800 p-4 flex justify-between items-center text-white shrink-0">
                    <div className="flex items-center gap-2">
                        <Truck className="h-5 w-5 text-orange-400" />
                        <h2 className="font-bold text-lg">
                            {step === 'search' ? 'Rastrear Lentes' : `OS #${selectedOS?.id}`}
                        </h2>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                        <X className="h-6 w-6" />
                    </button>
                </div>

                {/* PASSO 1: BUSCA */}
                {step === 'search' && (
                    <div className="p-6 flex-1 overflow-y-auto">
                        <form onSubmit={handleSearch} className="flex gap-2 mb-6">
                            <input 
                                autoFocus
                                type="text" 
                                placeholder="Nº OS, Nome Cliente ou Dependente..." 
                                className="flex-1 border-2 border-slate-200 rounded-xl px-4 py-3 font-bold text-slate-700 focus:border-orange-500 focus:outline-none"
                                value={query}
                                onChange={e => setQuery(e.target.value)}
                            />
                            <button disabled={isPending} className="bg-orange-500 hover:bg-orange-600 text-white px-6 rounded-xl font-bold transition-colors flex items-center gap-2">
                                {isPending ? <Loader2 className="h-5 w-5 animate-spin"/> : <Search className="h-5 w-5"/>}
                                Buscar
                            </button>
                        </form>

                        <div className="space-y-2">
                            {results.map(os => (
                                <button 
                                    key={os.id}
                                    onClick={() => handleSelect(os)}
                                    className="w-full text-left p-4 rounded-xl border border-slate-100 hover:border-orange-200 hover:bg-orange-50 transition-all group"
                                >
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="font-black text-slate-700 text-lg group-hover:text-orange-700">OS #{os.id}</span>
                                        <span className={`text-[10px] font-black uppercase tracking-wider px-2 py-1 rounded ${
                                            os.status === 'Fechada' ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'
                                        }`}>
                                            {os.status}
                                        </span>
                                    </div>
                                    <div className="flex flex-col gap-1 text-slate-500 text-sm">
                                        <div className="flex items-center gap-2">
                                            <User className="h-4 w-4" />
                                            <span className="font-bold">{os.customer_name}</span>
                                        </div>
                                        {os.dependente_name && (
                                            <div className="flex items-center gap-2 pl-6 text-xs text-orange-600 font-medium">
                                                <span>↳ Dep: {os.dependente_name}</span>
                                            </div>
                                        )}
                                    </div>
                                </button>
                            ))}
                            {query && results.length === 0 && !isPending && (
                                <p className="text-center text-slate-400 py-8">Nenhuma OS encontrada com estes dados.</p>
                            )}
                        </div>
                    </div>
                )}

                {/* PASSO 2: EDIÇÃO */}
                {step === 'edit' && selectedOS && (
                    <form action={handleSave} className="flex flex-col h-full">
                        <div className="p-6 bg-slate-50 flex-1 overflow-y-auto">
                            
                            <div className="bg-orange-500 rounded-xl p-5 shadow-lg text-white">
                                <h3 className="flex items-center gap-2 text-xs font-black uppercase tracking-widest mb-4 opacity-90 border-b border-orange-400/50 pb-2">
                                    <Truck className="h-4 w-4" /> Atualizar Status
                                </h3>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    {/* PEDIDO EM */}
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Pedido Em</label>
                                        <input 
                                            type="datetime-local" 
                                            name="dt_pedido_em"
                                            defaultValue={formatForInput(selectedOS.dt_pedido_em)}
                                            className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm focus:ring-2 focus:ring-orange-300 outline-none" 
                                        />
                                    </div>

                                    {/* PEDIDO POR (AGORA É UM SELECT) */}
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Pedido Por</label>
                                        <div className="relative text-slate-800">
                                            <User className="absolute left-2.5 top-2.5 h-4 w-4 text-slate-400 z-10" />
                                            <select 
                                                name="lab_pedido_por_id"
                                                defaultValue={selectedOS.lab_pedido_por_id || ''}
                                                className="w-full rounded-lg pl-9 pr-3 py-2 text-xs font-bold bg-white text-slate-800 shadow-sm focus:ring-2 focus:ring-orange-300 outline-none appearance-none cursor-pointer"
                                            >
                                                <option value="">Selecione...</option>
                                                {employees.map(emp => (
                                                    <option key={emp.id} value={emp.id}>
                                                        {emp.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    {/* LABORATÓRIO */}
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Laboratório</label>
                                        <div className="relative text-slate-800">
                                            <Microscope className="absolute left-2.5 top-2 h-4 w-4 text-slate-400" />
                                            <input 
                                                type="text" 
                                                name="lab_nome"
                                                placeholder="Ex: Hoya"
                                                defaultValue={selectedOS.lab_nome || ''}
                                                className="w-full rounded-lg pl-9 pr-3 py-2 text-xs font-bold shadow-sm focus:ring-2 focus:ring-orange-300 outline-none" 
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Lente Chegou</label>
                                        <input 
                                            type="datetime-local" 
                                            name="dt_lente_chegou"
                                            defaultValue={formatForInput(selectedOS.dt_lente_chegou)}
                                            className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm focus:ring-2 focus:ring-orange-300 outline-none" 
                                        />
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Montado Em</label>
                                        <input 
                                            type="datetime-local" 
                                            name="dt_montado_em"
                                            defaultValue={formatForInput(selectedOS.dt_montado_em)}
                                            className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm focus:ring-2 focus:ring-orange-300 outline-none" 
                                        />
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-[10px] font-bold uppercase opacity-80">Entregue Cliente</label>
                                        <input 
                                            type="datetime-local" 
                                            name="dt_entregue_em"
                                            defaultValue={formatForInput(selectedOS.dt_entregue_em)}
                                            className="w-full rounded-lg px-3 py-2 text-xs font-bold text-slate-800 shadow-sm focus:ring-2 focus:ring-orange-300 outline-none" 
                                        />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                            <button 
                                type="button"
                                onClick={() => setStep('search')}
                                className="px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded-lg transition-colors"
                            >
                                Voltar
                            </button>
                            <button 
                                disabled={isPending}
                                className="px-6 py-2 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-lg shadow-lg flex items-center gap-2 transition-colors"
                            >
                                {isPending ? <Loader2 className="h-4 w-4 animate-spin"/> : <Save className="h-4 w-4" />}
                                Salvar
                            </button>
                        </div>
                    </form>
                )}
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\NewAssistanceModal.tsx
==================================================
'use client'

import { useState, useTransition } from 'react'
import { createAssistanceTicket } from '@/lib/actions/assistance.actions'
import { searchCustomersByName, getItensCompradosPorCliente, type CustomerSearchResult, type ItemComprado } from '@/lib/actions/vendas.actions'
import { Search, ArrowRight, Phone, Package, AlertTriangle, CheckCircle2, Loader2, X, ShoppingBag, PlusCircle, History } from 'lucide-react'

// Helper de Moeda
const currency = (v: number) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const date = (d: string) => new Date(d).toLocaleDateString('pt-BR')

export default function NewAssistanceModal({ 
    isOpen, 
    onClose, 
    storeId, 
    onSuccess // Novo Prop para atualizar o Kanban sem F5
}: { 
    isOpen: boolean, 
    onClose: () => void, 
    storeId: number, 
    onSuccess: (ticket: any) => void 
}) {
  const [step, setStep] = useState(1)
  
  // Passo 1: Busca
  const [query, setQuery] = useState('')
  const [customers, setCustomers] = useState<CustomerSearchResult[]>([])
  const [selectedCustomer, setSelectedCustomer] = useState<CustomerSearchResult | null>(null)
  
  // Passo 2: Telefone
  const [confirmedPhone, setConfirmedPhone] = useState('')
  
  // Passo 3: Produto (Lista de Compras)
  const [purchasedItems, setPurchasedItems] = useState<ItemComprado[]>([])
  const [selectedProduct, setSelectedProduct] = useState<ItemComprado | null>(null)
  const [isManualProduct, setIsManualProduct] = useState(false)
  const [productDesc, setProductDesc] = useState('')
  
  // Passo 4: Detalhes
  const [defeito, setDefeito] = useState('')
  const [modalidade, setModalidade] = useState<'Padrao' | 'TrocaGarantida' | 'TrocaImediata'>('Padrao')
  
  const [isPending, startTransition] = useTransition()
  const [loadingItems, setLoadingItems] = useState(false)

  if (!isOpen) return null

  // 1. Busca Cliente
  const handleSearch = async (e: React.FormEvent) => {
    e.preventDefault()
    if (query.length < 3) return
    const res = await searchCustomersByName(query, storeId)
    if (res.success && res.data) setCustomers(res.data)
  }

  // 2. Seleciona Cliente e Busca Compras
  const handleSelectCustomer = async (c: CustomerSearchResult) => {
      setSelectedCustomer(c)
      setConfirmedPhone(c.fone_movel || '')
      setStep(2)
      
      // Já dispara a busca dos itens em background
      setLoadingItems(true)
      const itens = await getItensCompradosPorCliente(storeId, c.id)
      setPurchasedItems(itens)
      setLoadingItems(false)
  }

  const handlePhoneConfirm = () => {
      if (confirmedPhone.length < 10) return alert("Telefone inválido.")
      setStep(3) 
  }

  const handleSelectPurchasedItem = (item: ItemComprado) => {
      setSelectedProduct(item)
      setProductDesc(item.descricao) // Preenche auto
      setIsManualProduct(false)
      setStep(4)
  }

  const handleManualProduct = () => {
      setSelectedProduct(null)
      setProductDesc('')
      setIsManualProduct(true)
      // Não avança direto, deixa o usuário digitar no mesmo passo ou num sub-passo. 
      // Para simplificar, vou manter no passo 3 um campo que aparece se for manual.
  }

  const handleManualContinue = () => {
      if (!productDesc.trim()) return alert("Digite o nome do produto.")
      setStep(4)
  }

  const handleSubmit = () => {
      if (!selectedCustomer) return
      if (!defeito) return alert("Descreva o defeito.")

      const formData = new FormData()
      formData.append('store_id', storeId.toString())
      formData.append('customer_id', selectedCustomer.id.toString())
      formData.append('updated_phone', confirmedPhone)
      formData.append('product_descricao', productDesc)
      formData.append('descricao_defeito', defeito)
      formData.append('modalidade', modalidade)
      
      // Vínculos
      if (selectedProduct) {
          formData.append('product_id', selectedProduct.product_id ? selectedProduct.product_id.toString() : '')
          formData.append('venda_original_id', selectedProduct.venda_id.toString())
      }
      
      startTransition(async () => {
          const res = await createAssistanceTicket(formData)
          if (res.success && res.ticket) {
              onSuccess(res.ticket) // Atualiza Kanban
              onClose()
              // Reset Full
              setStep(1); setQuery(''); setCustomers([]); setSelectedCustomer(null); setPurchasedItems([]); setSelectedProduct(null);
          } else {
              alert(res.message)
          }
      })
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in">
       <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
          
          <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
             <h3 className="font-bold text-slate-800">Nova Assistência (Passo {step}/4)</h3>
             <button onClick={onClose}><X className="h-5 w-5 text-slate-400"/></button>
          </div>

          <div className="p-6 overflow-y-auto">
             
             {/* PASSO 1: BUSCA CLIENTE */}
             {step === 1 && (
                <div className="space-y-4">
                    <form onSubmit={handleSearch} className="relative">
                        <input value={query} onChange={e => setQuery(e.target.value)} placeholder="Nome ou CPF..." className="w-full h-12 pl-10 rounded-xl border border-slate-300 font-bold" autoFocus />
                        <Search className="absolute left-3 top-3.5 h-5 w-5 text-slate-400" />
                    </form>
                    <div className="space-y-2">
                        {customers.map(c => (
                            <button key={c.id} onClick={() => handleSelectCustomer(c)} className="w-full text-left p-3 rounded-lg hover:bg-blue-50 border border-slate-100 flex justify-between items-center group">
                                <span className="font-bold text-slate-700">{c.full_name}</span>
                                <ArrowRight className="h-4 w-4 text-slate-300 group-hover:text-blue-500" />
                            </button>
                        ))}
                    </div>
                </div>
             )}

             {/* PASSO 2: TELEFONE */}
             {step === 2 && selectedCustomer && (
                 <div className="text-center space-y-6 animate-in slide-in-from-right-4">
                     <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto text-blue-600">
                         <Phone className="h-8 w-8" />
                     </div>
                     <div>
                         <h3 className="text-xl font-bold text-slate-800">Confirmação de Contato</h3>
                         <p className="text-sm text-slate-500 mt-1">Para envio do link de rastreio.</p>
                     </div>
                     <input 
                        value={confirmedPhone} 
                        onChange={e => setConfirmedPhone(e.target.value)} 
                        className="w-full text-center text-2xl font-black tracking-widest h-14 rounded-xl border-2 border-blue-200 focus:border-blue-500 text-slate-800"
                     />
                     <button onClick={handlePhoneConfirm} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg">
                         Confirmar
                     </button>
                 </div>
             )}

             {/* PASSO 3: SELEÇÃO DE PRODUTO */}
             {step === 3 && (
                 <div className="space-y-4 animate-in slide-in-from-right-4">
                     <h3 className="font-bold text-slate-700 text-sm uppercase tracking-wide">Qual o produto?</h3>
                     
                     {/* Opção Manual */}
                     {isManualProduct ? (
                         <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                             <label className="text-xs font-bold text-slate-500 uppercase">Descrição do Item</label>
                             <input value={productDesc} onChange={e => setProductDesc(e.target.value)} className="w-full h-10 rounded-lg border-slate-300 font-bold" placeholder="Ex: Rayban antigo do cliente" autoFocus />
                             <div className="flex gap-2">
                                <button onClick={() => setIsManualProduct(false)} className="flex-1 py-2 text-slate-500 font-bold text-xs hover:bg-slate-200 rounded-lg">Cancelar</button>
                                <button onClick={handleManualContinue} className="flex-1 py-2 bg-slate-800 text-white font-bold text-xs rounded-lg hover:bg-slate-900">Continuar</button>
                             </div>
                         </div>
                     ) : (
                         <>
                            <button onClick={handleManualProduct} className="w-full p-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 hover:border-slate-400 hover:bg-slate-50 font-bold text-sm flex items-center justify-center gap-2">
                                <PlusCircle className="h-5 w-5" /> Produto Não Cadastrado / Externo
                            </button>

                            <div className="border-t border-slate-100 my-2"></div>
                            
                            <p className="text-xs font-bold text-slate-400 uppercase">Histórico de Compras</p>
                            
                            {loadingItems ? <div className="text-center py-4"><Loader2 className="h-6 w-6 animate-spin mx-auto text-blue-500"/></div> : 
                             purchasedItems.length === 0 ? <p className="text-center text-sm text-slate-400 py-4">Nenhuma compra recente encontrada.</p> :
                             <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                                {purchasedItems.map(item => (
                                    <button key={item.venda_item_id} onClick={() => handleSelectPurchasedItem(item)} className="w-full text-left p-3 rounded-xl border border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition-all group">
                                        <div className="flex justify-between items-start">
                                            <span className="font-bold text-slate-700 text-sm group-hover:text-blue-700 line-clamp-1">{item.descricao}</span>
                                            <span className="text-xs font-mono text-slate-400">{date(item.data_venda)}</span>
                                        </div>
                                        <div className="flex justify-between items-center mt-1">
                                            <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-bold">Venda #{item.venda_id}</span>
                                            <span className="text-xs font-bold text-green-600">{currency(item.valor)}</span>
                                        </div>
                                    </button>
                                ))}
                             </div>
                            }
                         </>
                     )}
                 </div>
             )}

             {/* PASSO 4: DEFEITO E MODALIDADE */}
             {step === 4 && (
                 <div className="space-y-5 animate-in slide-in-from-right-4">
                     
                     <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <p className="text-xs font-bold text-blue-800 uppercase mb-1">Produto Selecionado</p>
                        <p className="text-sm font-bold text-blue-900">{productDesc}</p>
                     </div>

                     <div>
                         <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Defeito Relatado</label>
                         <textarea value={defeito} onChange={e => setDefeito(e.target.value)} placeholder="Descreva o problema..." className="w-full h-20 rounded-lg border border-slate-300 p-3 text-sm resize-none focus:ring-2 focus:ring-blue-500" autoFocus />
                     </div>

                     <div className="grid grid-cols-3 gap-2">
                         <button onClick={() => setModalidade('Padrao')} className={`p-3 rounded-xl border-2 text-center transition-all ${modalidade === 'Padrao' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 hover:border-blue-200'}`}>
                             <Package className="h-6 w-6 mx-auto mb-1"/>
                             <span className="block text-[10px] font-bold uppercase">Padrão</span>
                         </button>
                         <button onClick={() => setModalidade('TrocaGarantida')} className={`p-3 rounded-xl border-2 text-center transition-all ${modalidade === 'TrocaGarantida' ? 'border-purple-500 bg-purple-50 text-purple-700' : 'border-slate-200 hover:border-purple-200'}`}>
                             <History className="h-6 w-6 mx-auto mb-1"/>
                             <span className="block text-[10px] font-bold uppercase">Garantida</span>
                         </button>
                         <button onClick={() => setModalidade('TrocaImediata')} className={`p-3 rounded-xl border-2 text-center transition-all ${modalidade === 'TrocaImediata' ? 'border-orange-500 bg-orange-50 text-orange-700' : 'border-slate-200 hover:border-orange-200'}`}>
                             <AlertTriangle className="h-6 w-6 mx-auto mb-1"/>
                             <span className="block text-[10px] font-bold uppercase">Imediata</span>
                         </button>
                     </div>
                     
                     <p className="text-center text-xs text-slate-400">
                        {modalidade === 'Padrao' && 'Cliente deixa o produto para análise.'}
                        {modalidade === 'TrocaGarantida' && 'Cliente leva produto. Pedimos novo ao fornecedor.'}
                        {modalidade === 'TrocaImediata' && 'Baixa estoque da loja agora. Risco nosso.'}
                     </p>

                     <button onClick={handleSubmit} disabled={isPending} className="w-full py-4 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg flex justify-center items-center gap-2">
                         {isPending ? <Loader2 className="h-5 w-5 animate-spin"/> : 'ABRIR TICKET'}
                     </button>
                 </div>
             )}

          </div>
       </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\modals\NewBillModal.tsx
==================================================
'use client'

import { useRef, useEffect } from 'react'
import { useFormState, useFormStatus } from 'react-dom'
import { saveBill } from '@/lib/actions/payable.actions'
import { X, Save, Loader2, Calendar, DollarSign, Tag, FileText } from 'lucide-react'

function SubmitButton() {
    const { pending } = useFormStatus()
    return (
        <button disabled={pending} className="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-rose-200 disabled:opacity-50 transition-transform active:scale-95">
            {pending ? <Loader2 className="h-5 w-5 animate-spin" /> : <Save className="h-5 w-5" />}
            SALVAR CONTA
        </button>
    )
}

// --- DESIGN SYSTEM (ALTO CONTRASTE) ---
const labelStyle = "block text-[10px] font-bold text-slate-700 uppercase mb-1 tracking-wider"
const inputStyle = "block w-full rounded-lg border border-slate-300 bg-white shadow-sm text-slate-900 h-10 text-sm px-3 focus:ring-2 focus:ring-rose-500 focus:border-rose-500 font-bold placeholder:font-normal placeholder:text-slate-400 transition-all"

export default function NewBillModal({ isOpen, onClose, storeId }: { isOpen: boolean, onClose: () => void, storeId: number }) {
    const [state, dispatch] = useFormState(saveBill, { success: false, message: '' })
    const formRef = useRef<HTMLFormElement>(null)

    useEffect(() => {
        if (state.success) {
            onClose()
            formRef.current?.reset()
        } else if (state.message) {
            alert(state.message)
        }
    }, [state, onClose])

    if (!isOpen) return null

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                
                {/* Header Gradiente */}
                <div className="bg-gradient-to-r from-rose-600 to-red-700 px-6 py-4 border-b border-rose-800 flex justify-between items-center">
                    <h3 className="font-bold text-white flex items-center gap-2">
                        <FileText className="h-5 w-5" /> Nova Conta a Pagar
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full text-white transition-colors"><X className="h-5 w-5"/></button>
                </div>
                
                <form action={dispatch} ref={formRef} className="p-6 space-y-5 bg-slate-50">
                    <input type="hidden" name="store_id" value={storeId} />
                    
                    <div>
                        <label className={labelStyle}>Descrição / Histórico</label>
                        <input name="description" required placeholder="Ex: Aluguel, Boleto Hoya..." className={inputStyle} autoFocus />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className={labelStyle}>Valor (R$)</label>
                            <div className="relative">
                                <DollarSign className="absolute left-3 top-3 h-4 w-4 text-slate-400" />
                                <input name="amount" type="number" step="0.01" required className={`${inputStyle} pl-9 text-lg`} placeholder="0.00" />
                            </div>
                        </div>
                        <div>
                            <label className={labelStyle}>Vencimento</label>
                            <div className="relative">
                                <Calendar className="absolute left-3 top-3 h-4 w-4 text-slate-400" />
                                <input name="due_date" type="date" required className={`${inputStyle} pl-9`} />
                            </div>
                        </div>
                    </div>

                    <div>
                        <label className={labelStyle}>Categoria</label>
                        <div className="relative">
                            <Tag className="absolute left-3 top-3 h-4 w-4 text-slate-400" />
                            <select name="category" className={`${inputStyle} pl-9 cursor-pointer`}>
                                <option value="Fixa">Despesa Fixa (Aluguel, Luz)</option>
                                <option value="Fornecedor">Fornecedor / Produtos</option>
                                <option value="Pessoal">Pessoal / Salários</option>
                                <option value="Impostos">Impostos</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                    </div>

                    <div className="pt-2">
                        <SubmitButton />
                    </div>
                </form>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\ParcelaSearchModal.tsx
==================================================
'use client'

import { useState, useTransition, useRef, useEffect } from 'react'
import { X, Search, Calendar, Loader2, Wallet, ArrowLeft, User, ShoppingBag, CheckCircle2, AlertTriangle, ArrowDownCircle } from 'lucide-react'
import { searchPendenciasCliente, receberParcela } from '@/lib/actions/vendas.actions'
import EmployeeAuthModal from '@/components/modals/EmployeeAuthModal'

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (d: string) => new Date(d).toLocaleDateString('pt-BR', { timeZone: 'UTC' })
const getToday = () => new Date().toISOString().split('T')[0]

// Helper Robusto de Limpeza (Remove R$, espaços, pontos)
const parseMoney = (val: string) => {
    if (!val) return 0
    const clean = val.replace(/[^\d,]/g, '')
    return parseFloat(clean.replace(',', '.')) || 0
}

function ParcelaCard({ p, onClick }: { p: any, onClick: () => void }) {
    const isVencida = new Date(p.data_vencimento) < new Date(getToday())
    
    return (
        <button 
            onClick={onClick}
            className="w-full flex items-center justify-between p-3 bg-white border border-slate-100 rounded-lg hover:border-emerald-300 hover:shadow-md hover:bg-emerald-50/30 transition-all group text-left"
        >
            <div className="flex items-center gap-3">
                <div className={`p-2 rounded-lg ${isVencida ? 'bg-red-50 text-red-600' : 'bg-slate-100 text-slate-500'}`}>
                    <Calendar className="h-4 w-4" />
                </div>
                <div>
                    <p className="text-xs font-bold text-slate-600 uppercase">{p.numero_parcela}ª Parcela</p>
                    <p className={`text-xs font-medium ${isVencida ? 'text-red-600' : 'text-slate-400'}`}>
                        Vence: {formatDate(p.data_vencimento)}
                    </p>
                </div>
            </div>
            <div className="text-right">
                <span className="block text-emerald-700 font-black text-base">{formatCurrency(p.valor_parcela)}</span>
                <span className="text-[9px] font-bold text-emerald-600 opacity-0 group-hover:opacity-100 transition-opacity uppercase tracking-wide">
                    Pagar Agora
                </span>
            </div>
        </button>
    )
}

export default function ParcelaSearchModal({ isOpen, onClose, storeId }: { isOpen: boolean, onClose: () => void, storeId: number }) {
    const [step, setStep] = useState<'search' | 'details' | 'pay'>('search')
    const [query, setQuery] = useState('')
    const [results, setResults] = useState<any[]>([])
    const [isSearching, startSearch] = useTransition()
    
    // Dados Selecionados
    const [selectedClientData, setSelectedClientData] = useState<any>(null)
    const [selectedParcela, setSelectedParcela] = useState<any>(null)
    
    // Form Pagamento
    const [valorTotalPagoStr, setValorTotalPagoStr] = useState('') // O que entra no caixa
    const [valorJurosStr, setValorJurosStr] = useState('0,00')     // A parte que é juros
    const [forma, setForma] = useState('PIX')
    const [estrategia, setEstrategia] = useState('criar_pendencia')
    
    const [isAuthOpen, setIsAuthOpen] = useState(false)
    const [isProcessing, startProcess] = useTransition()
    const searchInputRef = useRef<HTMLInputElement>(null)

    useEffect(() => {
        if (isOpen) {
            setStep('search')
            setQuery('')
            setResults([])
            setTimeout(() => searchInputRef.current?.focus(), 100)
        }
    }, [isOpen])

    const handleSearch = (e: React.FormEvent) => {
        e.preventDefault()
        if (query.length < 3) return
        startSearch(async () => {
            const res = await searchPendenciasCliente(storeId, query)
            setResults(res as any[])
        })
    }

    const handleSelectClient = (clientData: any) => {
        setSelectedClientData(clientData)
        setStep('details')
    }

    const handleSelectParcela = (parcela: any) => {
        setSelectedParcela(parcela)
        
        // Valor Sugerido = Valor Original
        const valLimpo = formatCurrency(parcela.valor_parcela).replace(/[^\d,]/g, '')
        setValorTotalPagoStr(valLimpo)
        setValorJurosStr('0,00') 
        setEstrategia('criar_pendencia')
        setStep('pay')
    }

    const parcelasAgrupadas = selectedClientData ? selectedClientData.parcelas.reduce((acc: any, p: any) => {
        const key = p.venda_id
        if (!acc[key]) {
            acc[key] = { venda_id: key, data_venda: p.data_venda, beneficiario: p.beneficiario, itens: [] }
        }
        acc[key].itens.push(p)
        return acc
    }, {}) : {}

    const gruposVendas = Object.values(parcelasAgrupadas).sort((a: any, b: any) => 
        new Date(a.data_venda).getTime() - new Date(b.data_venda).getTime()
    )

    const handlePreConfirm = () => setIsAuthOpen(true)

    const handleAuthSuccess = (employee: { id: number }) => {
        setIsAuthOpen(false)
        if (!selectedParcela) return

        const valorOriginal = selectedParcela.valor_parcela
        const valorTotalPago = parseMoney(valorTotalPagoStr)
        const valorJuros = parseMoney(valorJurosStr)
        
        const formData = new FormData()
        formData.append('parcela_id', selectedParcela.id.toString())
        formData.append('venda_id', selectedParcela.venda_id.toString())
        formData.append('store_id', storeId.toString())
        formData.append('employee_id', employee.id.toString())
        
        formData.append('valor_original', valorOriginal.toString())
        formData.append('valor_pago_total', valorTotalPago.toString()) // Dinheiro recebido
        formData.append('valor_juros', valorJuros.toString())          // Juros declarados
        
        formData.append('forma_pagamento', forma)
        formData.append('data_pagamento', getToday())
        
        // Recalcula a diferença aqui para enviar a estratégia certa
        const principalAbatido = valorTotalPago - valorJuros
        const diferenca = valorOriginal - principalAbatido
        const isParcial = diferenca > 0.01

        formData.append('estrategia', isParcial ? estrategia : 'quitacao_total')

        startProcess(async () => {
            const res = await receberParcela(null, formData)
            if (res.success) {
                alert("Pagamento Recebido!")
                onClose()
            } else {
                alert(res.message)
            }
        })
    }

    if (!isOpen) return null

    return (
        <>
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4 animate-in fade-in">
            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
                
                {/* Header */}
                <div className="bg-emerald-600 px-6 py-4 flex justify-between items-center text-white shrink-0">
                    <div className="flex items-center gap-3">
                        {step !== 'search' && (
                            <button onClick={() => setStep(step === 'pay' ? 'details' : 'search')} className="p-1 hover:bg-white/20 rounded-full transition-colors">
                                <ArrowLeft className="h-5 w-5" />
                            </button>
                        )}
                        <h3 className="font-bold flex items-center gap-2 text-lg">
                            <Wallet className="h-5 w-5" /> 
                            {step === 'search' ? 'Recebimento' : step === 'details' ? 'Selecione a Parcela' : 'Confirmar Pagamento'}
                        </h3>
                    </div>
                    <button onClick={onClose} className="hover:bg-white/20 p-1.5 rounded-full transition-colors"><X className="h-5 w-5"/></button>
                </div>

                <div className="flex-1 overflow-y-auto p-0 bg-slate-50">
                    
                    {step === 'search' && (
                        <div className="p-6 space-y-6">
                            <form onSubmit={handleSearch} className="relative">
                                <input 
                                    ref={searchInputRef}
                                    value={query}
                                    onChange={e => setQuery(e.target.value)}
                                    placeholder="Nome do cliente..."
                                    className="w-full h-12 rounded-xl border-slate-300 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 font-bold text-slate-800 text-lg pl-12"
                                />
                                <Search className="absolute left-4 top-3.5 h-5 w-5 text-gray-400" />
                                <button type="submit" className="absolute right-2 top-2 bg-emerald-100 text-emerald-700 px-4 py-2 rounded-lg text-xs font-bold hover:bg-emerald-200 uppercase tracking-wide">
                                    {isSearching ? <Loader2 className="h-4 w-4 animate-spin"/> : 'Buscar'}
                                </button>
                            </form>
                            <div className="space-y-3">
                                {results.map((grupo: any) => (
                                    <button key={grupo.cliente.id} onClick={() => handleSelectClient(grupo)} className="w-full bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-emerald-400 hover:shadow-md transition-all text-left flex justify-between items-center group">
                                        <div>
                                            <p className="font-bold text-slate-800 text-lg group-hover:text-emerald-700 transition-colors">{grupo.cliente.full_name}</p>
                                            <p className="text-xs text-slate-500 font-mono mt-1">CPF: {grupo.cliente.cpf || 'Não informado'}</p>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-xs font-bold text-slate-400 uppercase">Total Pendente</span>
                                            <span className="block text-emerald-600 font-black text-lg">{formatCurrency(grupo.parcelas.reduce((acc: number, p: any) => acc + p.valor_parcela, 0))}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {step === 'details' && selectedClientData && (
                        <div className="p-4 space-y-6">
                            <div className="bg-emerald-50 border border-emerald-100 p-4 rounded-xl text-center">
                                <h2 className="text-xl font-black text-emerald-900">{selectedClientData.cliente.full_name}</h2>
                                <p className="text-xs text-emerald-700 mt-1 uppercase font-bold tracking-wide">Selecione uma parcela para pagar</p>
                            </div>
                            <div className="space-y-6">
                                {gruposVendas.map((grupo: any) => (
                                    <div key={grupo.venda_id} className="relative pl-4 border-l-2 border-slate-200">
                                        <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-300 border-4 border-slate-50"></div>
                                        <div className="mb-3">
                                            <p className="text-sm font-bold text-slate-800 flex items-center gap-2">
                                                <ShoppingBag className="h-4 w-4 text-slate-400" />
                                                Compra em {formatDate(grupo.data_venda)}
                                            </p>
                                            {grupo.beneficiario && <p className="text-xs text-blue-600 font-bold ml-6 mt-0.5 bg-blue-50 inline-block px-2 py-0.5 rounded">Para: {grupo.beneficiario}</p>}
                                        </div>
                                        <div className="space-y-2">
                                            {grupo.itens.sort((a: any, b: any) => a.numero_parcela - b.numero_parcela).map((p: any) => (
                                                <ParcelaCard key={p.id} p={p} onClick={() => handleSelectParcela(p)} />
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* ETAPA 3: PAGAMENTO (LÓGICA HÍBRIDA) */}
                    {step === 'pay' && selectedParcela && (
                        <div className="p-6 space-y-6 animate-in slide-in-from-right-4">
                            <div className="text-center pb-4 border-b border-slate-200">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Valor Original</p>
                                <p className="text-4xl font-black text-slate-800 tracking-tight">{formatCurrency(selectedParcela.valor_parcela)}</p>
                                <div className="flex justify-center gap-4 mt-2">
                                    <p className="text-sm text-slate-500">Parcela {selectedParcela.numero_parcela}</p>
                                    <p className={`text-sm font-bold ${new Date(selectedParcela.data_vencimento) < new Date(getToday()) ? 'text-red-600' : 'text-slate-500'}`}>
                                        Vencimento: {formatDate(selectedParcela.data_vencimento)}
                                    </p>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Total Recebido</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2.5 text-emerald-600 font-bold">R$</span>
                                        <input 
                                            type="text" 
                                            value={valorTotalPagoStr} 
                                            onChange={e => setValorTotalPagoStr(e.target.value)} 
                                            className="w-full h-11 rounded-lg border-slate-300 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 font-bold text-slate-800 pl-11 text-xl"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">Forma</label>
                                    <select value={forma} onChange={e => setForma(e.target.value)} className="w-full h-11 rounded-lg border-slate-300 shadow-sm focus:ring-emerald-500 focus:border-emerald-500 font-bold text-slate-800 cursor-pointer">
                                        <option>PIX</option><option>Dinheiro</option><option>Cartão Débito</option><option>Cartão Crédito</option>
                                    </select>
                                </div>
                            </div>

                            {/* Campo de Juros CONDICIONAL */}
                            {new Date(selectedParcela.data_vencimento) < new Date(getToday()) && (
                                <div className="bg-red-50 p-4 rounded-xl border border-red-200">
                                    <label className="block text-xs font-bold text-red-800 mb-1 uppercase flex items-center gap-2">
                                        <AlertTriangle className="h-3 w-3" /> Juros / Multa (Incluso no total)
                                    </label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-2.5 text-red-600 font-bold">R$</span>
                                        <input 
                                            type="text" 
                                            value={valorJurosStr} 
                                            onChange={e => setValorJurosStr(e.target.value)} 
                                            className="w-full h-10 rounded-lg border-red-300 bg-white shadow-sm focus:ring-red-500 focus:border-red-500 font-bold text-red-800 pl-11"
                                        />
                                    </div>
                                    <p className="text-[10px] text-red-600 mt-1">Este valor não abate a dívida.</p>
                                </div>
                            )}

                            {/* Lógica de Decisão (Falta ou Sobra) */}
                            {(() => {
                                const vOrig = selectedParcela.valor_parcela
                                const vTotal = parseMoney(valorTotalPagoStr)
                                const vJuros = parseMoney(valorJurosStr)
                                
                                const principalAbatido = vTotal - vJuros
                                const diferenca = vOrig - principalAbatido
                                
                                if (diferenca > 0.01) {
                                    return (
                                        <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 animate-in fade-in">
                                            <div className="flex items-center gap-2 text-amber-800 font-bold text-sm mb-3">
                                                <AlertTriangle className="h-4 w-4" /> Restam R$ {formatCurrency(diferenca)} da dívida
                                            </div>
                                            <div className="space-y-2">
                                                <label className="flex items-start gap-3 cursor-pointer p-2 rounded hover:bg-amber-100/50 transition-colors">
                                                    <input type="radio" name="strat" checked={estrategia === 'criar_pendencia'} onChange={() => setEstrategia('criar_pendencia')} className="mt-1 text-amber-600 focus:ring-amber-500" />
                                                    <div><span className="block text-sm font-bold text-gray-800">Manter como Pendência</span><span className="block text-xs text-gray-500">Cria nova parcela.</span></div>
                                                </label>
                                                <label className="flex items-start gap-3 cursor-pointer p-2 rounded hover:bg-amber-100/50 transition-colors">
                                                    <input type="radio" name="strat" checked={estrategia === 'somar_proxima'} onChange={() => setEstrategia('somar_proxima')} className="mt-1 text-amber-600 focus:ring-amber-500" />
                                                    <div><span className="block text-sm font-bold text-gray-800">Jogar para Próxima</span><span className="block text-xs text-gray-500">Soma na próxima parcela.</span></div>
                                                </label>
                                            </div>
                                        </div>
                                    )
                                } else if (diferenca < -0.01) {
                                    return (
                                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 animate-in fade-in">
                                            <div className="flex items-center gap-2 text-blue-800 font-bold text-sm">
                                                <ArrowDownCircle className="h-4 w-4" /> 
                                                <span>Amortização Extra: R$ {formatCurrency(Math.abs(diferenca))}</span>
                                            </div>
                                            <p className="text-xs text-blue-600 mt-2 pl-6">
                                                O valor excedente será <strong>descontado automaticamente</strong> da próxima parcela pendente.
                                            </p>
                                        </div>
                                    )
                                }
                                return null
                            })()}
                            
                            <button onClick={handlePreConfirm} disabled={isProcessing} className="w-full py-4 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 shadow-lg flex items-center justify-center gap-2 transition-transform active:scale-95">
                                {isProcessing ? <Loader2 className="h-6 w-6 animate-spin"/> : <CheckCircle2 className="h-6 w-6" />}
                                CONFIRMAR RECEBIMENTO
                            </button>
                        </div>
                    )}
                </div>
            </div>
        </div>

        {isAuthOpen && (
            <EmployeeAuthModal 
                storeId={storeId} 
                isOpen={isAuthOpen} 
                onClose={() => setIsAuthOpen(false)} 
                onSuccess={handleAuthSuccess} 
                title="Autorizar Pagamento" 
                description="Insira seu PIN para confirmar." 
            />
        )}
        </>
    )
}

==================================================
ARQUIVO: .\src\components\modals\PayBillModal.tsx
==================================================
'use client'

import { useEffect } from 'react'
import { useFormState, useFormStatus } from 'react-dom'
import { payBill } from '@/lib/actions/payable.actions'
import { X, CheckCircle2, Loader2, AlertTriangle, Wallet, Landmark } from 'lucide-react'
import { Database } from '@/lib/database.types'

type Bill = Database['public']['Tables']['accounts_payable']['Row']

// --- DESIGN SYSTEM ---
const labelStyle = "block text-[10px] font-bold text-slate-600 uppercase mb-1 tracking-wider"
const inputStyle = "block w-full rounded-lg border border-slate-300 bg-white shadow-sm text-slate-900 h-10 text-sm px-3 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-bold transition-all"

function SubmitPayButton() {
    const { pending } = useFormStatus()
    return (
        <button disabled={pending} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-emerald-200 disabled:opacity-50 transition-transform active:scale-95">
            {pending ? <Loader2 className="h-5 w-5 animate-spin" /> : <CheckCircle2 className="h-5 w-5" />}
            CONFIRMAR PAGAMENTO
        </button>
    )
}

export default function PayBillModal({ bill, onClose }: { bill: Bill, onClose: () => void }) {
    const [state, dispatch] = useFormState(payBill, { success: false, message: '' })

    useEffect(() => {
        if (state.success) onClose()
        else if (state.message) alert(state.message)
    }, [state, onClose])

    return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in duration-200">
            <div className="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                
                {/* Header Gradiente Verde (Sucesso/Baixa) */}
                <div className="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4 border-b border-emerald-700 flex justify-between items-center">
                    <h3 className="font-bold text-white flex items-center gap-2">
                        <CheckCircle2 className="h-5 w-5" /> Baixar Conta
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full text-white transition-colors"><X className="h-5 w-5"/></button>
                </div>

                <form action={dispatch} className="p-6 space-y-5 bg-slate-50">
                    <input type="hidden" name="bill_id" value={bill.id} />
                    
                    <div className="text-center mb-4">
                        <p className="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Pagando</p>
                        <p className="text-lg font-bold text-slate-800 line-clamp-1">{bill.description}</p>
                        <p className="text-3xl font-black text-emerald-600 mt-1 tracking-tight">
                            {bill.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                        </p>
                    </div>

                    <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                        <p className={labelStyle}>Origem do Dinheiro</p>
                        <div className="space-y-2 mt-2">
                            <label className="flex items-center gap-3 p-3 bg-slate-50 border border-slate-200 rounded-lg cursor-pointer hover:border-emerald-400 transition-all group">
                                <input type="radio" name="source" value="Caixa" required className="text-emerald-600 focus:ring-emerald-500 w-4 h-4" />
                                <div className="flex items-center gap-2 text-slate-700 font-bold text-sm group-hover:text-emerald-700">
                                    <Wallet className="h-4 w-4 text-slate-400 group-hover:text-emerald-500"/> Caixa da Loja (Gaveta)
                                </div>
                            </label>
                            
                            <label className="flex items-center gap-3 p-3 bg-slate-50 border border-slate-200 rounded-lg cursor-pointer hover:border-emerald-400 transition-all group">
                                <input type="radio" name="source" value="Banco" required className="text-emerald-600 focus:ring-emerald-500 w-4 h-4" />
                                <div className="flex items-center gap-2 text-slate-700 font-bold text-sm group-hover:text-emerald-700">
                                    <Landmark className="h-4 w-4 text-slate-400 group-hover:text-emerald-500"/> Banco / Boleto / Pix
                                </div>
                            </label>
                        </div>
                        <div className="mt-2 flex gap-1.5 text-[10px] text-amber-700 font-bold bg-amber-50 p-2 rounded border border-amber-100">
                            <AlertTriangle className="h-3 w-3 flex-shrink-0 mt-0.5" />
                            <span>Atenção: "Caixa" lança uma sangria automática no fechamento do dia.</span>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3">
                        <div>
                            <label className={labelStyle}>Valor Pago</label>
                            <input name="amount_paid" type="number" step="0.01" defaultValue={bill.amount} className={`${inputStyle} text-right`} />
                        </div>
                        <div>
                            <label className={labelStyle}>Data Pagto</label>
                            <input name="payment_date" type="date" defaultValue={new Date().toISOString().split('T')[0]} className={inputStyle} />
                        </div>
                    </div>

                    <SubmitPayButton />
                </form>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\PaymentModal.tsx
==================================================
'use client'

import { useState, useTransition } from 'react'
import { X, CheckCircle, Printer, Plus, CreditCard, FileText, Loader2, Search } from 'lucide-react'
import FinanciamentoBox from '@/components/vendas/FinanciamentoBox'
import EmployeeAuthModal from '@/components/modals/EmployeeAuthModal' // <--- 1. Importação do Modal de Auth
import { 
    finalizarVendaExpress, 
    criarVendaParcialCarnê,
    searchCustomersByName, 
    type CustomerSearchResult 
} from '@/lib/actions/vendas.actions'
import { type CartItem } from '@/components/vendas/PdvExpressInterface'
import { Database } from '@/lib/database.types'

// Tipo para o funcionário autenticado
type Employee = Database['public']['Tables']['employees']['Row']

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const getToday = () => new Date().toISOString().split('T')[0]

interface PaymentModalProps {
    isOpen: boolean
    onClose: () => void
    onReset: () => void
    storeId: number
    employeeId: number // ID vindo da seleção anterior (pode ser sobrescrito pela auth)
    valorTotal: number
    cartItems: CartItem[]
}

export default function PaymentModal({
    isOpen,
    onClose,
    onReset,
    storeId,
    employeeId,
    valorTotal,
    cartItems
}: PaymentModalProps) {
    
    const [activeTab, setActiveTab] = useState<'pagamento' | 'carne'>('pagamento')
    const [isCompleted, setIsCompleted] = useState(false)
    const [vendaIdGerada, setVendaIdGerada] = useState<number | null>(null)
    
    // Estados do Pagamento
    const [valorPago, setValorPago] = useState(formatCurrency(valorTotal))
    const [formaPagamento, setFormaPagamento] = useState('PIX')
    const [parcelas, setParcelas] = useState(1)
    const [cpfNota, setCpfNota] = useState('')
    
    const [isProcessing, startProcess] = useTransition()
    const [isAuthOpen, setIsAuthOpen] = useState(false) // <--- 2. Estado do Modal de Auth

    // Estados do Carnê
    const [customerQuery, setCustomerQuery] = useState('')
    const [customersFound, setCustomersFound] = useState<CustomerSearchResult[]>([])
    const [selectedCustomer, setSelectedCustomer] = useState<CustomerSearchResult | null>(null)
    const [vendaParcialId, setVendaParcialId] = useState<number | null>(null) 

    // 3. Validação antes de abrir a senha
    const handlePrePayment = () => {
        const valorLimpo = valorPago.replace(/[^\d,]/g, '').replace(',', '.')
        const valorNumerico = parseFloat(valorLimpo) || 0

        if (valorNumerico <= 0) {
            alert("Valor inválido.")
            return
        }
        // Se passou na validação, abre a senha
        setIsAuthOpen(true)
    }

    // 4. Executa o pagamento APÓS a senha correta
    const handleAuthSuccess = (authedEmployee: Pick<Employee, 'id' | 'full_name'>) => {
        setIsAuthOpen(false)

        const valorLimpo = valorPago.replace(/[^\d,]/g, '').replace(',', '.')
        const valorNumerico = parseFloat(valorLimpo) || 0

        const formData = new FormData()
        formData.append('store_id', storeId.toString())
        
        // AQUI ESTÁ A LIGAÇÃO: Usamos o ID de quem digitou a senha [cite: 1502]
        formData.append('employee_id', authedEmployee.id.toString())
        
        formData.append('itens', JSON.stringify(cartItems))
        
        const pgtoData = {
            valor: valorNumerico,
            forma: formaPagamento,
            parcelas: parcelas,
            data: getToday()
        }
        formData.append('pagamento', JSON.stringify(pgtoData))
        if(cpfNota) formData.append('cpf_nota', cpfNota)

        startProcess(async () => {
            const res = await finalizarVendaExpress(formData)
            if (res.success) {
                setVendaIdGerada(res.vendaId!)
                setIsCompleted(true)
            } else {
                alert(res.message)
            }
        })
    }

    const handleSearchCustomer = async () => {
        if (customerQuery.length < 2) return
        const res = await searchCustomersByName(customerQuery, storeId)
        if (res.success && res.data) setCustomersFound(res.data)
    }

    const handleSelectCustomer = (cust: CustomerSearchResult) => {
        setSelectedCustomer(cust)
        startProcess(async () => {
            const formData = new FormData()
            formData.append('store_id', storeId.toString())
            formData.append('employee_id', employeeId.toString())
            formData.append('customer_id', cust.id.toString())
            formData.append('itens', JSON.stringify(cartItems))
            
            const res = await criarVendaParcialCarnê(formData)
            if (res.success) {
                setVendaParcialId(res.vendaId!)
            } else {
                alert("Erro: " + res.message)
                setSelectedCustomer(null)
            }
        })
    }

    if (!isOpen) return null

    // Estilos
    const labelStyle = 'block text-[10px] font-bold text-white/90 uppercase mb-1 tracking-wider'
    const inputStyle = 'block w-full rounded-lg border-0 bg-white shadow-sm text-gray-800 h-10 text-sm px-3 focus:ring-2 focus:ring-white/50 focus:outline-none font-bold transition-all'

    return (
        <>
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                <div className="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] relative">
                    
                    {!isCompleted && (
                        <button onClick={onClose} className="absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-full z-20">
                            <X className="h-5 w-5 text-gray-400" />
                        </button>
                    )}

                    <div className="flex-1 overflow-y-auto p-6 bg-white">
                        {isCompleted ? (
                            <div className="h-full flex flex-col items-center justify-center space-y-6 py-10 animate-in zoom-in duration-300">
                                <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
                                    <CheckCircle className="w-12 h-12 text-green-600" />
                                </div>
                                <div className="text-center space-y-2">
                                    <h3 className="text-3xl font-black text-slate-800">Venda Realizada!</h3>
                                    <p className="text-slate-500 font-medium">Venda #{vendaIdGerada} registrada com sucesso.</p>
                                </div>
                                <div className="flex gap-4 mt-8 w-full max-w-md">
                                    <button 
    // AQUI ESTÁ A MUDANÇA: Usa o ID da venda gerada
    onClick={() => window.open(`/print/recibo/${vendaIdGerada}`, '_blank')} 
    className="flex-1 py-4 rounded-xl border-2 border-slate-200 text-slate-600 font-bold hover:border-blue-500 hover:text-blue-600 transition-all flex flex-col items-center gap-2"
>
    <Printer className="h-6 w-6" /> Imprimir Recibo
</button>
                                    <button onClick={onReset} className="flex-1 py-4 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg transition-all flex flex-col items-center gap-2">
                                        <Plus className="h-6 w-6" /> Nova Venda
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col h-full gap-6">
                                
                                <div className="flex flex-col items-center justify-center space-y-1 pt-2">
                                    <p className="text-xs font-bold text-gray-400 uppercase tracking-widest">Total a Pagar</p>
                                    <p className="text-5xl font-black text-slate-800 tracking-tight">R$ {formatCurrency(valorTotal)}</p>
                                </div>

                                {!vendaParcialId && (
                                    <div className="flex p-1 bg-gray-100 rounded-xl mx-auto w-full max-w-md">
                                        <button onClick={() => setActiveTab('pagamento')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${activeTab === 'pagamento' ? 'bg-white text-emerald-600 shadow-sm' : 'text-gray-400'}`}>
                                            <CreditCard className="h-4 w-4" /> Pagamento
                                        </button>
                                        <button onClick={() => setActiveTab('carne')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all ${activeTab === 'carne' ? 'bg-white text-amber-600 shadow-sm' : 'text-gray-400'}`}>
                                            <FileText className="h-4 w-4" /> Carnê
                                        </button>
                                    </div>
                                )}

                                <div className="flex-1">
                                    {activeTab === 'pagamento' ? (
                                        // CARD VERDE (PAGAMENTO)
                                        <div className="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-2xl shadow-lg shadow-emerald-100 text-white animate-in slide-in-from-bottom-4">
                                            <div className="space-y-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className={labelStyle}>Valor Pago (R$)</label>
                                                        <input type="text" value={valorPago} onChange={e => setValorPago(e.target.value)} className={`${inputStyle} text-right text-lg text-emerald-800`} />
                                                    </div>
                                                    <div>
                                                        <label className={labelStyle}>Forma</label>
                                                        <select value={formaPagamento} onChange={e => setFormaPagamento(e.target.value)} className={`${inputStyle} cursor-pointer text-emerald-900`}>
                                                            <option>PIX</option><option>Dinheiro</option><option>Cartão Débito</option><option>Cartão Crédito</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className={labelStyle}>Parcelas</label>
                                                        <select value={parcelas} onChange={e => setParcelas(parseInt(e.target.value))} className={`${inputStyle} cursor-pointer text-emerald-900`}>
                                                            {[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}x</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className={labelStyle}>Data</label>
                                                        <div className={`${inputStyle} flex items-center text-emerald-900`}>
                                                            {new Date().toLocaleDateString('pt-BR')}
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div>
                                                    <label className={labelStyle}>Observação</label>
                                                    <input type="text" value={cpfNota} onChange={(e) => setCpfNota(e.target.value)} placeholder="Ex: CPF na nota..." className={`${inputStyle} text-emerald-900`} />
                                                </div>

                                                <button 
                                                    onClick={handlePrePayment} // <--- 5. Mudança aqui: Chama a pré-validação
                                                    disabled={isProcessing} 
                                                    className="w-full mt-4 bg-white text-emerald-700 hover:bg-emerald-50 font-bold py-3.5 rounded-xl shadow-md flex justify-center gap-2 transition-all active:scale-95"
                                                >
                                                    {isProcessing ? <Loader2 className="animate-spin"/> : 'AUTORIZAR E PAGAR'}
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        // CARD CARNÊ
                                        <div>
                                            {!vendaParcialId ? (
                                                <div className="bg-gradient-to-br from-amber-500 to-orange-600 p-6 rounded-2xl shadow-lg text-white text-center space-y-4 animate-in slide-in-from-bottom-4">
                                                    <p className="font-bold text-white/90 text-sm">Identifique o cliente para emitir o carnê</p>
                                                    <div className="flex gap-2">
                                                        <input type="text" value={customerQuery} onChange={e => setCustomerQuery(e.target.value)} placeholder="Digite nome..." className="flex-1 rounded-lg border-0 h-10 px-3 text-gray-800 font-bold" />
                                                        <button onClick={handleSearchCustomer} className="bg-white/20 hover:bg-white/30 text-white px-4 rounded-lg font-bold"><Search className="h-5 w-5"/></button>
                                                    </div>
                                                    
                                                    {customersFound.length > 0 && (
                                                        <div className="bg-white rounded-xl overflow-hidden text-left max-h-40 overflow-y-auto custom-scrollbar">
                                                            {customersFound.map(c => (
                                                                <div key={c.id} onClick={() => handleSelectCustomer(c)} className="p-3 hover:bg-orange-50 cursor-pointer border-b border-gray-100 last:border-0 text-gray-800">
                                                                    <p className="font-bold text-sm">{c.full_name}</p>
                                                                    <p className="text-[10px] text-gray-400">CPF: {c.cpf || 'N/A'}</p>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    )}
                                                    {isProcessing && <Loader2 className="animate-spin mx-auto text-white"/>}
                                                </div>
                                            ) : (
                                                <FinanciamentoBox 
                                                    financiamento={null}
                                                    vendaId={vendaParcialId}
                                                    customerId={selectedCustomer!.id}
                                                    storeId={storeId}
                                                    employeeId={employeeId}
                                                    valorRestante={valorTotal}
                                                    onFinanceAdded={async () => { setIsCompleted(true); setVendaIdGerada(vendaParcialId) }}
                                                    disabled={false}
                                                    isModal={true}
                                                />
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* 6. MODAL DE AUTH (PIN) */}
            {isAuthOpen && (
                <EmployeeAuthModal 
                    storeId={storeId} 
                    isOpen={isAuthOpen} 
                    onClose={() => setIsAuthOpen(false)} 
                    onSuccess={handleAuthSuccess} 
                    title="Autorizar Pagamento" 
                    description="Insira seu PIN para confirmar o recebimento." 
                />
            )}
        </>
    )
}

==================================================
ARQUIVO: .\src\components\modals\PrescriptionHistoryModal.tsx
==================================================
// ARQUIVO: src/components/modals/PrescriptionHistoryModal.tsx
'use client'

import { useEffect, useState } from 'react'
import { X, Loader2, History, Check, Calendar, Stethoscope, User } from 'lucide-react'
import { getCustomerPrescriptionHistory, type PrescriptionHistoryItem } from '@/lib/actions/vendas.actions'

type PrescriptionHistoryModalProps = {
  isOpen: boolean
  onClose: () => void
  onSelect: (data: PrescriptionHistoryItem) => void
  customerId: number
  storeId: number
  dependenteId: number | null // <--- RECEBE O ID DE QUEM ESTÁ SELECIONADO
  dependenteNome?: string // Opcional, só para exibir no título
}

// Helper
const formatDate = (dateStr: string) => new Date(dateStr).toLocaleDateString('pt-BR')

export default function PrescriptionHistoryModal({
  isOpen,
  onClose,
  onSelect,
  customerId,
  storeId,
  dependenteId,
  dependenteNome
}: PrescriptionHistoryModalProps) {
  const [history, setHistory] = useState<PrescriptionHistoryItem[]>([])
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    if (isOpen && customerId) {
      setLoading(true)
      // Passamos o dependenteId para filtrar no backend
      getCustomerPrescriptionHistory(customerId, storeId, dependenteId)
        .then(data => setHistory(data))
        .finally(() => setLoading(false))
    }
  }, [isOpen, customerId, storeId, dependenteId]) // <--- Recarrega se mudar o paciente

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onClick={onClose}>
      <div 
        className="relative w-full max-w-2xl bg-gray-100 rounded-xl shadow-2xl border border-gray-300 overflow-hidden flex flex-col max-h-[80vh]"
        onClick={e => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex justify-between items-center px-5 py-4 bg-white border-b border-gray-200">
          <div>
            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
              <History className="h-5 w-5 text-blue-600" />
              Histórico de Receitas
            </h3>
            {/* Feedback visual de quem estamos vendo */}
            <p className="text-xs text-gray-500 flex items-center gap-1 mt-1">
               Filtrando por: <span className="font-bold bg-blue-50 text-blue-700 px-1.5 rounded flex items-center gap-1"><User className="h-3 w-3"/> {dependenteNome || 'Titular'}</span>
            </p>
          </div>
          <button onClick={onClose} className="text-gray-400 hover:text-red-500 transition-colors">
            <X className="h-6 w-6" />
          </button>
        </div>

        {/* Lista de Receitas */}
        <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
          {loading ? (
            <div className="flex flex-col items-center justify-center py-10 text-gray-400">
              <Loader2 className="h-8 w-8 animate-spin mb-2" />
              <p className="text-sm">Buscando histórico de {dependenteNome || 'Titular'}...</p>
            </div>
          ) : history.length === 0 ? (
            <div className="text-center py-10 text-gray-400">
              <p>Nenhuma receita encontrada para este paciente.</p>
            </div>
          ) : (
            history.map((item) => (
              <div key={item.id} className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:border-blue-300 transition-colors">
                
                {/* Cabeçalho do Card */}
                <div className="flex justify-between items-start mb-3 border-b border-gray-100 pb-2">
                  <div className="flex gap-4">
                    <span className="flex items-center gap-1 text-xs font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded">
                      <Calendar className="h-3 w-3" /> {formatDate(item.created_at)}
                    </span>
                    <span className="flex items-center gap-1 text-xs font-medium text-gray-600">
                      <Stethoscope className="h-3 w-3" /> {item.oftalmologistas?.nome_completo || 'Médico N/A'}
                    </span>
                  </div>
                  <button 
                    onClick={() => onSelect(item)}
                    className="bg-green-600 hover:bg-green-700 text-white text-xs font-bold px-3 py-1.5 rounded flex items-center gap-1 shadow-sm transition-transform active:scale-95"
                  >
                    <Check className="h-3 w-3" /> USAR ESTA
                  </button>
                </div>

                {/* Grid de Resumo dos Valores */}
                <div className="grid grid-cols-7 gap-2 text-center text-xs">
                  {/* Labels */}
                  <div className="col-span-1 font-bold text-gray-400 text-[10px] self-center">OLHO</div>
                  <div className="col-span-2 font-bold text-gray-400 text-[10px]">ESF</div>
                  <div className="col-span-2 font-bold text-gray-400 text-[10px]">CIL</div>
                  <div className="col-span-2 font-bold text-gray-400 text-[10px]">EIXO</div>

                  {/* OD */}
                  <div className="col-span-1 font-bold text-blue-600 self-center">OD</div>
                  <div className="col-span-2 bg-gray-100 rounded py-1 font-medium text-gray-700">
                    {item.receita_longe_od_esferico || '-'}
                  </div>
                  <div className="col-span-2 bg-gray-100 rounded py-1 font-medium text-gray-700">
                    {item.receita_longe_od_cilindrico || '-'}
                  </div>
                  <div className="col-span-2 bg-gray-100 rounded py-1 font-medium text-gray-700">
                    {item.receita_longe_od_eixo || '-'}
                  </div>

                  {/* OE */}
                  <div className="col-span-1 font-bold text-blue-600 self-center">OE</div>
                  <div className="col-span-2 bg-gray-100 rounded py-1 font-medium text-gray-700">
                    {item.receita_longe_oe_esferico || '-'}
                  </div>
                  <div className="col-span-2 bg-gray-100 rounded py-1 font-medium text-gray-700">
                    {item.receita_longe_oe_cilindrico || '-'}
                  </div>
                  <div className="col-span-2 bg-gray-100 rounded py-1 font-medium text-gray-700">
                    {item.receita_longe_oe_eixo || '-'}
                  </div>
                </div>

                {/* Footer do Card (Adição e DNP) */}
                {(item.receita_adicao || item.medida_dnp_od) && (
                  <div className="mt-3 pt-2 border-t border-dashed border-gray-200 flex gap-4 text-xs text-gray-600">
                    {item.receita_adicao && <span>Add: <strong>{item.receita_adicao}</strong></span>}
                    {item.medida_dnp_od && <span>DNP OD: <strong>{item.medida_dnp_od}</strong></span>}
                    {item.medida_dnp_oe && <span>DNP OE: <strong>{item.medida_dnp_oe}</strong></span>}
                  </div>
                )}

              </div>
            ))
          )}
        </div>
        
        <div className="bg-gray-200 px-5 py-3 text-right">
            <button onClick={onClose} className="text-sm font-bold text-gray-600 hover:text-gray-800">Cancelar</button>
        </div>
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\modals\QuickCustomerModal.tsx
==================================================
'use client'

import { useState, useTransition } from 'react'
import { X, Save, Loader2, UserPlus, Phone } from 'lucide-react'
import { createQuickCustomer } from '@/lib/actions/customer.actions'
import { Database } from '@/lib/database.types'

type Customer = Database['public']['Tables']['customers']['Row']

interface Props {
    isOpen: boolean
    onClose: () => void
    onSuccess: (customer: Customer) => void
    storeId: number
    initialName: string
}

export default function QuickCustomerModal({ isOpen, onClose, onSuccess, storeId, initialName }: Props) {
    const [name, setName] = useState(initialName)
    const [phone, setPhone] = useState('')
    const [isPending, startTransition] = useTransition()
    const [errorMsg, setErrorMsg] = useState<string | null>(null)

    // Mascara simples de telefone
    const handlePhoneChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        let v = e.target.value.replace(/\D/g, '')
        v = v.replace(/^(\d{2})(\d)/g, '($1) $2')
        v = v.replace(/(\d)(\d{4})$/, '$1-$2')
        setPhone(v.substring(0, 15))
    }

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault()
        if (name.length < 3 || phone.length < 10) {
            setErrorMsg("Preencha nome e telefone corretamente.")
            return
        }

        const formData = new FormData()
        formData.append('store_id', storeId.toString())
        formData.append('full_name', name)
        formData.append('fone_movel', phone)

        startTransition(async () => {
            const res = await createQuickCustomer(formData)
            if (res.success && res.data) {
                onSuccess(res.data)
                onClose()
            } else {
                setErrorMsg(res.message)
            }
        })
    }

    if (!isOpen) return null

    // Estilo dos Inputs (Branco destacado com sombra)
    const inputStyle = "w-full h-11 rounded-lg border-0 bg-white shadow-sm focus:ring-2 focus:ring-blue-500 text-blue-900 font-bold placeholder-slate-400 transition-all px-4"
    // Estilo dos Labels
    const labelStyle = "block text-xs font-bold text-slate-600 uppercase mb-1.5 tracking-wider flex items-center gap-1"

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
                
                {/* Cabeçalho */}
                <div className="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center">
                    <h3 className="font-black text-xl text-blue-900 flex items-center gap-2">
                        <UserPlus className="h-6 w-6 text-blue-600" /> Cadastro Rápido
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-blue-100 rounded-full text-blue-400 hover:text-blue-600 transition-colors">
                        <X className="h-5 w-5" />
                    </button>
                </div>

                {/* Corpo do Formulário com Fundo Colorido */}
                <form onSubmit={handleSubmit} className="p-6 space-y-5 bg-slate-100">
                    <p className="text-sm font-medium text-slate-500 mb-2 leading-relaxed">
                        Cadastre apenas o essencial para não perder a venda. Você pode completar os dados depois.
                    </p>
                    
                    <div>
                        <label className={labelStyle}>Nome Completo</label>
                        <input 
                            type="text" 
                            value={name} 
                            onChange={e => setName(e.target.value)} 
                            className={inputStyle}
                            placeholder="Ex: João da Silva"
                            autoFocus
                        />
                    </div>

                    <div>
                        <label className={labelStyle}>
                            <Phone className="h-3.5 w-3.5" /> Celular / WhatsApp
                        </label>
                        <input 
                            type="text" 
                            value={phone} 
                            onChange={handlePhoneChange} 
                            placeholder="(00) 90000-0000"
                            className={inputStyle}
                        />
                    </div>

                    {errorMsg && (
                        <div className="p-3 bg-red-50 text-red-700 text-sm font-bold rounded-lg border border-red-100 flex items-center gap-2">
                            <X className="h-4 w-4" /> {errorMsg}
                        </div>
                    )}

                    <button 
                        type="submit" 
                        disabled={isPending}
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-blue-200 flex items-center justify-center gap-2 disabled:opacity-50 transition-all active:scale-95 mt-4"
                    >
                        {isPending ? <Loader2 className="h-6 w-6 animate-spin" /> : <Save className="h-6 w-6" />}
                        SALVAR E SELECIONAR
                    </button>
                </form>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\ReceiptSelectionModal.tsx
==================================================
'use client'

import { useState } from 'react'
import { X, Printer, Calendar, DollarSign, CheckSquare, Square, AlertTriangle, Loader2 } from 'lucide-react'
import { Database } from '@/lib/database.types'
import { markPaymentsAsPrinted } from '@/lib/actions/vendas.actions'

type Pagamento = Database['public']['Tables']['pagamentos']['Row']

interface Props {
    isOpen: boolean
    onClose: () => void
    pagamentos: Pagamento[]
    onReload: () => Promise<void> // <--- NOVO: Função para recarregar dados
}

const formatMoney = (v: number) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (d: string) => new Date(d).toLocaleDateString('pt-BR')

export default function ReceiptSelectionModal({ isOpen, onClose, pagamentos, onReload }: Props) {
    const [selectedIds, setSelectedIds] = useState<number[]>([])
    const [isProcessing, setIsProcessing] = useState(false)

    if (!isOpen) return null

    // Toggle de seleção
    const toggleSelect = (id: number) => {
        setSelectedIds(prev => 
            prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
        )
    }

    // Cálculos
    const totalSelecionado = pagamentos
        .filter(p => selectedIds.includes(p.id))
        .reduce((acc, p) => acc + p.valor_pago, 0)

    const handlePrint = async () => {
        if (selectedIds.length === 0) return

        // Verifica Reimpressão (Olha para o dado atual da tela)
        const itensJaImpressos = pagamentos.filter(p => selectedIds.includes(p.id) && p.receipt_printed_at)
        let isReimpressao = false

        if (itensJaImpressos.length > 0) {
            const confirm = window.confirm(`Atenção: ${itensJaImpressos.length} pagamento(s) já possuem recibo.\n\nDeseja gerar uma 2ª VIA (Reimpressão)?`)
            if (!confirm) return
            isReimpressao = true
        }

        setIsProcessing(true)

        // 1. Marca como impresso no banco
        await markPaymentsAsPrinted(selectedIds)

        // 2. Recarrega os dados da tela (Para que na próxima vez já apareça como impresso)
        await onReload()

        setIsProcessing(false)

        // 3. Gera a URL e abre a impressão
        const idsParam = selectedIds.join('-')
        const url = `/print/recibo/${idsParam}?reprint=${isReimpressao ? 'true' : 'false'}`
        
        window.open(url, '_blank')
        onClose()
    }

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in">
            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                <div className="bg-slate-800 px-6 py-4 flex justify-between items-center text-white shrink-0">
                    <h3 className="font-bold flex items-center gap-2">
                        <Printer className="h-5 w-5" /> Gerar Recibo Unificado
                    </h3>
                    <button onClick={onClose} disabled={isProcessing}><X className="h-5 w-5"/></button>
                </div>
                
                <div className="p-6 overflow-y-auto bg-slate-50">
                    <p className="text-sm text-slate-500 mb-4 font-medium">Selecione os pagamentos para somar no recibo:</p>
                    
                    <div className="space-y-2">
                        {pagamentos.length === 0 ? (
                            <p className="text-center text-slate-400 italic">Nenhum pagamento registrado.</p>
                        ) : (
                            pagamentos.map(pg => {
                                const isSelected = selectedIds.includes(pg.id)
                                const isPrinted = !!pg.receipt_printed_at
                                
                                return (
                                    <div 
                                        key={pg.id}
                                        onClick={() => !isProcessing && toggleSelect(pg.id)}
                                        className={`w-full flex items-center justify-between p-3 rounded-xl border cursor-pointer transition-all
                                            ${isSelected 
                                                ? 'bg-blue-50 border-blue-500 shadow-sm' 
                                                : 'bg-white border-slate-200 hover:border-blue-300'}
                                            ${isProcessing ? 'opacity-50 cursor-not-allowed' : ''}
                                        `}
                                    >
                                        <div className="flex items-center gap-3">
                                            <div className={`text-slate-400 ${isSelected ? 'text-blue-600' : ''}`}>
                                                {isSelected ? <CheckSquare className="h-5 w-5" /> : <Square className="h-5 w-5" />}
                                            </div>
                                            <div>
                                                <div className="flex items-center gap-2 text-slate-800 font-bold">
                                                    {formatMoney(pg.valor_pago)}
                                                </div>
                                                <div className="flex items-center gap-2 text-[10px] text-slate-500 mt-0.5 uppercase font-bold">
                                                    <span className="bg-slate-200 px-1.5 py-0.5 rounded">{pg.forma_pagamento}</span>
                                                    <span>{formatDate(pg.created_at)}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {isPrinted && (
                                            <div className="flex items-center gap-1 text-[9px] font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-100" title="Já impresso">
                                                <Printer className="h-3 w-3" /> 2ª VIA
                                            </div>
                                        )}
                                    </div>
                                )
                            })
                        )}
                    </div>
                </div>

                {/* Rodapé com Total e Ação */}
                <div className="p-4 bg-white border-t border-slate-200 shrink-0">
                    <div className="flex justify-between items-center mb-3">
                        <span className="text-xs font-bold text-slate-400 uppercase">Total do Recibo</span>
                        <span className="text-2xl font-black text-slate-800">{formatMoney(totalSelecionado)}</span>
                    </div>
                    <button 
                        onClick={handlePrint}
                        disabled={selectedIds.length === 0 || isProcessing}
                        className="w-full py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white rounded-xl font-bold shadow-md transition-all flex justify-center items-center gap-2"
                    >
                        {isProcessing ? <Loader2 className="h-5 w-5 animate-spin"/> : <Printer className="h-5 w-5" />}
                        {isProcessing ? 'PROCESSANDO...' : `IMPRIMIR (${selectedIds.length})`}
                    </button>
                </div>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\modals\ReturnModal.tsx
==================================================
'use client'

import { useState, useRef, useTransition } from 'react'
import { X, RefreshCcw, AlertTriangle, CheckCircle2, Wallet, CreditCard, ArrowRight, Loader2 } from 'lucide-react'
import { Database } from '@/lib/database.types'
import EmployeeAuthModal from '@/components/modals/EmployeeAuthModal'
import { processarDevolucao } from '@/lib/actions/return.actions'

type VendaItem = Database['public']['Tables']['venda_itens']['Row']
type Employee = Database['public']['Tables']['employees']['Row']

interface ReturnModalProps {
    isOpen: boolean
    onClose: () => void
    vendaId: number
    storeId: number
    customerId: number
    itens: VendaItem[]
}

type SelectedItemState = {
    selected: boolean
    condicao: 'Intacto' | 'Defeito' | 'Sobra'
    diametro?: string
    olho?: 'OD' | 'OE'
}

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

export default function ReturnModal({ isOpen, onClose, vendaId, storeId, customerId, itens }: ReturnModalProps) {
    // Estado dos Itens (Controle de seleção e condição)
    const [itemsState, setItemsState] = useState<Record<number, SelectedItemState>>(() => {
        const initial: Record<number, SelectedItemState> = {}
        itens.forEach(item => {
            initial[item.id] = { selected: false, condicao: 'Intacto' }
        })
        return initial
    })

    const [refundMethod, setRefundMethod] = useState<'Carteira' | 'Estorno'>('Carteira')
    const [isAuthOpen, setIsAuthOpen] = useState(false)
    const [isPending, startTransition] = useTransition()

    // Cálculos
    const selectedItemsIds = Object.keys(itemsState).filter(id => itemsState[parseInt(id)].selected).map(Number)
    const totalRefund = selectedItemsIds.reduce((acc, id) => {
        const item = itens.find(i => i.id === id)
        return acc + (item ? item.valor_total_item : 0) // Assume devolução total do item (qtd total)
    }, 0)

    // Handlers
    const toggleSelect = (id: number) => {
        setItemsState(prev => ({
            ...prev,
            [id]: { ...prev[id], selected: !prev[id].selected }
        }))
    }

    const updateCondition = (id: number, condicao: 'Intacto' | 'Defeito' | 'Sobra') => {
        setItemsState(prev => ({
            ...prev,
            [id]: { ...prev[id], condicao }
        }))
    }

    const updateDetails = (id: number, field: 'diametro' | 'olho', value: string) => {
        setItemsState(prev => ({
            ...prev,
            [id]: { ...prev[id], [field]: value }
        }))
    }

    // Fluxo de Confirmação
    const handlePreConfirm = () => {
        if (selectedItemsIds.length === 0) return alert("Selecione pelo menos um item.")
        
        // Validação de Sobras
        for (const id of selectedItemsIds) {
            const state = itemsState[id]
            if (state.condicao === 'Sobra') {
                if (!state.diametro || !state.olho) {
                    return alert("Para itens marcados como SOBRA, informe o Diâmetro e o Olho.")
                }
            }
        }

        setIsAuthOpen(true)
    }

    const handleAuthSuccess = (employee: { id: number, full_name: string, role: string }) => {
        // TRAVA DE SEGURANÇA: Estorno exige Gerente
        if (refundMethod === 'Estorno' && employee.role !== 'gerente' && employee.role !== 'admin') {
            alert("⛔ Acesso Negado: Apenas Gerentes podem autorizar Estorno Financeiro.\nPara vendedores, use a opção 'Crédito em Loja'.")
            // Não fecha o modal de auth, força tentar de novo ou cancelar
            return 
        }

        setIsAuthOpen(false)

        // Prepara Payload
        const itensPayload = selectedItemsIds.map(id => {
            const original = itens.find(i => i.id === id)!
            const state = itemsState[id]
            return {
                venda_item_id: id,
                product_id: original.product_id,
                quantidade: original.quantidade, // Devolução total da linha
                valor_unitario: original.valor_unitario,
                condicao: state.condicao,
                detalhes_sobra: state.condicao === 'Sobra' ? {
                    diametro: parseFloat(state.diametro || '0'),
                    olho: state.olho
                } : undefined
            }
        })

        const formData = new FormData()
        formData.append('store_id', storeId.toString())
        formData.append('venda_id', vendaId.toString())
        formData.append('customer_id', customerId.toString())
        formData.append('employee_id', employee.id.toString())
        formData.append('tipo_reembolso', refundMethod)
        formData.append('itens_json', JSON.stringify(itensPayload))

        startTransition(async () => {
            const res = await processarDevolucao(null, formData)
            if (res.success) {
                alert("Devolução processada com sucesso!")
                onClose()
            } else {
                alert(`Erro: ${res.message}`)
            }
        })
    }

    if (!isOpen) return null

    return (
        <>
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-in fade-in">
            <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                
                {/* Header */}
                <div className="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                    <div>
                        <h2 className="text-xl font-bold text-red-900 flex items-center gap-2">
                            <RefreshCcw className="h-6 w-6" /> Devolução / Troca
                        </h2>
                        <p className="text-xs text-red-700">Selecione os itens e o destino.</p>
                    </div>
                    <button onClick={onClose} className="p-2 hover:bg-red-100 rounded-full text-red-400"><X className="h-6 w-6"/></button>
                </div>

                <div className="flex-1 overflow-y-auto p-6 space-y-6">
                    
                    {/* 1. Lista de Itens */}
                    <div className="space-y-3">
                        <h3 className="text-sm font-bold text-gray-700 uppercase tracking-wide">Itens da Venda</h3>
                        {itens.map(item => {
                            const state = itemsState[item.id]
                            const isLente = item.item_tipo === 'Lente'
                            
                            return (
                                <div key={item.id} className={`p-4 rounded-xl border transition-all ${state.selected ? 'border-red-500 bg-red-50/50' : 'border-gray-200 bg-white'}`}>
                                    <div className="flex items-start gap-3">
                                        <input 
                                            type="checkbox" 
                                            checked={state.selected} 
                                            onChange={() => toggleSelect(item.id)}
                                            className="mt-1 w-5 h-5 text-red-600 rounded border-gray-300 focus:ring-red-500"
                                        />
                                        <div className="flex-1">
                                            <div className="flex justify-between">
                                                <span className="font-bold text-gray-800">{item.descricao}</span>
                                                <span className="font-mono text-gray-600">{formatCurrency(item.valor_total_item)}</span>
                                            </div>
                                            <p className="text-xs text-gray-500 mb-2">{item.quantidade}x {item.item_tipo}</p>

                                            {/* Opções Condicionais (Só aparecem se selecionado) */}
                                            {state.selected && (
                                                <div className="mt-3 flex flex-wrap gap-4 items-end animate-in slide-in-from-top-2">
                                                    <div>
                                                        <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1">Estado / Destino</label>
                                                        <select 
                                                            value={state.condicao} 
                                                            onChange={(e) => updateCondition(item.id, e.target.value as any)}
                                                            className="h-8 text-xs rounded border-gray-300 focus:ring-red-500 bg-white"
                                                        >
                                                            <option value="Intacto">Intacto (Estoque)</option>
                                                            <option value="Defeito">Defeito (Lixo/Perda)</option>
                                                            {isLente && <option value="Sobra">Sobra (Banco de Lentes)</option>}
                                                        </select>
                                                    </div>

                                                    {/* Campos Extras para Sobra */}
                                                    {state.condicao === 'Sobra' && (
                                                        <>
                                                            <div>
                                                                <label className="block text-[10px] font-bold text-blue-600 uppercase mb-1">Diâmetro Útil</label>
                                                                <input 
                                                                    type="number" 
                                                                    placeholder="Ex: 65"
                                                                    value={state.diametro || ''}
                                                                    onChange={(e) => updateDetails(item.id, 'diametro', e.target.value)}
                                                                    className="h-8 w-20 text-xs rounded border-blue-300 focus:ring-blue-500"
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-[10px] font-bold text-blue-600 uppercase mb-1">Olho</label>
                                                                <select 
                                                                    value={state.olho || ''}
                                                                    onChange={(e) => updateDetails(item.id, 'olho', e.target.value)}
                                                                    className="h-8 w-20 text-xs rounded border-blue-300 focus:ring-blue-500"
                                                                >
                                                                    <option value="">--</option>
                                                                    <option value="OD">OD</option>
                                                                    <option value="OE">OE</option>
                                                                </select>
                                                            </div>
                                                        </>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>

                    {/* 2. Resumo e Método */}
                    <div className="bg-gray-50 p-5 rounded-xl border border-gray-200">
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-sm font-bold text-gray-600 uppercase">Total do Reembolso</span>
                            <span className="text-2xl font-black text-gray-800">{formatCurrency(totalRefund)}</span>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <button 
                                onClick={() => setRefundMethod('Carteira')}
                                className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${refundMethod === 'Carteira' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 bg-white text-gray-500 hover:border-blue-200'}`}
                            >
                                <Wallet className="h-6 w-6" />
                                <span className="font-bold text-sm">Gerar Crédito (Carteira)</span>
                                <span className="text-[10px] bg-blue-200 text-blue-800 px-2 py-0.5 rounded">Recomendado</span>
                            </button>

                            <button 
                                onClick={() => setRefundMethod('Estorno')}
                                className={`p-4 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${refundMethod === 'Estorno' ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-200 bg-white text-gray-500 hover:border-red-200'}`}
                            >
                                <CreditCard className="h-6 w-6" />
                                <span className="font-bold text-sm">Estorno Financeiro</span>
                                <span className="text-[10px] bg-red-100 text-red-800 px-2 py-0.5 rounded flex items-center gap-1">
                                    <AlertTriangle className="h-3 w-3"/> Exige Gerente
                                </span>
                            </button>
                        </div>
                    </div>

                </div>

                {/* Footer */}
                <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
                    <button onClick={onClose} className="px-6 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-200 transition-colors">Cancelar</button>
                    <button 
                        onClick={handlePreConfirm}
                        disabled={selectedItemsIds.length === 0 || isPending}
                        className="px-8 py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold shadow-lg shadow-red-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {isPending ? <Loader2 className="h-5 w-5 animate-spin"/> : <ArrowRight className="h-5 w-5" />}
                        Confirmar Devolução
                    </button>
                </div>

            </div>
        </div>

        {/* Modal de Autenticação */}
        {isAuthOpen && (
            <EmployeeAuthModal 
                storeId={storeId} 
                isOpen={isAuthOpen} 
                onClose={() => setIsAuthOpen(false)} 
                onSuccess={handleAuthSuccess}
                title={refundMethod === 'Estorno' ? "Autorização de Gerente Necessária" : "Autorizar Devolução"}
                description={refundMethod === 'Estorno' ? "Para estornos financeiros, é necessário o PIN de um gerente." : "Insira seu PIN para confirmar a devolução."}
            />
        )}
        </>
    )
}

==================================================
ARQUIVO: .\src\components\modals\SaleDetailsModal.tsx
==================================================
'use client'

import { X, Eye, ShoppingBag, Calendar, DollarSign, User } from 'lucide-react'

// Tipagem simplificada baseada no retorno da Action
interface SaleDetailsModalProps {
  isOpen: boolean
  onClose: () => void
  data: any // O dado vem do join complexo da action getPostSaleDetails
}

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (d: string) => new Date(d).toLocaleDateString('pt-BR')

export default function SaleDetailsModal({ isOpen, onClose, data }: SaleDetailsModalProps) {
  if (!isOpen || !data) return null

  // Identifica quem é o paciente (Dependente ou Titular)
  const pacienteNome = data.dependentes?.full_name || data.customers?.full_name || 'Consumidor'
  const venda = data.vendas

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200" onClick={onClose}>
      <div className="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
        
        {/* 1. CABEÇALHO (O PACIENTE) */}
        <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-start">
          <div>
            <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
              <User className="h-6 w-6 text-blue-600" />
              {pacienteNome}
            </h2>
            <div className="flex gap-4 mt-1 text-xs font-bold text-slate-500 uppercase tracking-wide">
                <span className="flex items-center gap-1"><Calendar className="h-3 w-3"/> Entrega: {data.dt_entregue_em ? formatDate(data.dt_entregue_em) : 'Pendente'}</span>
                <span className="flex items-center gap-1">OS #{data.id}</span>
            </div>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-400 hover:text-slate-600">
            <X className="h-6 w-6" />
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-6 space-y-6">
            
            {/* 2. O CORAÇÃO (A RECEITA) */}
            <div className="bg-blue-50/50 rounded-xl border border-blue-100 p-4">
                <h3 className="text-sm font-bold text-blue-900 mb-3 flex items-center gap-2">
                    <Eye className="h-4 w-4" /> Dados da Receita (Em uso)
                </h3>
                
                {/* Grid de Receita */}
                <div className="grid grid-cols-7 gap-2 text-center text-xs">
                    <div className="col-span-1 font-bold text-slate-400 self-center text-[10px]">OLHO</div>
                    <div className="col-span-2 font-bold text-slate-500 bg-white/50 py-1 rounded">ESF.</div>
                    <div className="col-span-2 font-bold text-slate-500 bg-white/50 py-1 rounded">CIL.</div>
                    <div className="col-span-2 font-bold text-slate-500 bg-white/50 py-1 rounded">EIXO</div>

                    {/* OD */}
                    <div className="col-span-1 font-black text-blue-600 self-center text-sm">OD</div>
                    <div className="col-span-2 bg-white border border-blue-100 py-2 rounded font-bold text-slate-700 text-sm">
                        {data.receita_longe_od_esferico || '-'}
                    </div>
                    <div className="col-span-2 bg-white border border-blue-100 py-2 rounded font-bold text-slate-700 text-sm">
                        {data.receita_longe_od_cilindrico || '-'}
                    </div>
                    <div className="col-span-2 bg-white border border-blue-100 py-2 rounded font-bold text-slate-700 text-sm">
                        {data.receita_longe_od_eixo || '-'}
                    </div>

                    {/* OE */}
                    <div className="col-span-1 font-black text-blue-600 self-center text-sm">OE</div>
                    <div className="col-span-2 bg-white border border-blue-100 py-2 rounded font-bold text-slate-700 text-sm">
                        {data.receita_longe_oe_esferico || '-'}
                    </div>
                    <div className="col-span-2 bg-white border border-blue-100 py-2 rounded font-bold text-slate-700 text-sm">
                        {data.receita_longe_oe_cilindrico || '-'}
                    </div>
                    <div className="col-span-2 bg-white border border-blue-100 py-2 rounded font-bold text-slate-700 text-sm">
                        {data.receita_longe_oe_eixo || '-'}
                    </div>
                </div>

                <div className="flex justify-center gap-4 mt-3 pt-3 border-t border-blue-100 text-xs font-bold text-slate-600">
                    {data.receita_adicao && <span>Adição: <span className="text-blue-700">{data.receita_adicao}</span></span>}
                    {data.medida_dnp_od && <span>DNP OD: <span className="text-blue-700">{data.medida_dnp_od}</span></span>}
                    {data.medida_dnp_oe && <span>DNP OE: <span className="text-blue-700">{data.medida_dnp_oe}</span></span>}
                </div>
            </div>

            {/* 3. O PRODUTO (ITENS DA VENDA) */}
            <div>
                <h3 className="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                    <ShoppingBag className="h-4 w-4 text-slate-400" /> Produtos Adquiridos
                </h3>
                <div className="border border-slate-200 rounded-xl overflow-hidden">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 text-slate-500 font-bold text-[10px] uppercase">
                            <tr>
                                <th className="px-4 py-2">Item</th>
                                <th className="px-4 py-2 text-right">Valor</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {venda?.venda_itens?.map((item: any, idx: number) => (
                                <tr key={idx} className="bg-white">
                                    <td className="px-4 py-2">
                                        <p className="font-bold text-slate-700">{item.descricao}</p>
                                        <p className="text-[10px] text-slate-400 uppercase">{item.item_tipo}</p>
                                    </td>
                                    <td className="px-4 py-2 text-right text-slate-600">
                                        {formatCurrency(item.valor_unitario)}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* 4. RODAPÉ (FINANCEIRO) */}
            <div className="bg-slate-100 rounded-xl p-4 flex justify-between items-center">
                <div className="flex items-center gap-2">
                    <div className={`p-2 rounded-full ${venda?.valor_restante > 0.01 ? 'bg-amber-100 text-amber-600' : 'bg-green-100 text-green-600'}`}>
                        <DollarSign className="h-5 w-5" />
                    </div>
                    <div>
                        <p className="text-xs font-bold text-slate-500 uppercase">Situação Financeira</p>
                        <p className={`font-bold text-sm ${venda?.valor_restante > 0.01 ? 'text-amber-600' : 'text-green-600'}`}>
                            {venda?.valor_restante > 0.01 ? 'Pagamento Pendente' : 'Totalmente Quitado'}
                        </p>
                    </div>
                </div>
                <div className="text-right">
                    <p className="text-xs text-slate-400 uppercase font-bold">Total da Compra</p>
                    <p className="text-xl font-black text-slate-800">{formatCurrency(venda?.valor_final || 0)}</p>
                </div>
            </div>

        </div>
        
        <div className="bg-slate-50 px-6 py-3 border-t border-slate-200 text-right">
            <button onClick={onClose} className="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-lg transition-colors text-sm">
                Fechar Visualização
            </button>
        </div>
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\modals\StockMovementModal.tsx
==================================================
'use client'

import { useState, useTransition, useRef, useEffect } from 'react'
import { 
  X, Search, Package, ArrowRight, Loader2, 
  ArrowUpCircle, ArrowDownCircle, AlertTriangle, Lock 
} from 'lucide-react'
import { buscarProdutoExpress, type ProdutoExpressResult } from '@/lib/actions/vendas.actions'
import { registrarMovimentacao } from '@/lib/actions/stock.actions'
import EmployeeAuthModal from '@/components/modals/EmployeeAuthModal'

interface Props {
  isOpen: boolean
  onClose: () => void
  storeId: number
}

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

export default function StockMovementModal({ isOpen, onClose, storeId }: Props) {
  const [step, setStep] = useState<'search' | 'form'>('search')
  const [query, setQuery] = useState('')
  const [results, setResults] = useState<ProdutoExpressResult[]>([])
  const [selectedProduct, setSelectedProduct] = useState<ProdutoExpressResult | null>(null)
  
  const [tipo, setTipo] = useState<'Entrada' | 'Saida' | 'Perda' | 'Ajuste' | 'Brinde'>('Saida')
  const [quantidade, setQuantidade] = useState(1)
  const [motivo, setMotivo] = useState('')
  
  // --- NOVOS ESTADOS PARA O FLUXO 2 ---
  const [relatedVendaId, setRelatedVendaId] = useState('')
  const [gerouSobra, setGerouSobra] = useState(false)
  const [sobraDiametro, setSobraDiametro] = useState('')
  const [sobraOlho, setSobraOlho] = useState('OD')
  // ------------------------------------
  
  const [isSearching, startSearch] = useTransition()
  const [isSaving, startSave] = useTransition()
  
  const [isAuthOpen, setIsAuthOpen] = useState(false)
  
  const searchInputRef = useRef<HTMLInputElement>(null)

  // Reset ao abrir
  useEffect(() => {
    if (isOpen) {
        setStep('search')
        setQuery('')
        setResults([])
        setSelectedProduct(null)
        setQuantidade(1)
        setMotivo('')
        
        // Reset novos campos
        setRelatedVendaId('')
        setGerouSobra(false)
        setSobraDiametro('')
        setSobraOlho('OD')
        
        setTimeout(() => searchInputRef.current?.focus(), 100)
    }
  }, [isOpen])

  // Lógica de Busca
  const performSearch = (searchTerm: string) => {
    if (searchTerm.length < 3) return 
    startSearch(async () => {
      const res = await buscarProdutoExpress(searchTerm, storeId)
      setResults(res)
    })
  }

  // Busca Automática (Debounce)
  useEffect(() => {
      if (step !== 'search' || query.length < 3) {
          if (query.length === 0) setResults([]);
          return;
      }

      const timer = setTimeout(() => {
          performSearch(query);
      }, 500);

      return () => clearTimeout(timer);
      // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [query, step, storeId]); 

  const handleSearchSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    performSearch(query)
  }

  const handleSelect = (prod: ProdutoExpressResult) => {
    setSelectedProduct(prod)
    setStep('form')
  }

  const handlePreSubmit = () => {
    if (!selectedProduct) return
    if (!motivo.trim()) return alert("O motivo é obrigatório.")
    if (quantidade <= 0) return alert("Quantidade inválida.")
    
    setIsAuthOpen(true)
  }

  const handleAuthSuccess = (employee: { id: number, full_name: string }) => {
    setIsAuthOpen(false)
    
    const formData = new FormData()
    formData.append('store_id', storeId.toString())
    formData.append('employee_id', employee.id.toString())
    formData.append('product_id', selectedProduct!.id.toString())
    formData.append('tipo', tipo)
    formData.append('quantidade', quantidade.toString())
    formData.append('motivo', motivo)

    // --- NOVOS DADOS ---
    if (relatedVendaId) formData.append('related_venda_id', relatedVendaId)
    
    if (tipo === 'Perda' && gerouSobra) {
        formData.append('sobra_detalhes', JSON.stringify({
            diametro: parseFloat(sobraDiametro),
            olho: sobraOlho
        }))
    }
    // -------------------

    startSave(async () => {
        const res = await registrarMovimentacao({ success: false, message: '' }, formData)
        if (res.success) {
            alert("Movimentação registrada!")
            onClose()
        } else {
            alert("Erro: " + res.message)
        }
    })
  }

  if (!isOpen) return null

  const isEntrada = tipo === 'Entrada' || tipo === 'Ajuste';
  
  // --- ESTILOS PADRONIZADOS (ALTO CONTRASTE) ---
  // Borda Slate-300 visível mesmo sem foco
  const inputClass = "w-full rounded-lg border border-slate-300 bg-white shadow-sm text-slate-800 font-bold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all";

  return (
    <>
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
      <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        
        {/* Header */}
        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
            <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <ArrowLeftRightIcon tipo={tipo} />
                {step === 'search' ? 'Buscar Produto' : 'Registrar Movimentação'}
            </h3>
            <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-full text-gray-500"><X className="h-5 w-5"/></button>
        </div>

        <div className="p-6 overflow-y-auto">
            {step === 'search' && (
                <div className="space-y-4">
                    <form onSubmit={handleSearchSubmit} className="relative">
                        <input 
                            ref={searchInputRef}
                            value={query}
                            onChange={e => setQuery(e.target.value)}
                            placeholder="Digite 3 letras ou bipe o código..."
                            className={`${inputClass} h-12 pl-10 pr-4 text-lg`}
                        />
                        <Search className="absolute left-3 top-3.5 h-5 w-5 text-gray-400" />
                        {isSearching && <Loader2 className="absolute right-3 top-3.5 h-5 w-5 text-blue-500 animate-spin" />}
                    </form>
                    <div className="space-y-2">
                        {results.map(prod => (
                            <button key={prod.id} onClick={() => handleSelect(prod)} className="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-all flex justify-between items-center group">
                                <div>
                                    <p className="font-bold text-gray-800 text-sm">{prod.descricao}</p>
                                    <p className="text-xs text-gray-500 font-mono mt-0.5">Est: {prod.estoque}</p>
                                </div>
                                <span className="block font-bold text-green-600 text-sm">{formatCurrency(prod.preco)}</span>
                            </button>
                        ))}
                        {results.length === 0 && query.length >= 3 && !isSearching && (
                            <p className="text-center text-gray-400 text-sm py-4">Nenhum produto encontrado.</p>
                        )}
                    </div>
                </div>
            )}

            {step === 'form' && selectedProduct && (
                <div className="space-y-5">
                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-start gap-3">
                        <div className="p-2 bg-white rounded-lg shadow-sm"><Package className="h-6 w-6 text-blue-600" /></div>
                        <div>
                            <p className="font-bold text-blue-900 text-sm">{selectedProduct.descricao}</p>
                            <p className="text-xs text-blue-700 mt-1">Estoque: <strong>{selectedProduct.estoque}</strong></p>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo de Movimento</label>
                            <select value={tipo} onChange={e => setTipo(e.target.value as any)} className={`${inputClass} h-10`}>
                                <option value="Saida">Saída (Baixa)</option>
                                <option value="Brinde">Brinde / Cortesia</option>
                                <option value="Perda">Perda / Quebra</option>
                                <option value="Ajuste">Ajuste</option>
                                <option value="Entrada">Entrada</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Quantidade</label>
                            <input type="number" min="1" value={quantidade} onChange={e => setQuantidade(parseInt(e.target.value))} className={`${inputClass} h-10 text-center text-lg`}/>
                        </div>
                    </div>

                    <div>
                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Motivo *</label>
                        <textarea value={motivo} onChange={e => setMotivo(e.target.value)} placeholder="Ex: Brinde para o cliente X por fidelidade..." className={`${inputClass} h-24 p-3 resize-none text-sm font-normal`}/>
                    </div>

                    {/* --- INICIO DOS CAMPOS DE PERDA/QUEBRA --- */}
                    {tipo === 'Perda' && (
                        <div className="bg-rose-50 p-4 rounded-xl border border-rose-200 space-y-3 animate-in slide-in-from-top-2">
                            <div>
                                <label className="block text-xs font-bold text-rose-800 uppercase mb-1">Vincular à Venda (Opcional)</label>
                                <input 
                                    type="number" 
                                    placeholder="ID da Venda ou OS" 
                                    value={relatedVendaId} 
                                    onChange={e => setRelatedVendaId(e.target.value)} 
                                    className={`${inputClass} h-9 border-rose-300 focus:ring-rose-500 text-sm`}
                                />
                                <p className="text-[10px] text-rose-600 mt-1">Isso aloca o prejuízo ao relatório da venda.</p>
                            </div>

                            <div className="flex items-center gap-2 pt-2 border-t border-rose-200">
                                <input 
                                    type="checkbox" 
                                    id="chk_sobra" 
                                    checked={gerouSobra} 
                                    onChange={e => setGerouSobra(e.target.checked)}
                                    className="rounded text-rose-600 focus:ring-rose-500 w-5 h-5 border-rose-300"
                                />
                                <label htmlFor="chk_sobra" className="text-sm font-bold text-rose-900 select-none cursor-pointer">
                                    Gerou sobra aproveitável?
                                </label>
                            </div>

                            {gerouSobra && (
                                <div className="grid grid-cols-2 gap-3 pl-6 animate-in fade-in">
                                    <div>
                                        <label className="block text-[10px] font-bold text-rose-800 uppercase mb-1">Diâmetro Útil</label>
                                        <input type="number" value={sobraDiametro} onChange={e => setSobraDiametro(e.target.value)} className={`${inputClass} h-9 border-rose-300 text-sm`} placeholder="Ex: 65" />
                                    </div>
                                    <div>
                                        <label className="block text-[10px] font-bold text-rose-800 uppercase mb-1">Olho</label>
                                        <select value={sobraOlho} onChange={e => setSobraOlho(e.target.value)} className={`${inputClass} h-9 border-rose-300 text-sm`}>
                                            <option value="OD">OD</option>
                                            <option value="OE">OE</option>
                                        </select>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {/* --- FIM DOS CAMPOS DE PERDA/QUEBRA --- */}

                    {(tipo === 'Saida' || tipo === 'Perda' || tipo === 'Brinde') && (selectedProduct.estoque - quantidade < 0) && (
                        <div className="flex items-center gap-2 text-xs font-bold text-amber-700 bg-amber-50 p-3 rounded-lg border border-amber-200">
                            <AlertTriangle className="h-4 w-4" />
                            Atenção: Estoque ficará negativo ({selectedProduct.estoque - quantidade}).
                        </div>
                    )}

                    <div className="flex gap-3 pt-2">
                        <button onClick={() => setStep('search')} className="flex-1 py-3 rounded-xl border border-gray-300 font-bold text-gray-600 hover:bg-gray-100 bg-white">Voltar</button>
                        <button 
                            onClick={handlePreSubmit} 
                            disabled={isSaving}
                            className={`flex-1 py-3 rounded-xl text-white font-bold shadow-md flex items-center justify-center gap-2
                                ${isEntrada ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}
                            `}
                        >
                            {isSaving ? <Loader2 className="h-5 w-5 animate-spin" /> : <Lock className="h-5 w-5" />}
                            Autorizar & Salvar
                        </button>
                    </div>
                </div>
            )}
        </div>
      </div>
    </div>

    {/* Modal de Autenticação */}
    {isAuthOpen && (
      <EmployeeAuthModal 
            storeId={storeId} 
            isOpen={isAuthOpen} 
            onClose={() => setIsAuthOpen(false)} 
            onSuccess={handleAuthSuccess}
            title="Autorizar Movimentação"
            description="Insira seu PIN para confirmar a alteração de estoque."
        />
    )}
    </>
  )
}

function ArrowLeftRightIcon({ tipo }: { tipo: string }) {
    if (tipo === 'Entrada') return <ArrowUpCircle className="h-5 w-5 text-green-600" />
    if (tipo === 'Ajuste') return <ArrowRight className="h-5 w-5 text-blue-600" />
    return <ArrowDownCircle className="h-5 w-5 text-red-600" />
}

==================================================
ARQUIVO: .\src\components\pos-venda\PostSalesInterface.tsx
==================================================
// Caminho: src/components/pos-venda/PostSalesInterface.tsx
'use client'

import { useState, useEffect, useRef, useTransition } from 'react'
import { 
  PostSaleQueueItem, 
  Interaction, 
  saveInteraction, 
  concludePostSale,
  getInteractions 
} from '@/lib/actions/postsales.actions'
import { 
  User, Phone, MessageCircle, Star, CheckCircle, 
  Clock, Send, Eye, Wallet, ExternalLink, Loader2, DollarSign 
} from 'lucide-react'
import Link from 'next/link'
// ADICIONE ESTAS DUAS LINHAS:
import { getPostSaleDetails } from '@/lib/actions/postsales.actions'
import SaleDetailsModal from '@/components/modals/SaleDetailsModal'

// Helpers
const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

function StarRating({ value, onChange }: { value: number, onChange: (v: number) => void }) {
    return (
        <div className="flex gap-2">
            {[1, 2, 3, 4, 5].map((star) => (
                <button
                    key={star}
                    type="button"
                    onClick={() => onChange(star)}
                    className={`p-1 transition-all hover:scale-125 focus:outline-none`}
                >
                    <Star 
                        className={`h-8 w-8 drop-shadow-sm ${star <= value ? 'fill-amber-400 text-amber-400' : 'text-gray-300'}`} 
                    />
                </button>
            ))}
        </div>
    )
}

export default function PostSalesInterface({ initialQueue, storeId }: { initialQueue: PostSaleQueueItem[], storeId: number }) {
    const [selectedId, setSelectedId] = useState<number | null>(null)
    const [interactions, setInteractions] = useState<Interaction[]>([])
    const [loadingHistory, setLoadingHistory] = useState(false)
    
    const [tipoContato, setTipoContato] = useState('WhatsApp')
    const [resumoMsg, setResumoMsg] = useState('')
    const [rating, setRating] = useState(0)
    const [obsFinal, setObsFinal] = useState('')

    const [detailsModalOpen, setDetailsModalOpen] = useState(false)
    const [detailsData, setDetailsData] = useState<any>(null)
    const [loadingDetails, setLoadingDetails] = useState(false)


    const [isPending, startTransition] = useTransition()
    const selectedItem = initialQueue.find(item => item.os_id === selectedId)

    useEffect(() => {
        if (selectedItem && selectedItem.post_sales_id) {
            setLoadingHistory(true)
            getInteractions(selectedItem.post_sales_id).then((data) => {
                setInteractions(data)
                setLoadingHistory(false)
            })
        } else {
            setInteractions([])
        }
    }, [selectedItem])

    const handleWhatsApp = () => {
        if (!selectedItem || !selectedItem.titular_tel) return alert("Telefone não cadastrado.")
        const num = selectedItem.titular_tel.replace(/\D/g, '')
        const nome = selectedItem.titular_nome.split(' ')[0]
        const msg = `Olá ${nome}, aqui é da Ótica. Como está a adaptação com os novos óculos?`
        window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`, '_blank')
    }

    const handleSaveInteraction = (formData: FormData) => {
        if (!selectedItem) return
        startTransition(async () => {
            const res = await saveInteraction(formData)
            if (res.success) {
                setResumoMsg('')
                if (selectedItem.post_sales_id) {
                    const hist = await getInteractions(selectedItem.post_sales_id)
                    setInteractions(hist)
                }
            } else alert(res.message)
        })
    }

    const handleConclude = () => {
        if (!selectedItem?.post_sales_id) return alert("Salve uma interação primeiro.")
        if (rating === 0) return alert("Avaliação obrigatória.")
        
        const formData = new FormData()
        formData.append('post_sales_id', selectedItem.post_sales_id.toString())
        formData.append('store_id', storeId.toString())
        formData.append('nota', rating.toString())
        formData.append('obs', obsFinal)

        startTransition(async () => {
            await concludePostSale(formData)
            setSelectedId(null)
        })
    }

    return (
        <div className="flex h-full gap-8">
            
            {/* --- PAINEL ESQUERDO (LISTA FLUTUANTE) --- */}
            <div className="w-80 bg-white/80 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/50 flex flex-col overflow-hidden">
                <div className="p-4 border-b border-gray-100 bg-white/50">
                    <h3 className="font-black text-slate-700 text-xs tracking-wider uppercase opacity-70">Fila de Adaptação</h3>
                </div>
                <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                    {initialQueue.length === 0 ? (
                        <div className="p-8 text-center text-gray-400 flex flex-col items-center">
                            <CheckCircle className="h-12 w-12 mb-3 text-emerald-400 opacity-50" />
                            <p className="text-sm font-medium">Nenhuma pendência.</p>
                        </div>
                    ) : (
                        initialQueue.map(item => (
                            <div 
                                key={item.os_id}
                                onClick={() => setSelectedId(item.os_id)}
                                className={`p-4 rounded-xl cursor-pointer transition-all duration-200 border relative group
                                    ${selectedId === item.os_id 
                                        ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 border-transparent scale-[1.02]' 
                                        : 'bg-white hover:bg-slate-50 border-transparent hover:border-slate-200 shadow-sm'
                                    }`}
                            >
                                <div className="flex justify-between items-start mb-1">
                                    <span className={`font-bold text-sm ${selectedId === item.os_id ? 'text-white' : 'text-slate-800'}`}>
                                        {item.dependente_nome}
                                    </span>
                                    {item.status === 'Em Acompanhamento' && (
                                        <span className="absolute top-4 right-4 h-2 w-2 rounded-full bg-amber-400 shadow-sm animate-pulse"></span>
                                    )}
                                </div>
                                <p className={`text-xs mt-1 flex items-center gap-1 ${selectedId === item.os_id ? 'text-blue-100' : 'text-slate-500'}`}>
                                    <Clock className="h-3 w-3" /> Há {item.dias_desde_entrega} dias
                                </p>
                            </div>
                        ))
                    )}
                </div>
            </div>

            {/* --- PAINEL DIREITO (CARTÕES DE DETALHES) --- */}
            <div className="flex-1 flex flex-col overflow-hidden">
                {selectedItem ? (
                    <div className="flex-1 overflow-y-auto pr-2 pb-10 space-y-6 custom-scrollbar">
                        
                        {/* CARD 1: CABEÇALHO DO CLIENTE */}
                        <div className="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 flex justify-between items-start animate-in slide-in-from-bottom-4 duration-300">
                            <div>
                                <h2 className="text-3xl font-black text-slate-800">{selectedItem.dependente_nome}</h2>
                                <div className="mt-2 flex gap-6 text-sm text-slate-500">
                                    <div className="flex items-center gap-2">
                                        <User className="h-4 w-4" /> 
                                        <span>Titular: <strong className="text-slate-700">{selectedItem.titular_nome}</strong></span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <Phone className="h-4 w-4" /> 
                                        <span>{selectedItem.titular_tel || 'Sem fone'}</span>
                                    </div>
                                </div>
                            </div>
                            <button 
                                onClick={handleWhatsApp}
                                className="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-3 rounded-xl shadow-emerald-200 shadow-lg font-bold flex items-center gap-2 transition-all hover:-translate-y-1"
                            >
                                <MessageCircle className="h-5 w-5" />
                                Mensagem de Adaptação
                            </button>
                        </div>

                        {/* CARD 2: SITUAÇÃO FINANCEIRA (NOVO) */}
                        <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl shadow-xl p-5 text-white flex items-center justify-between animate-in slide-in-from-bottom-6 duration-500">
                            <div className="flex items-center gap-6">
                                <div className="p-3 bg-white/10 rounded-lg backdrop-blur-sm">
                                    <Wallet className="h-6 w-6 text-emerald-400" />
                                </div>
                                <div>
                                    <p className="text-slate-400 text-xs font-bold uppercase mb-1">Status Financeiro</p>
                                    <div className="flex gap-6 items-baseline">
                                        <div>
                                            <span className="text-slate-400 text-xs mr-1">Total Venda</span>
                                            <span className="font-bold text-lg">{formatCurrency(selectedItem.valor_final)}</span>
                                        </div>
                                        <div className="h-8 w-px bg-white/20"></div>
                                        <div>
                                            <span className="text-slate-400 text-xs mr-1">A Receber</span>
                                            <span className={`font-bold text-2xl ${selectedItem.valor_restante > 0.01 ? 'text-amber-400' : 'text-emerald-400'}`}>
                                                {formatCurrency(selectedItem.valor_restante)}
                                            </span>
                                        </div>
                                        {selectedItem.tem_carne && (
                                            <span className="text-[10px] bg-white/20 px-2 py-1 rounded font-bold tracking-wide uppercase">Carnê Ativo</span>
                                        )}
                                    </div>
                                </div>
                            </div>
                            
<button 
                                onClick={async () => {
                                    setLoadingDetails(true)
                                    const res = await getPostSaleDetails(selectedItem.os_id)
                                    if (res.success) {
                                        setDetailsData(res.data)
                                        setDetailsModalOpen(true)
                                    } else {
                                        alert("Erro ao carregar detalhes: " + res.message)
                                    }
                                    setLoadingDetails(false)
                                }}
                                disabled={loadingDetails}
                                className="flex items-center gap-2 px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-sm font-bold text-white disabled:opacity-50"
                            >
                                {loadingDetails ? <Loader2 className="h-4 w-4 animate-spin"/> : <Eye className="h-4 w-4" />}
                                Ver Detalhes / Receita
                            </button>
                        </div>

                        {/* GRID DE DETALHES TÉCNICOS E AÇÕES */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            {/* COLUNA 1: TÉCNICO E HISTÓRICO */}
                            <div className="space-y-6">
                                {/* Card Técnico */}
                                <div className="bg-white rounded-2xl shadow-md border border-slate-100 p-5">
                                    <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <Eye className="h-5 w-5 text-blue-500" /> Dados da Lente
                                    </h3>
                                    <div className="bg-blue-50 rounded-xl p-4 border border-blue-100">
                                        <p className="text-sm text-blue-900 font-medium">{selectedItem.resumo_lente}</p>
                                        <p className="text-xs text-blue-600 mt-1 opacity-80">OS #{selectedItem.os_id}</p>
                                    </div>
                                </div>

                                {/* Timeline */}
                                <div className="bg-white rounded-2xl shadow-md border border-slate-100 p-5 min-h-[300px]">
                                    <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <Clock className="h-5 w-5 text-slate-400" /> Histórico
                                    </h3>
                                    <div className="space-y-4 pl-2">
                                        {loadingHistory ? <Loader2 className="animate-spin text-slate-300 mx-auto"/> : 
                                         interactions.length === 0 ? <p className="text-slate-300 italic text-sm">Sem interações.</p> :
                                         interactions.map(int => (
                                            <div key={int.id} className="relative pl-6 border-l-2 border-slate-100 pb-2">
                                                <div className="absolute -left-[5px] top-1 h-2.5 w-2.5 rounded-full bg-slate-300"></div>
                                                <div className="bg-slate-50 p-3 rounded-lg rounded-tl-none border border-slate-100">
                                                    <div className="flex justify-between text-xs text-slate-400 mb-1 font-bold uppercase tracking-wider">
                                                        <span>{int.tipo_contato}</span>
                                                        <span>{new Date(int.created_at).toLocaleDateString('pt-BR')}</span>
                                                    </div>
                                                    <p className="text-sm text-slate-700">{int.resumo}</p>
                                                </div>
                                            </div>
                                         ))
                                        }
                                    </div>
                                </div>
                            </div>

                            {/* COLUNA 2: AÇÃO E FECHAMENTO */}
                            <div className="space-y-6">
                                {/* Novo Registro */}
                                <div className="bg-white rounded-2xl shadow-lg border border-blue-100 overflow-hidden">
                                    <div className="bg-blue-50/50 p-4 border-b border-blue-100">
                                        <h3 className="font-bold text-blue-900 text-sm uppercase">Registrar Contato</h3>
                                    </div>
                                    <div className="p-5">
                                        <form action={handleSaveInteraction} className="space-y-3">
                                            <input type="hidden" name="os_id" value={selectedItem.os_id} />
                                            <input type="hidden" name="store_id" value={storeId} />
                                            <input type="hidden" name="post_sales_id" value={selectedItem.post_sales_id || ''} />
                                            
                                            <div className="flex gap-3">
                                                <select name="tipo" value={tipoContato} onChange={e => setTipoContato(e.target.value)} className="w-1/3 rounded-lg border-slate-300 text-sm h-10 focus:ring-blue-500">
                                                    <option>WhatsApp</option>
                                                    <option>Ligação</option>
                                                    <option>Presencial</option>
                                                </select>
                                                <input name="resumo" value={resumoMsg} onChange={e => setResumoMsg(e.target.value)} placeholder="O que foi conversado?" className="flex-1 rounded-lg border-slate-300 text-sm h-10 focus:ring-blue-500" required />
                                            </div>
                                            <button disabled={isPending} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg shadow-md shadow-blue-100 transition-all flex justify-center items-center gap-2 text-sm">
                                                {isPending ? <Loader2 className="animate-spin h-4 w-4"/> : <Send className="h-4 w-4"/>} Salvar Registro
                                            </button>
                                        </form>
                                    </div>
                                </div>

                                {/* Conclusão */}
                                <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                                    <div className="bg-slate-50 p-4 border-b border-slate-100">
                                        <h3 className="font-bold text-slate-700 text-sm uppercase">Encerrar Acompanhamento</h3>
                                    </div>
                                    <div className="p-6 flex flex-col items-center">
                                        <p className="text-sm text-slate-500 mb-4 font-medium">Como foi a adaptação do cliente?</p>
                                        <StarRating value={rating} onChange={setRating} />
                                        
                                        <textarea 
                                            value={obsFinal}
                                            onChange={e => setObsFinal(e.target.value)}
                                            placeholder="Considerações finais..."
                                            className="w-full mt-6 rounded-lg border-slate-200 bg-slate-50 text-sm p-3 h-20 resize-none focus:bg-white transition-colors focus:ring-slate-400 focus:border-slate-400"
                                        />

                                        <button 
                                            onClick={handleConclude}
                                            disabled={isPending || rating === 0}
                                            className="w-full mt-4 bg-green-600 hover:bg-green-700 disabled:bg-slate-200 disabled:text-slate-400 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-100 transition-all flex justify-center items-center gap-2"
                                        >
                                            <CheckCircle className="h-5 w-5" />
                                            CONCLUIR E ARQUIVAR
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                ) : (
                    <div className="h-full flex flex-col items-center justify-center text-slate-300">
                        <User className="h-24 w-24 mb-6 opacity-20" />
                        <p className="text-2xl font-light text-slate-400">Selecione um cliente</p>
                    </div>
                )}
                
            </div>
            <SaleDetailsModal 
                isOpen={detailsModalOpen} 
                onClose={() => setDetailsModalOpen(false)} 
                data={detailsData} 
            />

    </div> // <--- Esse fechamento final fecha o container principal ("flex h-full gap-8")
    )
}


==================================================
ARQUIVO: .\src\components\print\ReceiptCalibration.tsx
==================================================
export function ReceiptCalibration() {
    // Gera linhas a cada 10mm para ajudar a medir
    const rulers = Array.from({ length: 15 }).map((_, i) => (i + 1) * 10)

    return (
        <div className="relative w-[210mm] h-[148mm] bg-white text-black font-sans text-[10px] overflow-hidden border border-gray-300">
            
            {/* Título de Ajuda */}
            <div className="absolute top-2 left-2 font-bold text-red-600">
                MODO CALIBRAGEM (Imprima em escala 100%)
            </div>

            {/* RÉGUA VERTICAL (Eixo Y) */}
            {rulers.map(mm => (
                <div key={`y-${mm}`} className="absolute left-0 w-full border-t border-gray-400 flex items-center" style={{ top: `${mm}mm` }}>
                    <span className="bg-white pr-1 text-xs font-bold">{mm}mm</span>
                </div>
            ))}

            {/* RÉGUA HORIZONTAL (Eixo X) - Apenas alguns pontos chave */}
            {[20, 40, 60, 80, 100, 120, 140, 160, 180, 200].map(mm => (
                <div key={`x-${mm}`} className="absolute top-0 h-full border-l border-gray-200" style={{ left: `${mm}mm` }}>
                    <span className="bg-white pt-1 text-[8px]">{mm}</span>
                </div>
            ))}

            {/* SIMULAÇÃO DOS DADOS (Alvos) */}
            {/* Aqui tento acertar onde seus campos estão. Se errar, você me diz o quanto errei. */}

            {/* 1. ALVO: NOME DO CLIENTE */}
            <div className="absolute top-[48mm] left-[35mm] border border-red-500 text-red-600 px-1 bg-white/50">
                ALVO: NOME CLIENTE (Top:48mm / Left:35mm)
            </div>

            {/* 2. ALVO: VALOR R$ */}
            <div className="absolute top-[60mm] left-[80mm] border border-blue-500 text-blue-600 px-1 bg-white/50">
                VALOR (Top:60mm)
            </div>

            {/* 3. ALVO: CHECKBOXES (Tentativa) */}
            <div className="absolute left-[142mm] border-l border-green-500 pl-1" style={{ top: '65mm', height: '40mm' }}>
                <div className="absolute top-0 -left-1">├ 65mm (Prestação)</div>
                <div className="absolute top-[7mm] -left-1">├ 72mm (À Vista)</div>
                <div className="absolute top-[14mm] -left-1">├ 79mm (Cheque)</div>
                <div className="absolute top-[21mm] -left-1">├ 86mm (Dinheiro)</div>
                <div className="absolute top-[28mm] -left-1">├ 93mm (Cartão)</div>
                <div className="absolute top-[35mm] -left-1">├ 100mm (Pix)</div>
            </div>

            {/* 4. ALVO: DATA */}
            <div className="absolute top-[60mm] left-[175mm] w-[30mm] border border-purple-500 text-purple-600 text-center bg-white/50">
                DATA
            </div>

        </div>
    )
}

==================================================
ARQUIVO: .\src\components\print\ReceiptPhantom.tsx
==================================================
import { Database } from '@/lib/database.types'

type Pagamento = Database['public']['Tables']['pagamentos']['Row']
type Venda = Database['public']['Tables']['vendas']['Row']
type Cliente = Database['public']['Tables']['customers']['Row']
type Item = Database['public']['Tables']['venda_itens']['Row']

interface ReceiptData {
    pagamentos: Pagamento[]
    venda: Venda
    cliente: Cliente | null
    itens: Item[]
    isReprint?: boolean
}

const formatMoney = (val: number) => val.toLocaleString('pt-BR', { minimumFractionDigits: 2 })

export function ReceiptPhantom({ data }: { data: ReceiptData }) {
    const { pagamentos, cliente, itens, isReprint } = data

    // 1. Soma Total
    const valorTotalRecibo = pagamentos.reduce((acc, p) => acc + p.valor_pago, 0)

    // 2. Checkboxes (VOLTAMOS O TOP PARA O ORIGINAL)
    const formas = pagamentos.map(p => p.forma_pagamento.toLowerCase())
    const checkPositions: Record<string, number> = {
        'prestacao': 65,
        'vista': 72,
        'cheque': 79,
        'dinheiro': 86,
        'cartao': 93,
        'pix': 100
    }

    const checksToMark: number[] = []
    if (formas.some(f => f.includes('crédito') || f.includes('carnê'))) checksToMark.push(checkPositions['prestacao'])
    if (formas.some(f => f.includes('vista'))) checksToMark.push(checkPositions['vista'])
    if (formas.some(f => f.includes('cheque'))) checksToMark.push(checkPositions['cheque'])
    if (formas.some(f => f.includes('dinheiro'))) checksToMark.push(checkPositions['dinheiro'])
    if (formas.some(f => f.includes('cart'))) checksToMark.push(checkPositions['cartao'])
    if (formas.some(f => f.includes('pix'))) checksToMark.push(checkPositions['pix'])
    
    if (checksToMark.length === 0) checksToMark.push(checkPositions['vista'])

    // 3. Resumo e Data
    const resumoItens = itens.map(i => `${i.quantidade}x ${i.descricao}`).join(', ').substring(0, 80)
    const dataRef = new Date(pagamentos[0].created_at) 
    const obsTexto = `Ref. Pagamento(s) ${pagamentos.map(p => p.id).join(', ')} - ${resumoItens}`

    return (
        <div className="relative w-[297mm] h-[210mm] bg-white text-black font-sans text-sm font-bold overflow-hidden">
            
            {/* Marca d'água de Reimpressão */}
            {isReprint && (
                <div className="absolute top-[10mm] right-[40mm] text-gray-400/40 text-2xl border-4 border-gray-400/40 p-2 rounded-lg uppercase -rotate-12 font-black z-0 pointer-events-none tracking-widest">
                    REIMPRESSÃO
                </div>
            )}

            {/* 1. NOME (Top: 48mm | Left: 35+50 = 85mm) */}
            <div className="absolute top-[48mm] left-[85mm] w-[120mm] truncate uppercase text-lg">
                {cliente?.full_name}
            </div>

            {/* 2. VALOR TOTAL (Top: 60mm | Left: 80+50 = 130mm) */}
            <div className="absolute top-[60mm] left-[130mm] w-[40mm] text-right text-lg">
                {formatMoney(valorTotalRecibo)}
            </div>

            {/* 3. TOTAL REPETIDO (Top: 90mm | Left: 80+50 = 130mm) */}
            <div className="absolute top-[90mm] left-[130mm] w-[40mm] text-right text-xl">
                {formatMoney(valorTotalRecibo)}
            </div>

            {/* 4. CHECKBOXES (Left: 142+50 = 192mm) */}
            {checksToMark.map((topPos, idx) => (
                <div 
                    key={idx}
                    className="absolute left-[192mm] text-lg font-black" 
                    style={{ top: `${topPos}mm` }}
                >
                    X
                </div>
            ))}

            {/* 5. DATA (Top: 60mm | Left: +50mm em cada) */}
            {/* Dia: 175 -> 225mm */}
            <div className="absolute top-[60mm] left-[225mm]">{dataRef.getDate().toString().padStart(2, '0')}</div>
            {/* Mês: 185 -> 235mm */}
            <div className="absolute top-[60mm] left-[235mm]">{(dataRef.getMonth() + 1).toString().padStart(2, '0')}</div>
            {/* Ano: 195 -> 245mm */}
            <div className="absolute top-[60mm] left-[245mm]">{dataRef.getFullYear().toString().slice(-2)}</div>

            {/* 6. OBS (Top: 68mm | Left: 160+50 = 210mm) */}
            <div className="absolute top-[68mm] left-[210mm] w-[55mm] h-[20mm] text-[10px] leading-tight whitespace-normal break-words text-gray-800">
                {obsTexto}
            </div>

        </div>
    )
}

==================================================
ARQUIVO: .\src\components\print\ReceiptTemplates.tsx
==================================================
import { Database } from '@/lib/database.types'

// Tipos de dados que o template vai receber
type VendaCompleta = Database['public']['Tables']['vendas']['Row'] & {
    customers: Database['public']['Tables']['customers']['Row'] | null
    pagamentos: Database['public']['Tables']['pagamentos']['Row'][]
    store: { name: string } // Nome da loja
}

const formatMoney = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (d: string) => new Date(d).toLocaleDateString('pt-BR')

// ============================================================================
// TEMPLATE 1: CLÁSSICO (CÓPIA DO SEU PAPEL AZUL)
// ============================================================================
export function ReceiptClassic({ venda }: { venda: VendaCompleta }) {
    const pagamentos = venda.pagamentos || []
    
    // Detecta formas de pagamento para marcar o "X"
    const formas = pagamentos.map(p => p.forma_pagamento.toLowerCase())
    const isDinheiro = formas.some(f => f.includes('dinheiro'))
    const isCartao = formas.some(f => f.includes('cart') || f.includes('débito') || f.includes('crédito'))
    const isPix = formas.some(f => f.includes('pix'))
    const isCheque = formas.some(f => f.includes('cheque'))
    const isCreditoLoja = formas.some(f => f.includes('crédito em loja'))

    return (
        <div className="w-[210mm] border-2 border-black p-1 mx-auto my-4 text-sm font-sans bg-white text-black">
            {/* CABEÇALHO */}
            <div className="border border-black p-2 mb-1 flex justify-between items-center bg-gray-100 print:bg-gray-100">
                <div className="flex-1 text-center">
                    <h1 className="text-3xl font-black uppercase tracking-widest">{venda.store?.name || 'NOME DA ÓTICA'}</h1>
                    <p className="text-[10px] mt-1">Óculos, Lentes e Armações</p>
                </div>
                <div className="text-right pl-4">
                    <p className="text-xl font-bold text-red-600">Nº {venda.id}</p>
                </div>
            </div>

            {/* FAIXA DE GARANTIA E VENCIMENTO */}
            <div className="grid grid-cols-3 border border-black mb-1 text-center text-xs font-bold divide-x divide-black bg-gray-50 print:bg-gray-50">
                <div className="p-1">
                    PERÍODO DE GARANTIA
                    <p className="text-[10px] font-normal mt-1">3 Meses (Conf. CDC)</p>
                </div>
                <div className="p-1 flex flex-col justify-center">
                    Nº DA DUPLICATA
                    <span className="text-lg">{venda.id}/1</span>
                </div>
                <div className="p-1 flex flex-col justify-center">
                    VENCIMENTO
                    <span className="text-lg">À Vista</span>
                </div>
            </div>

            {/* CORPO DO RECIBO */}
            <div className="border border-black flex">
                
                {/* LADO ESQUERDO (VALORES) */}
                <div className="flex-1 border-r border-black">
                    {/* Linha Nome */}
                    <div className="border-b border-black p-2 flex items-end">
                        <span className="font-bold mr-2 w-16 text-xs uppercase">Nome:</span>
                        <span className="font-bold text-base flex-1 border-b border-dotted border-black">{venda.customers?.full_name}</span>
                    </div>

                    {/* Linha Valor Bruto */}
                    <div className="border-b border-black p-2 flex justify-between items-center h-12">
                        <span className="font-bold text-xs uppercase w-24">Valor R$</span>
                        <span className="font-bold text-xl">{formatMoney(venda.valor_total)}</span>
                    </div>

                    {/* Linha Desconto */}
                    <div className="border-b border-black p-2 flex justify-between items-center h-12 bg-gray-50 print:bg-gray-50">
                        <span className="font-bold text-xs uppercase w-24">Desconto</span>
                        <span className="font-bold text-lg text-black">{formatMoney(venda.valor_desconto)}</span>
                    </div>

                    {/* Linha TOTAL */}
                    <div className="p-2 flex justify-between items-center h-14 bg-gray-200 print:bg-gray-200">
                        <span className="font-black text-sm uppercase w-24">TOTAL R$</span>
                        <span className="font-black text-2xl">{formatMoney(venda.valor_final)}</span>
                    </div>
                </div>

                {/* LADO DIREITO (FORMA PAGTO E DATA) */}
                <div className="w-[40%] flex flex-col">
                    
                    {/* Checkboxes de Forma de Pagamento */}
                    <div className="flex-1 p-2 space-y-1 text-xs font-bold border-b border-black">
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 border border-black flex items-center justify-center`}>{isCheque ? 'X' : ''}</div> Cheque
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 border border-black flex items-center justify-center`}>{isDinheiro ? 'X' : ''}</div> Dinheiro
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 border border-black flex items-center justify-center`}>{isCartao ? 'X' : ''}</div> Cartão
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-4 h-4 border border-black flex items-center justify-center`}>{isPix ? 'X' : ''}</div> Pix
                        </div>
                        {isCreditoLoja && (
                             <div className="flex items-center gap-2">
                                <div className="w-4 h-4 border border-black flex items-center justify-center">X</div> Crédito
                            </div>
                        )}
                    </div>

                    {/* Data e Assinatura */}
                    <div className="h-24 p-2 flex flex-col justify-between">
                        <div className="flex justify-end gap-2 text-sm font-bold">
                            <span>DATA:</span>
                            <span className="border-b border-black w-24 text-center">{formatDate(venda.created_at)}</span>
                        </div>
                        <div className="text-center mt-4">
                            <div className="border-b border-black w-[90%] mx-auto"></div>
                            <p className="text-[10px] font-bold mt-1">Assinatura</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div className="text-[10px] text-right mt-1 pr-1 italic">
                Documento não fiscal - Controle Interno
            </div>
        </div>
    )
}

// ============================================================================
// TEMPLATE 2: TÉRMICO (BOBINA 80MM - MODERNO)
// ============================================================================
export function ReceiptThermal({ venda }: { venda: VendaCompleta }) {
    const pagamentos = venda.pagamentos || []

    return (
        <div className="w-[80mm] p-2 font-mono text-xs bg-white text-black">
            <div className="text-center border-b border-dashed border-black pb-2 mb-2">
                <h2 className="text-sm font-bold uppercase">{venda.store?.name}</h2>
                <p>Recibo de Venda #{venda.id}</p>
                <p>{new Date(venda.created_at).toLocaleString('pt-BR')}</p>
            </div>

            <div className="mb-2">
                <p><strong>Cliente:</strong> {venda.customers?.full_name}</p>
            </div>

            <table className="w-full mb-2">
                <tbody>
                    <tr>
                        <td className="py-1">Subtotal</td>
                        <td className="text-right">{formatMoney(venda.valor_total)}</td>
                    </tr>
                    {venda.valor_desconto > 0 && (
                        <tr>
                            <td className="py-1">Desconto</td>
                            <td className="text-right">-{formatMoney(venda.valor_desconto)}</td>
                        </tr>
                    )}
                    <tr className="font-bold text-sm">
                        <td className="py-1 border-t border-dashed border-black">TOTAL</td>
                        <td className="text-right border-t border-dashed border-black">{formatMoney(venda.valor_final)}</td>
                    </tr>
                </tbody>
            </table>

            <div className="border-t border-dashed border-black pt-2 mb-4">
                <p className="font-bold mb-1">Pagamentos:</p>
                {pagamentos.map((pg, i) => (
                    <div key={i} className="flex justify-between">
                        <span>{pg.forma_pagamento} ({pg.parcelas}x)</span>
                        <span>{formatMoney(pg.valor_pago)}</span>
                    </div>
                ))}
            </div>

            <div className="text-center text-[10px] mt-4">
                <p>Obrigado pela preferência!</p>
                <p>*** NÃO É DOCUMENTO FISCAL ***</p>
            </div>
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\relatorios\TabelaVendas.tsx
==================================================
// Caminho: src/components/relatorios/TabelaVendas.tsx
'use client'

import { useState, useMemo } from 'react'
import { 
  useReactTable, 
  getCoreRowModel, 
  getFilteredRowModel, 
  getSortedRowModel,
  flexRender, 
  createColumnHelper,
  SortingState
} from '@tanstack/react-table'
import { VendaRelatorioItem } from '@/lib/actions/reports.actions'
import { ArrowUp, ArrowDown, ArrowUpDown, ExternalLink } from 'lucide-react'
import Link from 'next/link'

// Helpers
const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
const formatDate = (d: string) => new Date(d).toLocaleDateString('pt-BR')

// --- COMPONENTE DE FILTRO DA COLUNA ---
function Filter({ column }: { column: any }) {
  const columnFilterValue = column.getFilterValue()
  
  return (
    <div className="mt-2" onClick={e => e.stopPropagation()}>
      <input
        type="text"
        value={(columnFilterValue ?? '') as string}
        onChange={e => column.setFilterValue(e.target.value)}
        placeholder={`Buscar...`}
        className="w-full border border-gray-300 rounded px-2 py-1 text-[10px] text-gray-600 focus:outline-none focus:border-blue-500 font-normal bg-white"
      />
    </div>
  )
}

export default function TabelaVendas({ data, storeId }: { data: VendaRelatorioItem[], storeId: number }) {
  const [sorting, setSorting] = useState<SortingState>([])
  
  const columnHelper = createColumnHelper<VendaRelatorioItem>()

  // --- DEFINIÇÃO DAS COLUNAS ---
  const columns = useMemo(() => [
    columnHelper.accessor('id', {
      header: 'ID',
      cell: info => <span className="font-bold text-gray-700">#{info.getValue()}</span>,
      size: 70,
    }),
    
    columnHelper.accessor('data', {
      header: 'Data',
      cell: info => formatDate(info.getValue()),
      filterFn: (row, columnId, filterValue) => {
          const dateStr = formatDate(row.getValue(columnId))
          return dateStr.includes(filterValue)
      },
      size: 100,
    }),

    columnHelper.accessor('cliente', {
      header: 'Cliente',
      cell: info => <span className="truncate block" title={info.getValue()}>{info.getValue()}</span>,
      size: 200,
    }),
    columnHelper.accessor('vendedor', {
      header: 'Vendedor',
      cell: info => <span className="truncate block">{info.getValue()}</span>,
      size: 120,
    }),
    columnHelper.accessor('itens_resumo', {
      header: 'Produtos (Resumo)',
      cell: info => (
        <div className="text-[10px] text-gray-500 truncate" title={info.getValue()}>
            {info.getValue()}
        </div>
      ),
      enableSorting: false, 
      size: 250,
    }),
    columnHelper.accessor('status', {
      header: 'Status',
      cell: info => {
        const val = info.getValue()
        let color = 'bg-gray-100 text-gray-600'
        if(val === 'Fechada') color = 'bg-green-100 text-green-700'
        if(val === 'Cancelada') color = 'bg-red-100 text-red-700'
        if(val === 'Em Aberto') color = 'bg-yellow-100 text-yellow-800'
        
        return <span className={`px-1.5 py-0.5 rounded text-[10px] font-bold uppercase ${color}`}>{val}</span>
      },
      size: 110,
    }),

    // CORREÇÃO DOS FILTROS DE VALORES:
    // Removemos R$, espaços e pontos (.) antes de comparar. 
    // Assim "1.040" vira "1040" e o input "1040" dá match.
    columnHelper.accessor('valor_total', {
      header: 'Total',
      cell: info => <span className="text-gray-600">{formatCurrency(info.getValue())}</span>,
      filterFn: (row, columnId, filterValue) => {
          const valStr = formatCurrency(row.getValue(columnId))
          // Normaliza: remove "R$", espaços e pontos de milhar. Mantém a vírgula.
          const normalizedVal = valStr.replace(/[R$\s.]/g, '')
          const normalizedFilter = filterValue.replace(/[R$\s.]/g, '')
          return normalizedVal.includes(normalizedFilter)
      },
      meta: { isNumeric: true },
      size: 100,
    }),
    columnHelper.accessor('valor_pago', {
        header: 'Pago',
        cell: info => <span className="text-blue-700 font-bold">{formatCurrency(info.getValue())}</span>,
        filterFn: (row, columnId, filterValue) => {
            const valStr = formatCurrency(row.getValue(columnId))
            const normalizedVal = valStr.replace(/[R$\s.]/g, '')
            const normalizedFilter = filterValue.replace(/[R$\s.]/g, '')
            return normalizedVal.includes(normalizedFilter)
        },
        meta: { isNumeric: true },
        size: 100,
    }),
    columnHelper.accessor('saldo_devedor', {
        header: 'Devedor',
        cell: info => {
            const val = info.getValue()
            return <span className={`${val > 0.01 ? 'text-red-600 bg-red-50 px-1 rounded' : 'text-gray-300'} font-bold`}>{formatCurrency(val)}</span>
        },
        filterFn: (row, columnId, filterValue) => {
            const valStr = formatCurrency(row.getValue(columnId))
            const normalizedVal = valStr.replace(/[R$\s.]/g, '')
            const normalizedFilter = filterValue.replace(/[R$\s.]/g, '')
            return normalizedVal.includes(normalizedFilter)
        },
        meta: { isNumeric: true },
        size: 100,
    }),

columnHelper.display({
        id: 'actions',
        header: 'Ver',
        cell: (props) => (
            <Link 
                href={`/dashboard/loja/${storeId}/vendas/${props.row.original.id}`}
                // REMOVIDO: target="_blank"
                className="flex justify-center items-center text-blue-500 hover:text-blue-700 hover:bg-blue-50 w-8 h-8 rounded transition-colors"
                title="Abrir Venda"
            >
                <ExternalLink className="h-4 w-4" />
            </Link>
        ),
        size: 50,
        enableResizing: false,
    })
  ], [storeId])

  const table = useReactTable({
    data,
    columns,
    state: { sorting },
    onSortingChange: setSorting,
    columnResizeMode: 'onChange',
    getCoreRowModel: getCoreRowModel(),
    getFilteredRowModel: getFilteredRowModel(), 
    getSortedRowModel: getSortedRowModel(), 
  })

  // Dados processados para o rodapé e corpo
  const rows = table.getRowModel().rows 
  
  const totalGeral = rows.reduce((acc, row) => acc + row.original.valor_final, 0)
  const totalPago = rows.reduce((acc, row) => acc + row.original.valor_pago, 0)
  const totalDevedor = rows.reduce((acc, row) => acc + row.original.saldo_devedor, 0)

  return (
    <div className="flex flex-col h-full bg-white border border-gray-300 rounded shadow-sm overflow-hidden text-xs">
      <div className="flex-1 overflow-auto w-full">
        <table className="w-full text-left border-collapse" style={{ width: table.getTotalSize() }}>
          
          <thead className="bg-gray-100 text-gray-700 sticky top-0 z-10 shadow-sm">
            {table.getHeaderGroups().map(headerGroup => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map(header => (
                  <th 
                    key={header.id} 
                    colSpan={header.colSpan}
                    className="relative p-2 border-b border-r border-gray-300 last:border-r-0 font-bold uppercase tracking-wider group align-top"
                    style={{ width: header.getSize() }}
                  >
                    <div 
                        className={`flex items-center gap-1 cursor-pointer select-none mb-1 ${header.column.getCanSort() ? 'hover:text-blue-600' : ''}`}
                        onClick={header.column.getToggleSortingHandler()}
                    >
                      {flexRender(header.column.columnDef.header, header.getContext())}
                      
                      {header.column.getCanSort() && (
                          <span className="ml-1">
                              {{
                                asc: <ArrowUp className="h-3 w-3 text-blue-600" />,
                                desc: <ArrowDown className="h-3 w-3 text-blue-600" />,
                              }[header.column.getIsSorted() as string] ?? <ArrowUpDown className="h-3 w-3 text-gray-500" />}
                          </span>
                      )}
                    </div>
                    
                    {header.column.getCanFilter() ? (
                        <Filter column={header.column} />
                    ) : null}

                    <div
                        onMouseDown={header.getResizeHandler()}
                        onTouchStart={header.getResizeHandler()}
                        className={`absolute right-0 top-0 h-full w-[4px] cursor-col-resize select-none touch-none hover:bg-blue-400 ${
                            header.column.getIsResizing() ? 'bg-blue-600 opacity-100' : 'opacity-0 group-hover:opacity-100'
                        }`}
                    />
                  </th>
                ))}
              </tr>
            ))}
          </thead>

          <tbody className="divide-y divide-gray-200">
            {rows.length === 0 ? (
                <tr>
                    <td colSpan={columns.length} className="p-10 text-center text-gray-400">
                        Nenhum registro encontrado.
                    </td>
                </tr>
            ) : (
                rows.map((row, i) => (
                <tr 
                    key={row.id} 
                    className={`hover:bg-blue-50 transition-colors ${i % 2 === 0 ? 'bg-white' : 'bg-gray-100'}`} 
                >
                    {row.getVisibleCells().map(cell => (
                    <td 
                        key={cell.id} 
                        className={`p-1.5 border-r border-gray-200 last:border-r-0 text-gray-700 whitespace-nowrap overflow-hidden text-ellipsis ${(cell.column.columnDef.meta as any)?.isNumeric ? 'text-right' : ''}`}
                        style={{ width: cell.column.getSize() }}
                    >
                        {flexRender(cell.column.columnDef.cell, cell.getContext())}
                    </td>
                    ))}
                </tr>
                ))
            )}
          </tbody>
          
          <tfoot className="bg-gray-800 text-white sticky bottom-0 z-10 font-bold">
             <tr>
                <td className="p-2 border-r border-gray-600">Total: {rows.length}</td>
                <td colSpan={5} className="p-2 border-r border-gray-600 text-right">TOTAIS VISÍVEIS:</td>
                <td className="p-2 border-r border-gray-600 text-right">{formatCurrency(totalGeral)}</td>
                <td className="p-2 border-r border-gray-600 text-right text-emerald-300">{formatCurrency(totalPago)}</td>
                <td className="p-2 border-r border-gray-600 text-right text-red-300">{formatCurrency(totalDevedor)}</td>
                <td></td>
             </tr>
          </tfoot>
        </table>
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\AddItemForm.tsx
==================================================
//============================
//📄 ARQUIVO: src/components/vendas/AddItemForm.tsx
//============================

'use client'

import { useState, useEffect, useRef, KeyboardEvent } from 'react'
import { useFormStatus, useFormState } from 'react-dom'
import {
  addVendaItem,
  searchProductCatalog, 
  type SaveVendaItemResult,
  type ProductSearchResult
} from '@/lib/actions/vendas.actions'
import { Loader2, PlusCircle, Search, ScanBarcode, Box } from 'lucide-react'

type AddItemFormProps = {
  vendaId: number
  storeId: number
  onItemAdded: () => Promise<void> 
  disabled: boolean
}

const formatCurrency = (value: number | null | undefined): string => {
  return (value || 0).toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  })
}

const parseLocaleFloat = (stringNumber: string | null | undefined): number => {
  if (!stringNumber) return 0.0
  const cleaned = stringNumber.replace(/\./g, '').replace(',', '.')
  return parseFloat(cleaned) || 0.0
}

function SubmitButton() {
  const { pending } = useFormStatus()
  return (
    <button
      type="submit"
      disabled={pending}
      className="flex items-center justify-center gap-2 w-full h-10 bg-white/20 hover:bg-white/30 text-white border border-white/40 rounded-xl shadow-sm backdrop-blur-sm transition-all font-bold uppercase tracking-wide text-sm active:scale-95"
      title="Adicionar Item"
    >
      {pending ? (
        <Loader2 className="h-5 w-5 animate-spin" />
      ) : (
        <>
            <PlusCircle className="h-5 w-5" />
            <span>ADICIONAR</span>
        </>
      )}
    </button>
  )
}

export default function AddItemForm({
  vendaId,
  storeId,
  onItemAdded,
  disabled,
}: AddItemFormProps) {
  const formRef = useRef<HTMLFormElement>(null)
  const dropdownRef = useRef<HTMLDivElement>(null)

  const [itemTipo, setItemTipo] = useState<'Lente' | 'Armacao' | 'Tratamento' | 'Servico' | 'Outro'>('Lente')
  const [descricao, setDescricao] = useState('')
  const [quantidade, setQuantidade] = useState(1)
  const [valorUnitario, setValorUnitario] = useState('0,00')

  const [selectedIds, setSelectedIds] = useState({
    lente_id: null as number | null,
    armacao_id: null as number | null,
    tratamento_id: null as number | null,
  })

  const [suggestions, setSuggestions] = useState<ProductSearchResult[]>([])
  const [isDropdownOpen, setIsDropdownOpen] = useState(false)
  const [isSearching, setIsSearching] = useState(false)

  const initialState: SaveVendaItemResult = { success: false, message: '' }
  const [saveState, dispatchSave] = useFormState(addVendaItem, initialState)
  
  const lastStateRef = useRef(initialState);

  useEffect(() => {
    if (saveState !== lastStateRef.current && saveState.success) {
      formRef.current?.reset()
      setDescricao('')
      setQuantidade(1)
      setValorUnitario('0,00')
      setSelectedIds({ lente_id: null, armacao_id: null, tratamento_id: null })
      onItemAdded() 
    }
    lastStateRef.current = saveState;
  }, [saveState, onItemAdded])

  // LÓGICA DE BUSCA GLOBAL (Ignora o tipo selecionado inicialmente) [cite: 1132]
  useEffect(() => {
    if (descricao.trim().length < 2) {
        setSuggestions([])
        setIsDropdownOpen(false)
        return
    }

    // Se já temos um ID selecionado (clicou na sugestão), não busca de novo
    const currentId = itemTipo === 'Lente' ? selectedIds.lente_id 
                    : itemTipo === 'Armacao' ? selectedIds.armacao_id 
                    : itemTipo === 'Tratamento' ? selectedIds.tratamento_id : null;
    
    if (currentId) return; 

    setIsSearching(true)
    const timer = setTimeout(() => {
        // ATUALIZAÇÃO: Passa 'Todos' para buscar em tudo
        searchProductCatalog(descricao, storeId, 'Todos').then(result => {
            if (result.success && result.data) {
                setSuggestions(result.data)
                setIsDropdownOpen(result.data.length > 0)
            }
            setIsSearching(false)
        })
    }, 300)

    return () => clearTimeout(timer)
  }, [descricao, storeId, selectedIds, itemTipo])

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setDescricao(e.target.value)
    setSelectedIds({ lente_id: null, armacao_id: null, tratamento_id: null })
  }

// ATUALIZAÇÃO: Troca o tipo automaticamente ao clicar [cite: 1133]
  const handleSuggestionClick = (item: ProductSearchResult) => {
    setDescricao(item.descricao)
    setValorUnitario(formatCurrency(item.preco_venda))
    
    // 1. Define o Tipo com base no retorno do backend
    setItemTipo(item.tipo)
    
    // 2. Define o ID correto
    if (item.tipo === 'Lente') setSelectedIds({ ...selectedIds, lente_id: item.id })
    else if (item.tipo === 'Armacao') setSelectedIds({ ...selectedIds, armacao_id: item.id })
    else if (item.tipo === 'Tratamento') setSelectedIds({ ...selectedIds, tratamento_id: item.id })
    else setSelectedIds({ lente_id: null, armacao_id: null, tratamento_id: null })
    
    setIsDropdownOpen(false)
    setSuggestions([])
  }
  
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsDropdownOpen(false)
      }
    }
    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
        e.preventDefault();
    }
  }

  const handleTypeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
      setItemTipo(e.target.value as any);
      // Se o usuário trocar o tipo manualmente, limpamos o ID para evitar inconsistência
      setSelectedIds({ lente_id: null, armacao_id: null, tratamento_id: null });
  }

  const labelStyle = 'block text-[10px] font-bold text-blue-100 mb-1 uppercase tracking-wider' 
  const inputStyle = 'block w-full rounded-lg border-0 bg-white shadow-sm text-gray-800 h-10 text-sm px-3 focus:ring-2 focus:ring-blue-300 focus:outline-none disabled:bg-gray-100 disabled:text-gray-400 placeholder:text-gray-400 transition-all'

  return (
    <div className="relative bg-gradient-to-br from-blue-600 to-indigo-600 p-5 rounded-2xl shadow-lg shadow-blue-200 border border-white/20">
      
      <div className="flex items-center gap-2 mb-4 border-b border-white/20 pb-3">
         <div className="p-1.5 bg-white/20 rounded-lg text-white">
            <ScanBarcode className="h-5 w-5" />
         </div>
         <h3 className="text-sm font-bold text-white">
            Adicionar Produto
         </h3>
      </div>
      
      <form ref={formRef} action={dispatchSave} className="space-y-4">
        <input type="hidden" name="venda_id" value={vendaId} />
        <input type="hidden" name="lente_id" value={selectedIds.lente_id ?? ''} />
        <input type="hidden" name="armacao_id" value={selectedIds.armacao_id ?? ''} />
        <input type="hidden" name="tratamento_id" value={selectedIds.tratamento_id ?? ''} />
        <input type="hidden" name="valor_unitario" value={parseLocaleFloat(valorUnitario)} />

        <div className="grid grid-cols-12 gap-3 items-end">
            
          {/* ATUALIZAÇÃO VISUAL: Inverti a ordem das colunas no grid [cite: 1136] */}
            
            {/* 1. Descrição / Busca (Agora é o primeiro, col-span maior) */}
            <div className="col-span-6 md:col-span-6 relative" ref={dropdownRef}>
                <label className={labelStyle}>Descrição / Busca</label>
                <div className="relative">
                    <input 
                        name="descricao" 
                        type="text" 
                        value={descricao} 
                        onChange={handleInputChange}
                        onKeyDown={handleKeyDown}
                        disabled={disabled}
                        placeholder="Digite nome ou código..."
                        className={`${inputStyle} pr-9 font-medium`}
                        autoComplete="off"
                        autoFocus
                    />
                    <div className="absolute right-3 top-2.5 text-gray-400">
                        {isSearching ? <Loader2 className="h-5 w-5 animate-spin text-blue-500" /> : <Search className="h-5 w-5" />}
                    </div>
                </div>

                {/* Dropdown de Sugestões */}
                {isDropdownOpen && suggestions.length > 0 && (
                    <div className="absolute z-50 w-full mt-2 bg-white rounded-xl shadow-2xl max-h-60 overflow-y-auto border border-gray-100 ring-1 ring-black ring-opacity-5 animate-in fade-in slide-in-from-top-2">
                        {suggestions.map((item) => (
                            <div 
                                key={`${item.tipo}-${item.id}`}
                                onClick={() => handleSuggestionClick(item)}
                                className="px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 group transition-colors"
                            >
                                <div className="flex justify-between items-center">
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-gray-800 group-hover:text-blue-700">{item.descricao}</span>
                                            <span className="text-[9px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border uppercase">{item.tipo}</span>
                                        </div>
                                        {item.detalhes && <span className="text-xs text-gray-400 mt-0.5">{item.detalhes}</span>}
                                    </div>
                                    <span className="text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded text-xs group-hover:bg-white">
                                        {formatCurrency(item.preco_venda)}
                                    </span>
                                </div>
                            </div>
                        ))}
                     </div>
                )}
            </div>

            {/* 2. Tipo (Agora é o segundo, col-span menor) */}
            <div className="col-span-2 md:col-span-2">
                <label className={labelStyle}>Tipo</label>
                <div className="relative">
                    <select 
                        name="item_tipo" 
                        value={itemTipo} 
                        onChange={handleTypeChange} 
                        disabled={disabled}
                        className={`${inputStyle} font-bold cursor-pointer appearance-none text-xs px-2`}
                    >
                        <option value="Lente">Lente</option>
                        <option value="Armacao">Armação</option>
                        <option value="Tratamento">Trat.</option>
                        <option value="Servico">Serv.</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
            </div>

            {/* 3. Qtd */}
            <div className="col-span-2 md:col-span-2">
                <label className={labelStyle}>Qtd.</label>
                <input 
                    name="quantidade" 
                    type="number" 
                    min="1" 
                    value={quantidade} 
                    onChange={e => setQuantidade(parseInt(e.target.value) || 1)}
                    disabled={disabled}
                    className={`${inputStyle} text-center font-bold`} 
                />
            </div>

            {/* 4. Valor */}
            <div className="col-span-2 md:col-span-2">
                <label className={labelStyle}>Valor</label>
                <input 
                    type="text" 
                    value={valorUnitario} 
                    onChange={e => setValorUnitario(e.target.value)}
                    disabled={disabled}
                    className={`${inputStyle} text-right font-bold text-green-600`} 
                />
            </div>
        </div>

        <div className="pt-2">
            <SubmitButton />
        </div>
        
        {saveState.message && !saveState.success && (
            <div className="p-3 rounded-lg bg-red-500/10 border border-red-200/20 text-white text-xs font-bold text-center backdrop-blur-md">
                {saveState.message}
            </div>
        )}
      </form>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\AddPagamentoForm.tsx
==================================================
//============================
//📄 ARQUIVO: src/components/vendas/AddPagamentoForm.tsx
//============================

'use client'

import { useState, useEffect, useRef } from 'react'
import { useFormState, useFormStatus } from 'react-dom'
import {
  addPagamento,
  type SavePagamentoResult,
} from '@/lib/actions/vendas.actions'
import { Loader2, DollarSign, X, AlertCircle, CheckCircle2, Wallet } from 'lucide-react'
import EmployeeAuthModal from '@/components/modals/EmployeeAuthModal'
import { Database } from '@/lib/database.types'

type Employee = Database['public']['Tables']['employees']['Row']

type AddPagamentoFormProps = {
  vendaId: number
  customerId: number
  storeId: number
  valorRestante: number
  onPaymentAdded: () => Promise<void>
  disabled: boolean
  isQuitado?: boolean
  isModal?: boolean 
}

const formatCurrency = (value: number | null | undefined): string => {
  return (value || 0).toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  })
}
const getToday = (): string => new Date().toISOString().split('T')[0]

function SubmitFinalButton({ employeeName }: { employeeName: string | null }) {
    const { pending } = useFormStatus()
   
    return (
     <button
        type="submit"
        disabled={pending || !employeeName}
        className="flex items-center justify-center gap-2 w-full h-10 bg-white/20 hover:bg-white/30 text-white border border-white/40 rounded-xl shadow-sm backdrop-blur-sm transition-all font-bold uppercase tracking-wide text-sm active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
        title={!employeeName ? "Autentique o vendedor" : `Registrar por: ${employeeName}`}
      >
         {pending ? <Loader2 className="h-5 w-5 animate-spin" /> 
         : <><CheckCircle2 className="h-5 w-5" /><span>CONFIRMAR</span></>}
      </button>
    )
}

export default function AddPagamentoForm({
  vendaId,
  customerId,
  storeId,
  valorRestante,
  onPaymentAdded,
  disabled,
  isQuitado = false,
  isModal = false,
}: AddPagamentoFormProps) {
  
  const formRef = useRef<HTMLFormElement>(null)
  const lastProcessedTs = useRef<number>(0)

  const initialState: SavePagamentoResult = { success: false, message: '' }
  const [saveState, dispatchSave] = useFormState(addPagamento, initialState)
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [authedEmployee, setAuthedEmployee] = useState<Pick<Employee, 'id' | 'full_name'> | null>(null)
  
  const [valorPago, setValorPago] = useState(formatCurrency(valorRestante))
  const [formaPagamento, setFormaPagamento] = useState('PIX')
  const [parcelas, setParcelas] = useState(1)
  const [dataPagamento, setDataPagamento] = useState(getToday())
  const [obs, setObs] = useState<string>('')

  // LÓGICA DE CONTROLE DO CAMPO PARCELAS
  const isParcelable = formaPagamento === 'Cartão Crédito' || formaPagamento === 'Cheque-Pré'

  // Resetar para 1x se mudar para método não parcelável
  useEffect(() => {
    if (!isParcelable) {
        setParcelas(1)
    }
  }, [formaPagamento, isParcelable])

  useEffect(() => {
    if (saveState.success && saveState.timestamp && saveState.timestamp > lastProcessedTs.current) {
        lastProcessedTs.current = saveState.timestamp 
        setAuthedEmployee(null); 
        setObs(''); 
        onPaymentAdded(); 
    }
  }, [saveState, onPaymentAdded])
  
  useEffect(() => { setValorPago(formatCurrency(valorRestante)); }, [valorRestante])
  
  useEffect(() => {
    if (authedEmployee && formRef.current) {
        formRef.current.requestSubmit();
    }
  }, [authedEmployee])
  
  const handleAuthSuccess = (employee: Pick<Employee, 'id' | 'full_name'>) => {
    setAuthedEmployee(employee)
    setIsModalOpen(false)
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !authedEmployee) {
      e.preventDefault();
    }
  }

  const isBloqueado = disabled || isQuitado;

  const labelStyle = 'block text-[10px] font-bold text-emerald-100 mb-1 uppercase tracking-wider'
  const inputStyle = 'block w-full rounded-lg border-0 bg-white shadow-sm text-gray-800 h-10 text-sm px-3 focus:ring-2 focus:ring-emerald-300 focus:outline-none disabled:bg-gray-100 disabled:text-gray-400 placeholder:text-gray-400 transition-all'

  const containerClass = isModal 
    ? "bg-white p-4 h-full flex flex-col" 
    : "relative bg-gradient-to-br from-emerald-600 to-teal-600 p-5 rounded-2xl shadow-lg shadow-emerald-200 border border-white/20 flex flex-col";

  return (
    <div className={containerClass}>
      
      {!isModal && (
        <div className="flex items-center gap-2 mb-4 border-b border-white/20 pb-3">
            <div className="p-1.5 bg-white/20 rounded-lg text-white">
                <Wallet className="h-5 w-5" />
            </div>
            <h3 className="text-sm font-bold text-white">
                Registrar Pagamento
            </h3>
        </div>
      )}
      
      {authedEmployee && (
        <div className="mb-4">
            <div className="text-xs font-bold p-2 bg-white/90 rounded-lg text-emerald-800 flex justify-between items-center animate-in fade-in slide-in-from-top-1 shadow-sm">
                <span>Autorizado por: {authedEmployee.full_name}</span>
                <button type="button" onClick={() => setAuthedEmployee(null)}><X className="h-4 w-4 hover:text-red-600" /></button>
            </div>
        </div>
      )}

      <form ref={formRef} action={dispatchSave} className="flex-1 flex flex-col space-y-4">
       <div className={`space-y-4 flex-1 ${isBloqueado ? 'opacity-50 pointer-events-none' : ''}`}>
          <input type="hidden" name="venda_id" value={vendaId} />
          <input type="hidden" name="customer_id" value={customerId} />
          <input type="hidden" name="employee_id" value={authedEmployee?.id ?? ''} />
          
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className={isModal ? 'text-xs font-bold text-gray-500' : labelStyle}>Valor (R$)</label>
              <input
                name="valor_pago"
                type="text"
                value={valorPago}
                onChange={(e) => setValorPago(e.target.value)}
                onKeyDown={handleKeyDown}
                className={`${inputStyle} font-bold text-emerald-700 text-right text-lg`}
              />
            </div>
            <div>
              <label className={isModal ? 'text-xs font-bold text-gray-500' : labelStyle}>Forma</label>
              <select
                name="forma_pagamento"
                value={formaPagamento}
                onChange={(e) => setFormaPagamento(e.target.value)}
                className={`${inputStyle} font-bold cursor-pointer`}
              >
                <option value="PIX">PIX</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cartão Débito">Cartão Débito</option>
                <option value="Cartão Crédito">Cartão Crédito</option>
                <option value="Cheque-Pré">Cheque-Pré</option>
                <option value="Transferência">Transferência</option>
                <option value="Boleto">Boleto</option>
                <option value="Crédito em Loja">Crédito em Loja</option>
              </select>
            </div>
          </div>
          
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className={isModal ? 'text-xs font-bold text-gray-500' : labelStyle}>Parcelas</label>
              <select 
                name="parcelas"
                value={parcelas} 
                onChange={(e) => setParcelas(parseInt(e.target.value))} 
                // AQUI: Campo inativo se não for cartão ou cheque
                disabled={!isParcelable || isBloqueado}
                className={`${inputStyle} cursor-pointer ${!isParcelable ? 'bg-gray-100 text-gray-400' : ''}`}
              >
                {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}x</option>)}
              </select>
            </div>
          
            <div>
              <label className={isModal ? 'text-xs font-bold text-gray-500' : labelStyle}>Data</label>
              <input 
                type="date" 
                name="data_pagamento"
                value={dataPagamento} 
                onChange={(e) => setDataPagamento(e.target.value)} 
                className={inputStyle}
              />
            </div>
          </div>
          
          <div>
            <label className={isModal ? 'text-xs font-bold text-gray-500' : labelStyle}>Observação</label>
            <input 
                name="obs" 
                type="text" 
                value={obs} 
                onChange={(e) => setObs(e.target.value)} 
                onKeyDown={handleKeyDown}
                className={inputStyle}
                placeholder="Ex: Sinal óculos..."
            />
          </div>
       </div>

       {saveState.message && !saveState.success && (
           <div className="bg-red-500/20 border border-red-200/30 text-white text-xs font-bold p-3 rounded-xl flex items-center gap-2 animate-in fade-in backdrop-blur-sm">
               <AlertCircle className="h-4 w-4 flex-shrink-0" />
               {saveState.message}
           </div>
        )}

        <div className="pt-2">
            {isQuitado ? (
                <div className="flex items-center justify-center gap-2 px-4 py-3 text-sm rounded-xl w-full bg-white/20 text-white border border-white/30 font-bold">
                    <CheckCircle2 className="h-5 w-5" />
                    VENDA QUITADA
                </div>
            ) : disabled ? (
                <div className="text-sm text-center font-bold text-white/50 p-3 bg-black/10 rounded-xl border border-white/10">Venda Fechada</div>
            ) : !authedEmployee ? (
                <button 
                    type="button" 
                    onClick={() => setIsModalOpen(true)}
                    className="flex items-center justify-center gap-2 px-4 py-3 text-sm rounded-xl shadow-md w-full bg-white text-emerald-700 hover:bg-emerald-50 font-bold transition-all active:scale-95"
                   >
                    <DollarSign className="h-5 w-5" /> <span>AUTORIZAR E PAGAR</span>
                 </button>
            ) : (
                <SubmitFinalButton employeeName={authedEmployee.full_name} />
            )}
        </div>
     </form>
      
      {isModalOpen && <EmployeeAuthModal storeId={storeId} isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSuccess={handleAuthSuccess} title="Autorizar Pagamento" description="Confirme seu PIN." />}
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\CollapsibleBox.tsx
==================================================
// Caminho: src/components/vendas/CollapsibleBox.tsx
'use client'

import { useState } from 'react'
import { ChevronDown, ChevronUp } from 'lucide-react'

type ColorScheme = 'blue' | 'emerald' | 'purple' | 'amber' | 'gray'

interface CollapsibleBoxProps {
  title: string
  // MUDANÇA 1: Agora aceitamos um ReactNode (o ícone já montado) em vez de LucideIcon
  icon: React.ReactNode 
  children: React.ReactNode
  color?: ColorScheme
  defaultOpen?: boolean
  badge?: string | number 
}

export default function CollapsibleBox({
  title,
  icon,
  children,
  color = 'gray',
  defaultOpen = false,
  badge
}: CollapsibleBoxProps) {
  const [isOpen, setIsOpen] = useState(defaultOpen)

  const styles = {
    blue: {
      bgHeader: 'bg-blue-50',
      hoverHeader: 'hover:bg-blue-100',
      textTitle: 'text-blue-900',
      textIcon: 'text-blue-700', // Mantemos aqui caso precisemos usar em outro lugar, mas o ícone virá estilizado do pai
      border: 'border-blue-200',
      badge: 'bg-blue-200 text-blue-800'
    },
    emerald: {
      bgHeader: 'bg-emerald-50',
      hoverHeader: 'hover:bg-emerald-100',
      textTitle: 'text-emerald-900',
      textIcon: 'text-emerald-700',
      border: 'border-emerald-200',
      badge: 'bg-emerald-200 text-emerald-800'
    },
    purple: {
      bgHeader: 'bg-purple-50',
      hoverHeader: 'hover:bg-purple-100',
      textTitle: 'text-purple-900',
      textIcon: 'text-purple-700',
      border: 'border-purple-200',
      badge: 'bg-purple-200 text-purple-800'
    },
    amber: {
      bgHeader: 'bg-amber-50',
      hoverHeader: 'hover:bg-amber-100',
      textTitle: 'text-amber-900',
      textIcon: 'text-amber-700',
      border: 'border-amber-200',
      badge: 'bg-amber-200 text-amber-800'
    },
    gray: {
      bgHeader: 'bg-gray-50',
      hoverHeader: 'hover:bg-gray-100',
      textTitle: 'text-gray-800',
      textIcon: 'text-gray-600',
      border: 'border-gray-300',
      badge: 'bg-gray-200 text-gray-800'
    }
  }

  const currentStyle = styles[color]

  return (
    <div className={`border rounded-xl shadow-sm overflow-hidden bg-white ${currentStyle.border}`}>
      <div 
        onClick={() => setIsOpen(!isOpen)}
        className={`flex justify-between items-center px-4 py-3 cursor-pointer transition-colors select-none ${currentStyle.bgHeader} ${currentStyle.hoverHeader}`}
      >
        <div className="flex items-center gap-3">
          {/* MUDANÇA 2: Renderizamos o ícone diretamente, pois ele já vem como elemento */}
          {icon}
          
          <h2 className={`font-bold text-base ${currentStyle.textTitle}`}>{title}</h2>
          
          {badge && (
            <span className={`text-xs px-2 py-0.5 rounded-full font-bold ${currentStyle.badge}`}>
              {badge}
            </span>
          )}
        </div>

        <div className={currentStyle.textIcon}>
          {isOpen ? <ChevronUp className="h-5 w-5" /> : <ChevronDown className="h-5 w-5" />}
        </div>
      </div>

      {isOpen && (
        <div className="p-4 animate-in slide-in-from-top-2 fade-in duration-200">
          {children}
        </div>
      )}
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\FinanciamentoBox.tsx
==================================================
//============================
//📄 ARQUIVO: src/components/vendas/FinanciamentoBox.tsx
//============================

'use client'

import { useState, useEffect, useRef } from 'react'
import { useFormState } from 'react-dom'

import {
  saveFinanciamentoLoja,
  receberParcela,
  deleteFinanciamentoLoja,
  type CreateFinanciamentoResult,
} from '@/lib/actions/vendas.actions'

import { Database } from '@/lib/database.types'
import { Calendar, ClipboardList, AlertTriangle, CheckCircle2, Wallet, DollarSign, X, RefreshCw, Trash2, Calculator, Loader2 } from 'lucide-react'
import EmployeeAuthModal from '@/components/modals/EmployeeAuthModal'
import CollapsibleBox from './CollapsibleBox'

type Financiamento = Database['public']['Tables']['financiamento_loja']['Row']
type FinanciamentoParcela = Database['public']['Tables']['financiamento_parcelas']['Row']
type Employee = Database['public']['Tables']['employees']['Row']
type ParcelaGridItem = Pick<FinanciamentoParcela, 'numero_parcela' | 'data_vencimento' | 'valor_parcela'>

type FinanciamentoBoxProps = {
  financiamento: (Financiamento & { financiamento_parcelas: FinanciamentoParcela[] }) | null
  vendaId: number
  customerId: number
  storeId: number
  employeeId: number 
  valorRestante: number
  onFinanceAdded: () => Promise<void>
  disabled: boolean
  isQuitado?: boolean
  isModal?: boolean 
}

// Helpers
const formatCurrency = (value: number | null | undefined) => (value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
const parseLocaleFloat = (str: string) => parseFloat(str.replace(/\./g, '').replace(',', '.') || '0')
const formatDate = (dateStr: string) => new Date(dateStr).toLocaleDateString('pt-BR')
const getToday = () => new Date().toISOString().split('T')[0]

// Sugere data 30 dias no futuro (próximo mês)
const getFirstDueMonth = () => {
    const today = new Date();
    const nextMonth = new Date(today);
    nextMonth.setDate(today.getDate() + 30); 
    return nextMonth.toISOString().split('T')[0];
}

const ParcelaInput = ({ valor, index, onChange }: { valor: number, index: number, onChange: (idx: number, val: string) => void }) => {
    const [localStr, setLocalStr] = useState(formatCurrency(valor))
    const [isFocused, setIsFocused] = useState(false)
    useEffect(() => { if (!isFocused) setLocalStr(formatCurrency(valor)) }, [valor, isFocused])
    return (
        <div className="flex items-center gap-1 w-full justify-end">
            <span className="text-gray-500 text-xs font-bold">R$</span>
            <input 
                type="text" value={localStr} onFocus={() => setIsFocused(true)}
                onBlur={() => { setIsFocused(false); setLocalStr(formatCurrency(parseLocaleFloat(localStr))) }}
                onChange={(e) => { setLocalStr(e.target.value); onChange(index, e.target.value) }}
                className="w-24 text-right font-bold text-gray-900 bg-white border border-gray-200 rounded px-1 h-7 text-sm focus:ring-amber-500 focus:border-amber-500"
            />
        </div>
    )
}

function RecebimentoModal({ 
    parcela, 
    onClose, 
    onConfirm,
    storeId 
}: { 
    parcela: FinanciamentoParcela, 
    onClose: () => void, 
    onConfirm: (dados: any) => void,
    storeId: number
}) {
    const [valorPagoStr, setValorPagoStr] = useState(formatCurrency(parcela.valor_parcela))
    const [forma, setForma] = useState('Dinheiro')
   const [dataPagto, setDataPagto] = useState(getFirstDueMonth())
    const [estrategia, setEstrategia] = useState<'criar_pendencia' | 'somar_proxima'>('criar_pendencia')
    const [isAuthOpen, setIsAuthOpen] = useState(false)
    const [dadosParaEnviar, setDadosParaEnviar] = useState<any>(null)

    const valorOriginal = parcela.valor_parcela
    const valorPago = parseLocaleFloat(valorPagoStr)
    const diferenca = valorOriginal - valorPago
    const isParcial = diferenca > 0.01

    const handlePreConfirm = (e: React.FormEvent) => {
        e.preventDefault()
        setDadosParaEnviar({
            parcela_id: parcela.id,
            valor_original: valorOriginal,
            valor_pago: valorPago,
            forma_pagamento: forma,
            data_pagamento: dataPagto,
            estrategia: isParcial ? estrategia : 'quitacao_total'
        })
        setIsAuthOpen(true)
    }

    const handleAuthSuccess = (employee: Pick<Employee, 'id' | 'full_name'>) => {
        setIsAuthOpen(false)
        onConfirm({ ...dadosParaEnviar, employee_id: employee.id })
    }

    return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" onClick={onClose}>
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200" onClick={e => e.stopPropagation()}>
                <div className="bg-amber-50 px-6 py-4 border-b border-amber-100 flex justify-between items-center">
                    <h3 className="font-bold text-amber-900 flex items-center gap-2">
                        <Wallet className="h-5 w-5" /> Receber Parcela {parcela.numero_parcela}
                    </h3>
                    <button onClick={onClose} type="button" className="p-1 rounded hover:bg-amber-200/50 transition-colors"><X className="h-5 w-5 text-amber-600"/></button>
                </div>
                <form onSubmit={handlePreConfirm} className="p-6 space-y-5">
                    <div className="space-y-1 text-center">
                        <p className="text-xs text-gray-500 uppercase tracking-wider font-bold">Valor da Parcela</p>
                        <p className="text-3xl font-black text-slate-700">R$ {formatCurrency(valorOriginal)}</p>
                    </div>
                   <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold text-gray-500 mb-1">Valor a Receber</label>
                            <input type="text" value={valorPagoStr} onChange={e => setValorPagoStr(e.target.value)} className="w-full rounded-lg border-gray-300 focus:ring-amber-500 font-bold text-lg text-right"/>
                        </div>
                        <div>
                             <label className="block text-xs font-bold text-gray-500 mb-1">Forma</label>
                            <select value={forma} onChange={e => setForma(e.target.value)} className="w-full rounded-lg border-gray-300 focus:ring-amber-500 h-[46px]">
                                <option>Dinheiro</option><option>PIX</option><option>Cartão Débito</option><option>Cartão Crédito</option>
                            </select>
                        </div>
                    </div>
                    {isParcial && (
                        <div className="bg-red-50 p-4 rounded-xl border border-red-100 animate-in slide-in-from-top-2">
                            <div className="flex items-center gap-2 text-red-700 font-bold text-sm mb-3">
                                <AlertTriangle className="h-4 w-4" /><span>Diferença: R$ {formatCurrency(diferenca)}</span>
                            </div>
                            <div className="space-y-2">
                                <label className="flex items-start gap-3 cursor-pointer p-2 rounded hover:bg-red-100/50 transition-colors">
                                    <input type="radio" name="strat" checked={estrategia === 'criar_pendencia'} onChange={() => setEstrategia('criar_pendencia')} className="mt-1 text-red-600 focus:ring-red-500" />
                                    <div><span className="block text-sm font-bold text-gray-800">Manter como Pendência</span><span className="block text-xs text-gray-500">Cria nova parcela.</span></div>
                                </label>
                                <label className="flex items-start gap-3 cursor-pointer p-2 rounded hover:bg-red-100/50 transition-colors">
                                    <input type="radio" name="strat" checked={estrategia === 'somar_proxima'} onChange={() => setEstrategia('somar_proxima')} className="mt-1 text-red-600 focus:ring-red-500" />
                                    <div><span className="block text-sm font-bold text-gray-800">Jogar para Próxima</span><span className="block text-xs text-gray-500">Soma na próxima parcela.</span></div>
                                </label>
                            </div>
                        </div>
                    )}
                    <button type="submit" className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md transition-transform active:scale-95">CONFIRMAR RECEBIMENTO</button>
                </form>
                {isAuthOpen && (<EmployeeAuthModal storeId={storeId} isOpen={isAuthOpen} onClose={() => setIsAuthOpen(false)} onSuccess={handleAuthSuccess} title="Autorizar Baixa" description="Insira seu PIN." />)}
            </div>
        </div>
    )
}

export default function FinanciamentoBox({
  financiamento,
  vendaId,
  customerId,
  storeId,
  employeeId,
  valorRestante,
  onFinanceAdded,
  disabled,
  isQuitado = false,
  isModal = false,
}: FinanciamentoBoxProps) {
  
  const formRef = useRef<HTMLFormElement>(null)
  
  const [isConfigModalOpen, setIsConfigModalOpen] = useState(false)
  const [authedEmployee, setAuthedEmployee] = useState<Pick<Employee, 'id' | 'full_name'> | null>(null)
  const [selectedParcela, setSelectedParcela] = useState<FinanciamentoParcela | null>(null)
  const [isResetting, startResetTransition] = useState(false)
  
  const [isDeletedLocally, setIsDeletedLocally] = useState(false)

  const [valorFinanciadoStr, setValorFinanciadoStr] = useState('')
  const [qtdeParcelas, setQtdeParcelas] = useState(1)
  const [vencimentoPrimeira, setVencimentoPrimeira] = useState(getFirstDueMonth())
  const [parcelasGrid, setParcelasGrid] = useState<ParcelaGridItem[]>([])
  const [obs, setObs] = useState('')

  const initialState: CreateFinanciamentoResult = { success: false, message: '' }
  const [saveState, dispatchSave] = useFormState(saveFinanciamentoLoja, initialState)
  const [recebimentoState, dispatchRecebimento] = useFormState(receberParcela, { success: false, message: '' })

  const isFinanced = !!financiamento && !isDeletedLocally;
  const existeDivergencia = isFinanced && valorRestante > 0.01;
  const temParcelaPaga = financiamento?.financiamento_parcelas.some(p => p.status === 'Pago')

  useEffect(() => {
    if (isDeletedLocally) return;

    if (!isFinanced) {
        if (valorRestante > 0.01) {
            setValorFinanciadoStr(formatCurrency(valorRestante));
        }
    } else {
        setValorFinanciadoStr(formatCurrency(financiamento?.valor_total_financiado));
    }
  }, [valorRestante, isFinanced, financiamento, isDeletedLocally])

  useEffect(() => {
    if (!financiamento && isDeletedLocally) {
        setIsDeletedLocally(false);
    }
  }, [financiamento, isDeletedLocally])

  useEffect(() => {
      if (recebimentoState.success) { setSelectedParcela(null); onFinanceAdded(); } 
      else if (recebimentoState.message) { alert(recebimentoState.message); }
  }, [recebimentoState, onFinanceAdded])
  
  const handleCalcular = () => {
      const valorTotal = parseLocaleFloat(valorFinanciadoStr);
      if (valorTotal <= 0) return;
      const parteInteira = Math.floor(valorTotal);
      const centavos = valorTotal - parteInteira;
      const valorBaseInteiro = Math.floor(parteInteira / qtdeParcelas); 
      const restoInteiro = parteInteira % qtdeParcelas; 
      const novas: ParcelaGridItem[] = [];
      const [y, m, d] = vencimentoPrimeira.split('-').map(Number);
      const dataBase = new Date(y, m - 1, d, 12);
      for (let i = 0; i < qtdeParcelas; i++) {
        let val = valorBaseInteiro;
        if (i < restoInteiro) val += 1;
        if (i === 0) val += centavos;
        const dt = new Date(dataBase); dt.setMonth(dataBase.getMonth() + i);
        novas.push({ numero_parcela: i + 1, data_vencimento: dt.toISOString().split('T')[0], valor_parcela: parseFloat(val.toFixed(2)) });
      }
      setParcelasGrid(novas);
  }

  const handleParcelaChange = (index: number, novoValorStr: string) => {
      const novoValor = parseLocaleFloat(novoValorStr);
      const gridAtualizado = [...parcelasGrid];
      gridAtualizado[index] = { ...gridAtualizado[index], valor_parcela: novoValor };
      setParcelasGrid(gridAtualizado);
  };

  const handleResetCarne = async () => {
    if (!confirm(temParcelaPaga ? "Isso apagará as parcelas pendentes para renegociar o saldo. Confirmar?" : "Isso cancelará o carnê inteiro. Confirmar?")) return;
    
    const valorParaRestaurar = financiamento?.valor_total_financiado || 0;
    
    startResetTransition(true); 
    
    try {
        const res = await deleteFinanciamentoLoja(vendaId, storeId);
        
        // Verifica se deu sucesso OU se o erro é "já não existe mais" (que na prática é sucesso)
        const msg = res?.message ? res.message.toLowerCase() : '';
        const isSuccess = res?.success || msg.includes('not found') || msg.includes('excluído');

        if (isSuccess) {
            setIsDeletedLocally(true); 
            resetFormularioCriacao(valorParaRestaurar); 
            await onFinanceAdded(); 
        } else {
            alert(res?.message || 'Erro desconhecido');
        }
    } catch (error: any) {
        console.error(error);
        alert('Ocorreu um erro ao excluir. Tente recarregar a página.');
    } finally {
        startResetTransition(false);
    }
  }

  const resetFormularioCriacao = (valorSugerido?: number) => {
    const valorInicial = valorSugerido !== undefined ? valorSugerido : valorRestante;
    setValorFinanciadoStr(formatCurrency(valorInicial));
    setQtdeParcelas(1);
    setVencimentoPrimeira(getFirstDueMonth());
    setParcelasGrid([]);
    setObs('');
    setAuthedEmployee(null);
    setIsConfigModalOpen(false);
  }
      
  const handleAuthSuccess = (employee: Pick<Employee, 'id' | 'full_name'>) => {
    setAuthedEmployee(employee);
    setIsConfigModalOpen(false);
  }
  
  const handleConfirmRecebimento = (dados: any) => {
      const formData = new FormData();
      Object.keys(dados).forEach(key => formData.append(key, dados[key]));
      formData.append('venda_id', vendaId.toString());
      formData.append('store_id', storeId.toString());
      
      // Chamada direta para evitar complexidade
      receberParcela(null, formData).then(res => {
          if (res.success) { setSelectedParcela(null); onFinanceAdded(); } 
          else { alert(res.message); }
      });
  }

  // Estilos
  const labelStyle = 'text-[10px] font-bold text-amber-100 uppercase block mb-1 tracking-wider';
  const inputStyle = 'w-full h-10 rounded-lg border-0 bg-white shadow-sm text-sm px-3 focus:ring-2 focus:ring-amber-300 font-bold text-gray-800';

  const renderContent = () => (
    <>
      {isFinanced ? (
          /* MODO VISUALIZAÇÃO */
          <div className="space-y-4">
              <div className="flex justify-between items-end border-b border-amber-50 pb-2">
                  <div>
                      <p className="text-[10px] text-amber-800 uppercase font-bold">Total Financiado</p>
                      <p className="text-xl font-black text-slate-700">{formatCurrency(financiamento?.valor_total_financiado)}</p>
                  </div>
                  <span className="text-xs font-bold text-amber-700 bg-amber-50 px-2 py-1 rounded border border-amber-100">
                      {financiamento?.quantidade_parcelas}x
                  </span>
              </div>

              <div className="space-y-2">
                  {financiamento?.financiamento_parcelas.sort((a,b) => a.numero_parcela - b.numero_parcela).map((p) => {
                      const isPago = p.status === 'Pago';
                      const isAtrasado = !isPago && new Date(p.data_vencimento) < new Date(new Date().setHours(0,0,0,0));
                      return (
                          <div key={p.id} className={`flex items-center justify-between p-2 rounded border transition-all ${isPago ? 'bg-green-50 border-green-100' : isAtrasado ? 'bg-red-50 border-red-100' : 'bg-slate-50 border-slate-100'}`}>
                              <div className="flex items-center gap-3">
                                  <span className="text-xs font-bold text-slate-500 w-6 text-center">{p.numero_parcela}ª</span>
                                  <div>
                                      <p className={`text-sm font-bold ${isPago ? 'text-green-700' : 'text-slate-700'}`}>{formatCurrency(p.valor_parcela)}</p>
                                      <p className="text-[10px] text-slate-400">Venc: {formatDate(p.data_vencimento)}</p>
                                  </div>
                              </div>
                              {isPago ? (
                                  <span className="text-[10px] font-bold text-green-700 bg-white border border-green-200 px-2 py-0.5 rounded flex items-center gap-1"><CheckCircle2 className="h-3 w-3"/> Pago</span>
                              ) : (
                                  <button 
                                      type="button" 
                                      onClick={(e) => { e.stopPropagation(); setSelectedParcela(p); }}
                                      disabled={existeDivergencia} 
                                      className={`text-[10px] font-bold bg-white border border-amber-200 text-amber-700 hover:bg-amber-50 px-2 py-1 rounded flex items-center gap-1 shadow-sm ${existeDivergencia ? 'opacity-50 cursor-not-allowed' : ''}`}
                                  >
                                      <DollarSign className="h-3 w-3" /> RECEBER
                                  </button>
                              )}
                          </div>
                      )
                  })}
              </div>

              {!existeDivergencia && (
                  <div className="pt-2 text-center">
                      <button onClick={handleResetCarne} disabled={isResetting} className="text-[10px] text-slate-400 hover:text-amber-600 font-bold inline-flex items-center gap-1 transition-colors uppercase tracking-wider">
                          {isResetting ? <Loader2 className="h-3 w-3 animate-spin"/> : temParcelaPaga ? <RefreshCw className="h-3 w-3" /> : <Trash2 className="h-3 w-3" />}
                          {temParcelaPaga ? 'Refinanciar Saldo' : 'Cancelar Carnê'}
                      </button>
                  </div>
              )}
          </div>
      ) : (
          /* MODO CRIAÇÃO */
          <div className="relative bg-gradient-to-br from-amber-500 to-orange-600 p-5 rounded-2xl shadow-lg shadow-orange-200 border border-white/20">
               <div className="flex items-center gap-2 mb-4 border-b border-white/20 pb-3">
                    <div className="p-1.5 bg-white/20 rounded-lg text-white">
                        <Calculator className="h-5 w-5" />
                   </div>
                   <h3 className="text-sm font-bold text-white">Gerar Parcelas</h3>
               </div>

               {isQuitado && !isDeletedLocally && (
                   <div className="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 flex flex-col items-center justify-center rounded-2xl text-center p-4">
                       <div className="bg-green-50 border border-green-200 p-2 rounded-full mb-2"><CheckCircle2 className="h-5 w-5 text-green-600" /></div>
                       <p className="text-green-800 font-bold text-xs">Venda Quitada. Sem saldo para financiar.</p>
                   </div>
               )}

          {/* CRIAÇÃO MANUAL (SEM FORMULÁRIO HTML) */}
          {(() => {
              const handleCriarCarneManual = async () => {
                  if (parcelasGrid.length === 0) {
                      alert("Por favor, clique em CALCULAR antes de gerar o carnê.");
                      return;
                  }
                  
                  if (!confirm(`Confirma a criação do carnê em ${qtdeParcelas}x?`)) return;

                  const payload = {
                      venda_id: vendaId,
                      customer_id: customerId,
                      employee_id: authedEmployee?.id ?? employeeId,
                      valor_total: parseLocaleFloat(valorFinanciadoStr),
                      qtd_parcelas: qtdeParcelas,
                      data_primeiro_vencimento: vencimentoPrimeira,
                      obs: obs
                  };

                  const resultado = await saveFinanciamentoLoja(null, payload);

                  if (resultado.success) {
                      setParcelasGrid([]);
                      setIsDeletedLocally(false); // Garante que a UI atualize
                      await onFinanceAdded(); 
                  } else {
                      alert(resultado.message || "Erro desconhecido ao criar carnê.");
                  }
              };

              return (
                  <div className="space-y-4">
                       <div className="grid grid-cols-2 gap-3">
                          <div>
                              <label className={labelStyle}>Valor</label>
                              <input type="text" value={valorFinanciadoStr} onChange={e => { setValorFinanciadoStr(e.target.value); setParcelasGrid([]); }} className={`${inputStyle} text-right`} />
                          </div>
                          <div>
                              <label className={labelStyle}>Vezes</label>
                              <select value={qtdeParcelas} onChange={e => { setQtdeParcelas(parseInt(e.target.value)); setParcelasGrid([]); }} className={`${inputStyle} cursor-pointer`}>
                                  {[...Array(12)].map((_, i) => <option key={i} value={i+1}>{i+1}x</option>)}
                              </select>
                          </div>
                       </div>

                       <div className="flex gap-2 items-end">
                           <div className="flex-1">
                              <label className={labelStyle}>1º Vencimento</label>
                              <input type="date" value={vencimentoPrimeira} onChange={e => setVencimentoPrimeira(e.target.value)} className={inputStyle} />
                           </div>
                           <button type="button" onClick={handleCalcular} className="h-10 px-4 bg-white/20 hover:bg-white/30 border border-white/40 text-white rounded-lg text-xs font-bold transition-all">CALCULAR</button>
                       </div>

                       {parcelasGrid.length > 0 && (
                           <div className="bg-white/90 backdrop-blur-sm rounded-lg p-2 space-y-1 border border-white/50 max-h-40 overflow-y-auto custom-scrollbar shadow-inner">
                               {parcelasGrid.map((p, i) => (
                                   <div key={i} className="flex justify-between text-xs text-slate-700 border-b border-gray-200 last:border-0 pb-1 items-center font-medium">
                                       <span>{p.numero_parcela}ª - {formatDate(p.data_vencimento)}</span>
                                       <ParcelaInput valor={p.valor_parcela} index={i} onChange={handleParcelaChange} />
                                   </div>
                               ))}
                           </div>
                       )}

                       <div>
                          <label className={labelStyle}>Observação</label>
                          <input type="text" value={obs} onChange={(e) => setObs(e.target.value)} className={inputStyle} placeholder="Ex: Aprovado por..." />
                       </div>

                       <button 
                            type="button" 
                            onClick={handleCriarCarneManual}
                            disabled={parcelasGrid.length === 0} 
                            className="w-full h-10 bg-white text-amber-700 hover:bg-amber-50 rounded-xl font-bold text-xs flex items-center justify-center gap-2 shadow-md active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
                       >
                           <ClipboardList className="h-4 w-4"/> GERAR CARNÊ
                       </button>
                  </div>
              )
          })()}
        </div>
      )}
    </>
  );

  if (isModal) {
      return (
        <div className="h-full overflow-y-auto custom-scrollbar pr-1 pt-2">
            {renderContent()}
            {isConfigModalOpen && <EmployeeAuthModal storeId={storeId} isOpen={isConfigModalOpen} onClose={() => setIsConfigModalOpen(false)} onSuccess={handleAuthSuccess} title="Autorizar Emissão" description="PIN do responsável." />}
            {selectedParcela && <RecebimentoModal parcela={selectedParcela} storeId={storeId} onClose={() => setSelectedParcela(null)} onConfirm={handleConfirmRecebimento} />}
        </div>
      );
  }

  return (
    <>
        {isFinanced ? (
            <CollapsibleBox
                title="Carnê da Loja"
                icon={<Wallet className="h-5 w-5 text-amber-700" />}
                color="amber"
                defaultOpen={true}
                badge="EMITIDO"
            >
                {renderContent()}
            </CollapsibleBox>
        ) : renderContent()}

        {isConfigModalOpen && <EmployeeAuthModal storeId={storeId} isOpen={isConfigModalOpen} onClose={() => setIsConfigModalOpen(false)} onSuccess={handleAuthSuccess} title="Autorizar Emissão" description="PIN do responsável." />}
        {selectedParcela && <RecebimentoModal parcela={selectedParcela} storeId={storeId} onClose={() => setSelectedParcela(null)} onConfirm={handleConfirmRecebimento} />}
    </>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\ListaItens.tsx
==================================================
// Caminho: src/components/vendas/ListaItens.tsx
'use client'

import { useTransition } from 'react'
import {
  deleteVendaItem,
  type DeleteVendaItemResult,
} from '@/lib/actions/vendas.actions'
import { Database } from '@/lib/database.types'
import { Loader2, Trash2, XCircle } from 'lucide-react'

type VendaItem = Database['public']['Tables']['venda_itens']['Row']

// Props
type ListaItensProps = {
  itens: VendaItem[]
  vendaId: number
  storeId: number
  onItemDeleted: () => Promise<void> // Função para recarregar a página pai
  disabled: boolean
}

// --- Funções Helper ---
const formatCurrency = (value: number | null | undefined): string => {
  return (value || 0).toLocaleString('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  })
}
// --- FIM HELPER ---

// --- Botão Deletar (Componente interno) ---
function DeleteButton({
  item,
  vendaId,
  storeId,
  onItemDeleted,
  disabled,
}: {
  item: VendaItem
  vendaId: number
  storeId: number
  onItemDeleted: () => Promise<void>
  disabled: boolean
}) {
  const [isDeleting, startDeleteTransition] = useTransition()

  const handleDelete = () => {
    if (
      disabled ||
      !window.confirm(`Tem certeza que deseja remover o item "${item.descricao}"?`)
    ) {
      return
    }

    startDeleteTransition(async () => {
      const result = await deleteVendaItem(item.id, vendaId, storeId)
      if (result.success) {
        await onItemDeleted() // Recarrega os dados na página pai
      } else {
        alert(`Erro ao remover item: ${result.message}`)
      }
    })
  }

  return (
    <button
      type="button"
      onClick={handleDelete}
      disabled={isDeleting || disabled}
      className="p-1 text-gray-500 rounded-md hover:text-red-600 hover:bg-red-100 disabled:opacity-50 disabled:cursor-not-allowed"
      title="Remover Item"
    >
      {isDeleting ? (
        <Loader2 className="h-4 w-4 animate-spin" />
      ) : (
        <XCircle className="h-4 w-4" />
      )}
    </button>
  )
}

// --- Componente Principal da Lista ---
export default function ListaItens({
  itens,
  vendaId,
  storeId,
  onItemDeleted,
  disabled,
}: ListaItensProps) {
  return (
    <div className="flex flex-col h-full">
      <h3 className="text-lg font-semibold text-gray-800 mb-2">
        Itens da Venda
      </h3>
      
      {/* Cabeçalho da Lista */}
      <div className="hidden md:flex bg-gray-300 p-2 rounded-t-md font-semibold text-gray-700 text-sm">
        <div className="w-1/2">Descrição</div>
        <div className="w-1/6 text-center">Qtd.</div>
        <div className="w-1/6 text-right">Vl. Unit.</div>
        <div className="w-1/6 text-right">Vl. Total</div>
        <div className="w-8"></div> {/* Coluna do X */}
      </div>

      {/* Lista de Itens */}
      <div className="flex-1 overflow-y-auto space-y-2 bg-white p-2 rounded-b-md shadow-inner">
        {itens.length === 0 ? (
          <p className="text-sm text-gray-500 text-center py-4">
            Nenhum item adicionado ao carrinho.
          </p>
        ) : (
          itens.map((item) => (
            <div
              key={item.id}
              className="flex flex-col md:flex-row md:items-center p-2 rounded bg-gray-50 border border-gray-200"
            >
              {/* Descrição */}
              <div className="w-full md:w-1/2 font-medium text-gray-800">
                <span className="md:hidden text-xs text-gray-500">Item: </span>
                {item.descricao}
                <span className="text-xs text-gray-500 italic ml-1">
                  ({item.item_tipo})
                </span>
              </div>
              
              {/* Qtd */}
              <div className="w-full md:w-1/6 md:text-center">
                <span className="md:hidden text-xs text-gray-500">Qtd: </span>
                {item.quantidade}
              </div>
              
              {/* Vl. Unitário */}
              <div className="w-full md:w-1/6 md:text-right">
                <span className="md:hidden text-xs text-gray-500">Vl. Unit: </span>
                {formatCurrency(item.valor_unitario)}
              </div>
              
              {/* Vl. Total */}
              <div className="w-full md:w-1/6 md:text-right font-bold text-blue-700">
                <span className="md:hidden text-xs text-gray-500">Vl. Total: </span>
                {formatCurrency(item.valor_total_item)}
              </div>
              
              {/* Botão Deletar */}
              <div className="w-full md:w-8 flex justify-end md:justify-center mt-1 md:mt-0">
                <DeleteButton
                  item={item}
                  vendaId={vendaId}
                  storeId={storeId}
                  onItemDeleted={onItemDeleted}
                  disabled={disabled}
                />
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\ListaOS.tsx
==================================================
// Caminho: src/components/vendas/ListaOS.tsx
'use client'

import Link from 'next/link'
import { Database } from '@/lib/database.types'
import { FileText, PlusCircle, PenTool } from 'lucide-react'

type ServiceOrder = Database['public']['Tables']['service_orders']['Row']

// Props
type ListaOSProps = {
  vendaId: number
  storeId: number
  serviceOrders: ServiceOrder[]
  employeeId: string 
  employeeName: string 
  disabled: boolean
}

// --- Funções Helper ---
const formatDate = (dateString: string | null | undefined): string => {
  if (!dateString) return 'N/A'
  try {
    return new Date(dateString).toLocaleDateString('pt-BR')
  } catch (e) {
    return 'Data Inválida'
  }
}
// --- FIM HELPER ---

// --- Componente Principal ---
export default function ListaOS({
  vendaId,
  storeId,
  serviceOrders,
  employeeId,
  employeeName,
  disabled,
}: ListaOSProps) {
  // A URL base para a Ficha Técnica
  const linkBase = `/dashboard/loja/${storeId}/vendas/${vendaId}/os`
  
  // Parâmetros comuns (contexto do funcionário)
  // Nota: Removi o '?' do início para gerenciar melhor a concatenação abaixo
  const commonParams = `employee_id=${employeeId}&employee_name=${employeeName}`
  
  // O link para CRIAR uma nova OS (Sem ID = Nova)
  const linkNovaOS = `${linkBase}?${commonParams}`

  return (
    <div className="flex flex-col h-full">
      <div className="flex justify-between items-center mb-2">
        <h3 className="text-lg font-semibold text-gray-800">
          Fichas Técnicas (OS)
        </h3>
        <Link
          href={linkNovaOS}
          className="flex items-center gap-1 px-3 py-1 text-sm rounded-md shadow-sm bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
          title="Iniciar nova Ordem de Serviço"
        >
          <PlusCircle className="h-4 w-4" />
          Nova OS
        </Link>
      </div>

      {/* Lista de OSs */}
      <div className="flex-1 overflow-y-auto space-y-2 bg-white p-2 rounded-lg shadow-inner">
        {serviceOrders.length === 0 ? (
          <p className="text-sm text-gray-500 text-center py-4">
            Nenhuma Ficha Técnica vinculada a esta venda.
          </p>
        ) : (
          serviceOrders.map((os) => (
            <div
              key={os.id}
              className="flex justify-between items-center p-2 rounded bg-gray-50 border border-gray-200"
            >
              <div className="font-medium text-gray-800">
                OS #{os.id}
                <span className="text-xs text-gray-500 ml-2">
                  (Criada em: {formatDate(os.created_at)})
                </span>
              </div>
              
              {/* CORREÇÃO AQUI: Passamos 'os_id' explicitamente na URL */}
              <Link
                href={`${linkBase}?os_id=${os.id}&${commonParams}`}
                className="flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800"
                title="Ver e editar ficha técnica"
              >
                <PenTool className="h-3 w-3" />
                Ver/Editar
              </Link>
            </div>
          ))
        )}
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\ListaPagamentos.tsx
==================================================
'use client'

import { useTransition } from 'react'
import { deletePagamento } from '@/lib/actions/vendas.actions'
import { Database } from '@/lib/database.types'
import { Loader2, Trash2 } from 'lucide-react'

type Pagamento = Database['public']['Tables']['pagamentos']['Row']

type ListaPagamentosProps = {
  pagamentos: Pagamento[]
  vendaId: number
  storeId: number
  onDelete: () => Promise<void> 
  disabled: boolean
}

const formatCurrency = (value: number | null | undefined): string => {
  return (value || 0).toLocaleString('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  })
}
const formatDate = (dateString: string | null | undefined): string => {
    if (!dateString) return 'N/A';
    try {
        return dateString.split('T')[0].split('-').reverse().join('/');
    } catch (e) {
        return 'Data Inválida';
    }
}

function DeleteButton({
  pagamento,
  vendaId,
  storeId,
  onDelete,
  disabled,
}: {
  pagamento: Pagamento
  vendaId: number
  storeId: number
  onDelete: () => Promise<void>
  disabled: boolean
}) {
  const [isDeleting, startDeleteTransition] = useTransition()

  const handleDelete = () => {
    if (disabled || !window.confirm(`Remover pagamento de ${formatCurrency(pagamento.valor_pago)}?`)) return;

    startDeleteTransition(async () => {
      const result = await deletePagamento(pagamento.id, vendaId, storeId)
      if (result.success) {
        await onDelete() 
      } else {
        alert(`Erro: ${result.message}`)
      }
    })
  }

  return (
    <button
      type="button"
      onClick={handleDelete}
      disabled={isDeleting || disabled}
      className="p-1.5 text-gray-400 rounded-md hover:text-red-600 hover:bg-red-50 disabled:opacity-50 transition-colors"
      title="Estornar / Remover"
    >
      {isDeleting ? <Loader2 className="h-4 w-4 animate-spin" /> : <Trash2 className="h-4 w-4" />}
    </button>
  )
}

export default function ListaPagamentos({
  pagamentos,
  vendaId,
  storeId,
  onDelete,
  disabled,
}: ListaPagamentosProps) {
  return (
    <div className="flex flex-col h-full">
      {/* SUBTÍTULO DO QUADRO ESQUERDO */}
      <h3 className="text-lg font-bold text-gray-800 mb-3 border-b border-gray-300 pb-2">
        Histórico de Pgto
      </h3>

      {/* Cabeçalho Verde Esmeralda */}
      <div className="hidden md:flex bg-emerald-100 p-2 rounded-t-md font-bold text-emerald-800 text-[10px] uppercase tracking-wider">
        <div className="w-3/12 pl-2">Data</div>
        <div className="w-3/12">Forma</div>
        <div className="w-3/12 text-right">Valor</div>
        <div className="w-1/12 text-center">Parc.</div>
        <div className="w-2/12 text-center">Ações</div> 
      </div>

      <div className="flex-1 overflow-y-auto space-y-1 bg-emerald-50/30 p-2 rounded-b-md shadow-inner border border-emerald-100 max-h-60">
        {pagamentos.length === 0 ? (
          <p className="text-xs text-gray-500 text-center py-4 italic">
            Nenhum pagamento registrado.
          </p>
        ) : (
          pagamentos.map((pag) => (
            <div
              key={pag.id}
              className="flex flex-col md:flex-row md:items-center p-2 rounded bg-white border border-emerald-100 hover:shadow-sm transition-shadow"
            >
              <div className="w-full md:w-3/12 font-medium text-gray-700 text-sm pl-2">
                {formatDate(pag.data_pagamento)}
              </div>
              <div className="w-full md:w-3/12 text-xs text-gray-600 font-semibold uppercase">
                {pag.forma_pagamento}
              </div>
              <div className="w-full md:w-3/12 md:text-right font-bold text-emerald-700 text-sm">
                {formatCurrency(pag.valor_pago)}
              </div>
              <div className="w-full md:w-1/12 md:text-center text-xs text-gray-500">
                {pag.parcelas}x
              </div>
              
              {/* Coluna de Ações (Apenas Deletar agora) */}
              <div className="w-full md:w-2/12 flex justify-end md:justify-center gap-1">
                <DeleteButton
                  pagamento={pag}
                  vendaId={vendaId}
                  storeId={storeId}
                  onDelete={onDelete}
                  disabled={disabled}
                />
              </div>
            </div>
          ))
        )}
      </div>
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\PdvExpressInterface.tsx
==================================================
'use client'

import { useState, useRef, useTransition, useEffect, useCallback } from 'react'
import { useRouter } from 'next/navigation'
import { 
  buscarProdutoExpress, 
  type ProdutoExpressResult 
} from '@/lib/actions/vendas.actions'
import { Database } from '@/lib/database.types'
import { 
  ScanBarcode, Search, ShoppingCart, Loader2, 
  Trash2, ArrowRight, Package, Plus, UserCircle, AlertTriangle, SearchX 
} from 'lucide-react'
import PaymentModal from '@/components/modals/PaymentModal'

const formatCurrency = (val: number) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })

type Employee = Database['public']['Tables']['employees']['Row']

export type CartItem = {
    tempId: string
    originalId: number
    type: 'produtos_gerais' | 'armacoes'
    description: string
    price: number
    quantity: number
}

interface Props {
    storeId: number
    employees: Employee[] 
}

export default function PdvExpressInterface({ storeId, employees }: Props) {
    const router = useRouter()
    
    const [cartItems, setCartItems] = useState<CartItem[]>([])
    const [selectedEmployeeId, setSelectedEmployeeId] = useState<string>('') 
    
    // Busca
    const [query, setQuery] = useState('')
    const [searchResults, setSearchResults] = useState<ProdutoExpressResult[]>([])
    const [isSearching, startSearchTransition] = useTransition()
    // NOVO ESTADO: Controla se já houve uma tentativa de busca
    const [hasSearched, setHasSearched] = useState(false)

    const searchInputRef = useRef<HTMLInputElement>(null)
    const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false)

    useEffect(() => { searchInputRef.current?.focus() }, [])

    const valorTotal = cartItems.reduce((acc, item) => acc + (item.price * item.quantity), 0)

    const handleAddItem = (produto: ProdutoExpressResult) => {
        const newItem: CartItem = {
            tempId: Math.random().toString(36).substr(2, 9),
            originalId: produto.id,
            type: produto.tipo_origem,
            description: produto.descricao,
            price: produto.preco,
            quantity: 1
        }
        setCartItems(prev => [newItem, ...prev])
        setSearchResults([])
        setQuery('')
        setHasSearched(false)
        setTimeout(() => searchInputRef.current?.focus(), 100)
    }

    const handleRemoveItem = (tempId: string) => {
        setCartItems(prev => prev.filter(item => item.tempId !== tempId))
    }

    const executaBusca = () => {
        if (!query.trim()) return
        startSearchTransition(async () => {
            const results = await buscarProdutoExpress(query, storeId)
            const singleResult = results.length === 1 ? results[0] : null;

            // Marca que a busca foi feita
            setHasSearched(true)

            if (singleResult && singleResult.codigo_barras === query.trim()) {
                handleAddItem(singleResult)
            } else {
                setSearchResults(results)
            }
        })
    }

    const handleInputKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
        if (e.key === 'Enter') {
            e.preventDefault()
            executaBusca()
        }
    }

    const handleFinalizar = useCallback(() => {
        if (cartItems.length === 0) return alert("Carrinho vazio!")
        if (!selectedEmployeeId) {
            alert("Selecione o Vendedor antes de pagar.")
            return
        }
        setIsPaymentModalOpen(true)
    }, [cartItems.length, selectedEmployeeId])

    const handleReset = () => {
        setIsPaymentModalOpen(false)
        setCartItems([])
        setQuery('')
        setHasSearched(false)
        setSelectedEmployeeId('')
        searchInputRef.current?.focus()
    }

    useEffect(() => {
        const handleKeyDown = (e: KeyboardEvent) => {
            if (e.key === 'F2') { 
                e.preventDefault(); 
                handleFinalizar();
            }
        }
        window.addEventListener('keydown', handleKeyDown)
        return () => window.removeEventListener('keydown', handleKeyDown)
    }, [handleFinalizar])

    const labelStyle = 'block text-[10px] font-bold text-blue-100 uppercase mb-1 tracking-wider'
    const inputStyle = 'block w-full rounded-lg border-0 bg-white shadow-sm text-gray-800 h-10 text-sm px-3 focus:ring-2 focus:ring-blue-300 focus:outline-none font-bold transition-all placeholder:font-normal placeholder:text-gray-400'

    return (
        <div className="flex flex-col h-full bg-transparent overflow-hidden">
            <div className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 overflow-hidden min-h-0">
                
                {/* ESQUERDA (CONTROLES) */}
                <div className="lg:col-span-5 flex flex-col gap-4 h-full overflow-hidden">
                    <div className="bg-gradient-to-br from-blue-600 to-indigo-700 p-6 rounded-2xl shadow-lg shadow-blue-200 border border-white/20 flex-shrink-0">
                        <div className="flex items-center gap-2 mb-6 border-b border-white/20 pb-3">
                            <div className="p-1.5 bg-white/20 rounded-lg text-white">
                                <ScanBarcode className="h-5 w-5" />
                            </div>
                            <h2 className="text-sm font-bold text-white tracking-wide">PDV Rápido</h2>
                        </div>
                        <div className="space-y-5">
                            <div>
                                <label className={labelStyle}>Vendedor Responsável</label>
                                <div className="relative">
                                    <UserCircle className="absolute left-3 top-2.5 h-5 w-5 text-gray-400 z-10 pointer-events-none" />
                                    <select 
                                        value={selectedEmployeeId}
                                        onChange={(e) => setSelectedEmployeeId(e.target.value)}
                                        className={`${inputStyle} pl-10 cursor-pointer`}
                                    >
                                        <option value="">-- Selecione --</option>
                                        {employees.map(emp => (
                                            <option key={emp.id} value={emp.id}>{emp.full_name}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className={labelStyle}>Adicionar Produto</label>
                                <div className="relative">
                                    <input 
                                        ref={searchInputRef}
                                        type="text" 
                                        value={query}
                                        onChange={(e) => {
                                            setQuery(e.target.value)
                                            setHasSearched(false) // Reseta o aviso ao digitar
                                        }}
                                        onKeyDown={handleInputKeyDown}
                                        className={`${inputStyle} pl-10 pr-10`}
                                        placeholder="Bipe ou digite..."
                                        autoComplete="off"
                                    />
                                    <div className="absolute left-3 top-2.5 text-gray-400">
                                        {isSearching ? <Loader2 className="h-5 w-5 animate-spin text-blue-500" /> : <Search className="h-5 w-5" />}
                                    </div>
                                    {query && (
                                        <button onClick={executaBusca} className="absolute right-1.5 top-1.5 bg-blue-100 hover:bg-blue-200 text-blue-700 p-1.5 rounded-md transition-colors" title="Buscar">
                                            <ArrowRight className="h-4 w-4" />
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ÁREA DE RESULTADOS / FEEDBACK */}
                    {searchResults.length > 0 ? (
                        <div className="flex-1 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden flex flex-col animate-in fade-in slide-in-from-top-2 min-h-0">
                            <div className="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center flex-shrink-0">
                                <span className="text-[10px] font-bold text-gray-500 uppercase">Resultados ({searchResults.length})</span>
                                <button onClick={() => {setSearchResults([]); setQuery('')}} className="text-[10px] font-bold text-blue-600 hover:underline">Limpar</button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                 {searchResults.map((prod) => (
                                    <button 
                                        type="button" 
                                        key={`${prod.tipo_origem}-${prod.id}`} 
                                        onClick={() => handleAddItem(prod)} 
                                        className="w-full text-left p-3 rounded-lg border border-transparent hover:border-blue-200 hover:bg-blue-50 flex justify-between items-center group transition-all"
                                    >
                                        <div className="flex items-center gap-3 overflow-hidden">
                                            <div className="p-2 bg-gray-100 rounded text-gray-400 group-hover:bg-white group-hover:text-blue-500 flex-shrink-0">
                                                <Package className="h-5 w-5" />
                                            </div>
                                            <div className="min-w-0">
                                                <p className="font-bold text-gray-800 text-sm group-hover:text-blue-700 truncate">{prod.descricao}</p>
                                                <p className="text-[10px] text-gray-400 font-mono mt-0.5">Est: {prod.estoque}</p>
                                            </div>
                                        </div>
                                        <div className="text-right pl-2 flex-shrink-0">
                                            <span className="block font-bold text-green-600 text-sm">{formatCurrency(prod.preco)}</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    ) : (
                        // CONDICIONAL DE FEEDBACK
                        hasSearched && !isSearching ? (
                             <div className="flex-1 flex flex-col justify-center items-center text-amber-600 bg-amber-50 rounded-2xl border border-amber-200 min-h-0 animate-in fade-in">
                                <SearchX className="h-12 w-12 mb-3 opacity-50" />
                                <p className="text-sm font-bold">Nenhum produto encontrado</p>
                                <p className="text-xs mt-1 opacity-80">Verifique o nome ou código.</p>
                            </div>
                        ) : (
                            <div className="flex-1 flex flex-col justify-center items-center text-gray-300 bg-white/40 rounded-2xl border-2 border-dashed border-gray-200 min-h-0">
                                <ScanBarcode className="h-12 w-12 mb-2 opacity-20" />
                                <p className="text-xs font-medium">Aguardando...</p>
                            </div>
                        )
                    )}
                </div>

                {/* DIREITA (CARRINHO) - IGUAL AO ANTERIOR */}
                <div className="lg:col-span-7 flex flex-col bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden h-full">
                    <div className="bg-white px-5 py-3 border-b border-gray-100 flex justify-between items-center flex-shrink-0">
                        <div className="flex items-center gap-2">
                            <div className="p-1.5 bg-emerald-50 text-emerald-600 rounded-lg">
                                <ShoppingCart className="h-4 w-4" />
                            </div>
                            <span className="text-sm font-bold text-gray-800 uppercase tracking-wide">Cesta de Compras</span>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-600 font-bold">{cartItems.length} itens</span>
                            {cartItems.length > 0 && (
                                <button onClick={() => setCartItems([])} className="text-[10px] text-red-400 hover:text-red-600 font-bold px-2 py-1 rounded hover:bg-red-50 transition-colors">
                                    LIMPAR
                                </button>
                            )}
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar bg-gray-50/30">
                        {cartItems.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-gray-300 opacity-60">
                                <ShoppingCart className="h-12 w-12 mb-2 opacity-20" />
                                <p className="text-xs">Cesta vazia</p>
                            </div>
                        ) : (
                            cartItems.map((item) => (
                                <div key={item.tempId} className="flex justify-between items-center p-3 bg-white rounded-xl border border-gray-100 shadow-sm hover:border-blue-200 transition-colors">
                                    <div className="flex-1 min-w-0">
                                        <p className="font-bold text-gray-800 text-sm truncate">{item.description}</p>
                                        <div className="flex gap-2 mt-0.5">
                                            <span className="text-[9px] bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded uppercase">{item.type === 'armacoes' ? 'Armação' : 'Produto'}</span>
                                            <span className="text-[10px] text-gray-400">1 x {formatCurrency(item.price)}</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4 pl-3 flex-shrink-0">
                                        <p className="font-bold text-gray-800 text-base">{formatCurrency(item.price)}</p>
                                        <button onClick={() => handleRemoveItem(item.tempId)} className="p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Remover">
                                            <Trash2 className="h-4 w-4" />
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                    <div className="bg-white border-t border-gray-200 p-5 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-10 flex-shrink-0">
                        <div className="flex justify-between items-end mb-4">
                            <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Total a Pagar</p>
                            <p className="text-4xl font-black text-slate-800 tracking-tight leading-none">{formatCurrency(valorTotal)}</p>
                        </div>
                        <button 
                            onClick={handleFinalizar}
                            disabled={cartItems.length === 0}
                            className={`w-full h-12 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95 text-sm font-bold uppercase tracking-wide
                                ${!selectedEmployeeId 
                                    ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                                    : 'bg-emerald-600 hover:bg-emerald-700 text-white shadow-emerald-200'
                                }`}
                        >
                            <span>Finalizar Venda</span>
                            <ArrowRight className="h-4 w-4" />
                        </button>
                        {!selectedEmployeeId && (
                            <p className="text-center text-[10px] text-red-500 font-bold mt-2 animate-pulse">⚠ Selecione o Vendedor para liberar</p>
                        )}
                    </div>
                </div>
            </div>

            {isPaymentModalOpen && (
                <PaymentModal 
                    isOpen={isPaymentModalOpen}
                    onClose={() => setIsPaymentModalOpen(false)}
                    onReset={handleReset}
                    storeId={storeId}
                    employeeId={selectedEmployeeId ? parseInt(selectedEmployeeId) : 0}
                    valorTotal={valorTotal}
                    cartItems={cartItems}
                />
            )}
        </div>
    )
}

==================================================
ARQUIVO: .\src\components\vendas\ResumoFinanceiro.tsx
==================================================
'use client'

import { useState, useEffect } from 'react'
import { useFormState, useFormStatus } from 'react-dom'
import {
  updateVendaDesconto,
  type UpdateDescontoResult,
} from '@/lib/actions/vendas.actions'
import { Database } from '@/lib/database.types'
import { Loader2, TrendingDown } from 'lucide-react'

type Venda = Database['public']['Tables']['vendas']['Row']

type ResumoFinanceiroProps = {
  venda: Venda
  onUpdate: () => Promise<void> 
  disabled: boolean
}

const formatCurrency = (value: number | null | undefined): string => {
  return (value || 0).toLocaleString('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  })
}
const parseLocaleFloat = (stringNumber: string | null | undefined): number => {
  if (!stringNumber) return 0.0
  const cleaned = stringNumber.replace(/\./g, '').replace(',', '.')
  return parseFloat(cleaned) || 0.0
}

function DescontoSubmitButton() {
  const { pending } = useFormStatus()
  return (
    <button
      type="submit"
      disabled={pending}
      className="p-2 bg-slate-200 text-slate-600 rounded-r-md hover:bg-slate-300 disabled:opacity-50 h-10 flex items-center justify-center"
      title="Aplicar"
    >
      {pending ? <Loader2 className="h-4 w-4 animate-spin" /> : <TrendingDown className="h-4 w-4" />}
    </button>
  )
}

export default function ResumoFinanceiro({
  venda,
  onUpdate,
  disabled,
}: ResumoFinanceiroProps) {
  
  const [descontoString, setDescontoString] = useState('0,00')
  
  const descontoInitialState: UpdateDescontoResult = { success: false, message: '' }
  const [descontoState, dispatchDesconto] = useFormState(updateVendaDesconto, descontoInitialState)

  useEffect(() => {
    setDescontoString(formatCurrency(venda.valor_desconto).replace('R$', '').trim())
  }, [venda.valor_desconto])

  useEffect(() => {
    if (descontoState.success) {
      onUpdate()
    }
  }, [descontoState, onUpdate])

  const handleDescontoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    let value = e.target.value.replace(/\D/g, '')
    if (value === '') {
      setDescontoString('0,00')
      return
    }
    value = (parseInt(value, 10) / 100).toFixed(2)
    setDescontoString(value.replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.'))
  }

  const totalPago = venda.valor_final - (venda.valor_restante ?? 0)

  return (
    <div className="flex items-center gap-6 text-sm">
      
      {/* Bloco 1: Total Bruto */}
      <div className="flex flex-col">
        <span className="text-[10px] text-gray-400 uppercase font-bold">Subtotal</span>
        <span className="font-bold text-gray-600">{formatCurrency(venda.valor_total)}</span>
      </div>

      {/* Bloco 2: Desconto (Formulário Compacto) */}
      <div className="flex flex-col">
         <span className="text-[10px] text-gray-400 uppercase font-bold mb-0.5">Desconto (R$)</span>
         <form action={dispatchDesconto} className="flex items-center">
            <input type="hidden" name="venda_id" value={venda.id} />
            <input type="hidden" name="store_id" value={venda.store_id} />
            <input id="valor_desconto" name="valor_desconto" value={parseLocaleFloat(descontoString)} type="hidden" />
            
            <div className="flex items-center">
              <input
                type="text"
                value={descontoString}
                onChange={handleDescontoChange}
                disabled={disabled}
                className="w-20 rounded-l-md border-gray-300 border-r-0 shadow-sm text-gray-900 h-10 text-sm font-bold text-right disabled:bg-gray-100 focus:ring-0 focus:border-blue-500"
              />
              {!disabled && <DescontoSubmitButton />}
            </div>
         </form>
      </div>

      {/* Bloco 3: Total Pago */}
      <div className="flex flex-col border-l border-gray-200 pl-4">
        <span className="text-[10px] text-gray-400 uppercase font-bold">Pago / Sinal</span>
        <span className="font-bold text-green-600">{formatCurrency(totalPago)}</span>
      </div>

      {/* Bloco 4: A RECEBER (Destaque) */}
      <div className="flex flex-col items-end border-l border-gray-200 pl-4">
        <span className="text-[10px] text-gray-400 uppercase font-bold">A Receber</span>
        <span className={`text-2xl font-black leading-none ${venda.valor_restante > 0.01 ? 'text-red-600' : 'text-emerald-600'}`}>
            {formatCurrency(venda.valor_restante)}
        </span>
      </div>

    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\VendaActions.tsx
==================================================
// ARQUIVO: src/components/vendas/VendaActions.tsx
'use client'

import { useState, useTransition } from 'react'
import { useFormStatus } from 'react-dom'
import { updateVendaStatus } from '@/lib/actions/vendas.actions'
import { Database } from '@/lib/database.types'
import { Loader2, Check, X, Printer, RefreshCcw, CheckCircle2, Lock, Unlock } from 'lucide-react'
import ReturnModal from '@/components/modals/ReturnModal'
import EmployeeAuthModal from '@/components/modals/EmployeeAuthModal'

type Venda = Database['public']['Tables']['vendas']['Row']
type VendaItem = Database['public']['Tables']['venda_itens']['Row']
type Employee = Database['public']['Tables']['employees']['Row']

interface VendaActionsProps {
  venda: Venda
  vendaItens: VendaItem[]
  onStatusChange: () => Promise<void>
  isVendaFechada: boolean
  onPrint: () => void 
}

export default function VendaActions({
  venda,
  vendaItens,
  onStatusChange,
  isVendaFechada,
  onPrint,
}: VendaActionsProps) {
  
  const [isReturnModalOpen, setIsReturnModalOpen] = useState(false)
  const [isAuthOpen, setIsAuthOpen] = useState(false)
  const [authAction, setAuthAction] = useState<'Finalizar' | 'Reabrir' | null>(null)
  
  const [isPending, startTransition] = useTransition()
  
  const isSameDay = new Date(venda.created_at).toDateString() === new Date().toDateString()

  const hasRemaining = (venda.valor_restante ?? 0) > 0.01
  const hasFinance = !!venda.financiamento_id
  const isLocked = hasRemaining && !hasFinance

  const handleActionClick = (action: 'Finalizar' | 'Reabrir') => {
      setAuthAction(action)
      setIsAuthOpen(true)
  }

  const handleAuthSuccess = (employee: Pick<Employee, 'id' | 'full_name' | 'role'>) => {
      setIsAuthOpen(false)
      if (!authAction) return

      if (authAction === 'Reabrir') {
          const isOwner = employee.id === venda.employee_id
          // CORREÇÃO: Cast 'as string' para permitir a comparação com 'admin' sem erro de tipagem
          const userRole = employee.role as string
          const isManager = userRole === 'gerente' || userRole === 'admin'
          
          if (!isOwner && !isManager) {
              alert(`Acesso Negado: Apenas o Vendedor original (${venda.employee_id}) ou um Gerente podem reabrir esta venda.`)
              return
          }
      }

      startTransition(async () => {
          const newStatus = authAction === 'Finalizar' ? 'Fechada' : 'Em Aberto'
          
          const result = await updateVendaStatus(
              venda.id, 
              venda.store_id, 
              newStatus, 
              employee.id
          )
          
          if (result.success) {
              setTimeout(async () => { 
                  await onStatusChange()
                  alert(result.message)
              }, 500)
          } else {
              alert(`Erro: ${result.message}`)
          }
      })
  }

  return (
    <div className="flex items-center gap-3">
      
      {/* GRUPO 1: BOTÕES DE AÇÃO DE STATUS */}
      
      {/* CASO: VENDA EM ABERTO */}
      {!isVendaFechada && venda.status !== 'Cancelada' && (
          <div className="flex gap-3">
              <button
                  type="button"
                  disabled={isPending}
                  onClick={async () => {
                      if(confirm("Tem certeza que deseja cancelar esta venda?")) {
                          const res = await updateVendaStatus(venda.id, venda.store_id, 'Cancelada', 0)
                          if(res.success) onStatusChange()
                      }
                  }}
                  className="flex items-center gap-2 px-4 py-2.5 h-10 text-sm rounded-lg border border-red-200 text-red-600 hover:bg-red-50 font-bold transition-colors"
              >
                  <X className="h-4 w-4" /> Cancelar
              </button>

              {isLocked ? (
                  <div className="flex items-center gap-2 px-4 py-2.5 h-10 text-sm rounded-lg bg-gray-100 text-gray-400 font-bold cursor-not-allowed border border-gray-200" title="Zere o saldo ou gere um carnê para finalizar.">
                      <Lock className="h-4 w-4" />
                      <span>Falta Destinar</span>
                  </div>
              ) : (
                  <button
                      type="button"
                      disabled={isPending}
                      onClick={() => handleActionClick('Finalizar')}
                      className="flex items-center gap-2 px-6 py-2.5 h-10 text-sm rounded-lg shadow-md bg-green-600 hover:bg-green-700 text-white font-bold transition-transform active:scale-95"
                  >
                      {isPending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Check className="h-4 w-4" />}
                      <span>Finalizar Venda</span>
                  </button>
              )}
          </div>
      )}

      {/* CASO: VENDA FECHADA */}
      {isVendaFechada && (
        <div className="flex gap-3 items-center">
            
            <div className="flex items-center gap-2 text-green-700 bg-green-50 px-3 py-1 rounded text-sm font-bold border border-green-200 cursor-default">
                <CheckCircle2 className="h-4 w-4" /> Finalizada
            </div>

            {isSameDay && (
                <button 
                    type="button" 
                    disabled={isPending}
                    onClick={() => handleActionClick('Reabrir')}
                    className="flex items-center gap-2 px-4 py-2.5 h-10 text-sm rounded-lg bg-orange-50 border border-orange-200 text-orange-700 hover:bg-orange-100 font-bold transition-colors"
                    title="Reabrir para correções (Estorna comissões)"
                >
                    {isPending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Unlock className="h-4 w-4" />}
                    <span>Reabrir</span>
                </button>
            )}

            <button 
                type="button" 
                onClick={() => setIsReturnModalOpen(true)}
                className="flex items-center gap-2 px-4 py-2.5 h-10 text-sm rounded-lg bg-white border border-red-200 text-red-600 hover:bg-red-50 font-bold transition-colors"
            >
                <RefreshCcw className="h-4 w-4" />
                <span>Devolução</span>
            </button>
        </div>
      )}

      {/* BOTÃO IMPRIMIR (AGORA GLOBAL / SEMPRE VISÍVEL) */}
      <button 
          type="button" 
          onClick={onPrint} 
          className="flex items-center gap-2 px-4 py-2.5 h-10 text-sm rounded-lg bg-slate-700 text-white hover:bg-slate-800 font-bold transition-colors shadow-md"
          title="Imprimir Recibos de Pagamento"
      >
          <Printer className="h-4 w-4" />
          <span>Imprimir</span>
      </button>

      {/* MODAIS */}
      {isReturnModalOpen && (
        <ReturnModal 
            isOpen={isReturnModalOpen}
            onClose={() => setIsReturnModalOpen(false)}
            vendaId={venda.id}
            storeId={venda.store_id}
            customerId={venda.customer_id}
            itens={vendaItens}
        />
      )}

      {isAuthOpen && (
          <EmployeeAuthModal
              isOpen={isAuthOpen}
              onClose={() => setIsAuthOpen(false)}
              onSuccess={handleAuthSuccess}
              storeId={venda.store_id}
              title={authAction === 'Finalizar' ? "Confirmar Fechamento" : "Autorizar Reabertura"}
              description="Insira seu PIN para confirmar a operação."
          />
      )}
    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\VendaInterface.tsx
==================================================
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'
import { 
  ShoppingBag, DollarSign, FileText, User, 
  Briefcase, Wrench, ArrowLeft 
} from 'lucide-react'

import AddItemForm from '@/components/vendas/AddItemForm'
import AddPagamentoForm from '@/components/vendas/AddPagamentoForm'
import FinanciamentoBox from '@/components/vendas/FinanciamentoBox'
import ListaItens from '@/components/vendas/ListaItens'
import ListaPagamentos from '@/components/vendas/ListaPagamentos'
import ResumoFinanceiro from '@/components/vendas/ResumoFinanceiro'
import VendaActions from '@/components/vendas/VendaActions'
import ListaOS from '@/components/vendas/ListaOS'
import ReceiptSelectionModal from '@/components/modals/ReceiptSelectionModal' // NOVO IMPORT

import { Database } from '@/lib/database.types'

type Venda = Database['public']['Tables']['vendas']['Row']
type VendaItem = Database['public']['Tables']['venda_itens']['Row']
type ServiceOrder = Database['public']['Tables']['service_orders']['Row']
type Pagamento = Database['public']['Tables']['pagamentos']['Row']
type Financiamento = Database['public']['Tables']['financiamento_loja']['Row']
type FinanciamentoParcela = Database['public']['Tables']['financiamento_parcelas']['Row']
type Employee = Database['public']['Tables']['employees']['Row']
type Customer = Database['public']['Tables']['customers']['Row']

interface VendaInterfaceProps {
  venda: Venda
  customer: Customer | null
  employee: Employee | null
  vendaItens: VendaItem[]
  serviceOrders: ServiceOrder[]
  pagamentos: Pagamento[]
  financiamento: (Financiamento & { financiamento_parcelas: FinanciamentoParcela[] }) | null
  // Lentes, Armações, Tratamentos não são usados diretamente aqui, mas vêm da props
  lentes: any[]
  armacoes: any[]
  tratamentos: any[]
  isQuitado: boolean
  isVendaFechadaOuCancelada: boolean
  onDataReload: () => Promise<void>
}

export default function VendaInterface({
  venda, customer, employee, vendaItens, serviceOrders, 
  pagamentos, financiamento, isQuitado, isVendaFechadaOuCancelada, onDataReload
}: VendaInterfaceProps) {

  const router = useRouter()
  const [activeTab, setActiveTab] = useState<'produtos' | 'pagamento' | 'carne'>('produtos')
  
  // NOVO: Estado para controlar o modal de impressão
  const [isPrintModalOpen, setIsPrintModalOpen] = useState(false)

  const vendedorNome = employee?.full_name || 'N/A'
  const employeeIdFinanceiro = employee?.id || 0

  return (
    <div className="flex flex-col h-[calc(100vh-64px)] bg-gray-100 overflow-hidden">
        
        {/* 1. CABEÇALHO SUPERIOR */}
        <div className="bg-white border-b border-gray-200 px-6 py-2 flex items-center shrink-0 shadow-sm z-30 h-12">
            <div className="flex items-center gap-3">
                <button onClick={() => router.back()} className="p-1.5 hover:bg-gray-100 rounded-full text-gray-500 transition-colors" title="Voltar">
                    <ArrowLeft className="h-5 w-5" />
                </button>
                <div className="h-6 w-px bg-gray-300 mx-1"></div>
                <h1 className="text-sm font-bold text-gray-800 whitespace-nowrap uppercase tracking-wide flex items-center gap-2">
                    Venda #{venda.id}
                    <span className={`text-[10px] px-2 py-0.5 rounded-full font-black border ${
                        venda.status === 'Fechada' ? 'bg-green-50 text-green-700 border-green-200' :
                        venda.status === 'Cancelada' ? 'bg-red-50 text-red-700 border-red-200' :
                        'bg-amber-50 text-amber-700 border-amber-200'
                    }`}>
                        {venda.status}
                    </span>
                </h1>
            </div>

            <div className="ml-auto flex items-center gap-4 text-xs">
                <div className="flex items-center gap-1 font-bold text-blue-700 bg-blue-50 px-3 py-1 rounded-lg border border-blue-100">
                    <User className="h-3 w-3" />
                    <span className="truncate max-w-[200px]">{customer?.full_name}</span>
                </div>
                <div className="hidden sm:flex items-center gap-1 text-gray-500">
                    <Briefcase className="h-3 w-3" />
                    <span className="truncate max-w-[120px]">{vendedorNome}</span>
                </div>
            </div>
        </div>

        {/* 2. MIOLO (ÁREA DE SCROLL) */}
        <div className="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 p-4 overflow-hidden min-h-0 bg-gray-100">
      
            {/* COLUNA ESQUERDA (50%) - INPUTS */}
            <div className="flex flex-col bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-full">
                
                {/* Abas */}
                <div className="flex border-b border-gray-200 bg-white flex-shrink-0 h-14">
                    <button 
                        onClick={() => setActiveTab('produtos')} 
                        className={`flex-1 text-sm font-bold uppercase tracking-wide flex items-center justify-center gap-2 transition-all border-b-4 
                        ${activeTab === 'produtos' 
                            ? 'bg-blue-50 text-blue-700 border-blue-600' 
                            : 'bg-white text-blue-300 border-transparent hover:bg-blue-50 hover:text-blue-600'
                        }`}
                    >
                        <ShoppingBag className="h-5 w-5" /> Produtos
                    </button>
                    <button 
                        onClick={() => setActiveTab('pagamento')} 
                        className={`flex-1 text-sm font-bold uppercase tracking-wide flex items-center justify-center gap-2 transition-all border-b-4 
                        ${activeTab === 'pagamento' 
                            ? 'bg-emerald-50 text-emerald-700 border-emerald-600' 
                            : 'bg-white text-emerald-300 border-transparent hover:bg-emerald-50 hover:text-emerald-600'
                        }`}
                    >
                        <DollarSign className="h-5 w-5" /> Pagamento
                    </button>
                    <button 
                        onClick={() => setActiveTab('carne')} 
                        className={`flex-1 text-sm font-bold uppercase tracking-wide flex items-center justify-center gap-2 transition-all border-b-4 
                        ${activeTab === 'carne' 
                            ? 'bg-amber-50 text-amber-700 border-amber-600' 
                            : 'bg-white text-amber-300 border-transparent hover:bg-amber-50 hover:text-amber-600'
                        }`}
                    >
                        <FileText className="h-5 w-5" /> Carnê
                    </button>
                </div>
                                
                {/* Conteúdo da Aba */}
                <div className="flex-1 p-6 overflow-y-auto custom-scrollbar relative">
                    {activeTab === 'produtos' && (
                        <div className="space-y-6">
                            {!isVendaFechadaOuCancelada ? (
                                <AddItemForm vendaId={venda.id} storeId={venda.store_id} onItemAdded={onDataReload} disabled={isVendaFechadaOuCancelada} />
                            ) : (
                                <div className="p-6 bg-gray-50 rounded-xl text-center text-gray-400 font-bold border-2 border-dashed border-gray-200">
                                    Venda Fechada. Edição Bloqueada.
                                </div>
                            )}
                            <div className="p-3 bg-blue-50 rounded border border-blue-100 text-blue-800 text-xs flex gap-2 items-center justify-center">
                                <ShoppingBag className="h-4 w-4" />
                                <span>Itens adicionados aparecem na lista à direita ➔</span>
                            </div>
                        </div>
                    )}

                    {activeTab === 'pagamento' && (
                        <div className="space-y-6">
                            <div className="bg-white p-1 rounded-xl border border-gray-100 shadow-sm">
                                <AddPagamentoForm vendaId={venda.id} customerId={venda.customer_id} storeId={venda.store_id} valorRestante={venda.valor_restante ?? 0} onPaymentAdded={onDataReload} disabled={isVendaFechadaOuCancelada} isQuitado={isQuitado} />
                            </div>
                        </div>
                    )}

                    {activeTab === 'carne' && (
                        <div className="space-y-6">
                            <FinanciamentoBox financiamento={financiamento} vendaId={venda.id} customerId={venda.customer_id} storeId={venda.store_id} employeeId={employeeIdFinanceiro} valorRestante={venda.valor_restante ?? 0} onFinanceAdded={onDataReload} disabled={isVendaFechadaOuCancelada} isQuitado={isQuitado} />
                        </div>
                    )}
                </div>
            </div>

            {/* COLUNA DIREITA (50%) - LISTAS */}
            <div className="flex flex-col gap-4 h-full overflow-hidden">
                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-4 pr-1 pb-4">
                    
                    {/* Lista de Itens */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="bg-gray-50 px-4 py-2 border-b border-gray-200 flex justify-between items-center">
                            <span className="text-xs font-bold text-gray-500 uppercase">Itens ({vendaItens.length})</span>
                        </div>
                        <div className="p-2">
                            <ListaItens itens={vendaItens} vendaId={venda.id} storeId={venda.store_id} onItemDeleted={onDataReload} disabled={isVendaFechadaOuCancelada} />
                        </div>
                    </div>

                    {/* Extrato Pagamentos */}
                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                         <div className="bg-gray-50 px-4 py-2 border-b border-gray-200">
                            <span className="text-xs font-bold text-gray-500 uppercase">Extrato Financeiro</span>
                        </div>
                        <div className="p-2">
                            <ListaPagamentos pagamentos={pagamentos} vendaId={venda.id} storeId={venda.store_id} onDelete={onDataReload} disabled={isVendaFechadaOuCancelada} />
                        </div>
                    </div>

                    {/* Resumo OS */}
                    <div className="bg-purple-50 rounded-xl border border-purple-100 p-3">
                        <div className="flex justify-between items-center mb-2">
                            <h4 className="text-xs font-bold text-purple-800 uppercase flex items-center gap-1">
                                <Wrench className="h-3 w-3" /> Ordens de Serviço
                            </h4>
                        </div>
                        <div className="mt-1">
                            <ListaOS vendaId={venda.id} storeId={venda.store_id} serviceOrders={serviceOrders} employeeId={employee?.id.toString() || '0'} employeeName={vendedorNome} disabled={isVendaFechadaOuCancelada} />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {/* 3. RODAPÉ FIXO (TOTALIZADORES) */}
        <div className="bg-white border-t border-gray-300 shadow-[0_-5px_25px_rgba(0,0,0,0.15)] shrink-0 z-50 px-8 pt-4 pb-6 flex items-center justify-between">
            <div className="flex-1">
                <ResumoFinanceiro
                    venda={venda}
                    onUpdate={onDataReload}
                    disabled={isVendaFechadaOuCancelada}
                />
            </div>
            <div className="pl-8 border-l border-gray-200 ml-6">
                <VendaActions
                    venda={venda}
                    vendaItens={vendaItens}
                    onStatusChange={onDataReload}
                    isVendaFechada={isVendaFechadaOuCancelada}
                    // NOVO: Passamos a função de abrir o modal
                    onPrint={() => setIsPrintModalOpen(true)}
                />
            </div>
        </div>

        {/* 4. MODAL DE SELEÇÃO DE RECIBO (NOVO) */}
        <ReceiptSelectionModal 
            isOpen={isPrintModalOpen} 
            onClose={() => setIsPrintModalOpen(false)} 
            pagamentos={pagamentos} 
            onReload={onDataReload} // <--- ESSA LINHA FAZ A MÁGICA
        />

    </div>
  )
}

==================================================
ARQUIVO: .\src\components\vendas\VendasFilter.tsx
==================================================
'use client'

import { useState, useEffect } from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { ListFilter, Calendar, Search } from 'lucide-react'

export default function VendasFilter() {
    const router = useRouter()
    const searchParams = useSearchParams()

    // Estado inicial baseado na URL
    const [mode, setMode] = useState<'pendencias' | 'historico'>(
        (searchParams.get('mode') as 'pendencias' | 'historico') || 'pendencias'
    )
    
    // Datas padrão (Mês atual)
    const hoje = new Date()
    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().split('T')[0]
    const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0).toISOString().split('T')[0]

    const [dataInicio, setDataInicio] = useState(searchParams.get('inicio') || inicioMes)
    const [dataFim, setDataFim] = useState(searchParams.get('fim') || fimMes)

    // Atualiza a URL quando clica em filtrar ou muda a aba
    const applyFilter = (newMode: 'pendencias' | 'historico') => {
        setMode(newMode)
        const params = new URLSearchParams()
        params.set('mode', newMode)
        
        if (newMode === 'historico') {
            params.set('inicio', dataInicio)
            params.set('fim', dataFim)
        } else {
            // Limpa datas se for modo pendência para não poluir a URL
            params.delete('inicio')
            params.delete('fim')
        }
        
        router.push(`?${params.toString()}`)
    }

    return (
        <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6 space-y-4">
            
            {/* Abas Superiores */}
            <div className="flex p-1 bg-gray-100 rounded-lg w-fit">
                <button
                    onClick={() => applyFilter('pendencias')}
                    className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all ${
                        mode === 'pendencias' 
                        ? 'bg-white text-blue-600 shadow-sm' 
                        : 'text-gray-500 hover:text-gray-700'
                    }`}
                >
                    <ListFilter className="h-4 w-4" />
                    Pendências (Em Aberto)
                </button>
                <button
                    onClick={() => {
                        setMode('historico')
                        // Não aplica direto para deixar o usuário escolher a data, mas muda a UI visualmente
                    }}
                    className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-bold transition-all ${
                        mode === 'historico' 
                        ? 'bg-white text-purple-600 shadow-sm' 
                        : 'text-gray-500 hover:text-gray-700'
                    }`}
                >
                    <Calendar className="h-4 w-4" />
                    Histórico por Período
                </button>
            </div>

            {/* Controles de Data (Só aparecem no modo Histórico) */}
            {mode === 'historico' && (
                <div className="flex flex-wrap items-end gap-3 animate-in slide-in-from-top-2">
                    <div>
                        <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1">De</label>
                        <input 
                            type="date" 
                            value={dataInicio} 
                            onChange={e => setDataInicio(e.target.value)}
                            className="h-10 rounded-lg border-gray-300 text-sm font-bold" 
                        />
                    </div>
                    <div>
                        <label className="block text-[10px] font-bold text-gray-500 uppercase mb-1">Até</label>
                        <input 
                            type="date" 
                            value={dataFim} 
                            onChange={e => setDataFim(e.target.value)}
                            className="h-10 rounded-lg border-gray-300 text-sm font-bold" 
                        />
                    </div>
                    <button 
                        onClick={() => applyFilter('historico')}
                        className="h-10 px-6 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm transition-transform active:scale-95"
                    >
                        <Search className="h-4 w-4" />
                        Buscar
                    </button>
                </div>
            )}
        </div>
    )
}
